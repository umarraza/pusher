/**
   Zwibbler

   Copyright 2019 Hanov Solutions Inc. All Rights Reserved. This software is
   NOT open source. For licensing information, contact the author.

   steve.hanov@gmail.com

   @license
 */
(function(){var aa="function"==typeof Object.defineProperties?Object.defineProperty:function(c,a,b){c!=Array.prototype&&c!=Object.prototype&&(c[a]=b.value)},ba="undefined"!=typeof window&&window===this?this:"undefined"!=typeof global&&null!=global?global:this;function ca(c,a){if(a){for(var b=ba,d=c.split("."),e=0;e<d.length-1;e++){var f=d[e];f in b||(b[f]={});b=b[f]}d=d[d.length-1];e=b[d];f=a(e);f!=e&&null!=f&&aa(b,d,{configurable:!0,writable:!0,value:f})}}var da;
if("function"==typeof Object.setPrototypeOf)da=Object.setPrototypeOf;else{var ea;a:{var fa={xp:!0},ha={};try{ha.__proto__=fa;ea=ha.xp;break a}catch(c){}ea=!1}da=ea?function(c,a){c.__proto__=a;if(c.__proto__!==a)throw new TypeError(c+" is not extensible");return c}:null}var ia=da;ca("Object.setPrototypeOf",function(c){return c||ia});function ja(){ja=function(){};ba.Symbol||(ba.Symbol=ka)}var ka=function(){var c=0;return function(a){return"jscomp_symbol_"+(a||"")+c++}}();
function la(){ja();var c=ba.Symbol.iterator;c||(c=ba.Symbol.iterator=ba.Symbol("iterator"));"function"!=typeof Array.prototype[c]&&aa(Array.prototype,c,{configurable:!0,writable:!0,value:function(){return na(this)}});la=function(){}}function na(c){var a=0;return oa(function(){return a<c.length?{done:!1,value:c[a++]}:{done:!0}})}function oa(c){la();c={next:c};c[ba.Symbol.iterator]=function(){return this};return c}
function pa(c,a){la();c instanceof String&&(c+="");var b=0,d={next:function(){if(b<c.length){var e=b++;return{value:a(e,c[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d}ca("Array.prototype.values",function(c){return c?c:function(){return pa(this,function(a,b){return b})}});
ca("Array.prototype.fill",function(c){return c?c:function(a,b,d){var e=this.length||0;0>b&&(b=Math.max(0,e+b));if(null==d||d>e)d=e;d=Number(d);0>d&&(d=Math.max(0,e+d));for(b=Number(b||0);b<d;b++)this[b]=a;return this}});ca("Array.prototype.keys",function(c){return c?c:function(){return pa(this,function(a){return a})}});
var n=function(){var c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,b){a.__proto__=b}||function(a,b){for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d])};return function(a,b){function d(){this.constructor=a}c(a,b);a.prototype=null===b?Object.create(b):(d.prototype=b.prototype,new d)}}();function qa(c){for(var a="",b,d,e,f,g,h,l=0;l<c.length;)b=c.charCodeAt(l++),d=c.charCodeAt(l++),e=c.charCodeAt(l++),f=b>>2,b=(b&3)<<4|d>>4,g=(d&15)<<2|e>>6,h=e&63,isNaN(d)?g=h=64:isNaN(e)&&(h=64),a=a+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(f)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(b)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(g)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(h);
return a};var sa=function(){function c(a,b,d){void 0===d&&(d="");this.name=a;this.attributes=b;this.text=d;this.children=[]}c.prototype.toString=function(){var a=[];this.um(a,"");a=a.join("");for(var b="",d=0;d<a.length;d++){var e=a.charCodeAt(d);128>e?b+=String.fromCharCode(e):(127<e&&2048>e?b+=String.fromCharCode(e>>6|192):(b+=String.fromCharCode(e>>12|224),b+=String.fromCharCode(e>>6&63|128)),b+=String.fromCharCode(e&63|128))}return b};c.prototype.um=function(a,b){var d;if(this.hasAttributes()||0!==this.children.length){a.push(b);
a.push("<");a.push(this.name);for(d in this.attributes)this.attributes.hasOwnProperty(d)&&(a.push(" "),a.push(d),void 0!==this.attributes[d]&&null!==this.attributes[d]&&(a.push('="'),a.push(this.lm(""+this.attributes[d])),a.push('"')));if(this.children.length||""!==this.text){a.push(">\n");for(d=0;d<this.children.length;d++)this.children[d].um(a,b+"  ");""!==this.text&&a.push(b+"  "+this.lm(this.text));a.push(b+"</"+this.name+">")}else a.push("/>");a.push("\n")}};c.prototype.hasAttributes=function(){for(var a in this.attributes)if(this.attributes.hasOwnProperty(a))return!0;
return!1};c.prototype.Ri=function(a){for(var b in a)a.hasOwnProperty(b)&&(this.attributes[b]=a[b])};c.prototype.rd=function(a){this.children.push(a)};c.prototype.lm=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")};return c}();var u=function(){function c(a,b){this.type=a;this.values=b}c.ci=function(a){a.toLowerCase()in c.Tl&&(a=c.Tl[a.toLowerCase()]);var b=/#([0-9a-f])([0-9a-f])([0-9a-f])/i,d=/rgb\( *([0-9]+) *, *([0-9]+) *, *([0-9]+) *\)/,e=/rgba\( *([0-9]+) *, *([0-9]+) *, *([0-9]+) *, *([0-9\.]+) *\)/;var f=/#([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])/i.exec(a);if(null!==f)a=parseInt(f[1],16)/255,b=parseInt(f[2],16)/255,d=parseInt(f[3],16)/255,f=1;else if(f=e.exec(a),null!==f)a=parseFloat(f[1])/255,b=parseFloat(f[2])/
255,d=parseFloat(f[3])/255,f=parseFloat(f[4]);else if(f=d.exec(a),null!==f)a=parseFloat(f[1])/255,b=parseFloat(f[2])/255,d=parseFloat(f[3])/255,f=1;else if(f=b.exec(a),null!==f)a=parseInt(f[1],16),a=(16*a+a)/255,b=parseInt(f[2],16),b=(16*b+b)/255,d=parseInt(f[2],16),d=(16*d+d)/255,f=1;else return null;return new c(c.RGBA,[a,b,d,f])};c.vd=function(a){return c.ci(a)||new c(c.RGBA,[1,0,1,1])};c.Cs=function(a){var b=/#[0-9a-f]+|rgba?\([^\)]+\)|[a-z]+/gi,d=[],e;do(e=b.exec(a))&&d.push(e[0]);while(e);return d};
c.prototype.toString=function(){function a(a){a=Math.round(255*a);return 16>a?"0"+a.toString(16):a.toString(16)}var b=this.Lh(c.RGBA);return 1===b.values[3]?"#"+a(b.values[0])+a(b.values[1])+a(b.values[2]):"rgba("+Math.round(255*b.values[0])+","+Math.round(255*b.values[1])+","+Math.round(255*b.values[2])+","+b.values[3]+")"};c.prototype.Lh=function(a){return c.hq[this.type][a](this)};c.prototype.vb=function(a){a.type!==this.type&&(a=a.Lh(this.type));if(this.type===c.qe){var b=this.values[0],d=a.values[0];
b=b>d?Math.min(b-d,d-b+360):Math.min(d-b,b-d+360);b/=360;return Math.pow(b*b+(this.values[1]-a.values[1])*(this.values[1]-a.values[1])+(this.values[2]-a.values[2])*(this.values[2]-a.values[2]),.5)}return Math.pow((this.values[0]-a.values[0])*(this.values[0]-a.values[0])+(this.values[1]-a.values[1])*(this.values[1]-a.values[1])+(this.values[2]-a.values[2])*(this.values[2]-a.values[2]),.5)};c.RGBA=0;c.dm=1;c.qe=2;c.ep=3;c.nu=3;c.hq=[[ta,ua,va,wa],[ya,ta,za,Aa],[Ba,Ca,ta,Ea],[Fa,Ga,Ha,ta]];c.Tl={aliceblue:"#f0f8ff",
antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",
darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",
honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",
limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",
orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",
steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",transparent:"rgba(0,0,0,0.0)",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return c}(),Ia=.9505,Ja=1,Ka=1.089;
function Ba(c){var a=c.values[0],b=c.values[1],d=c.values[2];0>a&&(a+=360);var e=a/60-Math.floor(a/60),f=d*(1-b),g=d*(1-e*b);b=d*(1-(1-e)*b);var h=e=0,l=0;switch(Math.floor(a/60)%6){case 0:e=d;h=b;l=f;break;case 1:e=g;h=d;l=f;break;case 2:e=f;h=d;l=b;break;case 3:e=f;h=g;l=d;break;case 4:e=b;h=f;l=d;break;case 5:e=d,h=f,l=g}return new u(u.RGBA,[e,h,l,c.values[3]])}
function va(c){var a=c.values[0],b=c.values[1],d=c.values[2],e=Math.max(a,b,d),f=Math.min(a,b,d);return new u(u.qe,[e===f?0:e===a?(60*(b-d)/(e-f)+360)%360:e===b?60*(d-a)/(e-f)+120:60*(a-b)/(e-f)+240,0===e?0:1-f/e,e,c.values[3]])}function Aa(c){function a(a){return a>6/29*(6/29)*(6/29)?Math.pow(a,1/3):1/3*(29/6)*(29/6)*a+4/29}var b=a(c.values[1]/Ja);return new u(u.ep,[116*b-16,500*(a(c.values[0]/Ia)-b),200*(b-a(c.values[2]/Ka)),c.values[3]])}
function Ga(c){var a=(c.values[0]+16)/116,b=a+c.values[1]/500,d=a-c.values[2]/200,e=6/29;return new u(u.dm,[b>e?Ia*b*b*b:3*(b-16/116)*e*e*Ia,a>e?Ja*a*a*a:3*(a-16/116)*e*e*Ja,d>e?Ka*d*d*d:3*(d-16/116)*e*e*Ka,c.values[3]])}function ua(c){for(var a=[],b=0;3>b;b++)a[b]=.04045>=c.values[b]?c.values[b]/12.92:Math.pow((c.values[b]+.055)/1.055,2.4);return new u(u.dm,[.4124*a[0]+.3576*a[1]+.1805*a[2],.2126*a[0]+.7152*a[1]+.0722*a[2],.0193*a[0]+.1192*a[1]+.9505*a[2],c.values[3]])}
function ya(c){var a=[],b=[0,0,0,0];a[0]=3.241*c.values[0]-1.5374*c.values[1]-.4986*c.values[2];a[1]=-.9692*c.values[0]+1.876*c.values[1]+.0416*c.values[2];a[2]=.0556*c.values[0]-.204*c.values[1]+1.057*c.values[2];for(var d=0;3>d;d++)b[d]=.0031308>=a[d]?12.92*a[d]:1.055*Math.pow(a[d],1/2.4)-.055;b[3]=c.values[3];return new u(u.RGBA,b)}function ta(c){return new u(c.type,c.values.concat())}function wa(c){return Aa(ua(c))}function Fa(c){return ya(Ga(c))}function za(c){return va(ya(c))}
function Ca(c){return ua(Ba(c))}function Ea(c){return wa(Ba(c))}function Ha(c){return za(Ga(c))};var w=new (function(){function c(){this.disabled={};this.Ig=[];this.cq=!1}c.prototype.enable=function(a,b){void 0===b&&(b=!0);this.disabled[a]=!b};c.prototype.create=function(a,b){void 0===b&&(b=!0);!1===b&&(this.disabled[a]=!0);var d=this;return function(){for(var b=0;b<arguments.length;b++);d.$r(a,arguments)}};c.prototype.addListener=function(a){this.Ig.push(a);return a};c.prototype.removeListener=function(a){for(var b=0;b<this.Ig.length;b++)if(this.Ig[b]===a){this.Ig.splice(b,1);break}};c.prototype.Aq=
function(){this.cq||this.addListener(function(a,b){console.log(a+": "+b)})};c.prototype.$r=function(a,b){var d=[],e;if(!this.disabled[a]){var c=b[0].split("%s");d.push(c[0]);for(e=1;e<c.length;e++)e-1>=b.length-1?d.push("<too few args>"):"string"===typeof b[e]||"number"===typeof b[e]?d.push(b[e]):void 0===b[e]?d.push("(undefined)"):null===b[e]?d.push("(null)"):b[e]instanceof Object&&b[e].toString instanceof Function?d.push(b[e].toString()):d.push(JSON.stringify(b[e])),d.push(c[e]);d=d.join("");e=
0;for(c=this.Ig;e<c.length;e++)(0,c[e])(a,d)}};return c}());var La=function(){function c(a){this.code="en";this.data={};this.log=w.create("LANGUAGE");this.data=this.io(a,{})}c.prototype.Eo=function(a){a=a.split(",");this.log("Choice of languages: %s",a);for(var b=0;b<a.length;b++){var d=a[b].split("-")[0];if(d in this.data){this.log("Using language code %s",d);this.code=d;break}else this.log("No language for code %s",d)}};c.prototype.Bj=function(a){this.io(a,this.data)};c.prototype.io=function(a,b){for(var d=a.split("\n"),e=/^([ \t]*)([^:]+):([^:]+):(.*)/,
c=0;c<d.length;c++){var g=e.exec(d[c]);if(g){var h=g[2],l=g[3];g=g[4];h in b||(b[h]={});l in b[h]&&this.log("Warning: Replacing %s:%s",h,l);b[h][l]=g}}return b};c.prototype.fn=function(){var a=this;return function(b){for(var d=[],e=1;e<arguments.length;e++)d[e-1]=arguments[e];return a.nm(b,d)}};c.prototype.get=function(a){for(var b=[],d=1;d<arguments.length;d++)b[d-1]=arguments[d];return this.nm(a,b)};c.prototype.nm=function(a,b){var d="<not translated:"+a+">";this.code in this.data&&a in this.data[this.code]&&
(d=this.data[this.code][a]);for(var e=0;e<b.length;e++)d=d.replace("^"+e,b[e]);return d};return c}();function Ma(c,a){function b(a){for(var b=a.changedTouches,d=0;d<b.length;d++){var e;a:{var c=b[d],f=-1;if("identifier"in c)for(e=0;e<l.length;e++){if(c.identifier===l[e].identifier)break a}else{var k=0;for(e=0;e<l.length;e++){var m=l[e].qq(c);if(-1===f||m<k)f=e,k=m}}e=f}-1===e?"touchend"!==a.type&&(l.push(new h(b[d])),g("New touch %s",b[d].identifier)):"touchend"!==a.type?(l[e].pageX=b[d].pageX,l[e].pageY=b[d].pageY):(g("Remove touch %s",b[d].identifier),l.splice(e,1))}}function d(){for(var a=0,b=
0,d=0;d<l.length;d++)g("Active touch: %s,%s",l[d].pageX,l[d].pageY),a+=l[d].pageX,b+=l[d].pageY;return{x:a/l.length,y:b/l.length}}function e(a,b){for(var d=0,e=0;e<l.length;e++){var c=l[e];d+=Math.sqrt((c.pageX-a)*(c.pageX-a)+(c.pageY-b)*(c.pageY-b))}return d/l.length}function f(a,b){a.preventDefault=function(){b.preventDefault()};a.stopPropagation=function(){b.stopPropagation()};return a}var g=w.create("GESTURES");if(c.Au)c.addEventListener("gesture",a,!1),g("No emulation needed");else{var h=function(){function a(a){this.dh=
a.pageX;this.eh=a.pageY;this.pageX=a.pageX;this.pageY=a.pageY;this.identifier=a.identifier}a.prototype.qq=function(a){return Math.sqrt((this.pageX-a.pageX)*(this.pageX-a.pageX)+(this.pageY-a.pageY)*(this.pageY-a.pageY))};return a}(),l=[],k=!1,m=1,q=0,p,t;c.addEventListener("touchstart",function(c){b(c);g("touchend; inGesture=%s active.length=%s",k,l.length);2<=l.length&&!k&&(k=!0,t=d(),p=e(t.x,t.y),m=1,q=0,a(f({type:"gesturestart",pageX:t.x,pageY:t.y,scale:m,rotation:q},c)))});c.addEventListener("touchmove",
function(c){b(c);if(2<=l.length){t=d();m=e(t.x,t.y)/p;for(var g=t.x,h=t.y,k=0,r=0;r<l.length;r++)k+=Math.atan2(l[r].pageY-h,l[r].pageX-g)-Math.atan2(l[r].eh-h,l[r].dh-g);q=k/l.length/Math.PI*180;a(f({type:"gesturechange",pageX:t.x,pageY:t.y,scale:m,rotation:q},c))}});c.addEventListener("touchend",function(d){b(d);g("touchend; inGesture=%s active.length=%s",k,l.length);k&&2>l.length&&(k=!1,a(f({type:"gestureend",pageX:t.x,pageY:t.y,scale:m,rotation:q},d)))})}};var Na=function(){function c(a){this.next=a}c.prototype.Wo=function(a){for(var b=0;b<a.length;b++)this.Ab(a.charCodeAt(b))};c.prototype.Ab=function(a){this.next.Ab(a)};c.prototype.flush=function(){this.next.flush()};c.prototype.Df=function(){return this.next.Df()};return c}(),Oa=function(){function c(){this.data="";this.log=w.create("BYTESTREAM")}c.prototype.Wo=function(a){for(var b=0;b<a.length;b++)this.Ab(a.charCodeAt(b))};c.prototype.Df=function(){return this};c.prototype.Ab=function(a){if(255<
a||0>a)throw"Bad data written to byte buffer";this.data+=String.fromCharCode(a)};c.prototype.flush=function(){};c.prototype.toString=function(){return this.data};c.prototype.Sb=function(){for(var a=[],b=0;b<this.data.length;b++)a.push(this.data.charCodeAt(b));return a};c.ip=function(a){c.Wl.LZWEncoder=a};c.eg=function(a){var b=new c;a=a.split(",");a.reverse();for(var d=0;d<a.length;d++){var e=a[d];e.length&&(b=c.Wl[e](b))}return b};c.Wl={};return c}();function Pa(){}var Sa=setTimeout,Ta=[],Ua=!1;function Va(){for(var c=0;c<Ta.length;c++)Ta[c][0](Ta[c][1]);Ta=[];Ua=!1}function Wa(c,a){Ta.push([c,a]);Ua||(Ua=!0,Sa(Va,0))}function Xa(c,a){function b(b){Ya(a,b)}function d(b){Za(a,b)}try{c(b,d)}catch(e){d(e)}}function $a(c){var a=c.ys,b=a.Md;a=a.Rj;var d=c.rl[b];c=c.then;if("function"===typeof d){b="fulfilled";try{a=d(a)}catch(e){Za(c,e)}}ab(c,a)||("fulfilled"===b&&Ya(c,a),"rejected"===b&&Za(c,a))}
function ab(c,a){var b=!1;try{if(c===a)throw new TypeError("A promises callback cannot return that same promise.");if(a&&("function"===typeof a||"object"===typeof a)){var d=a.then;if("function"===typeof d)return d.call(a,function(d){b||(b=!0,a!==d?Ya(c,d):bb(c,d))},function(a){b||(b=!0,Za(c,a))}),!0}}catch(e){return b||Za(c,e),!0}return!1}function Ya(c,a){c!==a&&ab(c,a)||bb(c,a)}function bb(c,a){"pending"===c.Md&&(c.Md="sealed",c.Rj=a,Wa(cb,c))}
function Za(c,a){"pending"===c.Md&&(c.Md="sealed",c.Rj=a,Wa(db,c))}function eb(c){var a=c.ul;c.ul=[];for(c=0;c<a.length;c++)$a(a[c])}function cb(c){c.Md="fulfilled";eb(c)}function db(c){c.Md="rejected";eb(c)}
var ib=function(){function c(a){this.Md="pending";this.Rj=void 0;this.ul=[];Xa(a,this)}c.prototype.then=function(a,b){var d={ys:this,then:new c(Pa),rl:{}};d.rl.fulfilled=a;d.rl.rejected=b;"fulfilled"===this.Md||"rejected"===this.Md?Wa($a,d):this.ul.push(d);return d.then};c.prototype["catch"]=function(a){return this.then(null,a)};c.resolve=function(a){return a&&"object"===typeof a&&a.constructor===this?a:new this(function(b){b(a)})};c.reject=function(a){return new this(function(b,d){d(a)})};return c}();
ib.prototype.then=ib.prototype.then;var jb=function(){function c(a){this.Ga=a}c.prototype.Ec=function(a){for(var b in a){if(0<=b.indexOf("-"))throw Error("setStyle: styles must be camelcase; not "+b);this.Ga.style[b]=""+a[b]}return this};c.prototype.Ri=function(a){for(var b in a)this.Ga.setAttribute(b,a[b]);return this};c.prototype.Sd=function(a){a.appendChild(this.Ga);return this};c.prototype.wk=function(a){a.parentNode&&a.parentNode.insertBefore(this.Ga,a.nextSibling)};c.prototype.remove=function(){this.Ga.parentNode&&this.Ga.parentNode.removeChild(this.Ga);
return this};c.prototype.Me=function(a){return window.getComputedStyle(this.Ga)[a]||""};c.prototype.dc=function(){var a=this.Ga.getBoundingClientRect();return{top:a.top+window.pageYOffset,left:a.left+window.pageXOffset}};c.prototype.Ui=function(a){var b=(b=this.Br())?b.dc():{left:0,top:0};this.Ga.style.left=a.left-b.left+"px";this.Ga.style.top=a.top-b.top+"px"};c.prototype.Br=function(){if(!(this.Ga instanceof HTMLElement)||"fixed"===this.Me("position"))return z(document.body);for(var a=this.Ga.parentElement;a&&
"static"===z(a).Me("position");)a=a.parentElement;return a?z(a):null};c.prototype.ue=function(a){this.Ga.classList.add(a);return this};c.prototype.yl=function(a,b){b?this.Ga.classList.add(a):this.Ga.classList.remove(a)};c.prototype.addEventListener=function(a,b){for(var d=0,e=a.split(" ");d<e.length;d++)this.Ga.addEventListener(e[d],b);return this};c.prototype.matches=function(a){if(this.Ga.matches)return this.Ga.matches(a);var b=0;for(a=a.split(",");b<a.length;b++){var d=a[b];d=d.trim();if(0!=d.length)return"["==
d[0]?this.Ga.hasAttribute(d.substr(1,d.length-2)):this.Ga.tagName===d.toUpperCase()}return!1};return c}();function z(c){if("string"===typeof c){if("<"==c[0]){var a=document.createElement("div");a.innerHTML=c;c=[];for(a=a.firstChild;a;)a instanceof HTMLElement&&c.push(a),a=a.nextSibling;return new jb(c[0])}return new jb(document.createElement(c))}return new jb(c)}
function kb(c){return new ib(function(a,b){var d=new XMLHttpRequest;c.mimeType&&d.overrideMimeType(c.mimeType);c.withCredentials&&(d.withCredentials=!0);var e=c.method||"GET",f=c.Bs||{},g=c.url,h="",l=!0,k;for(k in f)l||(h+="&"),l=!1,h+=k+"="+encodeURIComponent(f[k]);"GET"===e&&0<h.length&&(g+="?"+h,h="");d.onreadystatechange=function(){if(4===d.readyState)if(200===d.status)a(d);else{var e=d.statusText;0===d.status?e="Could not contact server.":d.getResponseHeader("status")&&(e=d.getResponseHeader("status"));
b(Error(d.status+" "+e))}};d.open(e,g,!0);"string"===typeof c.data&&(h=c.data);c.contentType?d.setRequestHeader("Content-type","application/json"):"POST"===e&&d.setRequestHeader("Content-Type","application/x-www-form-urlencoded");c.oq?setTimeout(function(){d.send(h)},c.oq):d.send(h)})}var lb=[],mb=null;
function nb(c){for(var a=0;a<lb.length;a++)if(lb[a]===c)return;lb.push(c);mb||(mb=document.createElement("style"),document.head&&document.head.insertBefore(mb,document.head.firstChild));mb.appendChild(document.createTextNode(c))};var ob=w.create("MISC");function pb(c){return"jQuery"in window&&c instanceof window.jQuery?c[0]:c instanceof HTMLElement?c:"string"===typeof c?document.querySelector(c):null}function qb(c){var a=document.createElement("canvas");c&&c.appendChild(a);a.style.background="transparent";return a}function rb(){return(new Date).getTime()}var sb=/MSIE ([0-9]{1,}[\.0-9]{0,})/,tb=0,ub=!1;
function vb(){if(ub)var c=tb;else{c=-1;if("Microsoft Internet Explorer"===navigator.appName){var a=sb.exec(navigator.userAgent);null!==a&&(c=parseFloat(a[1]))}tb=c;ub=!0;ob("IE version is %s",c)}return 0<=c&&9>c}function wb(){for(var c=document.getElementsByTagName("*"),a=0,b=0;b<c.length;b++){var d=parseInt(z(c[b]).Me("z-index"),10)||0;d>a&&(a=d)}return a}
function xb(){if(null===yb){var c=document.createElement("div");c.style.visibility="hidden";c.style.width="100px";document.body.appendChild(c);var a=c.offsetWidth;c.style.overflow="scroll";var b=document.createElement("div");b.style.width="100%";c.appendChild(b);b=b.offsetWidth;c.parentNode.removeChild(c);yb=a-b;ob("ScrollbarWidth calculated as %spx",yb)}return yb}var yb=0;function zb(c,a){var b=u.vd(c);b.values[3]=a;return b.toString()}
function Ab(c){var a=atob(c.split(",")[1]);c=c.split(",")[0].split(":")[1].split(";")[0];for(var b=new ArrayBuffer(a.length),d=new Uint8Array(b),e=0;e<a.length;e++)d[e]=a.charCodeAt(e);return new Blob([b],{type:c})}
function Bb(){var c=document.documentElement,a=c.scrollWidth>c.clientWidth;c=c.scrollHeight>c.clientHeight?xb():0;a=a?xb():0;return{width:window.innerWidth-c,height:window.innerHeight-a,x:document.documentElement.scrollLeft||document.body.scrollLeft,y:document.documentElement.scrollTop||document.body.scrollTop}}function Cb(c){var a=Bb(),b=z(c).dc();b.left=Math.min(b.left,a.x+a.width-c.offsetWidth);b.top=Math.min(b.top,a.y+a.height-c.offsetHeight);z(c).Ui(b)}
function Db(c){var a=c.getContext("2d");if(null===a)return"error";var b=a.getImageData(0,0,c.width,c.height);c=b.width;var d=b.height;a=c*d*3;var e=a+54,f=[66,77,e&255,e>>8&255,e>>16&255,e>>24&255,0,0,0,0,54,0,0,0],g=[40,0,0,0,c&255,c>>8&255,c>>16&255,c>>24&255,d&255,d>>8&255,d>>16&255,d>>24&255,1,0,24,0,0,0,0,0,a&255,a>>8&255,a>>16&255,a>>24&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];a=(4-3*c%4)%4;b=b.data;e=c<<2;for(var h=Oa.eg("Base64Encoder"),l=0;l<f.length;l++)h.Ab(f[l]);for(l=0;l<g.length;l++)h.Ab(g[l]);
do{f=e*(d-1);for(g=0;g<c;g++)l=g<<2,h.Ab(b[f+l+2]),h.Ab(b[f+l+1]),h.Ab(b[f+l]);for(f=0;f<a;f++)h.Ab(0)}while(--d);h.flush();return"data:image/bmp;base64,"+h.Df().toString()}
function Eb(c,a){"erase"===a?c.nd?(c.strokeStyle="#000000",c.globalCompositeOperation="destination-out",--c.lineWidth,c.stroke(),c.globalCompositeOperation="source-over",c.strokeStyle=c.nd,c.lineWidth+=2,c.stroke(),--c.lineWidth):(c.strokeStyle="#000000",c.globalCompositeOperation="destination-out",c.stroke(),c.globalCompositeOperation="source-over"):(c.strokeStyle=a,c.stroke())}
function Fb(){for(var c=0;c<arguments.length;c++);c=arguments[0];for(var a=1;a<arguments.length;a++){var b=arguments[a],d;for(d in b)b.hasOwnProperty(d)&&(c[d]=b[d])}return c};var Gb=function(){function c(a,b,d,e,c){void 0===a&&(a="transparent");void 0===b&&(b=0);void 0===d&&(d=0);void 0===e&&(e=0);void 0===c&&(c=0);this.Be=a;this.left=b;this.top=d;this.right=e;this.bottom=c;this.zIndex=1;this.insertBefore=null;this.sa=document.createElement("div")}c.prototype.be=function(){this.sa&&z(this.sa).remove()};c.prototype.show=function(a){z(this.sa).Ec({position:"fixed",background:this.Be,opacity:.25,left:this.left+"px",top:this.top+"px",right:this.right+"px",bottom:this.bottom+
"px",display:"block"});this.sa.addEventListener("click",a);this.sa.style.zIndex=this.zIndex.toString();this.insertBefore?this.insertBefore.parentNode&&this.insertBefore.parentNode.insertBefore(this.sa,this.insertBefore):document.body.appendChild(this.sa)};return c}();var Hb=w.create("Graphics",!0),A=function(){function c(a,b){this.x=a;this.y=b}c.prototype.vb=function(a){return Math.sqrt((a.x-this.x)*(a.x-this.x)+(a.y-this.y)*(a.y-this.y))};c.prototype.toString=function(){return"("+this.x+", "+this.y+")"};c.prototype.ud=function(a){return this.x===a.x&&this.y===a.y};c.prototype.clone=function(){return new c(this.x,this.y)};c.prototype.rq=function(a,b){var d=a.x,e=a.y,c=this.x,g=this.y,h=b.x-d,l=b.y-e,k=h*h+l*l;if(0===k)return this.vb(a);k=((c-d)*h+(g-e)*l)/k;1<
k?k=1:0>k&&(k=0);d=d+k*h-c;e=e+k*l-g;return Math.sqrt(d*d+e*e)};return c}();function Ib(c,a){this.width=c;this.height=a}function B(c,a,b,d){return Math.sqrt((c-b)*(c-b)+(a-d)*(a-d))}function C(c,a,b,d){var e=B(c,a,b,d);return 0===e?{x:1,y:0}:{x:(b-c)/e,y:(d-a)/e}}function Jb(c){c.x*=-1;c.y*=-1;return c}
var D=function(){function c(a,b,d,e){this.x=a;this.y=b;this.width=d;this.height=e;this.ro()}c.load=function(a){return new c(a.x,a.y,a.width,a.height)};c.fg=function(a){if(0===a.length)return new c(0,0,0,0);for(var b=a[0].x,d=a[0].x,e=a[0].y,f=a[0].y,g=1;g<a.length;g++)a[g].x<b&&(b=a[g].x),a[g].x>d&&(d=a[g].x),a[g].y<e&&(e=a[g].y),a[g].y>f&&(f=a[g].y);return new c(b,e,d-b,f-e)};c.prototype.save=function(){return{x:this.x,y:this.y,width:this.width,height:this.height}};c.prototype.clone=function(){return new c(this.x,
this.y,this.width,this.height)};c.prototype.ud=function(a){return this.x===a.x&&this.y===a.y&&this.width===a.width&&this.height===a.height};c.prototype.mh=function(a){a.x<this.x&&(this.width+=this.x-a.x,this.x=a.x);a.y<this.y&&(this.height+=this.y-a.y,this.y=a.y);a.x+a.width>this.x+this.width&&(this.width+=a.x+a.width-this.x-this.width);a.y+a.height>this.y+this.height&&(this.height+=a.y+a.height-this.y-this.height)};c.prototype.Dl=function(a,b){a<this.x?(this.width+=this.x-a,this.x=a):a>this.x+this.width&&
(this.width=a-this.x);b<this.y?(this.height+=this.y-b,this.y=b):b>this.y+this.height&&(this.height=b-this.y)};c.prototype.contains=function(a){return this.x<=a.x&&this.x+this.width>a.x+a.width&&this.y<=a.y&&this.y+this.height>a.y+a.height};c.prototype.Vc=function(a,b,d){void 0===d&&(d=0);return this.x-d<=a&&this.x+this.width+d>a&&this.y-d<=b&&this.y+this.height+d>b};c.prototype.ro=function(){0>this.width&&(this.x+=this.width,this.width=-this.width);0>this.height&&(this.y+=this.height,this.height=
-this.height)};c.prototype.ed=function(a,b){void 0===b&&(b=a);this.x-=a/2;this.y-=b/2;this.width+=a;this.height+=b};c.prototype.transform=function(a){var b=a.apply(this.x,this.y);var d=a.apply(this.x+this.width,this.y);var e=a.apply(this.x+this.width,this.y+this.height);a=a.apply(this.x,this.y+this.height);this.x=Math.min(b.x,d.x,e.x,a.x);this.y=Math.min(b.y,d.y,e.y,a.y);this.width=Math.max(b.x,d.x,e.x,a.x)-this.x;this.height=Math.max(b.y,d.y,e.y,a.y)-this.y};c.prototype.right=function(){return this.x+
this.width};c.prototype.bottom=function(){return this.y+this.height};c.prototype.Uc=function(){return new A(this.x+this.width/2,this.y+this.height/2)};c.prototype.toString=function(){return"Rectangle("+this.x+", "+this.y+", "+this.width+", "+this.height+")"};return c}(),F=function(){function c(){this.log=w.create("MATRIX");this.Tb="Matrix";if(0===arguments.length)this.m11=1,this.m21=this.m12=0,this.m22=1,this.Da=this.Ca=0;else if(1===arguments.length){if(6!==arguments[0].length)throw"Bad array initializer for Matrix.";
this.m11=arguments[0][0];this.m12=arguments[0][1];this.m21=arguments[0][2];this.m22=arguments[0][3];this.Ca=arguments[0][4];this.Da=arguments[0][5]}else this.m11=arguments[0],this.m12=arguments[1],this.m21=arguments[2],this.m22=arguments[3],this.Ca=arguments[4],this.Da=arguments[5]}c.prototype.toString=function(){return"[ "+this.m11+" "+this.m12+" "+this.Ca+"    "+this.m21+" "+this.m22+" "+this.Da+"    0 0 1 ]"};c.prototype.Sb=function(){return[this.m11,this.m12,this.m21,this.m22,this.Ca,this.Da]};
c.prototype.zk=function(){return 1===this.m11&&0===this.m12&&0===this.m21&&1===this.m22&&0===this.Ca&&0===this.Da};c.prototype.ud=function(a){return this.m11===a.m11&&this.m12===a.m12&&this.m21===a.m21&&this.m22===a.m22&&this.Ca===a.Ca&&this.Da===a.Da};c.prototype.multiply=function(a){var b=new c;b.m11=this.m11*a.m11+this.m12*a.m21;b.m21=this.m21*a.m11+this.m22*a.m21;b.m12=this.m11*a.m12+this.m12*a.m22;b.m22=this.m21*a.m12+this.m22*a.m22;b.Ca=this.m11*a.Ca+this.m12*a.Da+this.Ca;b.Da=this.m21*a.Ca+
this.m22*a.Da+this.Da;return b};c.prototype.apply=function(a,b){return new A(this.m11*a+this.m12*b+this.Ca,this.m21*a+this.m22*b+this.Da)};c.prototype.nf=function(a){var b;void 0===b&&(b=!1);b?a.setTransform(this.m11,this.m21,this.m12,this.m22,this.Ca,this.Da):a.transform(this.m11,this.m21,this.m12,this.m22,this.Ca,this.Da)};c.prototype.clone=function(){return new c(this.m11,this.m12,this.m21,this.m22,this.Ca,this.Da)};c.prototype.inverse=function(){var a=this.m11*this.m22-this.m12*this.m21;return new c(this.m22/
a,-this.m12/a,-this.m21/a,this.m11/a,(this.m12*this.Da-this.Ca*this.m22)/a,(this.Ca*this.m21-this.m11*this.Da)/a)};c.prototype.Ro=function(){var a=this.m11,b=this.m21,d=this.m12,e=this.m22,f=Math.sqrt(a*a+b*b),g=Math.sqrt(d*d+e*e);return new c(a/f,d/g,b/f,e/g,this.Ca,this.Da)};c.prototype.Ad=function(){return new A(Math.sqrt(this.m11*this.m11+this.m21*this.m21),Math.sqrt(this.m12*this.m12+this.m22*this.m22))};c.prototype.Tr=function(){return 1===this.m11&&1===this.m22&&0===this.m12&&0===this.m21};
c.prototype.translate=function(a,b){return this.multiply(new E(a,b))};c.prototype.rotate=function(a,b,d){return this.multiply(new Kb(a,b,d))};return c}(),Kb=function(c){function a(a,d,e){var b=Math.cos(a);a=Math.sin(a);return c.call(this,b,a,-a,b,-d*b-e*a+d,d*a-e*b+e)||this}n(a,c);return a}(F),E=function(c){function a(a,d){return c.call(this,1,0,0,1,a,d)||this}n(a,c);return a}(F),Lb=function(c){function a(a,d,e,f){return void 0===e||void 0===f?c.call(this,a,0,0,d,0,0)||this:c.call(this,a,0,0,d,e-
a*e,f-d*f)||this}n(a,c);return a}(F),Mb=function(c){function a(a,d,e){var b=Math.cos(2*a);a=Math.sin(2*a);return c.call(this,b,a,a,-b,-d*b-e*a+d,-d*a+e*b+e)||this}n(a,c);return a}(F);
function Nb(c,a,b,d,e,f,g,h,l,k){if(!(8<++Nb.depth)){var m=(a+d)/2,q=(b+e)/2,p=(d+f)/2,t=(e+g)/2,r=(f+h)/2,v=(g+l)/2,x=(m+p)/2,I=(q+t)/2;p=(p+r)/2;t=(t+v)/2;var y=(x+p)/2,K=(I+t)/2,P=h-a,ma=l-b;d=Math.abs((d-h)*ma-(e-l)*P);f=Math.abs((f-h)*ma-(g-l)*P);(d+f)*(d+f)<k*(P*P+ma*ma)?c.push(new A(y,K)):(Nb(c,a,b,m,q,x,I,y,K,k),Nb(c,y,K,p,t,r,v,h,l,k))}--Nb.depth}(Nb||(Nb={})).depth=0;
function Ob(c,a,b,d,e,f,g,h){if(!(8<++Nb.depth)){var l=(a+d)/2,k=(b+e)/2,m=(d+f)/2,q=(e+g)/2,p=(l+m)/2,t=(k+q)/2,r=f-a,v=g-b;d=Math.abs((d-f)*v-(e-g)*r);d*d<=h*(r*r+v*v)?c.push(new A(p,t)):(Ob(c,a,b,l,k,p,t,h),Ob(c,p,t,m,q,f,g,h))}--Nb.depth}
function Pb(c,a,b){var d,e=!1,f=c.length;1<f&&c[f-1].x===c[0].x&&c[f-1].y===c[0].y&&--f;if(3>f)return!1;var g=c[f-1].x;var h=c[f-1].y;for(d=0;d<f;d++){var l=c[d].x;var k=c[d].y;if(l>g){var m=g;var q=l;var p=h;h=k}else m=l,q=g,p=k;l<a===a<=g&&(b-p)*(q-m)<(h-p)*(a-m)&&(e=!e);g=l;h=k}return e}function Qb(c,a,b,d){d*=d;for(var e=1;e<c.length;e++){var f=c[e-1].x,g=c[e-1].y,h=c[e].x-f,l=c[e].y-g,k=((a-f)*h+(b-g)*l)/(h*h+l*l);1<k?k=1:0>k&&(k=0);f=f+k*h-a;g=g+k*l-b;if(f*f+g*g<=d)return!0}return!1}
(function(){function c(a){this.Nb=a}c.prototype.clear=function(){for(var a=0;a<this.Nb.width*this.Nb.height*4;a++)this.Nb.data[a]=0};c.prototype.getImageData=function(){return this.Nb};c.prototype.width=function(){return this.Nb.width};c.prototype.height=function(){return this.Nb.height};c.prototype.get=function(a,b){var d=this.Nb.width*b*4+4*a;return this.Nb.data[d]|this.Nb.data[d+1]<<8|this.Nb.data[d+2]<<16|this.Nb.data[d+3]<<24};c.prototype.set=function(a,b,d){a=this.Nb.width*b*4+4*a;this.Nb.data[a]=
d&255;this.Nb.data[a+1]=d>>8&255;this.Nb.data[a+2]=d>>16&255;this.Nb.data[a+3]=d>>24&255};return c})();
(function(){function c(a,b){this.data=[];this.wf=a;this.wh=b;this.data=[]}c.prototype.width=function(){return this.wf};c.prototype.height=function(){return this.wh};c.prototype.getImageData=function(){var a=document.createElement("canvas");a.width=this.wf;a.height=this.wh;a=a.getContext("2d").getImageData(0,0,this.wf,this.wh);for(var b=this.wf*this.wh,d=0;d<b;d++){var e=!0===this.data[d]?255:0;a.data[4*d]=e;a.data[4*d+1]=e;a.data[4*d+2]=e;a.data[4*d+3]=255}return a};c.prototype.get=function(a,b){return!0===
this.data[this.wf*b+a]};c.prototype.set=function(a,b,d){this.data[this.wf*b+a]=d};return c})();
var H=function(){function c(a){this.closed=!1;this.ba=[];a instanceof D&&(this.moveTo(a.x,a.y),this.lineTo(a.x+a.width,a.y),this.lineTo(a.x+a.width,a.y+a.height),this.lineTo(a.x,a.y+a.height),this.lineTo(a.x,a.y),this.closePath())}c.prototype.clear=function(){this.closed=!1;this.ba=[]};c.prototype.beginPath=function(){};c.prototype.rect=function(){};c.prototype.moveTo=function(a,b){this.ba.push(c.jc,a,b)};c.prototype.lineTo=function(a,b){this.ba.push(c.ic,a,b)};c.prototype.bezierCurveTo=function(a,
b,d,e,f,g){this.ba.push(c.Pd,a,b,d,e,f,g)};c.prototype.quadraticCurveTo=function(a,b,d,e){this.ba.push(c.Rd,a,b,d,e)};c.prototype.arc=function(){};c.prototype.arcTo=function(){};c.prototype.closePath=function(){this.ba.push(c.hc)};c.prototype.ha=function(a){for(var b=0;b<this.ba.length;){switch(this.ba[b]){case c.jc:a.moveTo&&a.moveTo(this.ba[b+1],this.ba[b+2]);break;case c.ic:a.lineTo&&a.lineTo(this.ba[b+1],this.ba[b+2]);break;case c.Pd:a.bezierCurveTo&&a.bezierCurveTo(this.ba[b+1],this.ba[b+2],
this.ba[b+3],this.ba[b+4],this.ba[b+5],this.ba[b+6]);break;case c.Rd:a.quadraticCurveTo&&a.quadraticCurveTo(this.ba[b+1],this.ba[b+2],this.ba[b+3],this.ba[b+4]);break;case c.hc:a.closePath&&a.closePath();break;default:alert("Error!")}b+=c.kc[this.ba[b]]}};c.prototype.Ws=function(){for(var a=0,b=0,d=0,e=[];a<this.ba.length;){switch(this.ba[a]){case c.hc:e.push([c.hc]);break;case c.jc:b=this.ba[a+1];d=this.ba[a+2];break;case c.ic:e.push([c.ic,b,d]);b=this.ba[a+1];d=this.ba[a+2];break;case c.Pd:e.push([c.Pd,
this.ba[a+3],this.ba[a+4],this.ba[a+1],this.ba[a+2],b,d]);b=this.ba[a+5];d=this.ba[a+6];break;case c.Rd:e.push([c.Rd,this.ba[a+1],this.ba[a+2],b,d]),b=this.ba[a+3],d=this.ba[a+4]}a+=c.kc[this.ba[a]]}this.ba.length&&e.push([c.jc,b,d]);a=new c;for(b=e.length-1;0<=b;b--)Array.prototype.push.apply(a.ba,e[b]);a.closed=this.closed;return a};c.prototype.ag=function(){for(var a=0,b,d=[];a<this.ba.length;){var e=c.am[this.ba[a]];for(b=0;b<e;b++)d.push(new A(this.ba[a+1+2*b],this.ba[a+1+2*b+1]));a+=c.kc[this.ba[a]]}return d};
c.prototype.transform=function(a){for(var b=0,d,e;b<this.ba.length;){e=c.am[this.ba[b]];for(d=0;d<e;d++){var f=a.apply(this.ba[b+1+2*d],this.ba[b+1+2*d+1]);this.ba[b+1+2*d]=f.x;this.ba[b+1+2*d+1]=f.y}b+=c.kc[this.ba[b]]}};c.prototype.clone=function(){var a=new c;a.ba=this.ba.concat();return a};c.prototype.Gm=function(a){for(var b=0,d,e=d=0,f=new D(this.ba[1],this.ba[2],0,0),g;b<this.ba.length;){switch(this.ba[b]){case c.jc:case c.ic:d=this.ba[b+1];e=this.ba[b+2];f.Dl(d,e);break;case c.Pd:var h=g=
[],l=this.ba[b+5],k=this.ba[b+6];Nb(h,d,e,this.ba[b+1],this.ba[b+2],this.ba[b+3],this.ba[b+4],l,k,a*a);h.push(new A(l,k));for(d=0;d<g.length;d++)f.Dl(g[d].x,g[d].y);d=this.ba[b+5];e=this.ba[b+6];break;case c.Rd:h=g=[];l=this.ba[b+3];k=this.ba[b+4];Ob(h,d,e,this.ba[b+1],this.ba[b+2],l,k,a*a);h.push(new A(l,k));for(d=0;d<g.length;d++)f.Dl(g[d].x,g[d].y);d=this.ba[b+3];e=this.ba[b+4]}b+=c.kc[this.ba[b]]}return f};c.prototype.append=function(a){this.ba=this.ba.concat(a.ba)};c.prototype.xl=function(a){for(var b=
0,d=0,e=0,f=new c,g;b<this.ba.length;){switch(this.ba[b]){case c.jc:d=this.ba[b+1];e=this.ba[b+2];f.moveTo(d,e);break;case c.ic:d=this.ba[b+1];e=this.ba[b+2];f.lineTo(d,e);break;case c.Pd:var h=g=[],l=this.ba[b+5],k=this.ba[b+6];Nb(h,d,e,this.ba[b+1],this.ba[b+2],this.ba[b+3],this.ba[b+4],l,k,a*a);h.push(new A(l,k));2===g.length&&1E-4>d*(g[0].y-g[1].y)+g[0].x*(g[1].y-e)+g[1].x*(e-g[0].y)&&(g[0]=g[1],g.length=1);for(d=0;d<g.length;d++)f.lineTo(g[d].x,g[d].y);d=this.ba[b+5];e=this.ba[b+6];break;case c.Rd:h=
g=[];l=this.ba[b+3];k=this.ba[b+4];Ob(h,d,e,this.ba[b+1],this.ba[b+2],l,k,a*a);h.push(new A(l,k));for(d=0;d<g.length;d++)f.lineTo(g[d].x,g[d].y);d=this.ba[b+3];e=this.ba[b+4];break;case c.hc:f.closePath()}b+=c.kc[this.ba[b]]}return f};c.prototype.Fs=function(a,b){var d;void 0===d&&(d=0);return Pb(this.ag(),a,b)||0<d&&this.lo(a,b,d)};c.prototype.lo=function(a,b,d){var e=0,f=0,g=0;for(d*=d;g<this.ba.length;){switch(this.ba[g]){case c.jc:e=this.ba[g+1];f=this.ba[g+2];break;case c.ic:var h=this.ba[g+
1];var l=this.ba[g+2];var k=h-e;var m=l-f;var q=k*k+m*m;q=((a-e)*k+(b-f)*m)/q;1<q?q=1:0>q&&(q=0);e+=q*k;m=f+q*m;f=e-a;m-=b;f=f*f+m*m;if(f<=d)return!0;e=h;f=l}g+=c.kc[this.ba[g]]}return!1};c.prototype.Wh=function(a,b){for(var d=0,e=0,f=b[0],g,h=new A(0,0),l;d<this.ba.length;){switch(this.ba[d]){case c.jc:l=this.ba[d+1];g=this.ba[d+2];a.moveTo(l,g);h=new A(l,g);break;case c.ic:l=this.ba[d+1];var k=g=this.ba[d+2],m=new A(l,k);g=h.vb(m);if(!(0>=g)){for(;g>f;)h.x+=(m.x-h.x)*f/g,h.y+=(m.y-h.y)*f/g,e&1?
a.moveTo(h.x,h.y):a.lineTo(h.x,h.y),g-=f,e=(e+1)%b.length,f=b[e];g<=f&&(h=new A(l,k),e&1?a.moveTo(h.x,h.y):a.lineTo(h.x,h.y),f-=g)}}d+=c.kc[this.ba[d]]}};c.prototype.Gp=function(){function a(a,b){f-=(a-d)*(b+e);d=a;e=b}for(var b=0,d,e,f=0;b<this.ba.length;){switch(this.ba[b]){case c.jc:d=this.ba[b+1];e=this.ba[b+2];break;case c.ic:a(this.ba[b+1],this.ba[b+2]);break;case c.Pd:a(this.ba[b+5],this.ba[b+6]);break;case c.Rd:a(this.ba[b+3],this.ba[b+4])}b+=c.kc[this.ba[b]]}return f/2};c.prototype.Tm=function(a){for(var b=
0,d=0,e=0,f=!1;b<this.ba.length;){switch(this.ba[b]){case c.jc:d=this.ba[b+1];e=this.ba[b+2];f=!0;break;case c.ic:a(d,e,this.ba[b+1],this.ba[b+2],f),d=this.ba[b+1],e=this.ba[b+2],f=!1}b+=c.kc[this.ba[b]]}};c.prototype.Rp=function(){var a=0;this.Tm(function(b,d,e,c){a+=B(b,d,e,c)});return a};c.prototype.Tp=function(a){var b=new c,d=0;this.Tm(function(e,c,g,h,l){if(d<=a){l&&b.moveTo(e,c);l=B(e,c,g,h);if(d+l>=a){var f=a-d;g=e+(g-e)*f/l;h=c+(h-c)*f/l}d+=l;b.lineTo(g,h)}});return b};c.jc=0;c.ic=1;c.Pd=
2;c.Rd=3;c.hc=4;c.kc=[3,3,7,5,1];c.am=[1,1,3,2,0];return c}();function Rb(c,a,b,d,e){var f;if(2>=d-b)e.push(c[b]);else{var g=c[b],h=c[d-1],l=0,k=0;for(f=b+1;f<d;f++){var m=c[f].rq(g,h);m>l&&(l=m,k=f)}0<k&&l>a?(Rb(c,a,b,k,e),Rb(c,a,k,d,e)):e.push(g)}}function Sb(c,a){var b=[];Rb(c,a,0,c.length,b);0<c.length&&0<b.length&&!c[c.length-1].ud(b[b.length-1])&&b.push(c[c.length-1]);return b}
var Tb=function(){function c(){this.la=[];if(1===arguments.length){var a=arguments[0];if(a instanceof D)this.la.push(new A(a.x,a.y)),this.la.push(new A(a.right(),a.y)),this.la.push(new A(a.right(),a.bottom())),this.la.push(new A(a.x,a.bottom()));else if(a instanceof Array)this.la=a;else throw alert("Bad parameter passed to Polygon() constructor."),"Error";}}c.prototype.transform=function(a){for(var b=0;b<this.la.length;b++)this.la[b]=a.apply(this.la[b].x,this.la[b].y)};c.prototype.add=function(a,
b){this.la.push(new A(a,b))};c.prototype.Vc=function(a,b,d){void 0===d&&(d=0);return Pb(this.la,a,b)||d&&Qb(this.la,a,b,d)};c.prototype.Qp=function(){return D.fg(this.la)};c.prototype.clone=function(){return new c(this.la.slice(0))};c.prototype.ud=function(a){if(this.la.length!==a.la.length)return!1;for(var b=0;b<this.la.length;b++){var d=this.la[b],e=a.la[b];if(d.x!==e.x||d.y!==e.y)return!1}return!0};c.prototype.ed=function(a){for(var b=[],d=0;d<this.la.length;d++){var e=this.la[0===d?this.la.length-
1:d-1],c=this.la[d],g=this.la[d===this.la.length-1?0:d+1],h=B(e.x,e.y,c.x,c.y),l=B(g.x,g.y,c.x,c.y);b.push({x:c.x+((c.x-e.x)/h+(c.x-g.x)/l)/Math.sqrt(2)*a,y:c.y+((c.y-e.y)/h+(c.y-g.y)/l)/Math.sqrt(2)*a})}this.la=b};c.prototype.ha=function(a){if(!(1>this.la.length)){a.moveTo(this.la[0].x,this.la[0].y);for(var b=1;b<this.la.length;b++)a.lineTo(this.la[b].x,this.la[b].y);a.closePath()}};c.prototype.ag=function(){return this.la};c.lu=function(a,b){for(var d=0,e=0,c=!1,g=[],h=[],l=0;l<b.length;l++)h.push(0);
for(;;){var k=0,m=-1;for(l=0;l<b.length;l++)if(h[l]<b[l].length){var q=b[l][h[l]];if(0===l||q<k){k=q;m=l;var p=1-h[l]%2}}if(-1===m)return g;h[m]+=1;"intersection"===a?p?(e+=1,e===b.length&&(d=k)):(e===b.length&&(g.push(d),g.push(k)),--e):p?(e+=1,0===m?(c=!0,1===e)&&(d=k):c&&2===e&&(g.push(d),g.push(k))):(c&&1===e&&(g.push(d),g.push(k)),--e,0===m&&(c=!1),c&&1===e&&(d=k))}};return c}();
function Ub(c,a,b,d,e,f,g,h){b-=c;d-=a;g-=e;h-=f;var l=-g*d+b*h;if(0===l)return null;e=(g*(a-f)-h*(c-e))/l;return new A(c+e*b,a+e*d)}
function Vb(c,a){function b(a){var b,e;var c=[];var l=b=0;for(e=a.length;l<e;l++){var k=a[l];a[b+1]&&(c[b]=d(k,a[b+1]));b+=1}return c}function d(a,b){return new A(a.x+(b.x-a.x)/2,a.y+(b.y-a.y)/2)}return a?Vb(b(b(function(a){var b,e;a=[a[0]].concat(a).concat(a[a.length-1]);var c=[];var l=b=0;for(e=a.length;l<e;l++){var k=a[l];c[2*b]=k;a[b+1]&&(c[2*b+1]=d(k,a[b+1]));b+=1}return c}(c))),a-1):c}
(function(){function c(){this.items=[];this.oa=new F}c.prototype.toString=function(){return this.items.join(" ")};c.prototype.arc=function(){throw Error("SvgPathContext.arc is not implemented.");};c.prototype.arcTo=function(){throw Error("SvgPathContext.arcTo is not implemented.");};c.prototype.moveTo=function(a,b){var d=this.oa.apply(a,b);this.items.push("M",d.x,d.y)};c.prototype.lineTo=function(a,b){var d=this.oa.apply(a,b);this.items.push("L",d.x,d.y)};c.prototype.transform=function(a,b,d,e,c,
g){a=new F(a,d,b,e,c,g);this.oa=this.oa.multiply(a)};c.prototype.rect=function(){};c.prototype.bezierCurveTo=function(a,b,d,e,c,g){a=this.oa.apply(a,b);d=this.oa.apply(d,e);c=this.oa.apply(c,g);this.items.push("C",a.x,a.y,d.x,d.y,c.x,c.y)};c.prototype.quadraticCurveTo=function(){throw Error("SvgPathContext.quadraticCurveTo is not implemented.");};c.prototype.beginPath=function(){};c.prototype.closePath=function(){this.items.push("Z")};return c})();
function Wb(c,a,b,d,e){if(!(2>a.length)){void 0===d&&(d=!0);void 0===e&&(e=!0);var f=a[0].x===a[a.length-1].x&&a[0].y===a[a.length-1].y,g=[],h=[],l=new A(0,0),k=l,m=l,q=l,p=l,t=[];b/=2;var r;for(r=1;r<a.length;r++){m=a[r-1];p=a[r];q=C(m.x,m.y,p.x,p.y);l=new A(q.y,-q.x);k=new A(m.x-q.x*b-l.x*b,m.y-q.y*b-l.y*b);m=new A(m.x-q.x*b+l.x*b,m.y-q.y*b+l.y*b);if(h.length){var v=h[h.length-1];var x=t[t.length-1];k=Ub(v.x,v.y,v.x+x.x,v.y+x.y,k.x,k.y,k.x+q.x,k.y+q.y)||k;v=g[g.length-1];m=Ub(v.x,v.y,v.x+x.x,v.y+
x.y,m.x,m.y,m.x+q.x,m.y+q.y)||m}h.push(k);g.push(m);t.push(q)}f?(v=h[0],x=t[0],k=Ub(v.x,v.y,v.x+x.x,v.y+x.y,k.x,k.y,k.x+q.x,k.y+q.y)||k,v=g[0],m=Ub(v.x,v.y,v.x+x.x,v.y+x.y,m.x,m.y,m.x+q.x,m.y+q.y)||m,h[0].x=k.x,h[0].y=k.y,g[0].x=m.x,g[0].y=m.y,h.push(k),g.push(m)):(h.push(new A(p.x+q.x*b-l.x*b,p.y+q.y*b-l.y*b)),g.push(new A(p.x+q.x*b+l.x*b,p.y+q.y*b+l.y*b)));if(e){c.moveTo(h[0].x,h[0].y);for(r=1;r<h.length;r++)c.lineTo(h[r].x,h[r].y);f&&(c.closePath(),c.moveTo(g[g.length-1].x,g[g.length-1].y))}else d&&
c.moveTo(g[g.length-1].x,g[g.length-1].y);if(d){for(r=g.length-1;0<=r;r--)c.lineTo(g[r].x,g[r].y);!f&&e&&c.lineTo(h[0].x,h[0].y)}}}
(function(){function c(a){this.la=a;this.n=0;this.mb=new A(0,0)}c.prototype.next=function(a){if(0===this.la.length)return null;if(0===this.n)return this.mb=this.la[0].clone(),this.n+=1,this.mb.clone();for(;this.n<this.la.length;){var b=this.mb.vb(this.la[this.n]);if(0===b)this.n+=1;else if(b<=a)a-=b,this.n+=1;else return this.mb.x+=(this.la[this.n].x-this.mb.x)*a/b,this.mb.y+=(this.la[this.n].y-this.mb.y)*a/b,this.mb.clone()}return null};return c})();function Xb(c){return"object"===typeof c&&"[object Array]"===Object.prototype.toString.apply(c)}function Yb(c){return"string"===typeof c}function J(c){return"number"===typeof c}function Zb(c){return"object"===typeof c};var L=function(){function c(a,b){this.id=a;this.ea=b;this.parent=null;this.aa={};this.rect=new D(0,0,1,1);this.xh=!1;this.Pa=new D(0,0,1,1);this.Yb=this.order=0;this.log=w.create("BaseNode");this.aa.matrix=new F;this.aa.layer="default";this.Ej(c.wa)}c.od=function(a,b){c.types[a]=b};c.create=function(a,b,d){return a in c.types?new c.types[a](b,d):null};c.prototype.Ej=function(a){for(var b in a)a.hasOwnProperty(b)&&(this.aa[b]=a[b])};c.prototype.clip=function(){};c.prototype.toString=function(){return this.type()+
":"+this.id};c.prototype.Fg=function(){return!1};c.prototype.ri=function(){return null};c.prototype.Xh=function(){};c.prototype.Gn=function(){return!1};c.prototype.oi=function(){return"text"in this.aa};c.prototype.$m=function(a,b){var d=typeof this.aa[a],e=typeof b;d!==e&&"string"===e&&"number"===d&&(this.log("Convert property %s to a number.",a),b=parseFloat(b));return b};c.prototype.clone=function(a){a=c.create(this.type(),a(),this.ea);a.Jb(this.ec());return a};c.prototype.ec=function(){var a={},
b;for(b in this.aa)this.aa.hasOwnProperty(b)&&(a[b]=this.ka(b));return a};c.prototype.Jb=function(a){for(var b in a)a.hasOwnProperty(b)&&this.setProperty(b,a[b])};c.prototype.zd=function(){var a=this.ka("layer");return a?""+a:"default"};c.prototype.In=function(){return void 0!==this.children};c.prototype.Jn=function(){return null!==this.parent&&null!==this.parent.parent&&"PageNode"!==this.parent.type()};c.prototype.type=function(){return"BaseNode"};c.prototype.Ea=function(){return this.ka("matrix")};
c.prototype.yd=function(){return this.Ea().inverse()};c.prototype.Vf=function(a){this.setProperty("matrix",a)};c.prototype.setProperty=function(a,b){b=this.$m(a,b);if(a in this.aa||"customData"===a||"tag"===a||"locked"===a||"lockSize"===a||"lockRotation"===a||"lockPosition"===a||"lockEditMode"===a||"rotationHandles"===a||"lockAspectRatio"===a||"zIndex"===a||"snap"===a||"opacity"===a)Xb(b)&&(b=b.slice(0)),"opacity"===a&&(b=parseFloat(b)),this.aa[a]=b};c.prototype.ka=function(a){a=this.aa[a];a instanceof
Array&&(a=a.slice(0));return a};c.prototype.gn=function(){var a=new Tb(this.Pa);a.transform(this.Ea());return a};c.prototype.Ff=function(){return this.ka("zIndex")||0};c.prototype.transform=function(a){this.Vf(a.multiply(this.Ea()))};c.prototype.format=function(){};c.prototype.xb=function(a,b){var d=this.yd().apply(a,b);return this.hidden()||this.ka("locked")||!this.Pa.Vc(d.x,d.y)?null:this};c.prototype.ke=function(a){this.xh=a};c.prototype.hidden=function(){return this.xh};c.prototype.Wf=function(){};
c.prototype.Nk=function(){};c.prototype.Qk=function(){};c.prototype.Tg=function(a){if(a.Tg){var b={"zwibbler:id":""+this.id};if("tag"in this.aa){var d=this.aa.tag;"string"!==typeof d&&(d=JSON.stringify(d));b["zwibbler:tag"]=d}a.Tg(b)}};c.prototype.Sg=function(a){a.Sg&&a.Sg()};c.prototype.ha=function(a){a.save();this.Tg(a);var b=this.aa.matrix;a.transform(b.m11,b.m21,b.m12,b.m22,b.Ca,b.Da);"erase"===this.aa.strokeStyle?a.nd?a.strokeStyle=a.nd:(a.strokeStyle="#000000",a.globalCompositeOperation="destination-out"):
a.strokeStyle=this.aa.strokeStyle;a.fillStyle=this.aa.fillStyle;a.lineWidth=this.aa.lineWidth;this.aa.shadow&&(a.shadowOffsetX=3,a.shadowOffsetY=3,a.shadowBlur=5,a.shadowColor="rgba(0,0,0,0.5)");"opacity"in this.aa&&(a.globalAlpha=this.aa.opacity);this.re(a);this.Sg(a);a.restore();c.Vl&&(a.save(),a.beginPath(),a.lineWidth=1,a.strokeStyle="#ff8000",a.rect(this.rect.x,this.rect.y,this.rect.width,this.rect.height),a.stroke(),a.restore())};c.prototype.Vm=function(a,b){var d=b?function(b){a.fillStyle=
b;a.fill()}:function(b){a.strokeStyle=b;a.stroke()};a.nd?(a.globalCompositeOperation="destination-out",--a.lineWidth,d("#000000"),a.globalCompositeOperation="source-over",a.fillStyle=a.nd,a.lineWidth+=2,d(a.nd),--a.lineWidth):(a.globalCompositeOperation="destination-out",d("#000000"),a.globalCompositeOperation="source-over")};c.prototype.re=function(){};c.prototype.resolve=function(){return!1};c.prototype.Vq=function(a,b,d,e){this.vg||(this.vg={});var c=this.vg[a];if(!c||c.Uo!==e){c&&e===c.Uo||(c=
{Uo:e,value:e},this.vg[a]=c);a=/url\(([^\)]+)\)/.exec(e);var g;a&&(g=a[1]);var h=this;g&&(c.value="rgba(0, 0, 0, 0.2)",d.add(this.id,"image",g,null,function(a){h.log("Got image response.");c.value=b.createPattern(a,"repeat")||"magenta";d.Qf(h.id)}))}};c.prototype.kr=function(a){return this.vg&&(a=this.vg[a])?a.value:"magenta"};c.prototype.xd=function(){return""};c.prototype.Oe=function(){};c.prototype.ei=function(){return null};c.prototype.fi=function(){return null};c.prototype.Le=function(){return this.parent?
this.parent.ck(this):-1};c.wa={fillStyle:"#cccccc",strokeStyle:"#000000",lineWidth:2,shadow:!1};c.Vl=!1;c.types={};return c}();var $b=function(c){function a(a,d){var b=c.call(this,a,d)||this;b.la=[];b.cc=[];b.log=w.create("BRUSH",!0);b.log("New BrushNode created.");b.aa.points=[];b.aa.strokeStyle="#ff00ff";b.aa.lineWidth=10;return b}n(a,c);a.prototype.type=function(){return"BrushNode"};a.prototype.setProperty=function(a,d){"fillStyle"===a&&(a="strokeStyle");a in this.aa||"dashes"===a||"lineCap"===a?this.aa[a]=d:c.prototype.setProperty.call(this,a,d)};a.prototype.ka=function(a){"fillStyle"===a&&(a="strokeStyle");return c.prototype.ka.call(this,
a)};a.prototype.format=function(){var a,d;this.la.length=0;var e=this.aa.points;var c=a=0;for(d=e.length-1;a<=d;c=a+=2)this.la.push(new A(e[c],e[c+1]));c=D.fg(this.la);e=this.Ea().Ad();a=this.aa.lineWidth;c.ed(a/e.x,a/e.y);this.Pa=c.clone();c=new Tb(c);c.transform(this.aa.matrix);this.rect=D.fg(c.la);this.cc=[];if("dashes"in this.aa)for(e=this.aa.dashes.split(","),c=0;c<e.length;c++)a=parseFloat(e[c]),isNaN(a)||this.cc.push(a);this.log("Format brushnode")};a.prototype.xb=function(a,d){if(this.rect.Vc(a,
d)){var b=this.yd().apply(a,d);if(Qb(this.la,b.x,b.y,12+this.aa.lineWidth/2))return this}return null};a.prototype.re=function(b){var d=this.aa.points;if(0!==d.length){b.save();b.beginPath();var e=this.ka("lineCap")||"round";b.lineCap=e;b.lineJoin="round"===e?"round":"bevel";if(1<this.cc.length){e=this.la;var c=this.cc;if(0!==e.length){b.moveTo(e[0].x,e[0].y);var g=0;for(var h=1,l=c[0],k=e[0].clone(),m;h<e.length;)m=k.vb(e[h]),0===m?h+=1:m<=l?(k=e[h].clone(),g&1?b.moveTo(k.x,k.y):b.lineTo(k.x,k.y),
l-=m,h+=1):(k.x+=(e[h].x-k.x)*l/m,k.y+=(e[h].y-k.y)*l/m,g&1?b.moveTo(k.x,k.y):b.lineTo(k.x,k.y),g=(g+1)%c.length,l=c[g])}}else for(b.moveTo(d[0],d[1]),e=c=2,g=d.length-1;c<=g;e=c+=2)b.lineTo(d[e],d[e+1]);this.yd().nf(b);Eb(b,this.aa.strokeStyle);if(a.jp){this.Ea().nf(b);b.beginPath();e=c=0;for(g=d.length-1;c<=g;e=c+=2)b.rect(d[e]-2,d[e+1]-2,4,4);b.fillStyle="#ff0000";b.fill()}b.restore()}};a.jp=!1;return a}(L);L.od("BrushNode",$b);function ac(c){return{m11:c.m11,m12:c.m21,m21:c.m12,m22:c.m22,dx:c.Ca,dy:c.Da}}
var bc=function(){function c(a,b){this.node=a;this.request=b}c.prototype.Uq=function(a,b,d){this.node.Vq(b,a,this.request,d)};c.prototype.jr=function(a){return this.node.kr(a)};c.prototype.Rs=function(){this.request.Qf(this.node.id)};c.prototype.Yr=function(a,b){this.request.add(this.node.id,"image",a,null,b)};c.prototype.Hq=function(a){this.node.Vm(a,!0)};c.prototype.Dt=function(a){this.node.Vm(a,!1)};return c}(),cc=function(c){function a(a,d){var b=c.call(this,a,d)||this;b.Ua=null;b.log=w.create("CUSTOM");
b.setProperty("matrix",new F);return b}n(a,c);a.prototype.type=function(){return"CustomNode"};a.prototype.setProperty=function(a,d){if(null===this.Ua&&"nodeType"===a){var b=O.Pj[d];this.Ua=new b(this.id);for(var c in this.aa)this.setProperty(c,this.aa[c]);this.aa.nodeType=d}else this.aa[a]=d,"matrix"===a&&(d=ac(d)),this.Ua&&this.Ua.setProperty&&this.Ua.setProperty(a,d)};a.prototype.Fg=function(){return this.Ua&&this.Ua.hasEditMode?this.Ua.hasEditMode():!1};a.prototype.ik=function(){var a=[];this.Ua&&
this.Ua.getEditHandles&&(a=this.Ua.getEditHandles());for(var d=this.Ea(),e=[],c=0;c<a.length;c++){var g=a[c];e.push(d.apply(g.x||0,g.y||0))}return e};a.prototype.xb=function(a,d){var b=this.yd().apply(a,d);return this.hidden()||this.ka("locked")||!this.Pa.Vc(b.x,b.y)||this.Ua&&this.Ua.hittest&&!this.Ua.hittest(b.x,b.y)?null:this};a.prototype.Xh=function(a,d){a.beginPath();for(var b=10/d,c=2/d,g=0,h=this.ik();g<h.length;g++){var l=h[g];a.moveTo(l.x+b/d,l.y);a.arc(l.x,l.y,b,0,2*Math.PI,!1)}a.strokeStyle=
"#0050B7";a.lineWidth=c;a.stroke()};a.prototype.ei=function(a){var b=this.ik();return a<b.length?b[a]:null};a.prototype.ri=function(a,d,e){for(var b=this.ik(),c=0;c<b.length;c++)if(20>b[c].vb(new A(a,d))/e)return c;return null};a.prototype.Oe=function(a,d,e){this.Ua&&this.Ua.moveEditHandle&&(d=this.yd().apply(d,e),this.Ua.moveEditHandle(a,d.x,d.y))};a.prototype.ka=function(a){var b;this.Ua&&this.Ua.getProperty&&(b=this.Ua.getProperty(a));void 0===b&&(b=c.prototype.ka.call(this,a));"matrix"===a&&(b=
b?new F(b.m11||1,b.m21||0,b.m12||0,b.m22||1,b.dx||0,b.dy||0):new F);return b};a.prototype.format=function(a,d){if(this.Ua)if(this.ek||(this.ek=new bc(this,d)),"format"in this.Ua&&this.Ua.format(a,this.ek),this.Ua.getUntransformedRect){var b=this.Ua.getUntransformedRect();this.Pa=new D(b.x||0,b.y||0,b.width||0,b.height||0);this.rect=this.Pa.clone();this.rect.transform(this.Ea())}else this.log("Error: NodeType %s missing getUntransformedRect()",this.aa.nodeType)};a.prototype.re=function(a){a.save();
a.getTransform=function(){return a.Ql?ac(a.Ql):ac(new F)};this.Ua.draw(a,this.ek);a.restore()};return a}(L);L.od("CustomNode",cc);bc.prototype.formatFill=bc.prototype.Uq;bc.prototype.getFill=bc.prototype.jr;bc.prototype.reformat=bc.prototype.Rs;bc.prototype.loadImage=bc.prototype.Yr;bc.prototype.fillEraser=bc.prototype.Hq;bc.prototype.strokeEraser=bc.prototype.Dt;var dc=function(c){function a(a,d){var b=c.call(this,a,d)||this;b.element=null;b.Qh=void 0;b.uc=new Tb;b.vk=new Tb;b.Yd=new F;b.readOnly=!1;b.tb=!1;b.Gc=null;b.width=0;b.height=0;b.fc=null;b.log=w.create("DomNode",!0);b.aa.data="";b.aa.locked=!1;return b}n(a,c);a.prototype.type=function(){return"DomNode"};a.prototype.setProperty=function(a,d){if("data"===a)this.element&&(z(this.element).remove(),this.Qh=this.element=null);else if("border"===a||"lockSize"===a||"lockRotate"===a||"preview"===a){this.aa[a]=
d;return}c.prototype.setProperty.call(this,a,d)};a.prototype.kt=function(a){null!==this.Gc&&(this.log("Node %s receives DOM element and requests reformat",this.id),this.element&&(this.log("   Remove existing DOM element"),z(this.element).remove()),this.element=a,this.element.style.position="absolute","IFRAME"!==a.tagName&&(this.element.style.pointerEvents="none"),z(this.element).wk(this.Gc.canvas),this.width=this.element.offsetWidth||parseFloat(this.element.getAttribute("width")||"0"),this.height=
this.element.offsetHeight||parseFloat(this.element.getAttribute("height")||"0"),z(this.element).remove(),this.Wf(this.readOnly,!0),this.element.style.top="0px",this.element.style.left="0px",this.zj("transformOrigin","top left"),this.log("element height: %s, %s",this.element.offsetWidth,this.element.offsetHeight),this.Gc.Qf(this.id))};a.prototype.nn=function(){return this.element};a.prototype.zj=function(a,d){if(null!==this.element){for(var b=a.charAt(0).toUpperCase()+a.substr(1),c=["ms","Webkit",
"O","Moz"],g=0;g<c.length;g++)this.element.style[c[g]+b]=d;this.element.style[a]=d}};a.prototype.ke=function(a){L.prototype.ke.call(this,a);this.element&&(this.element.style.visibility=this.xh?"hidden":"visible")};a.prototype.Wf=function(a,d){void 0===d&&(d=!1);if(d||this.readOnly!==a)this.readOnly=a,this.element&&this.Gc&&this.tb&&(z(this.element).wk(this.Gc.canvas),this.element.style.pointerEvents=a?"auto":"none")};a.prototype.format=function(a,d){var b=this;null===this.element&&this.Qh!==this.ka("data")&&
d&&(this.Qh=this.ka("data"),this.Gc=d,this.log("DomNode %s requests conversion to DOM element",this.id),this.Gc.eq(this.Qh,this.id));if(this.element){var c=this.Yd;c=c.multiply(this.Ea());c.Tr()?(this.zj("transform",""),this.element.style.left=""+c.Ca+"px",this.element.style.top=""+c.Da+"px"):(this.element.style.left="0px",this.element.style.top="0px",this.zj("transform","matrix("+c.m11+","+c.m21+","+c.m12+","+c.m22+","+c.Ca+","+c.Da+")"));this.rect.x=0;this.rect.y=0;this.rect.width=this.width;this.rect.height=
this.height;this.element.style.visibility=this.xh?"hidden":"visible"}else this.rect.x=0,this.rect.y=0,this.rect.width=100,this.rect.height=22;this.uc=new Tb(this.rect);this.Pa=this.rect.clone();this.rect.transform(this.Ea());this.uc.transform(this.Ea());if(c=this.aa.border)this.rect.ed(c),this.vk=this.uc.clone(),this.vk.ed(c/2),this.uc.ed(c);!this.aa.preview||null!==this.fc&&this.fc.src===this.aa.preview?this.aa.preview||(this.fc=null):(this.log("Requesting new preview image for %s",this.aa.preview),
this.fc=document.createElement("img"),this.fc.src=this.aa.preview,this.fc.onload=function(){b.log("Preview image loaded.");d.Qf(b.id)},this.fc.onerror=function(){b.log("FAiled to load preview image")})};a.prototype.re=function(a){var b=a.Ql;b&&this.Gc&&(b.m11!==this.Yd.m11||b.m21!==this.Yd.m21||b.m12!==this.Yd.m12||b.m22!==this.Yd.m22||b.Ca!==this.Yd.Ca||b.Da!==this.Yd.Da)&&(this.log("Moving DOM element as result of draw zooming"),this.Yd=b,this.format(a,this.Gc));if(this.element){if(b=this.aa.border){var e=
this.vk;a.setTransform(1,0,0,1,0,0);a.beginPath();a.lineWidth=b;a.strokeStyle="#cccccc";a.moveTo(e.la[0].x,e.la[0].y);a.lineTo(e.la[1].x,e.la[1].y);a.lineTo(e.la[2].x,e.la[2].y);a.lineTo(e.la[3].x,e.la[3].y);a.lineTo(e.la[0].x,e.la[0].y);a.closePath();a.stroke()}}else a.beginPath(),a.lineWidth=1,a.fillStyle="#888888",a.strokeStyle="#CCCCCC",a.rect(0,0,100,22),a.stroke(),a.font="20px Arial",a.textBaseline="top",a.fillText("DomNode",0,0);if(this.fc&&this.fc.naturalHeight){this.log("Drawing preview image %s,%s ->%s,s",
this.fc.naturalWidth,this.fc.naturalHeight,this.width,this.height);try{a.drawImage(this.fc,0,0,this.fc.naturalWidth,this.fc.naturalHeight,0,0,this.width,this.height)}catch(f){this.log("Tried to draw image, got error: %s",f.toString())}}};a.prototype.xb=function(a,d){return!this.aa.locked&&this.rect.Vc(a,d)&&this.uc.Vc(a,d,3)?this:null};a.prototype.Nk=function(){this.element&&this.Gc&&(this.log("Added DOM NODE %s",this.id),z(this.element).wk(this.Gc.canvas),this.element.style.pointerEvents=this.readOnly?
"auto":"none");this.tb=!0};a.prototype.Qk=function(){this.log("Removed DOM NODE %s",this.id);this.element&&z(this.element).remove();this.tb=!1};return a}(L);L.od("DomNode",dc);var ec=function(c){function a(a,d){var b=c.call(this,a,d)||this;b.children=[];return b}n(a,c);a.prototype.type=function(){return"GroupNode"};a.prototype.clone=function(b){for(var d=new a(b(),this.ea),e=0;e<this.children.length;e++){var c=this.children[e].clone(b);c.parent=d;d.children.push(c)}return d};a.prototype.format=function(a,d){for(var b=0;b<this.children.length;b++)this.children[b].format(a,d),0===b?this.rect=this.children[b].rect.clone():this.rect.mh(this.children[b].rect)};a.prototype.ha=
function(a){for(var b=0;b<this.children.length;b++)this.children[b].ha(a)};a.prototype.xb=function(a,d){for(var b=this.children.length-1;0<=b;b--){var c=this.children[b].xb(a,d);if(c)return c}return null};a.prototype.ck=function(a){for(var b=0;b<this.children.length;b++)if(a===this.children[b])return b;return-1};return a}(L);L.od("GroupNode",ec);var fc=function(c){function a(a,d){var b=c.call(this,a,d)||this;b.wc=null;b.Yc=null;b.width=100;b.height=20;b.uc=new Tb;b.Fe=[];b.Ic=new D(0,0,b.width,b.height);b.bc=new D(0,0,b.width,b.height);b.log=w.create("IMAGE",!0);delete b.aa.fillStyle;delete b.aa.strokeStyle;delete b.aa.lineWidth;b.aa.url="";return b}n(a,c);a.prototype.type=function(){return"ImageNode"};a.prototype.setProperty=function(a,d){c.prototype.setProperty.call(this,a,d);switch(a){case "url":this.Yc=this.wc=null;break;case "brightness":case "contrast":case "gamma":this.Yc=
null;this.aa[a]=d;break;case "allowCrop":case "crop":case "blendMode":case "opacity":case "width":case "height":this.aa[a]=d}};a.prototype.ft=function(a){a.x=Math.max(a.x,0);a.y=Math.max(a.y,0);a.width=Math.min(a.width,this.Ic.width);a.height=Math.min(a.height,this.Ic.height);a.width=Math.max(1,a.width);a.height=Math.max(1,a.height);this.aa.crop=[a.x,a.y,a.width,a.height].join()};a.prototype.kn=function(){var a=this.aa.crop,d=new D(0,0,this.Ic.width,this.Ic.height);a&&(a=a.split(","),d.x=parseFloat(a[0])|
0,d.y=parseFloat(a[1])|0,d.width=parseFloat(a[2])|0,d.height=parseFloat(a[3])|0);return d};a.prototype.Ys=function(){var a={brightness:this.ka("brightness"),contrast:this.ka("contrast"),gamma:this.ka("gamma")};this.Yc=void 0!==a.brightness&&void 0!==a.contrast&&void 0!==a.gamma&&this.wc?this.Iq(this.wc,a)||this.wc:this.wc};a.prototype.format=function(a,d){function b(a,b,d){k.Fe.push({x:k.bc.x+a*k.bc.width,y:k.bc.y+b*k.bc.height,Cd:d})}var c=this;null===this.wc&&"ImageSurface"in window?(this.wc=new window.ImageSurface(this.aa.url),
this.Ic=new D(0,0,this.wc.width,this.wc.height)):null===this.wc?(this.Ic=new D(0,0,this.width,this.height),d.add(this.id,"image",this.aa.url,null,function(a){c.log("Got image response.");c.wc=a;return d.Qf(c.id)})):this.Ic=new D(0,0,this.wc.width,this.wc.height);if(null===this.Yc&&(this.Ys(),this.Yc)){var g=this.ka("width"),h=this.ka("height");this.log("Override width/height as %s/%s",g,h);g&&(this.Yc.style.width=g+"px");h&&(this.Yc.style.height=h+"px")}this.bc=this.kn();this.rect=this.bc.clone();
if(g=this.ka("boundingPolygon")){h=[];for(var l=0;l<g.length;l+=2)h.push(new A(g[l],g[l+1]));this.uc=new Tb(h)}else this.uc=new Tb(this.rect);this.Pa=this.rect.clone();this.uc.transform(this.aa.matrix);this.rect.transform(this.aa.matrix);this.Fe.length=0;var k=this;b(.5,0,!0);b(1,.5,!1);b(.5,1,!0);b(0,.5,!1)};a.prototype.gn=function(){return this.uc};a.prototype.xb=function(a,d){return!this.aa.locked&&this.uc.Vc(a,d,3)?this:null};a.prototype.re=function(b){var d,e,c=!1;if(this.Yc)try{var g=b.globalCompositeOperation,
h=b.globalAlpha,l=this.ka("blendMode"),k=this.ka("opacity");l&&(b.globalCompositeOperation=""+l,this.log("Using globalCompsiteOperation=%s (requested %s)",b.globalCompositeOperation,l));void 0!==k&&(b.globalAlpha=k);var m=this.ka("lineWidth")||0;if(m){b.save();this.yd().nf(b);var q=this.uc.clone();q.ed(m/2);b.beginPath();q.ha(b);b.lineWidth=m;b.strokeStyle=this.ka("strokeStyle")||"#000000";b.stroke();b.restore()}b.drawImage(this.Yc,this.bc.x,this.bc.y,this.bc.width,this.bc.height,this.bc.x,this.bc.y,
this.bc.width,this.bc.height);b.globalAlpha=h;b.globalCompositeOperation=g;if(a.Ul){var p=this.uc.la;b.save();b.setTransform(1,0,0,1,0,0);b.beginPath();b.lineWidth=2;b.strokeStyle="#000000";b.moveTo(p[0].x,p[0].y);var t=d=1;for(e=p.length-1;d<=e;t=d+=1)b.lineTo(p[t].x,p[t].y);b.closePath();b.stroke();b.restore()}}catch(r){this.log("Error drawing image: %s",r.message),c=r}if(null===this.Yc||c)b.save(),b.lineWidth=1,b.strokeStyle="#cccccc",b.strokeRect(0,0,this.width,this.height),b.restore()};a.prototype.Fg=
function(){return!0===this.ka("allowCrop")&&!0!==this.ka("lockEditMode")};a.prototype.Xh=function(a,d){a.save();a.beginPath();a.lineWidth=1*d;a.strokeStyle="#0050B7";for(var b=this.Ea(),c=0;c<this.Fe.length;c++){var g=this.Fe[c],h=b.apply(g.x,g.y),l;if(g.Cd){var k=20;var m=l=0;var q=3;g=h.x-10;h=h.y-6}else k=0,l=20,m=3,q=0,g=h.x-6,h=h.y-10;for(var p=0;5>p;p++)a.moveTo(g,h),a.lineTo(g+k*d,h+l*d),g+=m*d,h+=q*d}a.stroke();a.restore()};a.prototype.ri=function(a,d,e){var b=this.Ea();e*=10;for(var c=0;c<
this.Fe.length;c++){var h=this.Fe[c];h=b.apply(h.x,h.y);if(h.x-e<=a&&a<h.x+e&&h.y-e<=d&&d<h.y+e)return c}return null};a.prototype.ei=function(a){a=this.Fe[a];return this.Ea().apply(a.x,a.y)};a.prototype.Oe=function(a,d,e){var b=this.kn();d=this.yd().apply(d,e);d.x=Math.round(d.x);d.y=Math.round(d.y);0===a&&0<=d.y&&d.y<this.Ic.height?(b.height-=d.y-b.y,b.y=d.y):1===a&&0<=d.x&&d.x<this.Ic.width?b.width=d.x-b.x:2===a&&0<=d.y&&d.y<this.Ic.height?b.height=d.y-b.y:3===a&&0<=d.x&&d.x<this.Ic.width&&(b.width-=
d.x-b.x,b.x=d.x);this.ft(b)};a.prototype.Iq=function(a,d){var b=a.width,c=a.height;if(!(a instanceof HTMLCanvasElement)){var g=document.createElement("canvas");g.width=b;g.height=c;g.getContext("2d").drawImage(a,0,0);a=g}g="number"===typeof d.brightness?d.brightness:-1;var h="number"===typeof d.contrast?d.contrast:-1,l="number"===typeof d.gamma?d.gamma:-1,k=document.createElement("canvas");this.log("filterSpec: %s",JSON.stringify(d));this.log("brightness=%s contrast=%s gamma=%s w=%s h=%s",g,h,l,b,
c);k.width=b+1;k.height=c;try{var m=a.getContext("2d").getImageData(0,0,b,c).data}catch(x){return this.log("Cannot filter external image."),null}b=k.getContext("2d").getImageData(0,0,b,c);c=b.data;for(var q=0;q<m.length;q+=4){var p=m[q]/255,t=m[q+1]/255,r=m[q+2]/255,v=m[q+3];0<=l&&(p=Math.pow(p,l),t=Math.pow(t,l),r=Math.pow(r,l));0<=g&&(p*=g,r*=g,t*=g);0<=h&&(p=p*h-.5*h+.5,t=t*h-.5*h+.5,r=r*h-.5*h+.5);c[q]=Math.min(255*p|0,255);c[q+1]=Math.min(255*t|0,255);c[q+2]=Math.min(255*r|0,255);c[q+3]=v}k.getContext("2d").putImageData(b,
0,0);return k};a.Ul=!1;return a}(L);L.od("ImageNode",fc);var gc=function(){function c(){this.text="";this.font="10px Arial";this.bn="Arial";this.fontSize=10;this.lines=[];this.Il="top";this.Eg="left";this.Kn=this.bold=!1;this.textDecoration="";this.log=w.create("TextBox");this.rect=new D(0,0,0,this.fontSize)}c.prototype.mt=function(a,b,d,e,c){this.bn=a;this.fontSize=b;this.bold=d;this.Kn=e;this.textDecoration=c};c.prototype.Io=function(a){this.text=a};c.prototype.Ao=function(a,b){switch(a){case "left":case "center":case "right":this.Eg=a;break;case null:break;
default:this.log("Unknown alignment: %s",a)}switch(b){case "top":case "middle":case "bottom":this.Il=b;break;case null:break;default:this.log("Unknnown alignment: %s",b)}};c.prototype.format=function(a,b,d){this.font=""+this.fontSize+'px "'+this.bn+'"';this.bold&&(this.font="bold "+this.font);this.Kn&&(this.font="italic "+this.font);this.lines.length=0;var e;a.font=this.font;var c=0;this.rect.width=0;if(0===b){var g=this.text.split("\n");for(e=0;e<g.length;e++){var h=g[e];var l=a.measureText(h).width;
c+=this.fontSize;this.lines.push({x:0,y:c,width:l,text:h});this.rect.width=Math.max(this.rect.width,l)}}else{h=g=0;var k=!1;for(e=0;e<this.text.length;e++){var m=this.text.charAt(e);l=a.measureText(this.text.substr(g,e-g+1)).width;"\n"===m?k=!0:l>b?h?(e=h,k=!0):e>g&&(--e,k=!0):" "===m&&(h=e);k&&(l=" "===this.text.charAt(e)?a.measureText(this.text.substr(g,e-g)).width:a.measureText(this.text.substr(g,e-g+1)).width,c+=this.fontSize,this.lines.push({x:0,y:c,width:l,text:this.text.substr(g,e-g+1)}),g=
e+1,h=0,k=!1,this.rect.width=Math.max(this.rect.width,l))}l&&(c+=this.fontSize,this.lines.push({x:0,y:c,width:l,text:this.text.substr(g,e-g)}),this.rect.width=Math.max(this.rect.width,l))}this.rect.x=0;this.rect.y=0;this.rect.height=c;if("center"===this.Eg)for(e=0;e<this.lines.length;e++)a=this.lines[e],a.x=this.rect.width/2-a.width/2;else if("right"===this.Eg)for(e=0;e<this.lines.length;e++)a=this.lines[e],a.x=this.rect.width-a.width;b&&"center"===this.Eg?this.rect.x=b/2-this.rect.width/2:b&&"right"===
this.Eg&&(this.rect.x=b-this.rect.width);d&&"middle"===this.Il?this.rect.y=d/2-this.rect.height/2:d&&"bottom"===this.Il&&(this.rect.y=d-this.rect.height)};c.prototype.ha=function(a,b,d){this.fillText(a,b,d);this.Sm(a,b,d)};c.prototype.Sm=function(a,b,d){var e;if(0<=this.textDecoration.indexOf("underline")){a.save();a.beginPath();var c=1;for(e=0;e<this.lines.length;e++){var g=this.lines[e];a.moveTo(g.x+b,g.y+d+c);a.lineTo(g.x+b+g.width,g.y+d+c)}a.strokeStyle=a.fillStyle;a.lineWidth=1;a.stroke();a.beginPath();
a.restore()}if(0<=this.textDecoration.indexOf("line-through")){a.save();a.beginPath();c=.25*-this.fontSize;for(e=0;e<this.lines.length;e++)g=this.lines[e],a.moveTo(g.x+b,g.y+d+c),a.lineTo(g.x+b+g.width,g.y+d+c);a.strokeStyle=a.fillStyle;a.lineWidth=1;a.stroke();a.restore()}};c.prototype.fillText=function(a,b,d){a.textBaseline="alphabetic";a.font=this.font;for(var e=0;e<this.lines.length;e++){var c=this.lines[e];a.fillText(c.text,this.rect.x+c.x+b,this.rect.y+c.y+d)}};c.prototype.strokeText=function(a,
b,d){a.textBaseline="alphabetic";a.font=this.font;for(var e=0;e<this.lines.length;e++){var c=this.lines[e];a.strokeText(c.text,this.rect.x+c.x+b,this.rect.y+c.y+d)}};return c}();var hc=function(c){function a(b,d){var e=c.call(this,b,d)||this;e.gb=new gc;e.uk=0;e.border={lineWidth:0,Be:"#000000"};e.log=w.create("TEXT",!0);e.Ej(a.lp);e.aa.text="lorum ipsum dolor";return e}n(a,c);a.prototype.type=function(){return"TextNode"};a.prototype.setProperty=function(a,d){this.aa[a]=this.$m(a,d);"textFillStyle"===a?this.aa.fillStyle=d:"fillStyle"===a&&(this.aa.textFillStyle=d)};a.prototype.format=function(a){this.gb.mt(this.aa.fontName,this.aa.fontSize,this.aa.bold,this.aa.italic,this.aa.textDecoration);
var b=this.aa.text;b.length&&10===b.charCodeAt(b.length-1)&&(b=b.substr(0,b.length-1));this.gb.Io(b);var e=this.aa.matrix;b=e.apply(0,0);e=e.apply(1,0);b=b.vb(e);e=this.ka("wrap");var c=!1!==this.ka("scaleFont");this.gb.Ao(this.aa.textAlign,"top");e?(e=this.aa.baseWidth,void 0===e&&(this.gb.format(a,0,0),e=Math.max(this.gb.rect.width,10),500<e&&(e=500),this.aa.baseWidth=e,this.log("Formatting text for first time; baseWidth=%s",e)),b=Math.ceil(b*e),this.gb.format(a,b,0),a=this.gb.rect.height,this.Pa=
new D(0,0,e,a)):c?(this.gb.format(a,0,0),b=this.gb.rect.width,a=this.gb.rect.height,this.Pa=new D(0,-(0+this.ka("fontSize")),b,a)):(this.gb.format(a,0,0),b=this.gb.rect.width,a=this.gb.rect.height,this.Pa=new D(0,0,b,a));a=new Tb(this.Pa);a.transform(this.Ea());this.rect=a.Qp();this.uk=this.rect.height;this.rect.height+=.3*this.aa.fontSize;a=this.ka("lineWidth")+0;this.rect.ed(a,a);this.border=this.aa.border?this.Ds(this.aa.border):{lineWidth:0,Be:"#000000"}};a.prototype.Ds=function(a){var b={lineWidth:0,
Be:"#000000"};a=a.split(" ");for(var e=0;e<a.length;e++){var c=parseFloat(a[e]);if(isNaN(c)){if(c=u.ci(a[e]))b.Be=c.toString()}else b.lineWidth=c}return b};a.prototype.Ea=function(){return!1===this.ka("scaleFont")?c.prototype.Ea.call(this).Ro():c.prototype.Ea.call(this)};a.prototype.ha=function(a){if(0!==this.aa.text.length){var b=.3*this.aa.fontSize;a.save();this.Tg(a);"opacity"in this.aa&&(a.globalAlpha=this.aa.opacity);var e=this.aa.background;if(e||this.border.lineWidth)a.save(),this.Ea().nf(a),
e&&(a.fillStyle=e,a.fillRect(this.Pa.x,this.Pa.y,this.Pa.width,this.Pa.height+b)),this.border.lineWidth&&(a.beginPath(),a.strokeStyle=this.border.Be,a.lineWidth=this.border.lineWidth,a.rect(this.Pa.x,this.Pa.y,this.Pa.width,this.Pa.height+b),a.stroke()),a.restore();this.ka("wrap")?this.Ea().Ro().nf(a):this.Ea().nf(a);a.strokeStyle=this.aa.strokeStyle;a.fillStyle=this.aa.fillStyle;a.lineWidth=this.aa.lineWidth;b=0;e=this.Ea().Ad();e=this.Pa.height*e.y;if(this.aa.wrap||!1===this.ka("scaleFont"))switch(this.log("Available: %s rect: %s",
e,this.gb.rect),this.aa.verticalAlign){case "bottom":b+=e-this.gb.rect.height;break;case "middle":b+=(e-this.gb.rect.height)/2}else b=-(0+this.ka("fontSize"));this.aa.shadow&&(a.shadowOffsetX=3,a.shadowOffsetY=3,a.shadowBlur=5,a.shadowColor="rgba(0,0,0,0.5)");0<this.aa.lineWidth&&this.gb.strokeText(a,0,b);this.gb.fillText(a,0,b);this.gb.Sm(a,0,b);this.Sg(a);a.restore();L.Vl&&(a.save(),a.beginPath(),a.lineWidth=1,a.strokeStyle="#ff8000",a.rect(this.rect.x,this.rect.y,this.rect.width,this.rect.height),
a.stroke(),a.restore())}};a.lp={textFillStyle:"#000000",fontName:"Arial",fontSize:20,lineWidth:0,fillStyle:"#000000",wrap:!1,textAlign:"left",bold:!1,italic:!1,background:"rgba(0,0,0,0.0)",textDecoration:""};return a}(L);L.od("TextNode",hc);var ic=function(){function c(a,b){this.na=a;this.ga=b;this.zt=!0;this.log=w.create("MoveSegment")}c.prototype.ha=function(a){a.moveTo(this.ga.x,this.ga.y)};c.prototype.Ld=function(){return this.pc()};c.prototype.pc=function(){return{x:1,y:0}};return c}(),jc=function(){function c(a,b,d,e,c){this.na=a;this.ga=b;this.kl=e;this.Kd=c;this.log=w.create("LineSegment");this.ef=0;this.ya=new A(0,0);this.Fa=new A(0,0);this.length=0;this.from=new A(0,0);this.ga=b;this.na=a;this.Kd=c;this.kl=e;d.next();this.Ji=
d.next();this.Ki=d.next();this.moveTo=this.ff=null;this.format()}c.prototype.format=function(){var a=B(this.na.ga.x,this.na.ga.y,this.ga.x,this.ga.y);this.ef=this.length=a;var b=this.na.ga.clone();this.na instanceof c&&this.Kd&&(this.Kd=Math.min(this.Kd,a/2,this.na.length/2),a=C(this.na.ga.x,this.na.ga.y,this.ga.x,this.ga.y),b.x+=a.x*this.Kd,b.y+=a.y*this.Kd,this.na.ut(this.Kd),this.ef-=this.Kd);this.from=b;null===this.ff&&(this.ff=this.ga);a=this.ef/10*this.kl;10<a&&(a=10);var d=b.x,e=b.y,f=this.ga.x,
g=this.ga.y;d+=a;e+=a;this.ya=new A(d+this.Ji*(f+a-d),e+this.Ji*(g+a-e));d=b.x-a;f=this.ga.x-a;e=b.y-a;g=this.ga.y-a;this.Fa=new A(d+this.Ki*(f-d),e+this.Ki*(g-e))};c.prototype.ut=function(a){var b=C(this.from.x,this.from.y,this.ga.x,this.ga.y),d=this.ga.clone();d.x-=b.x*a;d.y-=b.y*a;this.ff=d;this.ef-=a;a=this.ef/10*this.kl;10<a&&(a=10);b=this.from.x;var e=this.from.y,c=d.x,g=d.y;b+=a;e+=a;this.ya=new A(b+this.Ji*(c+a-b),e+this.Ji*(g+a-e));this.log("RECALC ctrl1=%s",this.ya);b=this.from.x-a;c=d.x-
a;e=this.from.y-a;g=d.y-a;this.Fa=new A(b+this.Ki*(c-b),e+this.Ki*(g-e))};c.prototype.Zg=function(a){this.na=a;this.format();this.na instanceof c&&(this.moveTo=this.na.ff)};c.prototype.ha=function(a){null!==this.ff&&(this.Kd&&(this.moveTo&&a.moveTo(this.moveTo.x,this.moveTo.y),a.quadraticCurveTo(this.na.ga.x,this.na.ga.y,this.from.x,this.from.y)),a.bezierCurveTo(this.ya.x,this.ya.y,this.Fa.x,this.Fa.y,this.ff.x,this.ff.y))};c.prototype.Ld=function(){return this.na?C(this.na.ga.x,this.na.ga.y,this.ya.x,
this.ya.y):this.pc()};c.prototype.pc=function(){return C(this.Fa.x,this.Fa.y,this.ga.x,this.ga.y)};return c}(),kc=function(){function c(a,b,d){this.ll=d;this.ga=b;this.na=a;this.ll=d;var e=B(a.ga.x,a.ga.y,b.x,b.y);e||(e=1);var c=(b.x-a.ga.x)/e,g=(b.y-a.ga.y)/e;this.Fa=new A(b.x-e*d*c,b.y-e*d*g);if((b=a.Fa)&&a.na){var h=C(a.na.ga.x,a.na.ga.y,a.ga.x,a.ga.y),l=B(a.na.ga.x,a.na.ga.y,a.ga.x,a.ga.y);c=.5*(c+h.x);g=.5*(g+h.y);b.x=a.ga.x-l*d*c;b.y=a.ga.y-l*d*g}this.ya=new A(a.ga.x+e*d*c,a.ga.y+e*d*g);this.length=
e}c.prototype.Zg=function(a){this.na=a;var b=a.Fa,d=(this.ga.x-a.ga.x)/this.length,e=(this.ga.y-a.ga.y)/this.length,c=this.ll;if(b&&a.na){var g=C(a.na.ga.x,a.na.ga.y,a.ga.x,a.ga.y),h=B(a.na.ga.x,a.na.ga.y,a.ga.x,a.ga.y);d=.5*(d+g.x);e=.5*(e+g.y);b.x=a.ga.x-h*c*d;b.y=a.ga.y-h*c*e}this.ya=new A(a.ga.x+this.length*c*d,a.ga.y+this.length*c*e)};c.prototype.ha=function(a){a.bezierCurveTo(this.ya.x,this.ya.y,this.Fa.x,this.Fa.y,this.ga.x,this.ga.y)};c.prototype.Ld=function(){return this.na?C(this.na.ga.x,
this.na.ga.y,this.ya.x,this.ya.y):{x:1,y:0}};c.prototype.pc=function(){return 0<this.ll?C(this.Fa.x,this.Fa.y,this.ga.x,this.ga.y):C(this.na.ga.x,this.na.ga.y,this.ga.x,this.ga.y)};return c}(),lc=function(){function c(a,b,d){this.na=a;this.control=b;this.ga=d}c.prototype.ha=function(a){a.quadraticCurveTo(this.control.x,this.control.y,this.ga.x,this.ga.y)};c.prototype.Ld=function(){return this.na?C(this.na.ga.x,this.na.ga.y,this.control.x,this.control.y):{x:1,y:0}};c.prototype.pc=function(){return C(this.control.x,
this.control.y,this.ga.x,this.ga.y)};return c}(),mc=function(){function c(a,b,d,e){this.na=a;this.control=b;this.ga=d;this.Id=e}c.prototype.ha=function(a){a.arcTo(this.control.x,this.control.y,this.ga.x,this.ga.y,this.Id)};c.prototype.Ld=function(){return{x:1,y:0}};c.prototype.pc=function(){return C(0,0,1,0)};return c}(),nc=function(){function c(a,b,d,e,c,g,h){this.na=a;this.Uc=b;this.ga=d;this.Id=e;this.ol=c;this.Cq=g;this.iq=h}c.prototype.ha=function(a){a.arc(this.Uc.x,this.Uc.y,this.Id,this.ol,
this.Cq,0!==this.iq)};c.prototype.Ld=function(){return{x:1,y:0}};c.prototype.pc=function(){return C(0,0,1,0)};return c}(),oc=function(){function c(a,b,d,e){this.ya=b;this.Fa=d;this.ya=b;this.Fa=d;this.ga=e;this.na=a}c.prototype.ha=function(a){a.bezierCurveTo(this.ya.x,this.ya.y,this.Fa.x,this.Fa.y,this.ga.x,this.ga.y)};c.prototype.Ld=function(){return this.na?C(this.na.ga.x,this.na.ga.y,this.ya.x,this.ya.y):{x:1,y:0}};c.prototype.pc=function(){return C(this.Fa.x,this.Fa.y,this.ga.x,this.ga.y)};return c}(),
pc=function(){function c(a,b,d,e){this.na=a;this.ya=b;this.Fa=d;this.ga=e}c.prototype.ha=function(a){if(this.na){var b=[];this.na.Fa&&b.push(this.na.Fa);this.ya&&b.push(this.ya);2===b.length?a.bezierCurveTo(b[0].x,b[0].y,b[1].x,b[1].y,this.ga.x,this.ga.y):1===b.length&&a.quadraticCurveTo(b[0].x,b[0].y,this.ga.x,this.ga.y)}};c.prototype.Zg=function(a){this.na=a};c.prototype.Ld=function(){return this.na&&this.na.Fa?C(this.na.ga.x,this.na.ga.y,this.ya.x,this.ya.y):{x:1,y:0}};c.prototype.pc=function(){return this.ya?
C(this.ya.x,this.ya.y,this.ga.x,this.ga.y):{x:1,y:0}};return c}(),qc=function(){function c(a,b,d,e,c){this.na=a;this.mg=b;this.ga=d;this.log=w.create("SEGMENT");this.na=a;this.mg=b;c*=2;var f=2*e.next()-1;e.next();e=this.na.pc();if(!this.na.zt&&e){var h=B(a.ga.x,a.ga.y,b.x,b.y);this.ya=new A(a.ga.x+.5522847498*e.x*h,a.ga.y+.5522847498*e.y*h)}else this.ya=new A(a.ga.x+.5522847498*(b.x-a.ga.x),a.ga.y+.5522847498*(b.y-a.ga.y));this.Fa=new A(d.x-.5522847498*(d.x-b.x)*(1-f*c),d.y-.5522847498*(d.y-b.y)*
(1-f*c));this.ga=d}c.prototype.Zg=function(a){this.na=a;var b=this.na.pc();if(b){var d=B(a.ga.x,a.ga.y,this.mg.x,this.mg.y);this.ya=new A(a.ga.x+.5522847498*b.x*d,a.ga.y+.5522847498*b.y*d)}else this.ya=new A(a.ga.x+.5522847498*(this.mg.x-this.na.ga.x),a.ga.y+.5522847498*(this.mg.y-this.na.ga.y))};c.prototype.ha=function(a){a.bezierCurveTo(this.ya.x,this.ya.y,this.Fa.x,this.Fa.y,this.ga.x,this.ga.y)};c.prototype.Ld=function(){return this.na?C(this.na.ga.x,this.na.ga.y,this.ya.x,this.ya.y):{x:1,y:0}};
c.prototype.pc=function(){return C(this.Fa.x,this.Fa.y,this.ga.x,this.ga.y)};return c}();var rc=function(){function c(a){this.Kg=this.Jg=0;if("string"===typeof a){for(;8>a.length;)a+=a;for(var b=16777619,d=0;d<a.length;d++)b=(16777619*b^a.charCodeAt(d))&4294967295;a=b}this.yo=a;this.reset()}c.prototype.reset=function(){this.Kg=this.Jg=this.yo};c.prototype.next=function(){this.Kg=36969*(this.Kg&65535)+(this.Kg>>16);this.Jg=18E3*(this.Jg&65535)+(this.Jg>>16);return((this.Kg<<16)+this.Jg)/4294967295/2+.5};return c}();var sc=function(){function c(a){this.tc=a;this.Gh=[];this.Xk=!0;this.log=w.create("cloudAddon");this.Id=a.ka("cloudRadius")}c.prototype.format=function(){var a=this.tc.Mc.ag();this.log("Format cloud; %s points",a.length);this.Gh=this.$p(a,this.Id)};c.prototype.$p=function(a,b){var d=[],e=5/6*b*2,c,g=a[a.length-1];for(c=0;c<a.length;c++){var h=a[c];var l=h.x-g.x,k=h.y-g.y,m=Math.sqrt(l*l+k*k);l/=m;k/=m;var q=m/e+.5|0;1>q&&(q=1);q=m/q;for(var p=0;p+.1*q<m;p+=q)d.push({x:g.x+p*l,y:g.y+p*k,Em:0,end:0});
g=h}h=d[d.length-1];for(c=0;c<d.length;c++)e=d[c],l=e.x-h.x,k=e.y-h.y,g=.5*Math.sqrt(l*l+k*k)/b,-1>g&&(g=-1),1<g&&(g=1),l=Math.atan2(k,l),g=Math.acos(g),g=[l-g,Math.PI+l+g],h.end=g[0],e.Em=g[1],h=e;return d};c.prototype.ha=function(a){this.log("Drawing cloud with %s circles",this.Gh.length);var b=15*Math.PI/180,d=this.Id;a.beginPath();for(var e=0;e<this.Gh.length;e++){var c=this.Gh[e];a.arc(c.x,c.y,d,c.Em,c.end+b)}a.stroke()};return c}();var tc=function(){function c(a){this.tc=a;this.Id=0;this.Xk=!0;this.ni=!1;this.path=new H;this.Ii=new H;this.log=w.create("DoubleLineAddon")}c.prototype.format=function(){this.log("Formatting doubleline; thickness=%s",this.tc.ka("doubleLine"));var a=this.tc.Gj(!1).xl(Q.lj),b=this.tc.Zq();if(0<b){var d=a.Rp();d>b&&(a=a.Tp(d-b))}a=a.ag();b=this.tc.ka("doubleLine");this.path=new H;this.Ii=new H;d=this.tc.ka("doubleLineDashSide");this.ni=!1;"outer"===d?(Wb(this.path,a,b,!0,!1),Wb(this.Ii,a,b,!1,!0),this.ni=
!0):"inner"===d?(Wb(this.path,a,b,!1,!0),Wb(this.Ii,a,b,!0,!1),this.ni=!0):Wb(this.path,a,b,!0,!0)};c.prototype.ha=function(a){a.beginPath();this.tc.cc.length&&this.ni?(this.Ii.Wh(a,this.tc.cc),this.path.ha(a)):this.tc.cc.length?this.path.Wh(a,this.tc.cc):this.path.ha(a)};return c}();var uc=function(){function c(a){this.la=a;this.n=0;this.mb=new A(0,0)}c.prototype.next=function(a){if(0===this.la.length)return null;if(0===this.n)return this.mb=this.la[0].clone(),this.n+=1,this.mb.clone();for(;this.n<this.la.length;){var b=this.mb.vb(this.la[this.n]);if(0===b)this.n+=1;else if(b<=a)a-=b,this.n+=1;else return this.mb.x+=(this.la[this.n].x-this.mb.x)*a/b,this.mb.y+=(this.la[this.n].y-this.mb.y)*a/b,this.mb.clone()}return null};return c}(),vc=function(){function c(a){this.tc=a;this.Xk=
!0;this.la=[];this.log=w.create("WaveAddon");this.Id=a.ka("waveRadius")}c.prototype.format=function(){var a=this.tc.Gj(!1).xl(Q.lj).ag();this.log("Format cloud; %s points",a.length);this.la=this.au(a,this.Id)};c.prototype.au=function(a,b){var d=new uc(a),e=1,c=[];if(2>a.length)return c;var g=0;for(var h=1;h<a.length;h++)g+=B(a[h-1].x,a[h-1].y,a[h].x,a[h].y);b=g/Math.round(g/(2*b)+.5)/2;for(g=[];;){h=d.next(2*b);if(!h)break;g.push(h)}g.push(a[a.length-1]);var l=g[0];c.push(l);for(d=1;d<g.length;d++){h=
g[d];var k=C(l.x,l.y,h.x,h.y);var m=b,q=new A(k.y*e,-1*k.x*e);l=new A(l.x+(k.x+q.x)*m,l.y+(k.y+q.y)*m);c.push(l);c.push(h);e*=-1;l=h}for(d=2;d<c.length-1;d+=2)e=c[d-1],g=c[d+1],c[d].x=e.x+(g.x-e.x)/2,c[d].y=e.y+(g.y-e.y)/2;return c};c.prototype.ha=function(a){a.beginPath();a.moveTo(this.la[0].x,this.la[0].y);for(var b=1;b<this.la.length-1;b+=2)a.quadraticCurveTo(this.la[b].x,this.la[b].y,this.la[b+1].x,this.la[b+1].y)};return c}();var Q=function(c){function a(b,d){var e=c.call(this,b,d)||this;e.qa=[];e.yf=0;e.Qc=[];e.ml=[];e.Oo=!1;e.inverse=new F;e.origin=new A(0,0);e.cc=[];e.Mc=new H;e.xn=!1;e.backgroundImage=null;e.log=w.create("PATHNODE");e.log("New PathNode Created");e.Eb=new hc(0,d);e.Eb.setProperty("text",e.aa.text);e.Ej(a.wa);e.aa.closed=!1;e.aa.commands=[];e.aa.seed=0;return e}n(a,c);a.prototype.moveTo=function(b,d){var e=this.aa.commands;e.push(a.rf);e.push(b);e.push(d)};a.prototype.Op=function(b,d,e,c,g,h){var f=
this.aa.commands;f.push(a.dg);f.push(g);f.push(h);f.push(b);f.push(d);f.push(e);f.push(c)};a.prototype.type=function(){return"PathNode"};a.prototype.oi=function(){return!0};a.prototype.setProperty=function(a,d){c.prototype.setProperty.call(this,a,d);switch(a){case "bold":case "fontName":case "fontSize":case "italic":case "text":case "textAlign":case "textDecoration":case "wrap":this.aa[a]=d;this.Eb.setProperty(a,d);break;case "textFillStyle":this.Eb.setProperty("fillStyle",d);this.aa[a]=d;break;case "textBackground":this.Eb.setProperty("background",
d);this.aa[a]=d;break;case "cloudRadius":case "waveRadius":case "doubleLine":case "doubleLineDashSide":case "spotHighlight":case "verticalAlign":this.aa[a]=d;break;case "backgroundImage":this.aa[a]=d,this.backgroundImage=null}};a.prototype.ei=function(b){for(var d=0,e=this.aa.commands,c=b/3|0,g=0;g<c;g++)d+=a.Xa[e[d]]+1;g=b%3*2+1;c=e[d+g];d=e[d+g+1];this.log("getEditHandle(%s) = (%s, %s)",b,c,d);return this.Ea().apply(c,d)};a.prototype.Oe=function(b,d,e){for(var c=0,g=this.aa.commands,h=b/3|0,l=0;l<
h;l++)c+=a.Xa[g[c]]+1;h=this.inverse.apply(d,e);l=b%3*2+1;g[c+l]=h.x;g[c+l+1]=h.y;if(0===b&&this.aa.closed){for(b=null;c<g.length;)h=a.Xa[g[c]],2<=h&&(b=c),c+=h+1;b&&(c=b,h=this.inverse.apply(d,e),g[c+1]=h.x,g[c+2]=h.y)}};a.prototype.xd=function(){return"commands"};a.prototype.Us=function(b){for(var d=this.aa.commands,e=0,c=0;c<b/3;c++)e+=a.Xa[d[e]]+1;d.splice(e,a.Xa[d[e]]+1)};a.prototype.Zq=function(){return this.ka("arrowXOffset")||this.ka("arrowSize")};a.prototype.format=function(b,d){var e=this,
c=null;this.qa.length=0;this.inverse=this.aa.matrix.inverse();var g=new A(0,0),h=this.aa.commands,l=null,k=this.aa.matrix,m=new rc(this.aa.seed);this.ml.length=0;for(var q=null,p=null,t=0;t<h.length;){switch(h[t++]){case a.rf:g=k.apply(h[t++],h[t++]);p=new ic(l,g);this.qa.push(p);null===c&&(c=g);this.ml.push(g);q=null;break;case a.Qd:l&&(g=k.apply(h[t++],h[t++]),this.qa.push(new jc(l,g,m,this.aa.sloppiness,this.aa.roundRadius)),this.ml.push(g));break;case a.sf:if(l){g=k.apply(h[t++],h[t++]);var r=
k.apply(h[t++],h[t++]);this.qa.push(new lc(l,r,g))}break;case a.kj:if(l){g=k.apply(h[t++],h[t++]);r=k.apply(h[t++],h[t++]);var v=h[t++];this.qa.push(new mc(l,r,g,v))}break;case a.jj:if(l){g=k.apply(h[t++],h[t++]);r=k.apply(h[t++],h[t++]);v=h[t++];var x=h[t++],I=h[t++],y=h[t++];this.qa.push(new nc(l,r,g,v,x,I,y))}break;case a.dg:l&&(g=k.apply(h[t++],h[t++]),v=k.apply(h[t++],h[t++]),r=k.apply(h[t++],h[t++]),this.qa.push(new oc(l,v,r,g)));break;case a.cm:l&&(g=k.apply(h[t++],h[t++]),v=k.apply(h[t++],
h[t++]),r=k.apply(h[t++],h[t++]),this.qa.push(new pc(l,v,r,g)));break;case a.ph:l&&(g=k.apply(h[t++],h[t++]),this.qa.push(new kc(l,g,this.aa.smoothness)));break;case a.mj:l&&(g=k.apply(h[t++],h[t++]),v=k.apply(h[t++],h[t++]),this.qa.push(new qc(l,v,g,m,this.aa.sloppiness)));break;case a.hc:this.aa.closed=!0;q&&l&&q!==l&&q.Zg&&p&&(q.Zg(l),l.ga=p.ga);break;default:t++}l=this.qa[this.qa.length-1];null!==q||l instanceof ic||(q=l)}this.origin=c||new A(0,0);this.yf=this.qa.length;this.Sq(m);this.rect.x=
this.origin.x;this.rect.y=this.origin.y;this.rect.width=0;this.rect.height=0;c=this.aa.dashes.split(",");this.cc=[];for(t=0;t<c.length;t++)g=parseFloat(c[t]),isNaN(g)||this.cc.push(g);c=this.cc.length?a.lj:a.Xo;this.Mc=this.Gj(!0).xl(c);t=0+this.ka("shapeWidth");0<t&&(this.Mc=this.gq(this.Mc,t));this.rect=this.Mc.Gm(c);t=this.rect.width-2*(this.aa.lineWidth/2+1);g=this.aa.lineWidth;h=this.Mc.clone();h.transform(this.yd());this.Pa=h.Gm(c);c=this.Ea().Ad();this.Pa.ed(Math.ceil(g/c.x),Math.ceil(g/c.y));
this.rect.ed(g+1,g+1);8>this.rect.width&&(this.rect.x+=this.rect.width/2-4,this.rect.width=8);8>this.rect.height&&(this.rect.y+=this.rect.height/2-4,this.rect.height=8);if(""!==this.aa.text){c=this.rect.Uc();this.Eb.setProperty("textAlign",this.aa.textAlign||"center");this.Eb.setProperty("baseWidth",t);this.Eb.format(b,d);t=c.x-this.Eb.rect.x-this.Eb.rect.width/2;g=0;switch(this.aa.verticalAlign){default:case "middle":g=c.y-this.Eb.rect.y-this.Eb.uk/2;break;case "top":g=this.rect.y-this.Eb.rect.y;
break;case "bottom":g=this.rect.bottom()-this.Eb.uk-this.Eb.rect.y}this.Eb.transform(new E(t,g));this.Eb.format(b,d)}this.Oo=0===u.vd(this.aa.fillStyle).values[3]&&!this.backgroundImage;this.Qc.length=0;0<this.aa.cloudRadius?this.Qc.push(new sc(this)):0<this.aa.waveRadius?this.Qc.push(new vc(this)):this.aa.doubleLine&&this.Qc.push(new tc(this));for(t=0;t<this.Qc.length;t++)this.Qc[t].format(b);(t=this.ka("backgroundImage"))&&null===this.backgroundImage&&d.add(this.id,"image",t,null,function(a){e.backgroundImage=
a;d.Qf(e.id)})};a.prototype.ii=function(){return this.Mc};a.prototype.Sq=function(a){function b(b,d){b=b.clone();l&&(b.x+=d.x*g*.5,b.y+=d.y*g*.5);var f=b.x-d.x*g;var k=b.y-d.y*g;var m=f+d.y*c/2;var q=k-d.x*c/2;f+=-d.y*c/2;k+=d.x*c/2;e.qa.push(new ic(e.qa[e.qa.length-1],new A(f,k)));e.qa.push(new kc(e.qa[e.qa.length-1],b,h));e.qa.push(new kc(e.qa[e.qa.length-1],new A(m,q),h));"solid"===e.aa.arrowStyle&&e.qa.push(new jc(e.qa[e.qa.length-1],new A(f,k),a,e.aa.smoothness,0))}if(this.xn=0<this.aa.arrowSize&&
!this.aa.closed&&0<this.qa.length){var e=this,c=this.aa.arrowSize,g=this.aa.arrowXOffset,h=this.aa.smoothness,l=this.aa.doubleLine;null===g&&(g=c);var k=this.qa[this.qa.length-1];b(k.ga,k.pc());this.aa.doubleArrow&&b(this.qa[0].ga,Jb(this.qa[1].Ld()))}};a.prototype.close=function(){this.aa.commands.push(a.hc)};a.prototype.Kp=function(){var a=this.qa[this.qa.length-1];8>=B(a.ga.x,a.ga.y,this.origin.x,this.origin.y)&&this.close()};a.prototype.gq=function(a,d){this.log("ConvertToRects: width=%s",d);
for(var b=0,c=a.ba,g=0,h=0,l,k,m=new H;b<c.length;){this.log("cmd %s %s %s",c[b],c[b+1],c[b+2]);switch(c[b]){case H.jc:g=c[b+1];h=c[b+2];break;case H.ic:l=c[b+1];k=c[b+2];this.log("(%s,%s-%s,%s)",g,h,l,k);if(0<B(g,h,l,k)){var q=C(g,h,l,k),p=q.y*d/2;q=-q.x*d/2;m.moveTo(g+p,h+q);m.lineTo(l+p,k+q);m.lineTo(l-p,k-q);m.lineTo(g-p,h-q);m.closePath()}g=l;h=k}b+=H.kc[c[b]]}return m};a.prototype.clip=function(a){if(this.aa.closed){var b=new H;this.log("Clipping to a path");for(var e=0;e<this.qa.length;e++)this.qa[e].ha(b);
b.closePath();0>b.Gp()&&(b=b.Ws());b.ha(a)}};a.prototype.ha=function(a){this.aa.spotHighlight?this.log("Not drawing node %s due to spothighlight",this.id):c.prototype.ha.call(this,a)};a.prototype.re=function(a){var b=this.inverse;a.save();a.lineJoin="round";a.transform(b.m11,b.m21,b.m12,b.m22,b.Ca,b.Da);a.beginPath();a.lineCap="round";b=!0;var e;for(e=0;e<this.Qc.length;e++)this.Qc[e].Xk&&(b=!1);if(b)for(e=0;e<this.qa.length;e++)this.qa[e].ha(a);for(e=0;e<this.Qc.length;e++)this.Qc[e].ha(a);if(!b&&
0<this.aa.arrowSize)for(e=this.yf;e<this.qa.length;e++)this.qa[e].ha(a);if(this.aa.closed){a.closePath();if(this.backgroundImage){a.fillStyle=a.createPattern(this.backgroundImage,"no-repeat")||"magenta";e=Math.max(this.rect.width/this.backgroundImage.naturalWidth,this.rect.height/this.backgroundImage.naturalHeight);var c=this.rect.width-this.backgroundImage.naturalWidth*e,g=this.rect.height-this.backgroundImage.naturalHeight*e;a.translate(this.rect.x+c/2,this.rect.y+g/2);a.scale(e,e);a.fill();a.scale(1/
e,1/e);a.translate(-this.rect.x-c/2,-this.rect.y-g/2)}else a.fill();a.shadowColor="rgba(0,0,0,0.0)"}b&&(this.cc.length&&0<this.aa.lineWidth?(a.beginPath(),this.Mc.Wh(a,this.cc),a.lineCap="butt"):0<0+this.ka("shapeWidth")&&(a.beginPath(),this.Mc.ha(a)));0<this.aa.lineWidth&&a.stroke();if(this.aa.arrowSize&&"solid"===this.aa.arrowStyle){a.beginPath();for(e=this.yf;e<this.qa.length;e++)this.qa[e].ha(a);a.fillStyle=this.aa.strokeStyle;a.fill()}""!==this.aa.text&&this.Eb.ha(a);a.restore()};a.prototype.xb=
function(a,d){if(this.hidden()||this.ka("locked"))return null;var b=12+this.aa.shapeWidth/2+this.aa.lineWidth/2;if(a>=this.rect.x-b&&a<this.rect.x+b+this.rect.width&&d>=this.rect.y-b&&d<this.rect.y+b+this.rect.height)if(this.aa.closed&&!this.Oo){if(this.Mc.Fs(a,d))return this}else if(this.Mc.lo(a,d,b)||""!==this.aa.text&&this.Eb.xb(a,d))return this;return null};a.prototype.Gj=function(a){var b=new H;if(0<this.aa.arrowSize&&!a)for(a=0;a<this.yf;a++)this.qa[a].ha(b);else for(a=0;a<this.qa.length;a++)this.qa[a].ha(b);
this.aa.closed&&b.closePath();return b};a.prototype.lineTo=function(b,d){var e=this.aa.commands;e.push(a.Qd);e.push(b);e.push(d)};a.prototype.og=function(b,d){var e=this.aa.commands;e.push(a.ph);e.push(b);e.push(d)};a.prototype.Fg=function(){return!1!==this.aa.editable&&!0!==this.aa.lockEditMode};a.prototype.ri=function(a,d,e){e*=8;if(a>=this.origin.x-e&&a<this.origin.x+e&&d>=this.origin.y-e&&d<this.origin.y+e)return 0;for(var b=0;b<this.yf;b++){var c=this.qa[b];if(a>=this.qa[b].ga.x-e&&a<this.qa[b].ga.x+
e&&d>=this.qa[b].ga.y-e&&d<this.qa[b].ga.y+e)return 3*b;if(c.control){if(a>=c.control.x-e&&a<c.control.x+e&&d>=c.control.y-e&&d<c.control.y+e)return 3*b+1}else if(c.ya){if(a>=c.ya.x-e&&a<c.ya.x+e&&d>=c.ya.y-e&&d<c.ya.y+e)return 3*b+1;if(c.Fa&&a>=c.Fa.x-e&&a<c.Fa.x+e&&d>=c.Fa.y-e&&d<c.Fa.y+e)return 3*b+2}}return null};a.prototype.fi=function(b){var d=this.aa.commands;b/=3;var e=0,c=!1,g=0,h;for(h=0;h<d.length;){var l=d[h];if(l===a.hc){c=!0;break}g+=1;h+=a.Xa[d[h]]+1}0===b&&c&&(b=g-1);for(h=0;h<d.length;e++){c=
null;switch(d[h]){case a.rf:c="move_to";break;case a.Qd:c="line_to";break;case a.sf:c="quadratic_to"}if(b===e)return c;h+=a.Xa[d[h]]+1}return null};a.kp=function(b,d,e){d/=3;var c=0,g=[],h=new A(0,0),l=!1,k=0,m;for(m=0;m<b.length;){var q=b[m];if(q===a.hc){l=!0;break}k+=1;m+=a.Xa[b[m]]+1}0===d&&l&&(d=k-1);for(m=0;m<b.length;c++){q=b[m];l=!1;d===c&&(q===a.sf&&"line_to"===e?(g.push(a.Qd,b[m+1],b[m+2]),l=!0):q===a.Qd&&"quadratic_to"===e&&(g.push(a.sf,b[m+1],b[m+2],(h.x+b[m+1])/2,(h.y+b[m+2])/2),l=!0));
h=new A(b[m+1],b[m+2]);if(!l)for(q=0;q<1+a.Xa[b[m]];q++)g.push(b[m+q]);m+=a.Xa[b[m]]+1}return g};a.prototype.Gn=function(){return!0};a.prototype.Xh=function(a,d,e){a.save();a.lineWidth=1*d;a.strokeStyle="#0050B7";a.fillStyle="#0050B7";d*=8;0===e?a.fillRect(this.origin.x-d,this.origin.y-d,2*d,2*d):a.strokeRect(this.origin.x-d,this.origin.y-d,2*d,2*d);for(var b=1;b<this.yf;b++){var c=this.qa[b];a.beginPath();if(c.control)a.arc(c.control.x,c.control.y,d,0,2*Math.PI),a.arc(c.control.x,c.control.y,2*d,
0,2*Math.PI),e===3*b+1?a.fill():a.stroke();else if(c instanceof oc||c instanceof pc){var h=c.ya;var l=c.Fa;var k=c.na.ga;h&&(a.moveTo(k.x,k.y),a.lineTo(h.x,h.y),a.moveTo(h.x+d,h.y),a.arc(h.x,h.y,d,0,2*Math.PI),e===3*b+1?a.fill():a.stroke());a.beginPath();a.moveTo(c.ga.x,c.ga.y);a.lineTo(l.x,l.y);a.moveTo(l.x+d,l.y);a.arc(l.x,l.y,d,0,2*Math.PI);e===3*b+2?a.fill():a.stroke()}e===3*b?a.fillRect(this.qa[b].ga.x-d,this.qa[b].ga.y-d,2*d,2*d):a.strokeRect(this.qa[b].ga.x-d,this.qa[b].ga.y-d,2*d,2*d)}a.restore()};
a.Zo=function(a){var b=new R,e=0;for(a=a.ba;e<a.length;){switch(a[e]){case H.jc:b.moveTo(a[e+1],a[e+2]);break;case H.ic:b.lineTo(a[e+1],a[e+2]);break;case H.Pd:b.bezierCurveTo(a[e+1],a[e+2],a[e+3],a[e+4],a[e+5],a[e+6]);break;case H.Rd:b.quadraticCurveTo(a[e+1],a[e+2],a[e+3],a[e+4]);break;case H.hc:b.close()}e+=H.kc[a[e]]}return b.Sb()};a.wa={strokeStyle:"#000000",fillStyle:"#ffffff",fontName:"Arial",fontSize:20,lineWidth:2,dashes:"",shapeWidth:0,smoothness:.3,sloppiness:0,shadow:!1,closed:!1,arrowSize:0,
arrowXOffset:null,arrowStyle:"simple",doubleArrow:!1,text:"",roundRadius:0,wrap:!1};a.Xo=8;a.lj=2;a.rf=0;a.Qd=1;a.sf=2;a.kj=3;a.dg=4;a.ph=5;a.mj=6;a.hc=7;a.cm=8;a.jj=9;a.mu=.5522847498;a.Xa=[];return a}(L);Q.Xa[Q.rf]=2;Q.Xa[Q.Qd]=2;Q.Xa[Q.sf]=4;Q.Xa[Q.kj]=5;Q.Xa[Q.dg]=6;Q.Xa[Q.ph]=2;Q.Xa[Q.mj]=4;Q.Xa[Q.hc]=0;Q.Xa[Q.cm]=6;Q.Xa[Q.jj]=8;
var R=function(){function c(a){void 0===a&&(a=[]);this.ba=a}c.prototype.beginPath=function(){};c.prototype.ye=function(a,b,d){for(var e=0,c=0;c<a;c++)e+=Q.Xa[this.ba[e]]+1;this.ba[e+1]=b;this.ba[e+2]=d};c.prototype.moveTo=function(a,b){this.ba.push(Q.rf);this.ba.push(a);this.ba.push(b)};c.prototype.lineTo=function(a,b){this.ba.push(Q.Qd);this.ba.push(a);this.ba.push(b)};c.prototype.og=function(a,b){this.ba.push(Q.ph);this.ba.push(a);this.ba.push(b)};c.prototype.quadraticCurveTo=function(a,b,d,e){this.ba.push(Q.sf);
this.ba.push(d);this.ba.push(e);this.ba.push(a);this.ba.push(b)};c.prototype.De=function(a,b,d,e){this.ba.push(Q.mj);this.ba.push(d);this.ba.push(e);this.ba.push(a);this.ba.push(b)};c.prototype.bezierCurveTo=function(a,b,d,e,c,g){this.ba.push(Q.dg);this.ba.push(c);this.ba.push(g);this.ba.push(a);this.ba.push(b);this.ba.push(d);this.ba.push(e)};c.prototype.arc=function(a,b,d,e,c,g){void 0===g&&(g=!0);var f=(new Kb(-c,a,b)).apply(a+d,b);this.ba.push(Q.jj);this.ba.push(f.x);this.ba.push(f.y);this.ba.push(a);
this.ba.push(b);this.ba.push(d);this.ba.push(e);this.ba.push(c);this.ba.push(g?1:0)};c.prototype.arcTo=function(a,b,d,e,c){this.ba.push(Q.kj);this.ba.push(d);this.ba.push(e);this.ba.push(a);this.ba.push(b);this.ba.push(c)};c.prototype.en=function(){for(var a=[],b=0;b<this.ba.length;){for(var d=this.ba[b],e=0;e<Q.Xa[d];e+=2)a.push(new A(this.ba[b+1+e],this.ba[b+1+e+1]));b+=Q.Xa[d]+1}a=D.fg(a);return{x:a.x,y:a.y,width:a.width,height:a.height}};c.prototype.translate=function(a,b){for(var d=0;d<this.ba.length;){for(var e=
this.ba[d],c=0;c<Q.Xa[e];c+=2)this.ba[d+1+c]+=a,this.ba[d+2+c]+=b;d+=Q.Xa[e]+1}};c.prototype.closePath=function(){this.ba.push(Q.hc)};c.prototype.close=function(){this.closePath()};c.prototype.Sb=function(){return this.ba};return c}();R.prototype.change=R.prototype.ye;R.prototype.moveTo=R.prototype.moveTo;R.prototype.lineTo=R.prototype.lineTo;R.prototype.curveTo=R.prototype.og;R.prototype.quadraticCurveTo=R.prototype.quadraticCurveTo;R.prototype.cornerTo=R.prototype.De;R.prototype.bezierCurveTo=R.prototype.bezierCurveTo;
R.prototype.arc=R.prototype.arc;R.prototype.arcTo=R.prototype.arcTo;R.prototype.getBoundingBox=R.prototype.en;R.prototype.translate=R.prototype.translate;R.prototype.closePath=R.prototype.closePath;R.prototype.close=R.prototype.close;R.prototype.toArray=R.prototype.Sb;L.od("PathNode",Q);R.prototype.beginPath=R.prototype.beginPath;R.prototype.change=R.prototype.ye;R.prototype.moveTo=R.prototype.moveTo;R.prototype.lineTo=R.prototype.lineTo;R.prototype.curveTo=R.prototype.og;
R.prototype.quadraticTo=R.prototype.Bu;R.prototype.cornerTo=R.prototype.De;R.prototype.bezierTo=R.prototype.Op;R.prototype.arc=R.prototype.arc;R.prototype.arcTo=R.prototype.arcTo;R.prototype.getBoundingBox=R.prototype.en;R.prototype.translate=R.prototype.translate;R.prototype.closePath=R.prototype.closePath;R.prototype.close=R.prototype.close;R.prototype.toArray=R.prototype.Sb;var xc=function(){function c(){this.items=[];this.next=0;this.Vd=!1;this.log=w.create("UNDOSTACK")}c.prototype.pa=function(a,b,d){void 0===b&&(b=!1);a=a instanceof wc?[a]:a;if(0!==a.length){this.next<this.items.length&&(this.items.length=this.next);if(!b)for(b=0;b<a.length;b++)a[b].wb(d);for(d=this.top();d;)if(d[d.length-1].Un(a[0])){if(a.shift(),0===a.length)break}else break;a.length&&this.items.push(a);this.Vd=!0;this.next=this.items.length}};c.prototype.jb=function(a){this.log("Undo index %s of %s",
this.next,this.items.length);if(this.qd()){for(var b=this.items[--this.next],d=b.length-1;0<=d;d--)b[d].jb(a);return this.Vd=!0}return!1};c.prototype.Jd=function(a){this.log("Redo index %s of %s",this.next,this.items.length);if(this.pd()){for(var b=this.items[this.next++],d=0;d<b.length;d++)b[d].wb(a);return this.Vd=!0}return!1};c.prototype.qd=function(){return 0<this.next};c.prototype.pd=function(){return this.next<this.items.length};c.prototype.clear=function(){this.next=this.items.length=0;this.Vd=
!1};c.prototype.top=function(){return this.items.length?this.items[this.items.length-1]:null};return c}(),wc=function(){function c(){}c.prototype.wb=function(){};c.prototype.jb=function(){};c.prototype.Un=function(){return!1};return c}();var yc=function(c){function a(a,d){var b=c.call(this,a,d)||this;b.Bh="UnknownNode";b.width=100;b.height=20;b.gb=new gc;b.log=w.create("UNKNOWN",!0);b.gb.Ao("center","middle");return b}n(a,c);a.prototype.rt=function(a){this.Bh=a;this.gb.Io(a);this.log("Creating placeholder for node type %s",a)};a.prototype.type=function(){return this.Bh};a.prototype.setProperty=function(a,d){this.aa[a]=d};a.prototype.format=function(a){this.log("Formatting placeholder for %s",this.Bh);this.rect=new D(0,0,this.width,
this.height);this.rect.transform(this.aa.matrix);this.gb.format(a,this.width,this.height)};a.prototype.re=function(a){this.log("Drawing placeholder for for %s",this.Bh);a.save();a.lineWidth=1;a.fillStyle="#888888";a.fillRect(0,0,this.width,this.height);a.fillStyle="#000000";this.gb.ha(a,0,0);a.restore()};a.Ul=!1;return a}(L);L.od("UnknownNode",yc);var zc=function(c){function a(){var a=null!==c&&c.apply(this,arguments)||this;a.Tb="Action";a.log=w.create("ACTION");return a}n(a,c);a.prototype.wb=function(){};a.prototype.toString=function(){return""+this.Tb+"()"};return a}(wc),Ac=w.create("ACTION");function Bc(c,a,b){var d=L.create(c,a,b);d||(c in O.Pj?(d=new cc(a,b),d.setProperty("nodeType",c)):(Ac("Bad node type: %s",c),a=L.create("UnknownNode",a,b),a.rt(c),d=a));return d}
var S=function(c){function a(a,d,e,f,g){void 0===f&&(f=null);void 0===g&&(g=-1);var b=c.call(this)||this;b.id=a;b.type=d;b.aa=e;b.Hi=f;b.index=g;b.node=null;b.Tb="CreateAction";return b}n(a,c);a.prototype.wb=function(a){var b=Bc(this.type,this.id,a);b.Jb(this.aa);null===this.Hi&&(this.Hi=a.pk().id,this.index=-1);var e=a.va(this.Hi,!1);e instanceof ec&&(a.ob(e,b,this.index),this.log("Add %s id %s to parent %s index %s",b.type(),this.id,e.type(),this.index),this.node=b)};a.prototype.toString=function(){return""+
this.Tb+"("+this.type+NaN+this.id+", "+JSON.stringify(this.aa)+", parent="+this.Hi+", index="+this.index+")"};a.prototype.jb=function(a){this.node&&a.removeNode(this.node)};return a}(zc),Cc=function(c){function a(a){var b=c.call(this)||this;b.Oa=a;b.de=[];b.Tb="DeleteAction";return b}n(a,c);a.prototype.wb=function(a){var b;this.de.length=0;var e=this.Oa;var c=0;for(b=e.length;c<b;c++){var g=e[c];(g=a.va(g,!1))&&this.de.push({node:g,parent:g.parent,index:a.removeNode(g)})}};a.prototype.jb=function(a){for(var b,
e=this.de.length-1;0<=e;--e)b=this.de[e],b.node&&b.parent&&a.ob(b.parent,b.node,b.index)};return a}(zc),Dc=function(c){function a(a,d,e){var b=c.call(this)||this;b.Oa=a;b.name=d;b.value=e;b.Ed=[];b.Tb="SetAction";return b}n(a,c);a.prototype.wb=function(a){var b;this.Ed.length=0;var e=this.Oa;var c=0;for(b=e.length;c<b;c++){var g=e[c];if(g=a.va(g,!0))this.Ed.push(g.ka(this.name)),a.Pc(g,this.name,this.value)}};a.prototype.jb=function(a){var b,e,c;if(0!==this.Oa.length){var g=e=0;for(c=this.Oa.length-
1;0<=c?e<=c:e>=c;g=0<=c?++e:--e)(b=a.va(this.Oa[g],!0))&&a.Pc(b,this.name,this.Ed[g])}};a.prototype.Un=function(b){if(!(b instanceof a)||this.name!==b.name)return!1;switch(this.name){case "arrowSize":case "arrowStyle":case "arrowXOffset":case "background":case "bold":case "border":case "cloudRadius":case "dashes":case "doubleArrow":case "fillStyle":case "fontName":case "fontSize":case "italic":case "lineWidth":case "opacity":case "roudRadius":case "strokeStyle":case "textDecoration":break;default:return!1}this.Oa.sort();
b.Oa.sort();if(this.Oa.length!==b.Oa.length)return!1;for(var d=0;d<this.Oa.length;d++)if(this.Oa[d]!==b.Oa[d])return!1;this.log("Merging property change %s",this.name);this.value=b.value;return!0};return a}(zc),Ec=function(c){function a(a,d){var b=c.call(this)||this;b.Oa=a;b.oa=d;b.Tb="TransformAction";b.inverse=d.inverse();return b}n(a,c);a.prototype.wb=function(a){for(var b=a.mk(this.Oa,!0,!0),c=0;c<b.length;c++){var f=b[c],g=f.Ea();f.transform(this.oa);a.Wb.Jb(f.id,{matrix:f.Ea()},{matrix:g})}};
a.prototype.jb=function(a){for(var b=a.mk(this.Oa,!0,!0),c=0;c<b.length;c++){var f=b[c],g=f.Ea();f.transform(this.inverse);a.Wb.Jb(f.id,{matrix:f.Ea()},{matrix:g})}};return a}(zc),Fc=function(c){function a(a,d,e,f,g,h){var b=c.call(this)||this;b.id=a;b.handle=d;b.os=e;b.ps=f;b.x=g;b.y=h;b.Tb="MoveEditHandleAction";return b}n(a,c);a.prototype.wb=function(a){var b;if(b=a.va(this.id,!0)){var c={};c[b.xd()]=b.ka(b.xd());b.Oe(this.handle,this.x,this.y);var f={};f[b.xd()]=b.ka(b.xd());a.Wb.Jb(b.id,f,c)}};
a.prototype.jb=function(a){var b;if(b=a.va(this.id,!0)){var c={};c[b.xd()]=b.ka(b.xd());b.Oe(this.handle,this.os,this.ps);var f={};f[b.xd()]=b.ka(b.xd());a.Wb.Jb(b.id,f,c)}};return a}(zc),Gc=function(c){function a(a,d){var b=c.call(this)||this;b.id=a;b.Oa=d;b.de=[];b.node=null;b.Tb="GroupAction";return b}n(a,c);a.prototype.wb=function(a){var b;this.de.length=0;var c=this.Oa;var f=0;for(b=c.length;f<b;f++){var g=c[f];(g=a.va(g))&&this.de.push({node:g,parent:g.parent,index:g.parent.ck(g)})}this.node=
a.ng(this.id,this.Oa)};a.prototype.jb=function(a){var b,c;if(0!==this.Oa.length&&this.node){for(b=c=this.Oa.length-1;0<=c&&!(0>b);b=c+=-1)b=this.de[b],b.parent&&b.node&&a.ob(b.parent,b.node,b.index);a.removeNode(this.node)}};a.prototype.toString=function(){return"GroupAction("+JSON.stringify(this.Oa)+")"};return a}(zc),Hc=function(c){function a(a){var b=c.call(this)||this;b.Oa=a;b.Bd=[];b.Tb="UngroupAction";return b}n(a,c);a.prototype.wb=function(a){var b,c,f={};var g=this.Oa;var h=0;for(b=g.length;h<
b;h++){var l=g[h];l=a.va(l);if(l instanceof ec){var k=l;if(!(k.id in f)){f[k.id]=!0;var m={node:k,parent:k.parent,children:k.children.concat(),index:0};var q=m.children;var p=0;for(c=q.length;p<c;p++)l=q[p],a.ob(k.parent,l,-1);m.index=a.removeNode(k);this.Bd.push(m)}}}};a.prototype.jb=function(a){var b,c,f,g;if(0!==this.Bd.length){for(b=f=this.Bd.length-1;0<=f&&!(0>b);b=f+=-1)if(b=this.Bd[b],0!==b.children.length)for(a.ob(b.parent,b.node,b.index),c=g=b.children.length-1;0<=g&&!(0>c);c=g+=-1)a.ob(b.node,
b.children[c],-1);a.bi=!0}};return a}(zc);function Ic(c,a){var b;if(c.In()){var d=c.children;var e=0;for(b=d.length;e<b;e++){var f=d[e];Ic(f,a)}}else c.transform(a)}
var Jc=function(c){function a(a,d,e){var b=c.call(this)||this;b.Oa=a;b.offsetX=d;b.offsetY=e;b.ra=[];b.Tb="DuplicateAction";return b}n(a,c);a.prototype.wb=function(a){var b;var c=new E(this.offsetX,this.offsetY);this.ra.length=0;var f=function(){return a.$a()};var g=this.Oa;var h=0;for(b=g.length;h<b;h++){var l=g[h];if(l=a.va(l))l=l.clone(f),c.zk()||Ic(l,c),a.Ch(l),this.ra.push(l)}};a.prototype.jb=function(a){var b,c;if(0!==this.ra.length)for(b=c=this.ra.length-1;0<=c&&!(0>b);b=c+=-1)a.removeNode(this.ra[b])};
return a}(zc),Kc=function(c){function a(a,d,e){var b=c.call(this)||this;b.Oa=a;b.type=d;b.Vn=e;b.ra=[];b.Mk=[];b.Tb="ChangeOrderAction";return b}n(a,c);a.prototype.wb=function(b){var d,c;this.Mk.length=0;this.ra.length=0;var f=this.Oa;var g=0;for(c=f.length;g<c;g++){var h=f[g];if(h=b.va(h))if(d=h.parent){var l=h.Le();this.Mk.push(l);this.ra.push(h);switch(this.type){case a.Rl:b.ob(d,h,-1);break;case a.oj:b.ob(d,h,0);break;case a.Zl:0<l?b.ob(d,h,l-1):b.ob(d,h,l);break;case a.$l:l<d.children.length?
b.ob(d,h,l+1):b.ob(d,h,l);break;case a.bm:void 0===this.Vn?b.ob(d,h,-1):b.ob(d,h,this.Vn)}}}};a.prototype.jb=function(a){var b,c,f;if(0!==this.Oa.length)for(b=f=this.Oa.length-1;0<=f&&!(0>b);b=f+=-1){var g=this.ra[b];(c=g.parent)&&g&&a.ob(c,g,this.Mk[b])}};a.Rl=0;a.oj=1;a.$l=2;a.Zl=3;a.bm=4;return a}(zc),Lc=function(c){function a(a,d,e){var b=c.call(this)||this;b.id=a;b.Gt=d;b.Ft=e;b.Tb="MoveNodeAction";b.Zn=0;b.Qe=0;return b}n(a,c);a.prototype.wb=function(a){var b=a.va(this.id),c=a.va(this.Gt);if(c&&
!(c instanceof ec)&&b)throw console.log("FATAL: Parent node: "+c.id+":"+c.type()+" child "+b.id+":"+b.type()),Error("Tried to move to a non-group node!");b&&b.parent&&c&&(this.Zn=b.parent.id,this.Qe=b.Le(),a.ob(c,b,this.Ft))};a.prototype.jb=function(a){var b=a.va(this.id),c=a.va(this.Zn);b&&b.parent&&c&&a.ob(c,b,this.Qe)};return a}(zc),Mc=function(c){function a(a){var b=c.call(this)||this;b.aa=a;b.Ed={};b.Tb="SetDocumentPropertiesAction";return b}n(a,c);a.prototype.wb=function(a){var b;this.Ed={};
for(b in this.aa)this.aa.hasOwnProperty(b)&&(this.Ed[b]=a.ka(b),a.setProperty(b,this.aa[b]))};a.prototype.jb=function(a){for(var b in this.Ed)this.Ed.hasOwnProperty(b)&&a.setProperty(b,this.Ed[b])};return a}(zc),Nc=function(c){function a(a){var b=c.call(this)||this;b.zs=a;b.Yn=0;b.Tb="SetPageAction";return b}n(a,c);a.prototype.wb=function(a){this.Yn=a.Sa;a.Rb(this.zs)};a.prototype.jb=function(a){a.Rb(this.Yn)};return a}(zc);function Oc(c){c=c.replace(/\+/g," ");return decodeURIComponent(c)};var Pc=function(){function c(){this.Ci=!1;this.kb={};this.log=w.create("EventEmitter");this.Zj={}}c.prototype.ua=function(a){for(var b=this,d=1;d<arguments.length;d++);var c=Array.prototype.slice.apply(arguments);setTimeout(function(){b.$d.apply(b,c)},0)};c.prototype.$h=function(a){for(var b=this,d=1;d<arguments.length;d++);var c=Array.prototype.slice.apply(arguments),f=c[0];this.Zj[f]||(this.Zj[f]=!0,setTimeout(function(){b.Zj[f]=!1;b.$d.apply(b,c)},0))};c.prototype.$d=function(a){for(var b=1;b<
arguments.length;b++);this.kb||(this.kb={});b=Array.prototype.slice.call(arguments,1);var d,c=!1;if(a in this.kb){var f=this.kb[a];var g=0;for(d=f.length;g<d;g++){var h=f[g];this.Ci||c||(this.log("Emit %s",a),c=!0);h.apply(null,b)}}};c.prototype.Ja=function(a,b){this.kb||(this.kb={});this.bind(a,b)};c.prototype.once=function(a,b){function d(){c.Po(a,d);b.apply(null,arguments)}var c=this;c.bind(a,d)};c.prototype.bind=function(a,b){a in this.kb?this.kb[a].push(b):this.kb[a]=[b];return b};c.prototype.removeListener=
function(a,b){return this.Po(a,b)};c.prototype.Po=function(a,b){var d,c;if(a in this.kb){var f=this.kb[a];var g=d=0;for(c=f.length-1;d<=c;g=d+=1)if(f[g]===b){f.splice(g,1);break}0===f.length&&delete this.kb[a]}};return c}();var Qc=function(){var c;if(document.currentScript&&(c=document.currentScript.getAttribute("src")))return c;if(!document.getElementsByTagName)return"";c=document.getElementsByTagName("script");if(0===c.length)return"";c=c[c.length-1];return void 0!==c.getAttribute.length?c.src:c.getAttribute("src")||""}(),Rc={adaptiveBrushWidth:!1,adaptiveLineWidth:!1,angleArcs:0,allowSelectBox:"auto",allowResize:!0,allowTextInShape:!0,allowPointerEvents:!0,allowSystemClipboard:!1,allowZoom:!0,autoPickTool:!0,autoPickToolText:!0,
autoSnap:0,background:"clear",backgroundImage:null,collaborationServer:"zwibbler",clickToDrawShapes:!1,colourPicker:"wheel",colourPalette:"auto",debug:!1,defaultArrowStyle:"simple",defaultArrowSize:15,defaultArrowXOffset:null,defaultItalic:!1,defaultBold:!1,defaultBrushColour:"#000000",defaultBrushWidth:10,defaultFillStyle:"#e0e0e0",defaultFont:"Arial",defaultFontSize:20,defaultLineWidth:2,defaultPaperSize:"none",defaultRoundRectRadius:10,defaultSmoothness:"smooth",defaultStrokeStyle:"#000000",defaultText:"Lorum ipsum dolor",
defaultTextBackground:"rgba(0,0,0,0.0)",defaultTextAlign:"left",defaultTextDecoration:"none",defaultTextFillStyle:"#000000",defaultTextStrokeStyle:"#000000",defaultTextLineWidth:0,defaultZoom:1,drawShapeStyle:"box",fonts:["Arial","Times New Roman"],gridBlocks:10,gridColour:"#cccccc",gridSpacing:20,imageFolder:"$SCRIPT",iPadNoScrollText:!1,keyBringToFront:"Home",keyCancel:"ESC",keyCopy:"Ctrl+C,\u2318+C",keyCurveTool:"C",keyCut:"Ctrl+X,\u2318+X,Shift+Delete",keyDelete:"Delete,Backspace",keyDown:"Down,Ctrl+Down",
keyDuplicate:"Ctrl+D",keyEnter:"Enter",keyGroup:"Ctrl+G",keyLeft:"Left,Ctrl+Left",keyLineTool:"L",keyMoveDown:"PageDown",keyMoveUp:"PageUp",keyNext:"Down,Right",keyNextPage:"Shift+PageDown",keyPaste:"Ctrl+V,\u2318+V,Shift+Insert",keyPrevious:"Left,Up",keyPreviousPage:"Shift+Pageup",keyRedo:"Ctrl+Shift+Z",keyRight:"Right,Ctrl+Right",keySelectNone:"ESC",keySelectAll:"Ctrl+A",keySendToBack:"End",keyUndo:"Ctrl+Z",keyUngroup:"Ctrl+Shift+G",keyUp:"Up,Ctrl+Up",keyZoomIn:"+,Shift+=",keyZoomNormal:"=",keyZoomOut:"-",
keyZoomToPage:"F4",keyZoomToWidth:"Shift+F4",language:"en",latency:0,leaveTextToolOnBlur:!1,maximumZoom:0,minimumZoom:0,multilineText:!1,nudge:10,outsidePageColour:"#808080",pageBorderColour:"rbga(0,0,0,0.0)",pageInflation:20,pagePlacement:"centre",pageSelectorDiv:"",pageShadow:!0,pageView:!1,pasteOffset:10,pasteOffsetX:0,pasteOffsetY:0,persistent:!1,pixelsPerUnit:1,preciseNudge:1,readOnly:!1,scrollbars:!0,setFocus:!0,showArrowTool:!0,showBackgroundSelector:!1,showBrushTool:!0,showCircleTool:!0,showColourPanel:!0,
showCopyPaste:!0,showCurveTool:!0,showDebug:!1,showFontNameProperty:!0,showFontSizeProperty:!0,showHints:!0,showImageSelector:!1,showImageTool:!1,showKeyboardHelp:!0,showLineTool:!0,showMathTool:!1,showMoveToFrontBack:!1,showPageSelector:!1,showPageSelectorControls:!0,showPickTool:!0,showPropertyPanel:!1,showRoundRectTool:!1,showRuler:!1,showShapeBrushTool:!1,showSloppinessProperty:!0,showSmoothnessProperty:!0,showSquareTool:!0,showTextTool:!0,showToolbar:!0,showUndoRedo:!0,simulateGestures:!1,singleStrokeBrush:!1,
sloppy:!1,snap:0,spotHighlightColour:"rgba(0,0,0,0.2)",spotHighlightZIndex:1,symmetry:0,textMode:"interactive",toolbarButtonSize:50,useTouch:"auto",units:"",drawCircleStyle:"box",enableArrowKeysNudge:!1,showMenu:!1},Sc={},Tc;for(Tc in Rc)Sc[Tc.toLowerCase()]=Tc;
var Uc=function(c){function a(a,d){var b=c.call(this)||this;b.options=JSON.parse(JSON.stringify(Rc));b.zc="";b.log=w.create("CONFIG");for(var f in d)f.toLowerCase()in Sc||alert("Zwibbler: Unknown option '"+f+"'"),b.set(f,d[f],!0);a.addEventListener(window,"hashchange",function(){b.log("Reload parameters from url hash");b.On()});b.On();""===b.zc&&b.set("imageFolder",b.options.imageFolder);"auto"===b.options.useTouch&&b.log("Detected touch support: %s","ontouchstart"in window||"onmsgesturechange"in
window);b.log("Detect clipboard support: %s",b.yk());for(var g in b.options)b.log("%s=%s",g,b.options[g]);return b}n(a,c);a.prototype.On=function(){if(void 0===a)var a=window.location.hash;0===a.indexOf("#/")&&(a="#"+a.substr(2));var d=a,c;a={};var f=d.indexOf("#");0<=f&&(d=d.substr(f+1));f=d.indexOf("#");0<=f&&(d=d.substr(0,f));d=d.split("&");f=0;for(c=d.length;f<c;f++){var g=d[f];var h=g.split("=");g=Oc(h[0]);h=1<h.length?Oc(h[1]):"";g.length&&(a[g]=h)}for(var l in a)this.set(l,a[l])};a.cp=function(a){return a.toLowerCase()in
Sc};a.prototype.set=function(a,d,c){void 0===c&&(c=!1);a.toLowerCase()in Sc&&(a=Sc[a.toLowerCase()]);"debug"===a&&(a="showDebug");if(!(a in this.options))return this.log("Error: %s is not a configuration option.",a),!1;if("defaultZoom"===a){if("page"!==d&&"width"!==d&&!J(d)&&(d=parseFloat(d),isNaN(d)))return this.log("Error: Config option %s must be a number or 'page' or 'width'",a),!1}else if("allowSelectBox"!==a)if("imageFolder"===a){var b=this.Er();""===b?(this.zc=d.replace("$SCRIPT/",""),this.zc=
this.zc.replace("$SCRIPT","")):this.zc=d.replace("$SCRIPT/","$SCRIPT").replace("$SCRIPT",b);""!==this.zc&&"/"!==this.zc[this.zc.length-1]&&(this.zc+="/");this.log("scriptPath=%s imageFolder=%s, result:%s",b,this.options.imageFolder,this.zc)}else if("colourPalette"===a)"auto"!==d&&"string"===typeof d&&(d=u.Cs(d));else if("string"===typeof d)if("number"===typeof this.options[a]){if(d=parseFloat(d),isNaN(d))return this.log("Error: Config option %s expects a number",a),!1}else if("boolean"===typeof this.options[a]||
"useTouch"===a&&"auto"!==d)d="1"===d||"true"===d||""===d;this.log("Set config %s=%s",a,d);this.options[a]=d;c||(this.$d("update",a,d),this.$d(a,d,!1));return!0};a.prototype.Ja=function(a,d){if("update"!==a&&!(a in this.options))throw Error(a+" is not a valid config setting.");d(this.options[a],!0);return c.prototype.Ja.call(this,a,d)};a.prototype.Er=function(){var a=Qc;var d=a.lastIndexOf("/");return a=0<=d?a.substr(0,d+1):""};a.prototype.Cu=function(){return this.options.showBrushTool};a.prototype.Fu=
function(){return this.options.showPropertyPanel};a.prototype.Du=function(){return this.options.showColourPanel};a.prototype.Eu=function(){return this.options.showDebug};a.prototype.Gu=function(){return this.options.showToolbar};a.prototype.Na=function(a){if(!(a in this.options))throw Error(a+" is not a valid config setting.");return this.options[a]};a.prototype.get=function(a){switch(a){case "useTouch":return this.cg();default:return this.Na(a)}};a.prototype.cg=function(){return"auto"===this.options.useTouch?
"ontouchstart"in window||"onmsgesturechange"in window:this.options.useTouch};a.prototype.Yq=function(){if("auto"===this.options.allowSelectBox){var a=this.cg(),d=document.documentElement.offsetHeight,c=window.innerHeight,f=!a||a&&0<c-d+50;this.log("Allowing select box: %s (useTouch=%s, documentHeight=%s, windowHeight=%s)",f,a,d,c);return f}return this.options.allowSelectBox};a.prototype.fr=function(){var a=(""+this.options.defaultSmoothness).toLowerCase();return"sharpest"===a?0:"sharper"===a?.1:"sharp"===
a?.2:"smoothest"===a?.5:.3};a.prototype.lk=function(a){return 0===a.indexOf("http:")||0===a.indexOf("https:")||0===a.indexOf("/")?a:this.zc+a};a.prototype.nn=function(){return pb(this.get(void 0))};a.prototype.Ip=function(a){function b(a){for(var b="",d=0;d<a.length;d++){var c=a.charAt(d);b=c===c.toUpperCase()?b+("-"+c.toLowerCase()):b+c}return b}var c=this,f={keyCut:1,keyCopy:1,keyPaste:1},g;for(g in this.options)this.options.hasOwnProperty(g)&&(0!==g.indexOf("key")||f[g]||a.map(this.options[g],
b(g).substr(4)));this.Ja("allowSystemClipboard",function(){var b=!c.yk();b?c.log("Not using system clipboard. Mapping cut/copy/paste keys"):c.log("Using system clipboard. Ignore keyCut/keyCopy/keyPaste.");a.map(c.options.keyCut,"cut",b);a.map(c.options.keyCopy,"copy",b);a.map(c.options.keyPaste,"paste",b)})};a.prototype.mn=function(){return"radial"===this.get("drawCircleStyle")||"radial"===this.get("drawShapeStyle")?"circle":"rectangle"};a.prototype.Zk=function(a){var b=a;0<this.options.maximumZoom&&
(a=Math.min(a,this.options.maximumZoom));0<this.options.minimumZoom&&(a=Math.max(a,this.options.minimumZoom));a!==b&&this.log("Zoom restricted to %s",a);return a};a.prototype.yk=function(){var a=document;return this.get("allowSystemClipboard")&&void 0!==a.oncopy&&void 0!==a.oncut&&void 0!==a.onpaste};return a}(Pc);var Vc=function(){function c(a,b){this.name=b;this.sa=z("div").Ec({borderTop:"1px solid #888",padding:"5px",cursor:"default"}).Sd(a);this.update(0)}c.prototype.update=function(a){this.sa.Ga.innerText=this.name+"... "+Math.round(100*a)+"%"};c.prototype.error=function(a){var b=this,d=document.createElement("input");d.setAttribute("type","button");d.value="OK";d.addEventListener("click",function(){b.done()});this.sa.Ga.innerText=this.name+"... "+a+" ";this.sa.Ga.appendChild(d)};c.prototype.done=function(){this.sa.remove()};
c.all=[];return c}();var T=function(){function c(){this.keys={}}c.prototype.contains=function(a){return a in this.keys};c.prototype.add=function(a){if(a instanceof Array)for(var b=0;b<a.length;b++)this.keys[a[b]]=!0;else this.keys[a]=!0};c.prototype.remove=function(a){delete this.keys[a]};c.prototype.Cf=function(a){var b,d;void 0===d&&(d="");if(!(a instanceof c))throw d||"Assertion failed";d=new c;for(b in this.keys)a.contains(b)||d.add(b);return d};c.prototype.Sb=function(){var a;var b=[];for(a in this.keys)this.keys.hasOwnProperty(a)&&
b.push(a);return b};c.prototype.ld=function(){var a;var b=[];for(a in this.keys)this.keys.hasOwnProperty(a)&&b.push(parseFloat(a));return b};c.prototype.clear=function(){this.keys={}};c.prototype.oc=function(a){for(var b in this.keys)if(this.keys.hasOwnProperty(b)&&a(b))break};c.prototype.empty=function(){for(var a in this.keys)if(this.keys.hasOwnProperty(a))return!1;return!0};return c}();var Wc=function(c){function a(b,d){var e=c.call(this,b,d,a)||this;e.log=w.create("PAGE",!0);e.children=[];return e}n(a,c);a.prototype.type=function(){return"PageNode"};a.prototype.format=function(){};a.prototype.xb=function(){return null};a.prototype.ha=function(){};return a}(ec);L.od("PageNode",Wc);var Xc=function(){function c(){this.log=w.create("NullObserver")}c.prototype.createNode=function(a,b,d,c){this.log("Create node "+c.type+" "+a+" at "+b+":"+d)};c.prototype.yc=function(a,b,d){this.log("Delete node "+a+" from "+b+":"+d)};c.prototype.Pe=function(a,b,d,c,f){this.log("Move node "+a+" from "+c+":"+f+" to "+b+":"+d)};c.prototype.Jb=function(a,b){this.log("Set properties for node "+a+" to "+JSON.stringify(b))};c.prototype.pa=function(){};return c}(),Yc=function(c){function a(a){void 0===
a&&(a=!1);var b=c.call(this)||this;b.tu=a;b.Wb=new Xc;b.$b=new xc;b.ra={};b.ie=new T;b.cn=!0;b.bi=!0;b.nb=0;b.Kc=new T;b.removedNodes=new T;b.Td=new T;b.root=new ec(b.$a(),b);b.Wi=0;b.nl="magenta";b.readOnly=!1;b.Uj=new T;b.aa={};b.pi=new T;b.Pl=new T;b.jd=[];b.cb=[];b.Sa=0;b.sg=0;b.Jf=0;b.vo=0;b.log=w.create("DOC");b.ra[b.root.id]=b.root;b.Rn();a||(b.uj(b.root,0),b.Rb(b.vi(0)));return b}n(a,c);a.prototype.empty=function(){return 0===this.root.children.length};a.prototype.Rn=function(){this.vo=this.$b.next};
a.prototype.Vd=function(){return this.vo!==this.$b.next};a.prototype.$a=function(){for(;;){var a=this.nb++;if(!(a in this.ra))return a}};a.prototype.Ge=function(a){return a in this.ra};a.prototype.uj=function(a,d,c,f,g){void 0===c&&(c=!0);void 0===f&&(f=null);void 0===g&&(g=0);var b,e=!1;if(a.id in this.ra)null!==f&&a.parent&&(this.Wb.Pe(a.id,a.parent.id,a.Le(),f,g),this.log("Node %s inserted at %s:%s; was at %s",a.id,a.parent.id,a.Le(),g));else if(e=!0,this.ra[a.id]=a,a.parent&&(f=a.ec(),f.type=
a.type(),this.Wb.createNode(a.id,a.parent.id,a.Le(),f)),a instanceof ec){var k=a.children;g=0;for(b=k.length;g<b;g++)f=k[g],this.uj(f,d,c)}"PageNode"!==a.type()&&e&&(this.Kc.add(a.id),this.removedNodes.remove(a.id));a.Wf(this.readOnly);c&&this.ie.add(a.id);this.Pl.add(a.Ff());a.ka("spotHighlight")&&"PathNode"===a.type()&&this.jd.push(a);this.Jf=void 0===d||null===d?this.$c(a.id)||0:d;"DomNode"===a.type()?this.Uj.add(a.id):"PageNode"===a.type()&&(this.sg=-1);e&&a.Nk()};a.prototype.Lg=function(a){this.Td.add(a);
this.Jf=this.$c(a)||0;this.ie.add(a)};a.prototype.Ch=function(a){this.cb[this.Sa]||console.log("FATAL: Asked to add a node but bad page.",this.Sa,this.cb);this.ob(this.cb[this.Sa],a,-1)};a.prototype.va=function(a,d){void 0===d&&(d=!1);if(a in this.ra){var b=this.ra[a];d&&(this.ie.add(a),this.Td.add(a),this.Jf=this.$c(a)||0);return b}return null};a.prototype.$c=function(a){for(a=this.va(a,!1);;)if(a)if("PageNode"===a.type())break;else{if(null===a.parent)return null;a=a.parent}else return null;for(var b=
0;b<this.cb.length;b++)if(this.cb[b]===a)return b;return null};a.prototype.mk=function(a,d,c){for(var b=[],e=0;e<a.length;e++){var h=this.va(a[e],c);h&&b.push(h)}return b=d?this.Eq(b):this.Hh(b)};a.prototype.Nq=function(a){var b=[],c;for(c in this.ra)if(this.ra.hasOwnProperty(c)){var f=this.ra[c];f.ka("tag")===a&&b.push(f)}return b};a.prototype.pa=function(a,d){void 0===d&&(d=!1);this.Kc=new T;this.removedNodes=new T;this.Td=new T;if(d){this.log("Performing actions without adding to undo stack");
for(var b=0;b<a.length;b++)a[b].wb(this)}else this.$b.pa(a,!1,this);this.Wb.pa();b=this.Kc.ld();for(var c=0;c<b.length;c++){var g=b[c];g>=this.nb&&(this.nb=g+1)}return{ac:b,cf:this.removedNodes.ld(),bg:this.Td.Cf(this.Kc).Cf(this.removedNodes).ld()}};a.prototype.jb=function(){this.Kc=new T;this.removedNodes=new T;this.Td=new T;this.$b.jb(this);this.Wb.pa();return{ac:this.Kc.ld(),cf:this.removedNodes.ld(),bg:this.Td.Cf(this.Kc).Cf(this.removedNodes).ld()}};a.prototype.Jd=function(){this.Kc=new T;this.removedNodes=
new T;this.Td=new T;this.$b.Jd(this);this.Wb.pa();return{ac:this.Kc.ld(),cf:this.removedNodes.ld(),bg:this.Td.Cf(this.Kc).Cf(this.removedNodes).ld()}};a.prototype.qd=function(){return this.$b.qd()};a.prototype.pd=function(){return this.$b.pd()};a.prototype.Vg=function(){this.$b=new xc};a.prototype.format=function(a,d){var b=this,c;var g=[];if(this.cn)for(k in this.ra)g.push(this.ra[k]);else this.ie.oc(function(a){g.push(b.ra[parseInt(a,10)]);return!1});var h=this.Hh(g);var l=0;for(c=h.length;l<c;l++){var k=
h[l];k.format(a,d)}this.ie.clear();this.cn=!1;return g.length};a.prototype.xq=function(a,d,c){if(0!==this.jd.length&&d===this.Wi){a.save();a.beginPath();d=c||this.bd();a.moveTo(d.x,d.y);a.lineTo(d.x,d.bottom());a.lineTo(d.right(),d.bottom());a.lineTo(d.right(),d.y);a.closePath();c=!1;for(var b=0;b<this.jd.length;b++)this.$c(this.jd[b].id)===this.Sa&&(this.jd[b].clip(a),c=!0);c&&(a.clip(),a.fillStyle=this.nl,a.fillRect(d.x,d.y,d.width,d.height));a.restore()}};a.prototype.td=function(a,d){var b=d||
this.bd(),c=this.aa.background;c&&(c=u.ci(c))&&(a.fillStyle=c.toString(),a.fillRect(b.x,b.y,b.width,b.height))};a.prototype.ha=function(a,d){function b(b){g.Ee(function(d){g.pi.contains(d.zd())||d.Ff()===b&&(d.hidden()||d.ha(a))});g.xq(a,b,d)}var c,g=this;this.Pl.add(this.Wi);var h=this.Pl.ld();h.sort(function(a,b){return a-b});var l=0;for(c=h.length;l<c;l++)b(h[l])};a.prototype.xb=function(a,d,c,f){var b=null;this.Ee(function(e){e.zd()===c&&e.xb(a,d)&&(!(null===b||b.Ff()<=e.Ff())||f&&f!==e.type()||
(b=e))});return b};a.prototype.Ar=function(a){var b=[];this.Ee(function(d){a.contains(d.rect)&&b.push(d)});return b};a.prototype.Hh=function(a){var b,c;var f=[];var g={};var h=0;for(c=a.length;h<c;h++){for(b=a[h];b.Jn()&&b.parent;)this.log("Node type %s:%s is a group member",b.id,b.type()),b=b.parent;b.id in g||(g[b.id]=b,f.push(b))}this.At(f);return f};a.prototype.Eq=function(a){function b(a){if(!(a.id in f)&&(f[a.id]=a,c.push(a),a.children))for(var d=0;d<a.children.length;d++)b(a.children[d])}for(var c=
[],f={},g=0;g<a.length;g++)b(a[g]);return c};a.prototype.oc=function(a,d){function b(c){var e;if(c.children){a&&d(c);var f=c.children;var l=0;for(e=f.length;l<e;l++)c=f[l],b(c)}else d(c)}b(this.root)};a.prototype.Ee=function(a,d){function b(d){if(d.children)for(var c=0;c<d.children.length;c++)b(d.children[c]);else"PageNode"!==d.type()&&a(d)}void 0===d&&(d=this.Sa);d<this.cb.length&&b(this.cb[d||0])};a.prototype.filter=function(a){var b=[];this.oc(!1,function(d){if(a(d))return b.push(d)});return b};
a.prototype.At=function(a){var b=0;this.bi&&(this.bi=!1,this.oc(!0,function(a){a.order=b++}));a.sort(function(a,b){return a.order-b.order})};a.prototype.ng=function(a,d){var b;var c=new ec(a,this);this.Ch(c);var g=0;for(b=d.length;g<b;g++){var h=d[g];this.ob(c,this.ra[h],-1)}return c};a.prototype.Zs=function(a){var b,c=[];var f=0;var g=this.Hh(a);var h=0;for(b=g.length;h<b;h++)a=g[h],f=this.qm(a,c,f,null);return"zwibblerclip."+JSON.stringify(c)};a.prototype.qm=function(a,d,c,f){var b=a.ec(),e={},
l;for(l in b){var k=b[l];k instanceof F&&(k=["Matrix",k.m11,k.m12,k.m21,k.m22,k.Ca,k.Da]);e[l]=k}d.push({type:"CreateAction",node:a.type(),parent:f,properties:e});f=c+1;if(a.children)for(b=0,a=a.children;b<a.length;b++)f=this.qm(a[b],d,f,c);return f};a.prototype.Pn=function(a,d){var b,c;0===a.indexOf("zwibblerclip.")&&(a=a.substr(13));var g=[];var h=JSON.parse(a);var l=[];var k={},m=0,q=0;var p=0;for(c=h.length;p<c;p++){var t=h[p];if("GroupAction"===t.type){var r=this.$a();k[m++]=r;var v=[];var x=
0;for(t=t.members;x<t.length;x++)v.push(k[t[x]]);l.push(new Gc(r,v));g.push(r)}else if("CreateAction"===t.type){x=t.properties;v={};for(b in x)x.hasOwnProperty(b)&&(r=x[b],"[object Array]"===Object.prototype.toString.apply(r)&&"Matrix"===r[0]&&(r.splice(0,1),r=new F(r)),v[b]=r);r=this.$a();k[m++]=r;x=null;var I=-1;"parent"in t&&t.parent in k?x=k[t.parent]:"PageNode"===t.node&&(x=this.root.id,I=this.Sa+1+q,q+=1);l.push(new S(r,t.node,v,x,I));g.push(r)}}0!==q||d.zk()||l.push(new Ec(g,d));return l};
a.prototype.ob=function(a,d,c){var b=null,e=0;d.parent&&(b=d.parent.id,e=d.Le(),this.removeNode(d,!1));-1===c?a.children.push(d):a.children.splice(c,0,d);d instanceof Wc&&(-1===c?this.cb.push(d):this.cb.splice(c,0,d));d.parent=a;this.uj(d,this.$c(a.id),!0,b,e);this.bi=!0};a.prototype.Ts=function(a,d){var b="function"!==typeof d?function(a){return a===d}:d;for(var c=0,g=0;g<a.length;g++)b(a[g])?c+=1:c&&(a[g-c]=a[g]);a.length-=c};a.prototype.removeNode=function(a,d){void 0===d&&(d=!0);var b=this,c=
this.$c(a.id);if(!a.parent||null===c)return this.log("Error: removeNode -- should not happen!"),-1;var g=a.parent.ck(a);if(0<=g&&(d&&this.Wb.yc(a.id,a.parent.id,g),a.parent.children.splice(g,1),a.parent=null,d)){var h=function(a){var d;delete b.ra[a.id];b.Kc.remove(a.id);b.removedNodes.add(a.id);a.Qk();b.ie.remove(a.id);if(a.children){var c=a.children;var e=0;for(d=c.length;e<d;e++){var f=c[e];h(f)}}a.ka("spotHighlight")&&b.Ts(b.jd,a);b.Uj.remove(a.id)};h(a)}"PageNode"===a.type()?(this.cb.splice(g,
1),g===this.Sa&&(this.log("Removed current page."),this.Rb(Math.min(g,this.cb.length-1)),this.Jf=this.Sa),this.sg=-1):this.Jf=c;return g};a.prototype.hn=function(a){function b(a){if(!l||a.rect.x<c)c=a.rect.x;if(!l||a.rect.right()>f)f=a.rect.right();if(!l||a.rect.y<g)g=a.rect.y;if(!l||a.rect.bottom()>h)h=a.rect.bottom();l=!0}var c=0,f=0,g=0,h=0,l=!1;"number"===typeof a?this.Ee(b,a):this.oc(!1,b);return l?new D(c,g,f-c,h-g):new D(0,0,10,10)};a.prototype.bd=function(a){return this.aa.width?new D(0,0,
this.aa.width,this.aa.height):this.hn(a)};a.prototype.ka=function(a){return this.aa[a]};a.prototype.zn=function(a){return a in this.aa};a.prototype.setProperty=function(a,d){var b=this.aa[a]||null;null===d?a in this.aa&&delete this.aa[a]:this.aa[a]=d;var c={};c[a]=d;var g={};g[a]=b;this.Wb.Jb(this.root.id,c,g)};a.prototype.Pc=function(a,d,c){a===this.root&&this.setProperty(d,c);var b={};b[d]=c;var e={};e[d]=a.ka(d);a.setProperty(d,c);this.Wb.Jb(a.id,b,e);if("spotHighlight"===d&&"PathNode"===a.type()){for(d=
0;d<this.jd.length;d++)if(this.jd[d]===a){this.jd.splice(d,1);break}c?(this.log("Added node %s to spotHighlightNodes",a.id),this.jd.push(a)):this.log("Removed node %s from spotHighlightNodes",a.id)}};a.prototype.ah=function(a,d){this.log("showLayer(%s, %s)",a,d);d?this.pi.remove(a):this.pi.add(a)};a.prototype.Ak=function(a){return!this.pi.contains(a)};a.prototype.vi=function(a){this.log("Adding page to document with index %s",a);if(a>this.cb.length)return this.log("Error: Can insert page with index %s",
a),-1;var b=L.create("PageNode",this.$a(),this);this.ob(this.root,b,a);return a};a.prototype.Hc=function(){return this.cb.length};a.prototype.Rb=function(a){if(a!==this.Sa){if(0<=a&&a<this.cb.length)return this.log("Set current page to %s/%s",a,this.cb.length),this.Sa=a,!0;this.log("Tried to set page to non-existing %s",a);return!1}};a.prototype.vt=function(){this.sg!==this.Sa&&(this.zl(this.sg,!1),this.zl(this.Sa,!0),this.sg=this.Sa)};a.prototype.zl=function(a,d){var b=this;d?this.Ee(function(a){"DomNode"===
a.type()&&a.Nk()},a):this.Uj.oc(function(a){(a=b.va(parseInt(a,10),!1))&&a.Qk()})};a.prototype.pk=function(a){return 0===this.cb.length?this.root:void 0===a?this.cb[this.Sa]:this.cb[a]};a.prototype.qk=function(){var a=816,d=1056;"width"in this.aa&&(a=this.aa.width);"height"in this.aa&&(d=this.aa.height);return new Ib(a,d)};a.prototype.Wf=function(a){this.oc(!1,function(b){b.Wf(a)})};a.prototype.getRootNode=function(){return this.root};a.prototype.Fo=function(a,d){void 0===d&&(d=!0);this.Wb=a;d&&(this.Wb.Jb(this.root.id,
this.aa,{}),this.oc(!0,function(b){if(b.parent){var d=b.ec();d.type=b.type();a.createNode(b.id,b.parent.id,b.Le(),d)}}),this.Wb.pa())};return a}(Pc);var Zc=function(){function c(a,b){void 0===b&&(b="repeat");this.Ha=a;this.repeat=b}c.prototype.loaded=function(){return this.Ha instanceof HTMLImageElement?this.Ha.complete:!0};c.prototype.setTransform=function(){};return c}(),$c=function(){function c(a,b,d,c){this.Ct=[];this.from=new A(a,b);this.ga=new A(d,c)}c.prototype.addColorStop=function(a,b){this.Ct.push({offset:a,Be:b})};return c}(),ad=function(){function c(){this.stack=[];this.oa=new F;this.lineCap="butt";this.lineJoin="miter";this.lineWidth=
1;this.strokeStyle=this.fillStyle="#000000";this.textBaseline="top";this.font="10px arial";this.globalCompositeOperation="source-over";this.globalAlpha=1;this.shadowBlur=this.shadowOffsetY=this.shadowOffsetX=0;this.shadowColor="rgba(0,0,0,0)"}c.prototype.save=function(){this.stack.push({oa:this.oa.clone(),fillStyle:this.fillStyle,font:this.font,lineJoin:this.lineJoin,lineCap:this.lineCap,lineWidth:this.lineWidth,strokeStyle:this.strokeStyle,textBaseline:this.textBaseline,globalCompositeOperation:this.globalCompositeOperation,
globalAlpha:this.globalAlpha,shadowOffsetX:this.shadowOffsetX,shadowOffsetY:this.shadowOffsetY,shadowBlur:this.shadowBlur,shadowColor:this.shadowColor,Ae:this.tj()})};c.prototype.restore=function(){var a=this.stack.pop();a&&(this.oa=a.oa,this.fillStyle=a.fillStyle,this.font=a.font,this.lineJoin=a.lineJoin,this.lineCap=a.lineCap,this.lineWidth=a.lineWidth,this.oa=a.oa,this.strokeStyle=a.strokeStyle,this.textBaseline=a.textBaseline,this.globalCompositeOperation=a.globalCompositeOperation,this.globalAlpha=
a.globalAlpha,this.shadowOffsetX=a.shadowOffsetX,this.shadowOffsetY=a.shadowOffsetY,this.shadowBlur=a.shadowBlur,this.shadowColor=a.shadowColor,this.wj(a.Ae))};c.prototype.drawImage=function(a,b,d,c,f,g,h,l,k){var e=a.width,q=a.height,p=0,t=e,r=q;void 0!==c&&void 0!==f&&void 0!==g&&void 0!==h&&void 0!==l&&void 0!==k?(p=b,0-d,t=c,r=f,b=g,d=h,e=l,q=k):void 0!==c&&void 0!==f&&(e=c,q=f);this.qj(a,p,0,t,r,b,d,e,q)};c.prototype.beginPath=function(){};c.prototype.closePath=function(){};c.prototype.arc=function(a,
b,d,c,f,g){g&&(g=c,c=f,f=g);for(;0>c;)c+=2*Math.PI;for(;0>f;)f+=2*Math.PI;c>f&&(c-=2*Math.PI);var e=2*Math.PI;var l=c%e;var k=f%e;k===l&&(k+=2*Math.PI);f=[];c=Math.PI/2;g=l<k?1:-1;var m=l;for(e=Math.min(e,Math.abs(k-l));1E-5<e;){l=m+g*Math.min(e,c);var q=(l-m)/2,p=d*Math.cos(q),t=d*Math.sin(q),r=.5522847498*Math.tan(q);k=p+r*t;p=-t+r*p;t=-p;r=q+m;q=Math.cos(r);r=Math.sin(r);f.push({bu:d*Math.cos(m),fu:d*Math.sin(m),cu:k*q-p*r,gu:k*r+p*q,du:k*q-t*r,hu:k*r+t*q,eu:d*Math.cos(l),iu:d*Math.sin(l)});e-=
Math.abs(l-m);m=l}for(d=0;d<f.length;d++)c=f[d],0===d&&this.moveTo(c.bu+a,c.fu+b),this.bezierCurveTo(c.cu+a,c.gu+b,c.du+a,c.hu+b,c.eu+a,c.iu+b)};c.prototype.arcTo=function(){};c.prototype.strokeRect=function(a,b,d,c){this.beginPath();this.rect(a,b,d,c);this.stroke()};c.prototype.setTransform=function(a,b,d,c,f,g){this.oa=new F(a,d,b,c,f,g)};c.prototype.transform=function(a,b,d,c,f,g){a=new F(a,d,b,c,f,g);this.oa=this.oa.multiply(a)};c.prototype.translate=function(a,b){this.transform(1,0,0,1,a,b)};
c.prototype.scale=function(a,b){this.transform(a,0,0,b,0,0)};c.prototype.rotate=function(a){var b=Math.cos(a);a=Math.sin(a);this.transform(b,a,-a,b,0,0)};c.prototype.rect=function(a,b,d,c){this.beginPath();this.moveTo(a,b);this.lineTo(a+d,b);this.lineTo(a+d,b+c);this.lineTo(a,b+c);this.lineTo(a,b);this.closePath()};c.prototype.fillRect=function(a,b,d,c){this.rect(a,b,d,c);this.fill()};c.prototype.te=function(a){var b=null,d="10",c="normal",f="normal",g="normal",h="normal",l=!1;a=a.split(/\s+/);a:for(;;){var k=
a.shift();if(!k)break;switch(k){case "normal":break;case "italic":case "oblique":c=k;break;case "small-caps":g=k;break;case "bold":case "bolder":case "lighter":case "100":case "200":case "300":case "400":case "500":case "600":case "700":case "800":case "900":f=k;break;default:if(l){b=k;a.length&&(b+=" "+a.join(" "));2<b.length&&('"'===b.charAt(0)||"'"===b.charAt(0))&&(b=b.substr(1,b.length-2));break a}else k=k.split("/"),d=k[0],l=!0,1<k.length&&(h=k[1])}}return{fontStyle:c,fontVariant:g,fontWeight:f,
fontSize:d,lineHeight:h,fontFamily:b}};c.prototype.createPattern=function(a,b){return new Zc(a,b)};c.prototype.createLinearGradient=function(a,b,d,c){return new $c(a,b,d,c)};return c}();var bd=function(c){function a(a){a=c.call(this,a)||this;a.Te=0;a.gd=0;a.Sn=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8193];a.log=w.create("BITWRITER");return a}n(a,c);a.prototype.Ab=function(a){this.Vo(a,8)};a.prototype.Vo=function(a,d){this.Te=this.Te<<d|a&this.Sn[d];for(this.gd+=d;8<=this.gd;)this.next.Ab(this.Te>>>this.gd-8&255),this.gd-=8,this.Te&=this.Sn[this.gd]};a.prototype.flush=function(){this.gd&&(this.next.Ab(this.Te<<8-this.gd),this.Te=this.gd=0);this.next.flush()};return a}(Na);var cd=function(c){function a(a){var b=c.call(this,a)||this;b.Kf=258;b.uu=0;b.lf=0;b.first=!0;b.lg=[];b.Tk=[];b.Dj=[];b.yu=0;b.Kj=9;b.log=w.create("LZWEncoder");b.Pp=new bd(a);b.im();return b}n(a,c);a.prototype.Ab=function(a){if(this.first)this.lf=a,this.first=!1;else{var b=this.op(this.lf,a);void 0!==this.lg[b]?this.lf=this.lg[b]:(this.Ah(this.lf),this.lg[b]=this.Kf,this.Tk[b]=this.lf,this.lf=this.Dj[b]=a,4095>this.Kf?(this.Kf+=1,this.Kj=Math.ceil(Math.log(this.Kf)/Math.log(2))):this.im())}};a.prototype.op=
function(a,d){var b;var c=d<<4^a;for(b=0===c?1:18041-c;;){if(void 0===this.lg[c]||this.Tk[c]===a&&this.Dj[c]===d)return c;c-=b;0>c&&(c+=18041)}};a.prototype.im=function(){this.Ah(a.Yo);this.Kf=258;this.Kj=9;this.lg.length=0;this.Tk.length=0;this.Dj.length=0};a.prototype.flush=function(){this.first||(this.Ah(this.lf),this.Ah(a.bp))};a.prototype.Ah=function(a){this.Pp.Vo(a,this.Kj)};a.Yo=256;a.bp=257;return a}(Na);Oa.ip(function(c){return new cd(c)});var dd=function(){function c(a,b,d,c){this.x=a;this.y=b;this.width=d;this.height=c;this.Vb=[];this.fonts={};this.images=[];this.bj={};this.nb=1;this.bq=!0;this.page={};this.log=w.create("PdfWriter");this.cb=this.object("Pages",{Kids:[],Count:0});this.Up=this.object("Catalog",{Pages:this.cb._id+" 0 R"});this.Zf()}c.prototype.Pr=function(){if(null!==c.vj)return c.vj;var a=document.createElement("canvas"),b=!1;a.width=10;a.height=10;"toDataURL"in a&&(b=0<a.toDataURL("image/jpeg").indexOf("jpeg"));c.vj=
b;this.log("JPEG supported: %s",b);return b};c.prototype.Zf=function(a,b,d,c){void 0===a&&(a=this.x);void 0===b&&(b=this.x);void 0===d&&(d=this.width);void 0===c&&(c=this.height);this.log("StartPage MediaBox=[%s %s %s %s]",a,b,d,c);this.page=this.object("Page",{MediaBox:[a,b,a+d,b+c],Parent:this.cb._id+" 0 R"});this.cb.Kids.push(this.page._id+" 0 R");this.cb.Count+=1;this.bj={}};c.prototype.object=function(a,b){var d=this.Vb.length+1;a&&(b.Type=a);b._id=d;this.Vb.push(b);return b};c.prototype.Ep=
function(a){this.page.Contents=a._id+" 0 R"};c.prototype.stream=function(a){if(this.bq){var b=Oa.eg("LZWEncoder");b.Wo(a);b.flush();a=b.Df().toString();a=this.object(null,{_stream:a,Filter:"[/LZWDecode]",DecodeParms:"[ << /EarlyChange 0 >> ]"})}else a=this.object(null,{_stream:a});return a};c.prototype.Qt=function(a){if(!(a in this.fonts)){var b="F"+this.nb;this.nb+=1;var d="/"+a.replace(/ /g,"");b=this.object("Font",{_name:b,BaseFont:d,Encoding:"/StandardEncoding",Subtype:"/Type1"});this.fonts[a]=
b}this.th("Font",this.fonts[a]);return"/"+this.fonts[a]._name};c.prototype.To=function(a,b){var d=""+a+"-"+b;if(!(d in this.bj)){var c="gs"+this.nb;this.nb+=1;var f=this.object("ExtGState",{_name:c});b?f.ca=this.Dc(a):f.CA=this.Dc(a);this.bj[d]=c;this.th("ExtGState",f)}return this.bj[d]};c.prototype.th=function(a,b){"Resources"in this.page||(this.page.Resources={});a in this.page.Resources||(this.page.Resources[a]={});this.page.Resources[a][b._name]=b._id+" 0 R"};c.prototype.sj=function(a,b){void 0===
b&&(b="");for(var d=0;d<this.images.length;d++)if(this.images[d].Gg===a&&b===this.images[d].Cn)return this.images[d].Pg;return null};c.prototype.ej=function(a,b){var d,c=this.sj(a);if(!c){var f="I"+this.nb;this.nb+=1;b instanceof HTMLCanvasElement?c=b:(c=document.createElement("canvas"),c.width=b.width,c.height=b.height,c.getContext("2d").drawImage(b,0,0));var g=c.getContext("2d").getImageData(0,0,c.width,c.height),h=!1;if(this.Pr()){this.log("Using JPEG encoding");var l="[/DCTDecode]";var k=Oa.eg("");
for(d=0;d<g.data.length;d+=4)h=h||255>g.data[d+3];d=c.toDataURL("image/jpeg");var m=atob(d.split(",")[1]);for(d=0;d<m.length;d++)k.Ab(m.charCodeAt(d))}else{this.log("Using LZW encoding");l="[/LZWDecode]";k=Oa.eg("LZWEncoder");for(d=0;d<g.data.length;d+=4)k.Ab(g.data[d]),k.Ab(g.data[d+1]),k.Ab(g.data[d+2]),h=h||255>g.data[d+3];var q="[ <</EarlyChange 0 >> ]"}k.flush();k=k.Df().toString();f=this.object("XObject",{Subtype:"/Image",Width:c.width,Height:c.height,ColorSpace:"/DeviceRGB",BitsPerComponent:8,
Length:k.length,Interpolate:"true",Filter:l,_name:f,_stream:k});q&&(f.DecodeParms=q);if(h){k=Oa.eg("LZWEncoder");for(d=0;d<g.data.length;d+=4)k.Ab(g.data[d+3]);k.flush();k=k.Df().toString();q=this.object("XObject",{Subtype:"/Image",Width:c.width,Height:c.height,ColorSpace:"/DeviceGray",BitsPerComponent:8,Length:k.length,Filter:"[/LZWDecode]",DecodeParms:"[ << /EarlyChange 0 >> ]",_stream:k});f.SMask=q._id+" 0 R"}this.images.push({Gg:a,Cn:"",Pg:f});c=f}this.th("XObject",c);return"/"+c._name};c.prototype.fj=
function(a,b){var d=this.sj(a.Ha,b.toString());if(!d){d="P"+this.nb;this.nb+=1;this.ej(a.Ha,a.Ha);var c=this.sj(a.Ha),f=new F(a.Ha.width,0,0,-a.Ha.height,0,a.Ha.height);f=b.multiply(f);var g="1",h="1",l=b.Ad();l=Math.max(l.x,l.y);if("no-repeat"===a.repeat||"repeat-y"===a.repeat)g=""+Math.ceil(this.width/a.Ha.width/l);if("no-repeat"===a.repeat||"repeat-x"===a.repeat)h=""+Math.ceil(this.height/a.Ha.height/l);d=this.object("Pattern",{_name:d,PatternType:"1",PaintType:"1",TilingType:"2",BBox:"[0 0 1 1]",
XStep:g,YStep:h,Matrix:"[ "+this.Dc(f.m11,f.m21,f.m12,f.m22,f.Ca,f.Da)+"]",Resources:"<< /XObject << /"+c._name+" "+c._id+" 0 R >> >>"});d._stream="/"+c._name+" Do";this.images.push({Gg:a.Ha,Cn:b.toString(),Pg:d})}this.th("Pattern",d);return"/"+d._name};c.prototype.df=function(){var a=[],b=[],d;a.push("%PDF-1.4\n%\u0080\u0081\u0082\u0083\n");for(d=0;d<this.Vb.length;d++)this.vm(a,b,this.Vb[d],!1);var c=a.join("").length;a.push("xref\n0 "+(this.Vb.length+1)+"\n");a.push("0000000000 65535 f\n");for(d=
0;d<this.Vb.length;d++){for(var f=""+b[d];10>f.length;)f="0"+f;a.push(f+" 00000 n \n")}a.push("trailer\n");a.push("<< /Size "+(this.Vb.length+1)+"\n");a.push("   /Root "+this.Up._id+" 0 R\n");a.push(">>\n");a.push("startxref\n");a.push(c+"\n");a.push("%%EOF\n");return a.join("")};c.prototype.toBlob=function(){for(var a=this.df(),b=new Uint8Array(a.length),d=0;d<a.length;d++)b[d]=a.charCodeAt(d);return new Blob([b],{type:"application/pdf"})};c.prototype.vm=function(a,b,d,c){c?a.push("<<\n"):(b.push(a.join("").length),
a.push(d._id+" 0 obj\n"),"Type"in d?a.push("<< /Type /"+d.Type+"\n"):a.push("<<\n"));"_stream"in d&&(d.Length=d._stream.toString().length);for(var e in d)if(d.hasOwnProperty(e)&&"Type"!==e&&"_"!==e.charAt(0)){c&&a.push("    ");a.push("   /"+e+" ");var g=d[e];"object"===typeof g&&"[object Array]"===Object.prototype.toString.apply(g)?a.push("[ "+g.join(" ")+" ]"):"object"===typeof g?this.vm(a,b,g,!0):a.push(g);a.push("\n")}c&&a.push("    ");a.push(">>\n");"_stream"in d&&(a.push("stream\n"),a.push(d._stream+
"\n"),a.push("endstream\n"));c||a.push("endobj\n")};c.prototype.Dq=function(a){return"("+a.replace(/\\/g,"\\\\").replace(/\(/g,"\\(").replace(/\)/g,"\\)")+")"};c.prototype.Dc=function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];b=[];for(var d=0;d<a.length;d++){var c=""+a[d];0<c.indexOf("e")&&(c=a[d].toFixed(20));b.push(c)}return b.join(" ")};c.vj=null;return c}(),ed=function(c){function a(a,d){var b=c.call(this)||this;b.Qq=d;b.path=[];b.x=0;b.y=0;b.jo=[];b.Ve="";b.af="";b.$e=-1;b.Ze=
"";b.Ye="";b.Xe="";b.We="";b.Ue=-1;b.log=w.create("PDFContext");b.Hd=a.clone();b.Hd.transform(new Lb(.75,.75,0,0));b.lb=new dd(72*a.x/96,72*a.y/96,72*a.width/96,72*a.height/96);b.stream=[];b.x=0;b.y=0;b.fillStyle="#000000";b.strokeStyle="#000000";b.sm=b.vp;b.rm();return b}n(a,c);a.prototype.save=function(){c.prototype.save.call(this);this.stream.push("q");this.jo.push({Ve:this.Ve,af:this.af,$e:this.$e,Ze:this.Ze,Ye:this.Ye,Xe:this.Xe,We:this.We,Ue:this.Ue})};a.prototype.restore=function(){c.prototype.restore.call(this);
var a=this.jo.pop();a&&(this.stream.push("Q"),this.Ve=a.Ve,this.af=a.af,this.$e=a.$e,this.Ze=a.Ze,this.Ye=a.Ye,this.Xe=a.Xe,this.We=a.We,this.Ue=a.Ue)};a.prototype.Zf=function(a){var b=new Lb(.75,.75,0,0);a&&(this.Hd=a.clone(),this.Hd.transform(b));this.$j();this.lb.Zf(this.Hd.x,this.Hd.y,this.Hd.width,this.Hd.height);this.rm();this.beginPath()};a.prototype.beginPath=function(){this.path.length=0};a.prototype.rm=function(){this.log("Start page: %s",this.Hd);this.setTransform(1,0,0,1,0,0);this.af=
this.Ve="";this.$e=-1;this.We=this.Xe=this.Ye=this.Ze="";this.Ue=-1};a.prototype.$j=function(){this.stream.length&&this.lb.Ep(this.lb.stream(this.stream.join("\n")));this.stream.length=0};a.prototype.toString=function(){this.$j();return this.lb.df()};a.prototype.toBlob=function(){this.$j();return this.lb.toBlob()};a.prototype.setTransform=function(a,d,c,f,g,h){var b=this.Hd.Uc();this.oa=(new F(a,c,d,f,g,h)).multiply(new Mb(0,b.x,b.y)).multiply(new Lb(.75,.75,0,0))};a.prototype.closePath=function(){this.path.push("h")};
a.prototype.fill=function(){this.xj();for(var a=0;a<this.path.length;a++)this.stream.push(this.path[a]);this.stream.push("f")};a.prototype.stroke=function(){this.yj();for(var a=0;a<this.path.length;a++)this.stream.push(this.path[a]);this.stream.push("S")};a.prototype.moveTo=function(a,d){var b=this.oa.apply(a,d);this.path.push(this.lb.Dc(b.x,b.y)+" m");this.x=a;this.y=d};a.prototype.lineTo=function(a,d){var b=this.oa.apply(a,d);this.path.push(this.lb.Dc(b.x,b.y)+" l");this.x=a;this.y=d};a.prototype.bezierCurveTo=
function(a,d,c,f,g,h){a=this.oa.apply(a,d);c=this.oa.apply(c,f);f=this.oa.apply(g,h);this.path.push(this.lb.Dc(a.x,a.y,c.x,c.y,f.x,f.y)+" c");this.x=g;this.y=h};a.prototype.quadraticCurveTo=function(a,d,c,f){this.bezierCurveTo(2/3*a+1/3*this.x,2/3*d+1/3*this.y,2/3*a+1/3*c,2/3*d+1/3*f,c,f)};a.prototype.fillText=function(a,d,c){this.sm(a,d,c,0)};a.prototype.strokeText=function(a,d,c){this.sm(a,d,c,1)};a.prototype.xj=function(){if(this.Ve!==this.fillStyle){if(this.fillStyle instanceof Zc){var a=this.lb.fj(this.fillStyle,
this.oa);this.stream.push("/Pattern cs");this.stream.push(a+" scn")}else"string"===typeof this.fillStyle&&(a=u.vd(this.fillStyle).Lh(u.RGBA),this.stream.push(this.lb.Dc(a.values[0],a.values[1],a.values[2])+" rg"),a=this.lb.To(a.values[3],!0),this.stream.push("/"+a+" gs"));this.Ve=this.fillStyle}};a.prototype.yj=function(){function a(a){return"bevel"===a?2:"round"===a?1:0}function d(a){return"butt"===a?0:"round"===a?1:2}if(this.af!==this.strokeStyle){if(this.strokeStyle instanceof Zc){var c=this.lb.fj(this.strokeStyle,
this.oa);this.stream.push("/Pattern CS");this.stream.push(c+" SCN")}else"string"===typeof this.strokeStyle&&(c=u.vd(this.strokeStyle).Lh(u.RGBA),this.stream.push(this.lb.Dc(c.values[0],c.values[1],c.values[2])+" RG"),c=this.lb.To(c.values[3],!1),this.stream.push("/"+c+" gs"));this.af=this.strokeStyle}this.$e!==this.lineWidth&&(this.$e=this.lineWidth,this.stream.push(this.lb.Dc(72*this.lineWidth/96)+" w"));this.Ze!==this.lineJoin&&(this.Ze=this.lineJoin,this.stream.push(a(this.lineJoin)+" j"));this.Ye!==
this.lineCap&&(this.Ye=this.lineCap,this.stream.push(d(this.lineCap)+" J"))};a.prototype.wp=function(a,d,c,f){var b=this.te(this.font);if(this.Xe!==b.fontSize||this.We!==b.fontFamily){var e=this.lb.Qt(b.fontFamily);this.stream.push(e+" "+this.lb.Dc(parseFloat(b.fontSize))+" Tf");this.Xe=b.fontSize;this.We=b.fontFamily}this.Ue!==f&&(this.stream.push(f+" Tr"),this.Ue=f);0===f?this.xj():this.yj();this.stream.push("BT");d=this.oa.multiply(new F(1,0,0,-1,d,c));this.stream.push(this.lb.Dc(d.m11,d.m21,d.m12,
d.m22,d.Ca,d.Da)+" Tm");this.stream.push(this.lb.Dq(a)+" Tj");this.stream.push("ET")};a.prototype.vp=function(a,d,c,f){var b=this.te(this.font),e=this.Qq.get(b.fontFamily);e?(0===f?this.xj():this.yj(),this.beginPath(),e.yq(this,a,d,c,parseFloat(b.fontSize)),0===f?this.fill():this.stroke()):this.wp(a,d,c,f)};a.prototype.measureText=function(){return{width:1}};a.prototype.te=function(a){var b="",c="",f="normal",g="normal",h="normal",l="normal";a=a.split(/\s+/);a:for(;;){var k=a.shift();if(!k)break;
switch(k){case "normal":break;case "italic":case "oblique":f=k;break;case "small-caps":h=k;break;case "bold":case "bolder":case "lighter":case "100":case "200":case "300":case "400":case "500":case "600":case "700":case "800":case "900":g=k;break;default:if(""===c)k=k.split("/"),c=k[0],1<k.length&&(l=k[1]);else{b=k;a.length&&(b+=" "+a.join(" "));break a}}}b&&(b=b.replace(/"/g,""));return{fontStyle:f,fontVariant:h,fontWeight:g,fontSize:c,lineHeight:l,fontFamily:b}};a.prototype.qj=function(a,d,c,f,
g,h,l,k,m){this.log("DrawImage(%s, %s, %s, %s, %s, %s, %s %s)",d,c,f,g,h,l,k,m);l+=m;var b=document.createElement("canvas"),e=b.getContext("2d");b.width=f;b.height=g;e.drawImage(a,-d,-c);a=this.lb.ej(a instanceof HTMLImageElement?[a.src,d,c,f,g].join():a,b);this.stream.push("q");h=this.oa.multiply(new F(k,0,0,-m,h,l));this.stream.push(this.lb.Dc(h.m11,h.m21,h.m12,h.m22,h.Ca,h.Da)+" cm");this.stream.push(a+" Do");this.stream.push("Q")};a.prototype.df=function(){return this.lb.df()};a.prototype.tj=
function(){return{}};a.prototype.wj=function(){};a.prototype.clip=function(){for(var a=0;a<this.path.length;a++)this.stream.push(this.path[a]);this.stream.push("W");this.stream.push("n");this.path.length=0};return a}(ad);var fd=function(){function c(){this.ba=[]}c.prototype.lineTo=function(a,b,d){a.apply(b,d);this.ba.push({kg:"L",Nf:a.apply(b,d)})};c.prototype.moveTo=function(a,b,d){a.apply(b,d);this.ba.push({kg:"M",Nf:a.apply(b,d)})};c.prototype.quadraticCurveTo=function(a,b,d,c,f){this.ba.push({kg:"Q",Nf:a.apply(b,d),Fi:a.apply(c,f)})};c.prototype.bezierCurveTo=function(a,b,d,c,f,g,h){this.ba.push({kg:"C",Nf:a.apply(b,d),Fi:a.apply(c,f),Sk:a.apply(g,h)})};c.prototype.closePath=function(){this.ba.push({kg:"Z"})};
c.prototype.wl=function(a){a=a.inverse();for(var b="",d=0;d<this.ba.length;d++){var c=this.ba[d];0<d&&(b+=" ");b+=c.kg;if(c.Nf){var f=a.apply(c.Nf.x,c.Nf.y);b+=f.x+","+f.y;c.Fi&&(f=a.apply(c.Fi.x,c.Fi.y),b+=","+f.x+","+f.y,c.Sk&&(c=a.apply(c.Sk.x,c.Sk.y),b+=","+c.x+","+c.y))}}return b};return c}(),gd=function(c){function a(a){var b=c.call(this)||this;b.oa=new F;b.ba=[];b.path=new fd;b.Ae="";b.Vb=[];b.nb=0;b.log=w.create("SvgContext");b.gg=1;b.tf=2;b.nj=4;b.log("SVG context rect: %s",a);b.root=new sa("svg",
{xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink","xmlns:zwibbler":"http://zwibbler.com/xml",version:1.2,baseProfile:"tiny",width:a.width,height:a.height,viewBox:a.x+" "+a.y+" "+a.width+" "+a.height});b.Sh=new sa("defs",{});b.root.rd(b.Sh);b.Bd=[b.root];return b}n(a,c);a.prototype.cs=function(){return"clip"+this.nb++};a.prototype.Tg=function(a){a=new sa("g",a||{});this.Nj().rd(a);this.Bd.push(a)};a.prototype.Sg=function(){var a=this.Bd.pop();if(a&&1===a.children.length){var d=
a.children[0];d.Ri(a.attributes);a.name=d.name;a.attributes=d.attributes;a.children=d.children;a.text=d.text}};a.prototype.Nj=function(){return this.Bd[this.Bd.length-1]};a.prototype.node=function(a,d,c,f){function b(a,b){if(b instanceof Zc)c[a]="url(#"+e.fj(b)+")";else if("string"===typeof b){var d=u.vd(b),f=d.values[3];1>f&&(d.values[3]=1,c[a+"-opacity"]=""+f);c[a]=d.toString()}}void 0===c&&(c={});var e=this;this.oa.zk()||(c.transform="matrix("+this.oa.m11+" "+this.oa.m21+" "+this.oa.m12+" "+this.oa.m22+
" "+this.oa.Ca+" "+this.oa.Da+")");d&this.gg?b("fill",this.fillStyle):c.fill="none";d&this.tf&&(b("stroke",this.strokeStyle),c["stroke-width"]=this.lineWidth,"miter"!==this.lineJoin&&(c["stroke-linejoin"]=this.lineJoin),"butt"!==this.lineCap&&(c["stroke-linecap"]=this.lineCap));d&this.nj&&(d=this.te(this.font),c["font-weight"]=d.fontWeight,c["font-size"]=parseFloat(d.fontSize),c["font-style"]=d.fontStyle,c["font-family"]=d.fontFamily);""!==this.Ae&&(c["clip-path"]="url(#"+this.Ae+")");this.Cp(new sa(a,
c,f))};a.prototype.Cp=function(a){var b=!0,c=null,f={},g,h=this.Nj();0===h.children.length?b=!1:c=h.children[h.children.length-1];!c||a.name===c.name&&a.text===c.text||(b=!1);if(b&&c)for(g in c.attributes)if(c.attributes.hasOwnProperty(g))if(g in a.attributes){var l=c.attributes[g],k=a.attributes[g];if(l!==k)if(0===g.indexOf("fill")||0===g.indexOf("stroke"))if("none"===l)f[g]=k;else if("none"===k)f[g]=l;else{b=!1;break}else{b=!1;break}}else f[g]=c.attributes[g];if(b&&c)for(g in a.attributes)a.attributes.hasOwnProperty(g)&&
(g in c.attributes||(f[g]=a.attributes[g]));b&&c?c.Ri(f):h.rd(a)};a.prototype.wi=function(a){if(a===this.tf){if(0===this.lineWidth)return!1;a=this.strokeStyle}else a=this.fillStyle;return a instanceof Zc?!0:"string"===typeof a?0<u.vd(a).values[3]:!1};a.prototype.mm=function(a){for(var b=0;b<this.Vb.length;b++)if(this.Vb[b].Gg===a)return this.Vb[b].Pg;return null};a.prototype.ej=function(a){var b=this.mm(a);if(b)return b;b="image"+this.Vb.length;this.Vb.push({Gg:a,Pg:b});var c=document.createElement("canvas"),
f=c.getContext("2d");c.width=a.width;c.height=a.height;f.drawImage(a,0,0);c=c.toDataURL();a=new sa("image",{id:b,x:0,y:0,width:a.width,height:a.height,"xlink:href":c});this.Sh.rd(a);return b};a.prototype.fj=function(a){var b=this.mm(a);if(b)return b;var c=this.ej(a.Ha);b="pattern"+this.Vb.length;this.Vb.push({Gg:a,Pg:b});var f=new sa("pattern",{id:b});"no-repeat"===a.repeat?(f.attributes.width="1",f.attributes.height="1"):"repeat-x"===a.repeat?(f.attributes.patternUnits="userSpaceOnUse",f.attributes.width=
a.Ha.width,f.attributes.height=1E4):("repeat-y"===a.repeat?(f.attributes.patternUnits="userSpaceOnUse",f.attributes.width=1E4):(f.attributes.patternUnits="userSpaceOnUse",f.attributes.width=a.Ha.width),f.attributes.height=a.Ha.height);f.rd(new sa("use",{"xlink:href":"#"+c}));this.Sh.rd(f);return b};a.prototype.toString=function(){return'<?xml version="1.0" encoding="UTF-8"?>\n'+this.root.toString()};a.prototype.toBlob=function(){for(var a=this.toString(),d=new Uint8Array(a.length),c=0;c<a.length;c++)d[c]=
a.charCodeAt(c);return new Blob([d],{type:"image/svg+xml"})};a.prototype.beginPath=function(){this.path=new fd};a.prototype.transform=function(a,d,c,f,g,h){a=new F(a,c,d,f,g,h);this.oa=this.oa.multiply(a)};a.prototype.closePath=function(){this.path.closePath()};a.prototype.fill=function(){this.wi(this.gg)&&this.node("path",this.gg,{d:this.path.wl(this.oa)})};a.prototype.stroke=function(){this.wi(this.tf)&&this.node("path",this.tf,{d:this.path.wl(this.oa)})};a.prototype.moveTo=function(a,d){this.path.moveTo(this.oa,
a,d)};a.prototype.lineTo=function(a,d){this.path.lineTo(this.oa,a,d)};a.prototype.quadraticCurveTo=function(a,d,c,f){this.path.quadraticCurveTo(this.oa,a,d,c,f)};a.prototype.bezierCurveTo=function(a,d,c,f,g,h){this.path.bezierCurveTo(this.oa,a,d,c,f,g,h)};a.prototype.fillText=function(a,d,c){this.wi(this.gg)&&(this.te(this.font),this.node("text",this.gg|this.nj,{x:d,y:c},a))};a.prototype.strokeText=function(a,d,c){this.wi(this.tf)&&(this.te(this.font),this.node("text",this.tf|this.nj,{x:d,y:c},a))};
a.prototype.qj=function(a,d,c,f,g,h,l,k,m){var b=document.createElement("canvas"),e=b.getContext("2d");b.width=f;b.height=g;e.drawImage(a,-d,-c);a=b.toDataURL();this.Nj().rd(new sa("image",{transform:"matrix("+this.oa.m11+" "+this.oa.m21+" "+this.oa.m12+" "+this.oa.m22+" "+this.oa.Ca+" "+this.oa.Da+")",x:h,y:l,width:k,height:m,"xlink:href":a}))};a.prototype.measureText=function(){return{width:1}};a.prototype.Zf=function(){};a.prototype.tj=function(){return{name:this.Ae}};a.prototype.wj=function(a){this.Ae=
a?a.name:""};a.prototype.clip=function(){var a=this.cs(),d=new sa("clipPath",{id:a});d.rd(new sa("path",{d:this.path.wl(this.oa)}));this.Sh.rd(d);this.Ae=a;this.path=new fd};return a}(ad);var hd=new (function(){function c(){this.log=w.create("serializer");this.Sl={pdf:"application/pdf",svg:"image/svg+xml",png:"image/png",jpeg:"image/jpeg",jpg:"image/jpeg",bmp:"image/bmp"}}c.prototype.rh=function(a){if(a instanceof Array)var b=this.En(a);else{if("string"!==typeof a)return this.log("Can only open an array or string as a document."),null;if("{"===a.charAt(0))b=this.Zr(a);else if(0===a.indexOf("zwibbler3."))b=JSON.parse(a.substr(10)),b=this.En(b);else if(0===a.indexOf("zwibblerclip."))b=
new Yc(!1),a=b.Pn(a,new F),b.pa(a),b.Vg();else throw Error("Format detection failed.");}for(a=1;a<b.Hc();a++)b.zl(a,!1);return b};c.prototype.Zr=function(a){function b(a){var b=new F;b.m11=a.m11;b.m12=a.m12;b.m21=a.m21;b.m22=a.m22;b.Ca=a.dx;b.Da=a.dy;return b}function d(a,c){switch(a.type){case "Node":for(var e=[],h=a.children,k=h.length-1;0<=k;k--){var l=f.nb;try{d(h[k],c+1)}catch(y){continue}e.push(l)}0<c&&g.push(new Gc(f.$a(),e));break;case "PathNode":case "ArrowNode":var r=a;h=0;"arrowSize"in
r&&(h=r.arrowSize,r=r.path);e=b(r.matrix);h={strokeStyle:r.strokeStyle,fillStyle:r.fillStyle,lineWidth:r.lineWidth,smoothness:r.smoothness,sloppiness:r.sloppiness,shadow:r.shadow,arrowSize:h,seed:Math.round(65535*Math.random())};"textNode"in r&&(k=r.textNode,h.fontSize=k.fontSize,h.fontName=k.fontName,h.text=k.text,h.textFillStyle="textFillStyle"in k?k.textFillStyle:k.fillStyle);"path"in r&&(r=r.path);var v=r.startX,x=r.startY;k=r.closed;l=new R;r=r.segments;v=e.apply(v,x);l.moveTo(v.x,v.y);for(v=
0;v<r.length;v++){var I=r[v];switch(I.type){case 1:x=e.apply(I.x,I.y);l.lineTo(x.x,x.y);break;case 2:x=e.apply(I.x,I.y);l.og(x.x,x.y);break;case 3:x=e.apply(I.x1,I.y1);I=e.apply(I.x,I.y);l.De(x.x,x.y,I.x,I.y);break;default:throw"Unknown path segment type: "+I.type;}}k&&l.close();h.commands=l.Sb();g.push(new S(f.$a(),"PathNode",h));break;case "TextNode":e=b(a.matrix);e=e.multiply(new E(0,1.3*a.fontSize));e={fillStyle:a.fillStyle,lineWidth:0,text:a.text,fontName:a.fontName,fontSize:a.fontSize,matrix:e};
g.push(new S(f.$a(),"TextNode",e));break;default:throw Error("Unknown node type: "+a.type);}}var c=w.create("IMPORT"),f=new Yc,g=[];try{var h=JSON.parse(a)}catch(l){a=a.replace(/\\\\/g,"\\").replace(/\\"/g,'"');try{h=JSON.parse(a)}catch(k){throw c("Couldn't parse file."),"Couldn't parse file.";}}c("Successfully parsed!");d(h,0);f.pa(g);return f};c.prototype.En=function(a){function b(a,d){if(void 0!==a){var e={};for(var g in a)a.hasOwnProperty(g)&&"children"!==g&&"parent"!==g&&"id"!==g&&"type"!==g&&
(e[g]="matrix"===g?new F(a[g]):a[g]);g=f;0!==a.id&&c.push(new S(g,a.type,e,d,-1));f+=1;if(void 0!==a.children)for(e=0;e<a.children.length;e++)b(a.children[e],g)}}var d;a=JSON.parse(JSON.stringify(a));var c=[],f=0,g={},h=!1;for(d=0;d<a.length;d++){var l=a[d];if("document"===l.type)delete l.type,c.push(new Mc(l));else{"PageNode"===l.type&&(h=!0);if("parent"in l){if(!(l.parent in g))throw"Error: child "+l.id+" references parent "+l.parent+" before it was defined.";var k=g[l.parent];void 0!==k.children?
k.children.push(l):k.children=[l]}"GroupNode"!==l.type&&"PageNode"!==l.type||void 0!==l.children||(l.children=[]);g[l.id]=l}}h||(f+=1);b(g[0],f);for(d=0;d<c.length;d++)this.log(c[d].toString());a=new Yc(h);a.pa(c);a.Vg();return a};c.prototype.Xm=function(a){function b(a,c){var e={id:c.id,type:c.type()};d.push(e);a&&(e.parent=a.id);var f=c.ec(),g;for(g in f)f.hasOwnProperty(g)&&("matrix"===g?e[g]=f[g].Sb():"inverse"!==g&&(e[g]=f[g]));if(c.In()&&c.children)for(e=0;e<c.children.length;e++)b(c,c.children[e])}
var d=[],c={type:"document"},f=!1,g;for(g in a.aa)a.aa.hasOwnProperty(g)&&(c[g]=a.aa[g],f=!0);f&&d.push(c);b(null,a.getRootNode());return d};c.prototype.sh=function(a,b,d){b in this.Sl&&(b=this.Sl[b]);if("list"===b)a=this.Xm(a),b="application/json";else if("zwibbler3"===b)a=this.Xm(a),a="zwibbler3."+JSON.stringify(a),b="application/octet-stream";else if("image/svg+xml"===b){var c=a.bd();var f=new gd(c);a.td(f);a.ha(f);a=f;b="image/svg+xml"}else if("application/pdf"===b){c=a.bd();f=new ed(new D(0,
0,c.width,c.height),O.fonts);var g=a.Sa;for(b=0;b<a.Hc();b++)0<b&&f.Zf(),f.translate(-c.x,-c.y),a.Rb(b),a.td(f),a.ha(f);a.Rb(g);a=f;b="application/pdf"}else if(!(c="image/png"===b||"image/bmp"===b)&&(c="image/jpeg"==b)&&(c=document.createElement("canvas"),f=!1,c.width=10,c.height=10,"toDataURL"in c&&(f=0<c.toDataURL("image/jpeg").indexOf("jpeg")),ob("JPEG supported: %s",f),c=f),c)f=document.createElement("canvas"),c=a.bd(),f.width=c.width,f.height=c.height,g=f.getContext("2d"),g.translate(-c.x,-c.y),
a.td(g),a.ha(g),a="image/bmp"===b?Db(f):f.toDataURL(b),a=a.split(",")[1],a=atob(a);else throw"Unknown save format: "+b;if("string"===typeof a)if("string"===d)var h=a;else if("data-uri"===d)h="data:"+b+";base64,"+qa(a);else{if("blob"===d)for(d=new Uint8Array(a.length),b=0;b<a.length;b++)d[b]=a.charCodeAt(b)}else if(a.toBlob&&a.toString)"string"===d?h=a.toString():"data-uri"===d?h="data:"+b+";base64,"+qa(a.toString()):"blob"===d&&(h=a.toBlob());else if("object"===d)h=a;else throw"Error in ZwibblerDocument.save()";
return h};return c}());var id=function(){function c(a,b,d){void 0===d&&(d=!1);var c=this;this.sa=a;this.Ik=0;this.Ck={};this.tb=!1;this.timeout=null;this.lines=[];this.filter=null;this.Lj="#ffffff #008800 #008888 #880000 #880088 #884400 #888888 #444444 #0000ff #00ff00 #00ffff #ff0000 #ff00ff #ffff00".split(" ");nb('\n\n.z-inner-debug.black {\n    background: #000;\n}\n\n.z-inner-debug.white {\n    background: #fff;\n}\n\n.z-debug-panel {\n    font-family: "monospace";\n    font-size: 12px;\n    display: flex;\n    flex-flow: column nowrap;\n}\n\n.z-inner-debug {\n    flex: 1 1 auto;\n    overflow: scroll;\n}\n\n.z-inner-debug.black div {\n    border-bottom: 1px solid #222;\n    margin-bottom: 3px;\n}\n\n.z-inner-debug.white div {\n    border-bottom: 1px solid #eee;\n    margin-bottom: 3px;\n}\n');
a.classList.add("z-debug-panel");var f=0;z("input").Ri({type:"text",placeholder:"regexp...",onclick:"this.select()"}).Sd(a).addEventListener("input",function(a){f&&window.clearTimeout(f);f=setTimeout(function(){c.lt(a.target.value);f=0},200)});this.fd=z("div").ue("z-inner-debug").Sd(a).Ga;this.Xr=w.addListener(function(a,b){return c.wm(a,b)});b.add(function(){w.removeListener(c.Xr)});this.wm("DEBUG","Debug window starting");z(this.fd).ue(d?"white":"black");this.Lj[0]=d?"#000000":"#ffffff"}c.prototype.show=
function(){this.sa.style.display="flex";this.tb=!0;this.fm();this.fd.scrollTop=this.fd.scrollHeight};c.prototype.be=function(){this.sa.style.display="none";this.tb=!1};c.prototype.br=function(a){a in this.Ck||(this.Ck[a]=this.Lj[this.Ik],this.Ik=(this.Ik+1)%this.Lj.length);return this.Ck[a]};c.prototype.wm=function(a,b){for(var d=this,c=0,f=b.split("\n");c<f.length;c++)this.lines.push({key:a,line:f[c]});this.tb&&null===this.timeout&&(this.timeout=setTimeout(function(){d.timeout=null;d.fm()},100))};
c.prototype.lt=function(a){this.filter=2>a.length?null:new RegExp(a,"i");for(a=this.fd.firstChild;a;){var b=a;1===b.nodeType&&"DIV"===b.tagName&&(!this.filter||this.filter.exec(b.textContent)?b.style.display="block":b.style.display="none");a=a.nextSibling}};c.prototype.fm=function(){for(var a=this.fd.scrollTop>this.fd.scrollHeight-this.fd.clientHeight-100,b=0,d=this.lines;b<d.length;b++){var c=d[b],f=this.br(c.key),g=document.createElement("div");g.style.color=f;c=c.key+": "+c.line;this.filter&&!this.filter.exec(c)&&
(g.style.display="none");g.appendChild(document.createTextNode(c));this.fd.appendChild(g)}a&&(this.fd.scrollTop=this.fd.scrollHeight);this.lines.length=0};return c}();var jd=function(){function c(){this.rg=[];this.log=w.create("DESTRUCTOR")}c.prototype.add=function(a){this.rg.push(a)};c.prototype.addEventListener=function(a,b,c){a.addEventListener(b,c);this.add(function(){a.removeEventListener(b,c)})};c.prototype.qg=function(){this.log("Running %s destructors",this.rg.length);for(var a=this.rg.length-1;0<=a;a--)this.rg[a]();this.rg.length=0};return c}();var kd=function(c){function a(){var a=c.call(this)||this;a.keys={};a.Ci=!0;a.Bt=new RegExp("alt backspace cmd command control ctrl del delete down end enter esc escape f4 home ins insert left meta pagedown pageup right shift up \u2318".split(" ").sort(function(a,b){return b.length-a.length}).join("|"),"g");a.log=w.create("KEYMAP");a.wn=function(b){a.Lr(b)};return a}n(a,c);a.prototype.map=function(a,c,e){void 0===e&&(e=!0);a=a.toLowerCase().split(",");var b;if("string"===typeof c)for(c=c.split(","),
b=0;b<a.length;b++)for(var d=0;d<c.length;d++)this.gm(a[b],c[d],!e);else for(b=0;b<a.length;b++)this.gm(a[b],c,!e)};a.prototype.gm=function(a,c,e){if(0!==a.length){var b=a.match(this.Bt)||[],d=!1,h=!1,l=!1,k=!1,m=[],q;for(q=0;q<b.length;q++)switch(b[q]){case "alt":l=!0;break;case "control":case "ctrl":h=!0;break;case "shift":d=!0;break;case "home":m.push(36);break;case "end":m.push(35);break;case "pageup":m.push(33);break;case "pagedown":m.push(34);break;case "delete":case "del":m.push(46);break;
case "backspace":m.push(8);break;case "up":m.push(38);break;case "right":m.push(39);break;case "down":m.push(40);break;case "left":m.push(37);break;case "escape":case "esc":m.push(27);break;case "enter":m.push(13);break;case "ins":case "insert":m.push(45);break;case "f4":m.push(115);break;case "meta":case "command":case "cmd":case "\u2318":k=!0;break;default:alert("key entry not found: "+b[q])}var p=this;b=function(a){d&&-1===a.indexOf("-shift")&&(a+="-shift");h&&-1===a.indexOf("-control")&&(a+="-control");
l&&-1===a.indexOf("-alt")&&(a+="-alt");k&&-1===a.indexOf("-meta")&&(a+="-meta");"string"===typeof c?p.log("%sKeyboard mapping: %s->%s",e?"Remove ":"",a,c):p.log("%sKeyboard mapping: %s->%s",e?"Remove ":"",a,"function()");if(e){if(a in p.keys){for(var b=[],f=0,g=p.keys[a];f<g.length;f++){var m=g[f];m!==c&&b.push(m)}p.keys[a]=b}}else if(a in p.keys){f=p.keys[a];for(b=0;b<f.length&&f[b]!==c;b++);b===f.length&&p.keys[a].push(c)}else p.keys[a]=[c]};if(0===m.length)switch(a=a.toUpperCase().charAt(a.length-
1),a){case "=":b("107-shift");b("187");b("61");break;case "+":b("107");b("61-shift");break;case "-":b("109");b("189");b("173");break;default:m.push(a.charCodeAt(0))}for(q=0;q<m.length;q++)b(""+m[q])}};a.prototype.qr=function(a){var b="";a.keyCode&&(b+=a.keyCode);a.shiftKey&&(b+="-shift");a.ctrlKey&&(b+="-control");a.altKey&&(b+="-alt");a.metaKey&&(b+="-meta");return b};a.prototype.translate=function(a){var b=[];a=this.qr(a);a in this.keys&&(b=this.keys[a]);this.log("%s",a);return b};a.prototype.Lr=
function(a){for(var b=0,c=this.translate(a);b<c.length;b++){var f=c[b];"string"===typeof f?(this.log("action: %s",f),this.$d("*",f,a)):f(a)}};a.prototype.Jp=function(a){a.addEventListener("keydown",this.wn)};a.prototype.detach=function(a){a.removeEventListener("keydown",this.wn)};return a}(Pc);var ld=new (function(){function c(){this.bk={}}c.prototype.Eh=function(){if("localStorage"in window)try{var a=window.localStorage}catch(b){}return void 0!==a};c.prototype.setItem=function(a,b){this.Eh()?window.localStorage.setItem(a,b):this.bk[a]=""+b};c.prototype.getItem=function(a){return this.Eh()?window.localStorage.getItem(a):this.bk[a]};c.prototype.removeItem=function(a){this.Eh()?window.localStorage.removeItem(a):delete this.bk[a]};return c}());function md(c){function a(a){b&&clearTimeout(b);b=setTimeout(function(){b=null;c()},arguments.length?a:1E3)}var b=null;a.cancel=function(){b&&(clearTimeout(b),b=null)};return a};var od=function(){function c(a,b,c,e,f,g,h){this.view=a;this.node=b;this.handle=c;this.bf=g;this.eh=this.dh=0;this.log=w.create("MoveEditNode");this.ho=b.ei(c);this.Ma=b.ka("snap")||0;this.Ta(e,f,h)}c.prototype.Fc=function(){this.log("Entering MoveEditNode")};c.prototype.Ac=function(){this.log("Leaving MoveEditNode")};c.prototype.rb=function(a){if("touchmove"===a.type){var b=a.touches[0];b=this.view.Za(b.pageX,b.pageY);return this.Va(b.x,b.y,a)}return"touchend"===a.type?(b=a.changedTouches[0],b=this.view.Za(b.pageX,
b.pageY),this.Wa(b.x,b.y,a)):!1};c.prototype.Ta=function(a,b){var c=this.view.Ma(new A(a,b),this.Ma);a=c.x;b=c.y;this.log("onMouseDown(%s,%s)",a,b);this.dh=a;this.eh=b;return!0};c.prototype.Va=function(a,b){var c=this.view.Ma(new A(a,b),this.Ma);a=c.x;b=c.y;this.node.Oe(this.handle,a,b);this.node.format(this.view.ia,this.view.request);this.view.ha();return!1};c.prototype.Wa=function(a,b){var c=this.view.Ma(new A(a,b),this.Ma);a=c.x;b=c.y;this.log("onMouseUp(%s,%s)",a,b,this.dh,this.eh);a!==this.dh||
b!==this.eh?this.view.pa([new Fc(this.node.id,this.handle,this.ho.x,this.ho.y,a,b)]):this.view.at(this.node.id,this.handle);this.view.ha();this.view.fb(this.bf||new nd(this.view));return!0};return c}();var pd=function(){function c(a,b,c,e){this.view=a;this.bf=b;this.Da=this.Ca=0;this.Ra=!1;this.log=w.create("SELECT");this.co(c,e)}c.prototype.rb=function(a){if("touchmove"===a.type){var b=this.view.Zb(a.changedTouches[0]);this.Va(b.x,b.y,a)}else"touchend"===a.type&&(b=this.view.Zb(a.changedTouches[0]),this.Wa(b.x,b.y,a));return!0};c.prototype.bb=function(a){this.log("Gesture detected; aborting select box.");this.view.fb(this.bf);return this.bf.bb?this.bf.bb(a):!1};c.prototype.Ta=function(a,b){return this.co(a,
b)};c.prototype.co=function(a,b){this.Ca=a;this.Da=b;return this.Ra=!0};c.prototype.Va=function(a,b){if(this.Ra){var c=this;this.view.ha(function(d){d.save();d.strokeStyle="#0050B7";d.lineWidth=2/c.view.scale;d.fillStyle="rgba(0, 80, 183, 0.2)";var e=new D(c.Ca+.5,c.Da+.5,a-c.Ca,b-c.Da);d.fillRect(e.x,e.y,e.width,e.height);d.strokeRect(e.x,e.y,e.width,e.height);d.restore()});return!0}return!1};c.prototype.Wa=function(a,b){this.Ra=!1;this.view.pb();this.view.$s(new D(this.Ca,this.Da,a-this.Ca,b-this.Da));
this.view.Mb();this.view.ha();this.view.fb(this.bf);return!0};return c}();var qd={type:"translate",position:new A(0,0),offset:new A(0,0),Ne:""},rd={type:"translate",position:new A(0,0),offset:new A(0,0),Ne:""},sd={type:"translate",position:new A(0,0),offset:new A(0,0),Ne:""},td=function(){function c(a,b,c){this.me=a;this.oa=b;this.Pa=c}c.prototype.li=function(a,b){void 0===a&&(a=this.oa);void 0===b&&(b=1);var c=a.Ad();return new A(this.Pa.x+this.Pa.width*this.me.position.x+this.me.offset.x/c.x/b,this.Pa.y+this.Pa.height*this.me.position.y+this.me.offset.y/c.y/b)};c.prototype.rk=
function(){var a=this.li();return this.oa.apply(a.x,a.y)};c.prototype.ha=function(a,b,c,e){a.save();e=e.multiply(this.oa);var d=e.Ad();d.x=1/d.x/c;d.y=1/d.y/c;c=this.li(e,c);e=e.multiply(new Lb(d.x,d.y,c.x,c.y));e.nf(a);(b=b.get(this.me.Ne))?(e=b.width,d=b.height,a.drawImage(b,c.x-e/2,c.y-d/2,e,d)):this.Xj(a,c);a.restore()};c.prototype.Xj=function(a,b){a.strokeStyle="red";a.lineWidth=1;a.strokeRect(b.x-10,b.y-10,20,20)};c.prototype.xb=function(a,b,c,e,f){var d=a.get(this.me.Ne);a=this.li(this.oa,
f);b=this.oa.inverse().apply(b,c);c=this.oa.Ad();c.x*=f;c.y*=f;d?(e=d.height,f=d.width/2/c.x,e=e/2/c.y):(f=e/c.x,e/=c.y);return(new D(a.x-f,a.y-e,2*f,2*e)).Vc(b.x,b.y,0)};c.prototype.click=function(){return!1};return c}(),ud=function(c){function a(a,d,e,f){a=c.call(this,a,d,e)||this;a.origin=f;return a}n(a,c);a.prototype.Ef=function(a){var b=1,c=1,f=this.oa.inverse(),g=this.rk(),h=this.li();a=f.apply(g.x+a.x,g.y+a.y);h=new A(h.x-this.origin.x,h.y-this.origin.y);a=new A(a.x-this.origin.x,a.y-this.origin.y);
a=(a.x*h.x+a.y*h.y)/(h.x*h.x+h.y*h.y);0!==h.x&&0!==h.y?c=b=a:0!==h.x?b=a:c=a;return this.oa.multiply(new Lb(b,c,this.origin.x,this.origin.y)).multiply(f)};a.prototype.Xj=function(a,c){a.beginPath();a.strokeStyle="#000";a.lineWidth=1;a.rect(c.x-4,c.y-4,8,8);a.stroke()};return a}(td),vd=function(c){function a(a,d,e,f,g){a=c.call(this,a,d,e)||this;a.Kh=g;a.log=w.create("RotationSelHandle");d=a.rk();a.origin=a.oa.apply(f.x,f.y);a.ol=Math.atan2(d.y-a.origin.y,d.x-a.origin.x);a.Kh=g;return a}n(a,c);a.prototype.Ef=
function(a){var b=this.rk();a=Math.atan2(b.y+a.y-this.origin.y,b.x+a.x-this.origin.x)-this.ol;this.Kh&&(b=Math.PI/16,a=Math.floor(a/b)*b);return new Kb(-a,this.origin.x,this.origin.y)};a.prototype.Xj=function(a,c){a.beginPath();a.strokeStyle="#008000";a.lineWidth=3;a.moveTo(c.x,c.y);a.arc(c.x,c.y,6,0,1.5*Math.PI,!1);a.stroke()};return a}(td),wd=function(c){function a(a,d){return c.call(this,a,d,new D(0,0,0,0))||this}n(a,c);a.prototype.Ef=function(a){return new E(a.x,a.y)};return a}(td),xd=function(c){function a(){return c.call(this,
sd,new F,new D(0,0,0,0))||this}n(a,c);a.prototype.Ef=function(){return new F};return a}(td),yd=function(c){function a(a,d,e){return c.call(this,a,d,e)||this}n(a,c);a.prototype.click=function(){this.me.Jm&&this.me.Jm();return!0};a.prototype.Ef=function(){return new F};return a}(td);
function zd(c,a,b,d){var e=void 0,f=new A(0,0),g=b.Ad();f.x=a.x+a.width*c.position.x+c.offset.x/g.x;f.y=a.y+a.height*c.position.y+c.offset.y/g.y;switch(c.type){case "translate":return new wd(c,b);case "scale":return e||(e=new A(a.right()-c.position.x*a.width,a.bottom()-c.position.y*a.height)),new ud(c,b,a,e);case "rotate":return e||(e=a.Uc()),new vd(c,b,a,e,d||!1);case "click":return new yd(c,b,a)}};function Ad(c){for(var a=[],b=0;b<c.length;b++)a.push(c[b].id);return a}
var Bd=function(){function c(a,b,c,e,f,g){this.view=a;this.handle=b;this.Ht=c;this.Wg=new D(0,0,0,0);this.ra=[];this.If=[];this.kd=new A(0,0);this.log=w.create("TransformSelectionBehaviour");this.Bn=!1;this.Ma=0;this.Ta(e,f,g)}c.prototype.rb=function(a){var b;if(this.Bn||"touchmove"!==a.type&&"touchstart"!==a.type&&"touchend"!==a.type)return!1;for(b=0;b<a.touches.length;){b=a.touches[b];b=this.view.Za(b.pageX,b.pageY);"touchmove"===a.type&&this.Va(b.x,b.y,a);break}for(b=0;b<a.changedTouches.length;){b=
a.changedTouches[b];b=this.view.Za(b.pageX,b.pageY);"touchend"===a.type&&this.Wa(b.x,b.y,a);break}return!0};c.prototype.bb=function(a){if("gesturestart"!==a.type&&"gesturechange"!==a.type&&"gestureend"!==a.type)return!1;this.log("%s scale=%s rotation=%s",a.type,a.scale,a.rotation);this.Bn=!0;var b=this.Wg.x+this.Wg.width/2,c=this.Wg.y+this.Wg.height/2,e=a.scale;this.view.Oi||(e=1);var f=-a.rotation/180*Math.PI;if(0<this.view.fa.get("snap")){var g=Math.PI/16;f=Math.floor(f/g)*g}e=new Lb(e,e,b,c);b=
new Kb(f,b,c);b=e.multiply(b);for(c=0;c<this.ra.length;c++)this.ra[c].Vf(b.multiply(this.If[c])),this.ra[c].format(this.view.ia,this.view.request);this.view.aj(b);this.view.ha();if("gestureend"===a.type){for(c=0;c<this.ra.length;c++)this.ra[c].Vf(this.If[c]);this.view.pa([new Ec(Ad(this.ra),b)]);this.Wm()}return!0};c.prototype.Ta=function(a,b){this.ra=this.view.ad();this.Gq(this.ra);this.kd=this.view.Ma(new A(a,b),this.Ma);this.log("onMouseDown(%s,%s)",this.kd.x,this.kd.y);this.Wg=new D(this.view.Oc.x,
this.view.Oc.y,this.view.Oc.width,this.view.Oc.height);return!0};c.prototype.Gq=function(a){this.If=[];for(var b=0;b<a.length;b++)this.If.push(a[b].Ea()),this.Ma=this.Ma||a[b].ka("snap")};c.prototype.Va=function(a,b){var c=this;var e=this.view.Ma(new A(a,b),this.Ma);var f=e.x;var g=e.y;for(var h=this.handle.Ef(new A(e.x-this.kd.x,e.y-this.kd.y)),l=0;l<this.ra.length;l++)e=h.multiply(this.If[l]),this.ra[l].Vf(e),this.ra[l].format(this.view.ia,this.view.request);this.view.aj(h);this.view.ha(function(){if(c.handle instanceof
vd){var a=c.view.ia;a.save();a.beginPath();a.strokeStyle="#0050B7";a.lineWidth=1/c.view.scale;a.moveTo(c.handle.origin.x,c.handle.origin.y);a.lineTo(f,g);a.stroke();a.restore()}});return!0};c.prototype.Wa=function(a,b){var c=a,e=b,f=this.view.Ma(new A(a,b),this.Ma);a=f.x;b=f.y;this.log("onMouseUp(%s,%s)",a,b);if(f.ud(this.kd))this.Ht?(c=this.view.ea.xb(c,e,this.view.Qa))&&c.Fg()?(this.log("Didn't move, and has edit mode. Selecting node %s",c.id),this.view.pb(),this.view.jf(c)):this.log("Didn't move, but node has no edit mode or failed hittest"):
this.log("Didn't move, but toggleEditNode=false");else{this.log("Moved by %s,%s",a-this.kd.x,b-this.kd.y);c=this.handle.Ef(new A(f.x-this.kd.x,f.y-this.kd.y));for(e=0;e<this.ra.length;e++)this.ra[e].Vf(this.If[e]);this.view.pa([new Ec(Ad(this.ra),c)])}this.Wm();return!0};c.prototype.Wm=function(){this.view.aj(new F);this.view.Af();this.view.update(!0);this.view.eb()};return c}();var Cd=function(){function c(a,b){this.view=a;this.aa=b;this.Zh=!1;this.xa=this.Zd=this.ja=null;this.fillStyle="#000000";this.Zi=!1;this.sl="normal";this.log=w.create("Text");this.multiline=a.fa.get("multilineText");this.qb=document.createElement("div");a.fa.get("iPadNoScrollText")&&null!==navigator.userAgent.match(/iPad|iPhone|Android/i)&&(this.sl="top")}c.prototype.Fc=function(){this.log("Entering text mode");this.view.canvas.style.cursor="text"};c.prototype.Ac=function(){this.Zh&&this.Oh();this.view.canvas.style.cursor=
"default";this.log("Leaving text mode");this.ja&&this.ja.parentNode&&(this.ja.parentNode.removeChild(this.ja),this.ja=null);this.qb.parentNode&&this.qb.parentNode.removeChild(this.qb)};c.prototype.rb=function(a){if("touchstart"!==a.type&&"touchend"!==a.type&&"touchmove"!==a.type)return!1;for(var b=0;b<a.touches.length;b++){var c=a.touches[b];c=this.view.Za(c.pageX,c.pageY);"touchstart"===a.type&&this.Ta(c.x,c.y,a)}return!0};c.prototype.Ta=function(a,b,c){this.log("onMouseDown(%s)",c.type);this.Zh?
(this.log("Editing somewhere else on mousedown; submit that first."),this.Oh(),this.view.fa.get("autoPickToolText")&&this.view.eb()):(c=this.view.ea.xb(a,b,this.view.Qa),this.ql(c,a,b));this.log("Eating click");this.view.Yh=!0;return!1};c.prototype.Fq=function(){if(this.qb&&this.ja){this.qb.style.fontSize=this.ja.style.fontSize;this.qb.style.fontFamily=this.ja.style.fontFamily;this.qb.style.fontWeight=this.ja.style.fontWeight;this.qb.style.fontStyle=this.ja.style.fontStyle;this.qb.style.whiteSpace=
"pre-line";this.qb.style.position="absolute";this.qb.style.visibility="hidden";this.qb.style.backgroundColor="rgba(0,0,0,0.2)";document.body.appendChild(this.qb);this.qb.style.left="0";for(this.qb.style.top="0";this.qb.firstChild;)this.qb.removeChild(this.qb.firstChild);this.qb.appendChild(document.createTextNode(this.ja.value));var a=this.qb.clientWidth,b=this.ja.clientWidth;b<a&&(b=a,this.view.fa.get("multilineText")&&b>500*this.view.scale&&(b=500*this.view.scale),this.ja.style.width=b+2+"px")}};
c.prototype.ql=function(a,b,c){function d(){p.ja&&(p.log("Set editBox height to %s",""+p.ja.scrollHeight+"px"),p.ja.style.height=""+p.ja.scrollHeight+"px",p.ja.style.width=""+p.ja.scrollWidth+"px");t=null}function f(){null===p.xa&&p.Fq()}var g=0;this.Zi=!1;if(a&&"TextNode"===a.type()||a&&"PathNode"===a.type()&&this.view.fa.get("allowTextInShape")){this.xa=a;"top"!==this.sl&&"TextNode"===a.type()&&this.xa.ke(!0);this.view.ha();this.Zd=new A(a.rect.x,a.rect.y);var h=a.ka("fontName");var l=a.ka("fontSize");
var k=a.ka("bold");var m=a.ka("italic");var q=a.ka("textDecoration");g=a.rect.width*this.view.scale;g=Math.max(g,200);this.fillStyle=a.ka("textFillStyle")||this.Ia("textFillStyle")}else this.xa=null,this.Zd=new A(b,c),h=this.Ia("fontName"),l=this.Ia("fontSize"),k=this.Ia("bold"),m=this.Ia("italic"),q=this.Ia("textDecoration"),this.fillStyle=this.aa.fillStyle||this.Ia("textFillStyle")||this.Ia("fillStyle"),this.Ia("wrap")&&(c-=l);var p=this;this.ja=document.createElement("textarea");a=this.ja.clientHeight;
this.ja.style.width=g?""+g+"px":"auto";g=this.view.Tj(this.Zd.x,this.Zd.y);this.ja.style.position="absolute";this.ja.style.fontFamily=h;this.ja.style.fontSize=""+l*this.view.scale+"px";this.ja.style.overflow="auto";this.ja.style.fontWeight=k?"bold":"normal";this.ja.style.fontStyle=m?"italic":"normal";this.ja.style.padding="0";this.ja.style.border="1px solid #888";this.ja.style.color=this.fillStyle;this.ja.style.backgroundColor=this.Ia("background");this.xa&&"PathNode"===this.xa.type()&&(this.ja.style.backgroundColor=
"white");this.ja.style.textDecoration=q||"none";this.ja.style.textAlign=this.Ia("textAlign");this.ja.style.zIndex=""+(this.view.Ff()+1);this.log("Using z-index %s",this.ja.style.zIndex);"#ffffff"===u.vd(this.fillStyle).toString()&&(this.ja.style.backgroundColor="#808080");h=this.view.canvas.parentElement;l=z(h).dc();m=k=0;"top"===this.sl?(m=z(this.view.canvas).dc(),k=this.view.canvas.clientWidth,g=this.ja.clientWidth,k=m.left+k/2-g/2,m=m.top):(k=Math.round(g.x)-1,m=Math.round(g.y)-1);this.ja.style.WebkitTransitionDuration=
"0";this.ja.style.MozTransitionDuration="0";this.ja.style.msTransitionDuration="0";this.ja.style.OTransitionDuration="0";this.ja.style.transitionDuration="0";this.ja.style.left=k-l.left+"px";this.ja.style.top=m-l.top+"px";h.appendChild(this.ja);Cb(this.ja);this.Zh=!0;this.Zd=new A(b,c+a);this.xa&&(this.ja.value=this.xa.ka("text"));var t=null;t=setTimeout(d,0);this.ja.addEventListener("keydown",function(a){"keydown"===a.type&&(27===a.keyCode&&p.multiline||13===a.keyCode&&(a.shiftKey||!p.multiline)?
(p.log("Enter pressed. create text."),p.Oh(),p.view.Aa.tb&&p.view.wt(a),p.view.fa.get("autoPickToolText")&&p.view.eb()):27===a.keyCode?(p.log("ESC pressed; cancel."),p.cancel(),p.view.eb(),p.view.qc.ua("goto-toolbar")):13===a.keyCode&&(t||(t=setTimeout(d,0))))});this.ja.addEventListener("input",f);this.ja.addEventListener("propertychange",f);this.view.fa.get("leaveTextToolOnBlur")&&(this.ja.addEventListener("focus",function(){p.log("Text focus received.")}),this.ja.addEventListener("blur",function(){p.ja&&
!p.ja.Vk&&(p.log("Text blur received -- removing=%s",!0===p.ja.Vk),p.ja.Vk=!0,p.Oh())}));setTimeout(function(){p.ja&&p.ja.focus()},200);this.ja.focus();this.view.za.ua("edit-text-shown",p.ja)};c.prototype.cancel=function(){this.ja&&(this.ja.Vk=!0,this.ja.parentNode&&this.ja.parentNode.removeChild(this.ja),this.view.za.ua("edit-text-hidden"),this.view.Aa.tb&&this.view.qc.ua("goto-canvas"));this.ja=null;this.Zh=!1;this.xa&&(this.xa.ke(!1),this.view.ha())};c.prototype.Ia=function(a){return a in this.aa?
this.aa[a]:"background"===a?this.view.fa.get("defaultTextBackground"):"wrap"===a?this.view.fa.get("multilineText"):this.view.wa[a]};c.prototype.ki=function(){return{textFillStyle:this.Ia("textFillStyle"),fillStyle:this.Ia("textFillStyle"),bold:this.Ia("bold"),italic:this.Ia("italic"),textDecoration:this.Ia("textDecoration"),strokeStyle:this.Ia("strokeStyle"),lineWidth:this.Ia("lineWidth"),fontName:this.Ia("fontName"),fontSize:this.Ia("fontSize"),textAlign:this.Ia("textAlign")}};c.prototype.Oh=function(){if(this.ja){var a=
this.ja.value;this.cancel();if(this.xa&&this.xa.ka("text")===a&&!this.Zi)this.log("Text was not changed.");else if(null===this.xa&&""===a)this.log("No text entered.");else if(this.xa)this.log("Update text in node %s",this.xa.id),a=[new Dc([this.xa.id],"text",a),new Dc([this.xa.id],"textFillStyle",this.fillStyle),new Dc([this.xa.id],"textAlign",this.Ia("textAlign")),new Dc([this.xa.id],"textDecoration",this.Ia("textDecoration"))],"bold"in this.aa&&a.push(new Dc([this.xa.id],"bold",this.aa.bold)),"italic"in
this.aa&&a.push(new Dc([this.xa.id],"italic",this.aa.bold)),this.view.pa(a);else if(this.Zd){this.log("Create new text node.");var b=this.view.ea.nb,c=0,e=this.Ia("fontSize");this.view.fa.get("multilineText")||(c=e);c=new E(this.Zd.x,this.Zd.y+c);this.view.pa([new S(this.view.ea.$a(),"TextNode",Fb({text:a,background:this.Ia("background"),fontSize:e,fontName:this.Ia("fontName"),bold:this.Ia("bold"),italic:this.Ia("italic"),textAlign:this.Ia("textAlign"),textFillStyle:this.Ia("textFillStyle"),textDecoration:this.Ia("textDecoration"),
strokeStyle:this.Ia("textStrokeStyle"),lineWidth:this.Ia("textLineWidth"),layer:this.aa.layer||this.view.Qa,wrap:this.view.fa.get("multilineText")},this.aa)),new Ec([b],c)])}}};c.prototype.Va=function(){return!1};c.prototype.Lc=function(a){this.log("keyboard: %s",a);"cancel"===a&&null===this.ja&&(this.view.eb(),this.view.qc.ua("goto-toolbar"))};c.prototype.ee=function(a){this.log("Set text colour to %s",a);this.Zi=!0;this.fillStyle=a;this.aa.textFillStyle=a;this.ja&&(this.ja.style.color=a,"#ffffff"===
u.vd(a).toString()?this.ja.style.backgroundColor="#808080":this.ja.style.backgroundColor="#ffffff")};c.prototype.ge=function(a,b){this.view.hl(a,b)};c.prototype.Fd=function(a,b){"defaultBold"===a?(a="bold",this.ja&&(this.ja.style.fontWeight=b?"bold":"normal")):"defaultItalic"===a?(a="italic",this.ja&&(this.ja.style.fontStyle=b?"italic":"normal")):"defaultTextBackground"===a?(a="background",this.ja&&(this.ja.style.backgroundColor=b)):"defaultFont"===a?(a="fontName",this.ja&&(this.ja.style.fontFamily=
b)):"defaultFontSize"===a?(a="fontSize",this.ja&&(this.ja.style.fontSize=b+"px")):"defaultTextFillStyle"===a?(a="textFillStyle",this.ja&&(this.ja.style.color=b)):"defaultTextDecoration"===a?(a="textDecoration",this.ja&&(this.ja.style.textDecoration=b)):"defaultTextAlign"===a&&(a="textAlign",this.ja&&(this.ja.style.textAlign=b));this.log("Update %s=%s",a,b);this.Zi=!0;this.aa[a]=b};c.prototype.cd=function(){return"text"};c.prototype.hd=function(a,b){this.aa[a]=b;"fillStyle"===a&&(this.aa.textFillStyle=
b);if(this.ja)switch(a){case "textFillStyle":case "fillStyle":this.ja.style.color=b}};return c}();var Dd=function(){function c(a){this.view=a;this.start=new A(0,0);this.pl=new A(0,0);this.active=!1;this.rect=null;this.log=w.create("PanZoomMixin")}c.prototype.bb=function(a){this.log("onGesture(%s)",a.type);if(!this.view.fa.get("allowZoom"))return!1;if("gesturestart"===a.type)this.start=new A(a.pageX,a.pageY),this.pl=this.view.Za(a.pageX,a.pageY),this.rect=this.view.ae(),this.active=!0;else if("gesturechange"===a.type&&this.rect){var b=a.pageX-this.start.x,c=a.pageY-this.start.y;a=this.view.fa.Zk(1/
a.scale);a=new Lb(a,a,this.pl.x,this.pl.y);a=(new E(-b/this.view.scale,-c/this.view.scale)).multiply(a);b=this.rect.clone();b.transform(a);this.view.$g(b)}else"gestureend"===a.type&&(this.active=!1);return!0};return c}();var nd=function(){function c(a){this.view=a;this.wo=1;this.log=w.create("DefaultBehaviour");this.view.Si("");if(this.cg=this.view.fa.cg())this.wo=2;this.Xb=new Dd(a)}c.prototype.Fc=function(){this.log("Entering pick tool.");this.view.canvas.style.cursor="default"};c.prototype.Ac=function(){this.log("Leaving pick tool.")};c.prototype.rb=function(a){if("touchmove"!==a.type&&"touchstart"!==a.type&&"touchend"!==a.type)return!1;for(var b=0;b<a.touches.length;b++){var c=a.touches[b];c=this.view.Za(c.pageX,
c.pageY);if("touchstart"===a.type)return this.Ta(c.x,c.y,a);if("touchend"===a.type)return this.Wa(c.x,c.y,a)}return!1};c.prototype.bb=function(a){return this.Xb.bb(a)};c.prototype.Ta=function(a,b,c){var d,f;this.log("onMouseDown");if(c.button)return this.log("   -- not main button. ignore."),!1;if(this.view.fa.get("readOnly"))return(d=this.view.ea.xb(a,b,this.view.Qa))?(this.log("layer=%s active=%s",d.zd(),this.view.Qa),this.view.za.ua("node-clicked",d.id,a,b)):this.log("readOnly mode: Ignoring click."),
!1;if(f=this.view.mr(a,b)){if(f.click())return!0;this.view.fb(new Bd(this.view,f,!1,a,b,c));return!0}this.view.selection.length&&this.view.Rr(c)&&this.view.pg();if(this.view.xa&&(d=this.view.xa,f=d.ri(a,b,1/this.view.scale*this.wo),null!==f))return this.view.fb(new od(this.view,d,f,a,b,this,c)),!0;if(d=this.view.ea.xb(a,b,this.view.Qa))this.log("layer=%s active=%s",d.zd(),this.view.Qa),this.view.za.ua("node-clicked",d.id,a,b);if(d&&d.zd()===this.view.Qa){f=d===this.view.xa;var g=this.view.Qr(d);this.log("wasEditNode: %s, wasSelected: %s",
f,g);g||(c.shiftKey||this.view.pb(),this.view.ve(d),this.view.Mb());this.view.fb(new Bd(this.view,this.view.Sf?new wd(qd,d.Ea()):new xd,!f&&g,a,b,c))}else if(this.view.ko(a,b))this.view.fb(new Bd(this.view,this.view.Sf?new wd(qd,this.view.selection[0].Ea()):new xd,!0,a,b,c));else if(this.view.fa.Yq())this.view.jf(null),this.view.fb(new pd(this.view,this,a,b));else return this.log("Disabled select box -- mobile touch active."),this.view.jf(null),this.view.pb(),this.view.Mb(),this.view.ha(),!1;return!0};
c.prototype.Wa=function(){this.log("onMouseUp");return!1};c.prototype.Lc=function(a,b){this.log("keyboard: %s on target %s",a,b.target.tagName);if("INPUT"!==b.target.tagName){var c=!0,e=this.view.fa.get("nudge");b&&b.ctrlKey&&(e=this.view.fa.get("preciseNudge"));var f=this.view.Aa.tb;switch(a){case "bring-to-front":this.view.Fh();break;case "send-to-back":this.view.Pi();break;case "left":f||this.view.Di(-1,0,e)||(this.view.ub=Math.min(this.view.ub+16,0),this.view.mc(),this.view.ha());break;case "right":f||
this.view.Di(1,0,e)||(e=this.view.xe.width,this.view.ub=Math.max(-(e*this.view.scale-e),this.view.ub-16),this.view.mc(),this.view.ha());break;case "up":f||this.view.Di(0,-1,e)||(this.view.ib=Math.min(this.view.ib+16,0),this.view.mc(),this.view.ha());break;case "down":f||this.view.Di(0,1,e)||(e=this.view.xe.height,this.view.ib=Math.max(-(e*this.view.scale-e),this.view.ib-16),this.view.mc(),this.view.ha());break;case "select-none":this.view.pb();this.view.Mb();this.view.ha();f&&this.view.qc.ua("goto-toolbar");
break;case "select-all":var g=[];this.view.ea.Ee(function(a){g.push(a)});this.view.selectNodes(g);this.view.ha();f&&this.view.qc.ua("goto-toolbar");break;case "duplicate":this.view.duplicate();break;case "move-up":this.view.Ai();break;case "move-down":this.view.zi();break;case "delete":this.view.pg();break;case "curve-tool":this.view.Nm({});break;case "line-tool":this.view.Nn({},!1,!1);break;case "group":this.view.group();break;case "ungroup":this.view.lh();break;case "undo":this.view.jb();break;
case "redo":this.view.Jd();break;case "cut":this.view.Qj();break;case "copy":this.view.Ce();break;case "paste":this.view.Rg();break;case "zoom-normal":this.view.fa.get("allowZoom")?this.view.vc(1):this.log("Zooming is disabled.");break;case "zoom-in":this.view.fa.get("allowZoom")?this.view.gj():this.log("Zooming is disabled.");break;case "zoom-out":this.view.fa.get("allowZoom")?this.view.hj():this.log("Zooming is disabled.");break;default:c=!1}c&&(b.preventDefault(),b.stopPropagation())}};c.prototype.ee=
function(a,b){if(b){this.view.Bb=a;this.view.Ub=a;var c="fillStyle"}else this.view.Lb=a,c="strokeStyle";this.view.setProperty(c,a)};c.prototype.ge=function(a,b){b?(this.view.Bb=zb(this.view.Bb,a),this.view.Ub=zb(this.view.Ub,a)):this.view.Lb=zb(this.view.Lb,a);this.view.hl(a,b)};c.prototype.fe=function(a,b){this.log("onDoubleClick");var c=this.view.ea.xb(a,b,this.view.Qa);this.log("hittest: %s, hasText: %s",null!==c,null!==c&&c.oi());this.view.za.ua("double-click",a,b,c?c.id:null);if(c&&"PathNode"===
c.type()&&!this.view.fa.get("allowTextInShape"))this.log("Editing text in shape is disabled.");else if(c&&c.oi()&&!this.view.fa.get("readOnly"))this.log("Text double-clicked."),this.view.tl({}),this.view.ma instanceof Cd&&this.view.ma.ql(c,a,b);else return!1;return!0};c.prototype.cd=function(){return"pick"};return c}();var Ed=w.create("FitCurve");
function Fd(c){function a(a,b){y.bezierCurveTo(b[1].x,b[1].y,b[2].x,b[2].y,b[3].x,b[3].y);Ed("Bezier: (%s,%s), (%s,%s), (%s,%s), (%s,%s)",b[0].x,b[0].y,b[1].x,b[1].y,b[2].x,b[2].y,b[3].x,b[3].y)}function b(a,b){return a.x*b.x+a.y*b.y}function d(a){var b=1-a;return 3*a*b*b}function e(a){return 3*a*a*(1-a)}function f(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*c+d*d)}function g(a){return a.x*a.x+a.y*a.y}function h(a,b){var c=Math.sqrt(g(a));0!==c&&(a.x*=b/c,a.y*=b/c);return a}function l(a,b,c){void 0===
c&&Ed("Undef!");c.x=a.x+b.x;c.y=a.y+b.y;return c}function k(a,b){return{x:a.x+b.x,y:a.y+b.y}}function m(a,b){return{x:a.x*b,y:a.y*b}}function q(a,b){return{x:a.x-b.x,y:a.y-b.y}}function p(a,c,g,p,t,r){var N,y=[],x=[[],[]],K=[];var v=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}];var I=g-c+1;for(N=0;N<I;N++){var P={x:t.x,y:t.y};var G={x:r.x,y:r.y};h(P,d(p[N]));h(G,e(p[N]));y[N]=[P,G]}x[0][0]=0;x[0][1]=0;x[1][0]=0;x[1][1]=0;K[0]=0;for(N=K[1]=0;N<I;N++)x[0][0]+=b(y[N][0],y[N][0]),x[0][1]+=b(y[N][0],y[N][1]),
x[1][0]=x[0][1],x[1][1]+=b(y[N][1],y[N][1]),P=1-p[N],G=p[N],P=q(a[c+N],k(m(a[c],P*P*P),k(m(a[c],d(p[N])),k(m(a[g],e(p[N])),m(a[g],G*G*G))))),K[0]+=b(y[N][0],P),K[1]+=b(y[N][1],P);p=x[0][0]*x[1][1]-x[1][0]*x[0][1];N=x[0][0]*K[1]-x[0][1]*K[0];K=K[0]*x[1][1]-K[1]*x[0][1];0===p&&(p=x[0][0]*x[1][1]*1E-11);x=K/p;K=N/p;if(0>x||0>K)return x=f(a[g],a[c])/3,v[0]=a[c],v[3]=a[g],l(v[0],h(t,x),v[1]),l(v[3],h(r,x),v[2]),v;v[0]=a[c];v[3]=a[g];l(v[0],h(t,x),v[1]);l(v[3],h(r,K),v[2]);return v}function t(a,b,c){var d;
var e=[];for(d=0;d<=a;d++)e[d]={x:b[d].x,y:b[d].y};for(d=1;d<=a;d++)for(b=0;b<=a-d;b++)e[b].x=(1-c)*e[b].x+c*e[b+1].x,e[b].y=(1-c)*e[b].y+c*e[b+1].y;return e[0]}function r(a){var b=Math.sqrt(Math.sqrt(g(a)));0!==b&&(a.x/=b,a.y/=b);return a}function v(a,b,c,d,e){var f,h=(c-b+1)/2;var l=0;for(f=b+1;f<c;f++){var k=t(3,d,e[f-b]);k=q(k,a[f]);k=g(k);k>=l&&(l=k,h=f)}return{Tn:l,Ko:h}}function x(b,c,d,e,g,k){var m;var y=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}];var K=k*k;if(2===d-c+1)k=f(b[d],b[c])/3,y[0]=
b[c],y[3]=b[d],l(y[0],h(e,k),y[1]),l(y[3],h(g,k),y[2]),a(3,y);else{var U=[0];for(m=c+1;m<=d;m++)U[m-c]=U[m-c-1]+f(b[m],b[m-1]);for(m=c+1;m<=d;m++)U[m-c]/=U[d-c];var P=U;y=p(b,c,d,P,e,g);m=v(b,c,d,y,P);U=m.Tn;m=m.Ko;if(U<k)a(3,y);else{if(U<K||I)for(K=0;4>K;K++){m=b;U=c;var G=d;var ma=y;var Da=[];for(y=U;y<=G;y++){var Qa=Da,ye=y-U,M,Ra=ma,fb=m[y],gb=P[y-U],ra=[];var xa=[];var hb=t(3,Ra,gb);for(M=0;2>=M;M++)ra[M]={x:0,y:0},ra[M].x=3*(Ra[M+1].x-Ra[M].x),ra[M].y=3*(Ra[M+1].y-Ra[M].y);for(M=0;1>=M;M++)xa[M]=
{x:0,y:0},xa[M].x=2*(ra[M+1].x-ra[M].x),xa[M].y=2*(ra[M+1].y-ra[M].y);M=t(2,ra,gb);xa=t(1,xa,gb);Qa[ye]=gb-((hb.x-fb.x)*M.x+(hb.y-fb.y)*M.y)/(M.x*M.x+M.y*M.y+(hb.x-fb.x)*xa.x+(hb.y-fb.y)*xa.y)}G=Da;y=p(b,c,d,G,e,g);m=v(b,c,d,y,G);U=m.Tn;m=m.Ko;if(U<k||I){a(3,y);return}P=G}G={x:0,y:0};K=q(b[m-1],b[m]);U=q(b[m],b[m+1]);G.x=(K.x+U.x)/2;G.y=(K.y+U.y)/2;K=G=r(G);x(b,c,m,e,K,k);K.x=-K.x;K.y=-K.y;x(b,m,d,K,g,k)}}}var I=!0;void 0===I&&(I=!1);var y=new H;y.moveTo(c[0].x,c[0].y);(function(a,b,c){var d=q(a[1],
a[0]);d=r(d);var e=b-1;e=q(a[e-1],a[e]);e=r(e);x(a,0,b-1,d,e,c)})(c,c.length,25);return y};var Gd=function(){function c(a,b,c,e){var d=this;this.view=a;this.bf=b;this.options=c;this.mode=e;this.Ra=!1;this.Qb=[];this.jh={};this.from=this.He=null;this.log=w.create("Brush");this.Xb=new Dd(this.view);this.view.pb(!0);this.so=function(){return d.Re()}}c.prototype.Re=function(){this.Fk(this.Zc()/2)};c.prototype.Fc=function(){this.view.canvas.style.cursor="crosshair";this.Fk(this.Zc()/2);window.addEventListener("resize",this.so)};c.prototype.Ac=function(){this.view.canvas.style.cursor="default";
this.view.ha();window.removeEventListener("resize",this.so)};c.prototype.reset=function(){this.Ra=!1;this.Qb=[];this.jh={}};c.prototype.bb=function(a){a=this.Xb.bb(a);this.Ra&&this.Xb.active&&this.reset();return a};c.prototype.Fk=function(a){var b=document.createElement("canvas");a*=this.view.scale;a=Math.ceil(a+1);b.width=2*a+2;b.height=2*a+2;var c=b.getContext("2d");c.beginPath();"round"===(this.options.lineCap||"round")?c.arc(a+1,a+1,a,0,2*Math.PI):c.rect(1,1,2*a-2,2*a-2);c.lineWidth=2;c.strokeStyle=
"#ffffff";c.stroke();c.lineWidth=1;c.strokeStyle="#000000";c.stroke();b=b.toDataURL();this.view.canvas.style.cursor="url("+b+") "+(a+1)+" "+(a+1)+", auto"};c.prototype.Tf=function(a){this.options.strokeStyle=a};c.prototype.Zc=function(){var a=this.options.lineWidth;this.view.fa.get("adaptiveBrushWidth")&&(a/=this.view.scale);return a};c.prototype.Ti=function(a){this.options.lineWidth=a;this.Fk(this.Zc()/2)};c.prototype.rb=function(a){var b;if(this.Xb.active)return!0;if("touchstart"===a.type){var c=
a.changedTouches;var e=0;for(b=c.length;e<b;e++){var f=c[e];a=this.view.Za(f.pageX,f.pageY,!0);this.Qb.push([a]);f.identifier&&(this.jh[f.identifier]=this.Qb[this.Qb.length-1])}this.Ra=!0;1===this.Qb.length&&(this.He=this.view.Hk())}else if("touchmove"===a.type){var g=a.changedTouches;b=0;for(c=g.length;b<c;b++)f=g[b],a=this.view.Za(f.pageX,f.pageY,!0),f.identifier?f.identifier in this.jh?e=this.jh[f.identifier]:(e=[a],this.Qb.push(e),this.jh[f.identifier]=e):e=this.Lq(a),e?a.x===e[e.length-1].x&&
a.y===e[e.length-1].y||e.push(a):this.log("WARNING: Can't find path for touch!");!1===this.Ra&&(this.He=this.view.Hk(),this.Ra=!0);this.He?this.He.ha(this.Qg,this):this.view.ha()}else"touchend"===a.type&&this.Ra&&0===a.touches.length&&(this.pa(),this.Ra=!1);return!0};c.prototype.Lq=function(a){var b=0,c;var e=null;for(c=0;c<this.Qb.length;c++){var f=this.Qb[c],g=f[f.length-1].vb(a);if(null===e||g<b)e=f,b=g}e||(e=[a],this.Qb.push(e));return e};c.prototype.Ta=function(a,b){var c=new A(a,b);this.Ra=
!0;this.Qb.push([c]);1===this.Qb.length&&(this.He=this.view.Hk());return!0};c.prototype.Qg=function(a){var b,c,e,f=this.view.Km();a.lineCap=this.options.lineCap||"round";a.lineJoin="round"===a.lineCap?"round":"bevel";a.lineWidth=this.Zc();var g=a.globalAlpha;"opacity"in this.options&&(a.globalAlpha=this.options.opacity);a.beginPath();var h=this.Qb;var l=0;for(c=h.length;l<c;l++){var k=h[l];a.moveTo(k[0].x,k[0].y);var m=b=1;for(e=k.length-1;b<=e;m=b+=1)m=k[m],a.lineTo(m.x,m.y)}Eb(a,this.options.strokeStyle);
f&&a.restore();a.globalAlpha=g};c.prototype.Va=function(a,b){var c=new A(a,b);this.Ra&&(this.from=this.Qb[0][this.Qb[0].length-1],c.x!==this.from.x||c.y!==this.from.y)&&(this.Qb[0].push(c),this.He?this.He.ha(this.Qg,this):this.view.ha());return!0};c.prototype.Wa=function(a,b,c){this.Va(a,b,c);this.Ra=!1;this.pa();return!0};c.prototype.pa=function(){var a,b,c,e;var f=[];var g=this.Qb;var h=this.view.ea.nb;var l=0;for(c=g.length;l<c;l++){var k=g[l];if("brush"===this.mode){var m=[];1===k.length&&k.push(new A(k[0].x+
.1,k[0].y+.1));if(1<k.length){var q=a=0;for(b=k.length-1;a<=b;q=a+=1)m.push(k[q].x),m.push(k[q].y);f.push(new S(this.view.ea.$a(),"BrushNode",Fb({points:m,layer:this.view.Qa},this.options,{lineWidth:this.Zc()})))}}else{if("shapebrush"===this.mode){k=Sb(k,20);b=k;if(!(2>b.length)){k=b[0];q=b[b.length-1];m=40>k.vb(q);for(a=0;a<b.length;a++){var p=b[a];for(e=a+1;e<b.length;e++){var t=b[e];20>Math.abs(p.x-t.x)&&(t.x=p.x);20>Math.abs(p.y-t.y)&&(t.y=p.y)}}p=D.fg(b).Uc();for(a=0;a<b.length;a++)e=b[a],20>
Math.abs(e.x-p.x)&&(e.x=p.x),20>Math.abs(e.y-p.y)&&(e.y=p.y);m&&(k.x=q.x,k.y=q.y)}k=b}else if("freehand"===this.mode)m=k,m=Sb(m,2),m=Vb(m,4),k=m=Sb(m,.5);else if("quadratic"===this.mode){k=Sb(k,10);a=Fd(k);m=a.ba[1];q=a.ba[2];e=a.ba[4];b=a.ba[5];k=a.ba[8];a=a.ba[9];e=((3*e-m)/2+(3*e-k)/2)/2;b=((3*b-q)/2+(3*b-a)/2)/2;p=new H;p.moveTo(m,q);p.quadraticCurveTo(e,b,k,a);m=p;m=Q.Zo(m);f.push(new S(this.view.ea.$a(),"PathNode",Fb({commands:m,fillStyle:this.view.Bb,sloppiness:0,layer:this.view.Qa},this.options,
{lineWidth:this.Zc()})));continue}1===k.length&&"freehand"===this.mode&&k.push(new A(k[0].x+.1,k[0].y+.1));if(1<k.length){m=new R;m.moveTo(k[0].x,k[0].y);a=k[0].ud(k[k.length-1]);q=b=1;for(e=k.length-1;b<=e;q=b+=1)m.lineTo(k[q].x,k[q].y);a&&m.close();f.push(new S(this.view.ea.$a(),"PathNode",Fb({commands:m.Sb(),fillStyle:this.view.Bb,sloppiness:0,layer:this.view.Qa},this.options,{lineWidth:this.Zc()})))}}}this.view.pa(f);this.view.pb();l=this.view.ea.va(h,!1);f.length&&"quadratic"===this.mode?(l&&
this.view.jf(l),this.view.eb()):this.view.fa.get("singleStrokeBrush")?(l&&this.view.ve(l),this.view.eb()):this.reset();this.view.Mb()};c.prototype.ee=function(a,b){this.options.strokeStyle=a;if(b){this.view.Bb=a;this.view.Ub=a;var c="fillStyle"}else this.view.Lb=a,c="strokeStyle";this.view.setProperty(c,a)};c.prototype.ge=function(a){this.view.Ub=zb(this.view.Ub,a);this.options.strokeStyle=zb(this.options.strokeStyle,a);this.view.Bb=this.view.Ub};c.prototype.Lc=function(a){this.log("keyboard: %s",
a);"cancel"===a&&(this.log("ESC pressed. Abort brush and go back to toolbar."),this.view.eb(),this.view.qc.ua("goto-toolbar"))};c.prototype.Fd=function(a,b){"defaultBrushWidth"===a?this.Ti(b):"defaultBrushColour"===a&&this.Tf(b)};c.prototype.hd=function(a,b){switch(a){case "lineWidth":this.Ti(b);break;case "strokeStyle":this.Tf(b)}};c.prototype.cd=function(){return"circle"===this.mode?"ellipse":this.mode};c.prototype.ki=function(){return this.options};return c}();var Hd=function(){function c(a,b,c,e,f,g){void 0===c&&(c="");void 0===e&&(e={});void 0===f&&(f=!1);void 0===g&&(g=!1);this.view=a;this.type=b;this.url=c;this.aa=e;this.xt=f;this.Kh=g;this.node=null;this.dk=new A(0,0);this.Dk=new A(0,0);this.index=0;this.state="start";this.log=w.create("DRAWLINES");"wrap"in this.aa||(this.aa.wrap=this.view.fa.get("multilineText"));"fontSize"in this.aa||(this.aa.fontSize=this.view.fa.get("defaultFontSize"));this.Xb=new Dd(this.view);this.view.pb(!0)}c.prototype.Fc=
function(){this.log("Entering DrawLinesBehaviour");this.view.canvas.style.cursor="crosshair";this.view.fa.cg()||this.view.Si("click-to-place-first-point-of-line");this.view.ha()};c.prototype.reset=function(){this.Fc()};c.prototype.rb=function(a){if("touchstart"===a.type){var b=a.changedTouches[0];b=this.view.Za(b.pageX,b.pageY);return this.Ta(b.x,b.y,a)}return"touchmove"===a.type?(b=a.changedTouches[0],b=this.view.Za(b.pageX,b.pageY),this.Va(b.x,b.y,a)):"touchend"===a.type?(b=a.changedTouches[0],
b=this.view.Za(b.pageX,b.pageY),this.Wa(b.x,b.y,a)):!1};c.prototype.bb=function(a){a=this.Xb.bb(a);this.Xb.active&&this.node&&this.reset();return a};c.prototype.Lc=function(a){"cancel"===a&&(null!==this.node&&this.view.Aa.tb&&"curve"===this.type&&this.pa(),null!==this.node&&this.view.ea.removeNode(this.node),this.view.Aa.tb?this.view.qc.ua("goto-toolbar"):this.view.eb())};c.prototype.done=function(){this.view.fa.get("autoPickTool")?(this.view.eb(),this.view.no()):this.state="start"};c.prototype.xm=
function(a,b){this.node instanceof Q&&("curve"===this.type||"arrow"===this.type||"linear-bezier"===this.type?this.node.og(a,b):this.node.lineTo(a,b))};c.prototype.Ta=function(a,b){var c=this.view.Ma(new A(a,b));if("start"===this.state){this.dk=new A(a,b);this.node=new Q(this.view.ea.$a(),this.view.ea);this.node.setProperty("seed",Math.round(65535*Math.random()));this.node.setProperty("strokeStyle",this.view.Lb);this.node.setProperty("lineWidth",this.Zc());this.node.setProperty("sloppiness",this.view.wa.sloppiness);
this.node.setProperty("smoothness",this.view.wa.smoothness);for(var e in this.aa)this.aa.hasOwnProperty(e)&&this.node.setProperty(e,this.aa[e]);this.view.ea.Ch(this.node);"arrow"===this.type&&(this.node.setProperty("arrowSize",this.view.fa.Na("defaultArrowSize")),this.node.setProperty("arrowStyle",this.view.fa.Na("defaultArrowStyle")),this.node.setProperty("arrowXOffset",this.view.fa.Na("defaultArrowXOffset")));this.node.moveTo(c.x,c.y);this.xm(c.x,c.y);this.index=3;this.view.update();this.state=
"predrag"}else if("placing"===this.state)if("arrow"!==this.type&&8>this.dk.vb(new A(a,b))&&3<this.index)this.log("Clicked close to start; automatically closing path"),this.node instanceof Q&&this.node.close(),this.pa(),this.done();else if(8>this.Dk.vb(new A(a,b)))3<this.index?(this.node instanceof Q&&this.node.Us(this.index),this.pa()):this.cancel(),this.done();else{if(this.xt)return this.pa(),this.done(),!0;this.node&&(this.xm(c.x,c.y),this.index+=3,this.view.ea.Lg(this.node.id),this.view.update())}else return this.log("Invalid state %s",
this.state),!0;this.Dk=new A(c.x,c.y);return!0};c.prototype.Wa=function(a,b){var c=new A(a,b);c=this.dk.vb(c);this.log("onMouseUp (%s,%s) %s",a,b,this.state);"predrag"===this.state&&(this.log("MovedBy: %s",c),10<c?(this.pa(),this.done()):(this.state="placing",this.view.Si("click-to-place-another-point-or-double-click-to-end-the-line")));return!0};c.prototype.Va=function(a,b,c){b=this.view.Ma(new A(a,b));a=b.x;b=b.y;if(c.ctrlKey||this.Kh){c=this.Dk;var d=Math.atan2(b-c.y,a-c.x),f=Math.PI/8;d>=-f&&
d<f?b=c.y:d>=f&&d<3*f?(a=Math.max(b-c.y,a-c.x),b=c.y+a,a=c.x+a):d>=3*f&&d<5*f?a=c.x:d>=5*f&&d<7*f?(a=Math.max(b-c.y,c.x-a),b=c.y+a,a=c.x-a):d>=7*f||d<=7*-f?b=c.y:d<5*-f?(a=Math.max(c.y-b,c.x-a),b=c.y-a,a=c.x-a):d<3*-f?a=c.x:(a=Math.max(c.y-b,a-c.x),b=c.y-a,a=c.x+a)}this.node&&(this.node.Oe(this.index,a,b),this.node.format(this.view.ia,this.view.request),this.view.ha());return!1};c.prototype.Gd=function(){this.log("onMouseClick()");return!0};c.prototype.fq=function(a){for(var b=0,c=[],e,f,g,h,l,k;b<
a.length;){var m=a[b];switch(m){case Q.rf:g=a[b+1];h=a[b+2];c.push(m,g,h);break;case Q.Qd:e=a[b+1],f=a[b+2],void 0!==g&&void 0!==h&&void 0!==l&&void 0!==k&&c.push(Q.dg,e,f,(l+g)/2,(k+h)/2,(g+e)/2,(h+f)/2),l=g,k=h,g=e,h=f}b+=Q.Xa[m]+1}return c};c.prototype.pa=function(){if(this.node){this.node instanceof Q&&this.node.Kp();this.view.ea.removeNode(this.node);var a=this.view.fa.Na("defaultArrowSize"),b=this.node.ka("commands");"linear-bezier"===this.type&&(b=this.fq(b));a={arrowSize:"arrow"===this.type?
a:0,arrowStyle:this.view.fa.Na("defaultArrowStyle"),arrowXOffset:this.view.fa.Na("defaultArrowXOffset"),commands:b,seed:this.node.ka("seed"),fillStyle:this.view.Bb,strokeStyle:this.view.Lb,lineWidth:this.Zc(),sloppiness:this.view.wa.sloppiness,smoothness:this.view.wa.smoothness,layer:this.view.Qa};for(var c in this.aa)this.aa.hasOwnProperty(c)&&(a[c]=this.aa[c]);this.view.pa([new S(this.view.ea.$a(),"PathNode",a)]);this.node=null}};c.prototype.cancel=function(){this.node&&(this.view.ea.removeNode(this.node),
this.node=null)};c.prototype.Ac=function(){this.cancel();this.view.canvas.style.cursor="default";this.view.Si("");this.view.ha()};c.prototype.ee=function(a,b){if(b){this.view.Bb=a;this.view.Ub=a;var c="fillStyle";this.log("We are drawing lines. Set strokeStyle instead of fillStyle")}else c="strokeStyle";this.view.Lb=a;this.view.setProperty(c,a)};c.prototype.ge=function(a,b){b?(this.view.Bb=zb(this.view.Bb,a),this.view.Ub=zb(this.view.Ub,a)):this.view.Lb=zb(this.view.Lb,a);this.view.hl(a,b)};c.prototype.cd=
function(){return this.type};c.prototype.hd=function(a,b){this.aa[a]=b};c.prototype.Zc=function(){return this.view.ig(this.view.wa.lineWidth)};return c}();var Id=function(){function c(a,b,c,e,f,g,h,l){var d=this;this.view=a;this.nodeType=b;this.aa=c;this.width=e;this.height=f;this.xo=g;this.Jt=h;this.state="initial";this.start=new A(0,0);this.end=new A(0,0);this.node=null;this.log=w.create("DrawShape");"rectangle-tl"===g&&(this.Rm=function(a){a.lineWidth=1/d.view.scale;a.strokeStyle="#ccc";a.beginPath();a.rect(d.start.x,d.start.y,d.end.x-d.start.x,d.end.y-d.start.y);a.stroke()});this.Cm=null===l?this.view.fa.get("autoPickTool"):l;this.Xb=new Dd(this.view);
this.view.pb(!0)}c.prototype.Rm=function(){};c.prototype.Fc=function(){this.log("Entering DrawShapeBehaviour");this.view.canvas.style.cursor="crosshair"};c.prototype.Ac=function(){this.log("Leaving DrawShapeBehaviour");this.cancel()};c.prototype.cancel=function(){this.node&&(this.view.ea.removeNode(this.node),this.view.update(),this.node=null);this.state="initial"};c.prototype.bb=function(a){a=this.Xb.bb(a);this.node&&this.Xb.active&&(this.view.ea.removeNode(this.node),this.node=null,this.state="initial");
return a};c.prototype.Lc=function(a){"cancel"===a&&this.view.eb()};c.prototype.rb=function(a){if("touchstart"===a.type){var b=a.changedTouches[0];b=this.view.Za(b.pageX,b.pageY);return this.Ta(b.x,b.y)}return"touchmove"===a.type?(b=a.changedTouches[0],b=this.view.Za(b.pageX,b.pageY),this.Va(b.x,b.y,a)):"touchend"===a.type?(b=a.changedTouches[0],b=this.view.Za(b.pageX,b.pageY),this.Wa(b.x,b.y,a)):!1};c.prototype.Ta=function(a,b){"initial"===this.state&&(this.start=this.view.Ma(new A(a,b)),this.state=
"predraw",this.log("initial -> predraw"));return!0};c.prototype.Va=function(a,b,c){a=this.view.Ma(new A(a,b));c=c.ctrlKey;"predraw"===this.state&&10<this.start.vb(a)&&(this.create(),this.state="drawing",this.log("predraw -> drawing"));"drawing"===this.state&&(this.transform(this.start,a,c),this.end=a,this.view.update(!1,this.Rm));return!0};c.prototype.Wa=function(a,b,c){"predraw"===this.state?this.view.fa.get("clickToDrawShapes")?(this.create(),this.transform(this.start,null,c.ctrlKey),this.pa(),
this.Cm&&this.view.eb(),this.state="initial"):this.cancel():"drawing"===this.state&&(this.transform(this.start,this.view.Ma(new A(a,b)),c.ctrlKey),this.pa(),this.Cm&&this.view.eb(),this.state="initial");return!0};c.prototype.create=function(){if(this.node=Bc(this.nodeType,this.view.ea.$a(),this.view.ea))this.node.Jb(this.aa),this.view.ea.Ch(this.node)};c.prototype.transform=function(a,b,c){if(b)if("circle"===this.xo){var d=a;a=a.vb(b);var f=2*a/this.width;a=2*a/this.height}else{if("rectangle-tl"===
this.xo)a=a.clone(),b=b.clone(),a.x>b.x&&(f=a.x,a.x=b.x,b.x=f),a.y>b.y&&(f=a.y,a.y=b.y,b.y=f),d=a;else if(f=[a,b],0===f.length)d=new A(0,0);else{d=f[0].x;for(var g=f[0].y,h=1;h<f.length;h++)d+=f[h].x,g+=f[h].y;d=new A(d/f.length,g/f.length)}f=(b.x-a.x)/this.width;a=(b.y-a.y)/this.height}else d=a,a=f=1;c&&(a=f=Math.min(f,a));c=new E(d.x,d.y);c=c.multiply(new Lb(f,a));this.node&&(this.node.Vf(c),this.view.ea.Lg(this.node.id))};c.prototype.pa=function(){this.node&&(this.aa.matrix=this.node.Ea(),this.view.ea.removeNode(this.node),
this.node=null,this.view.pa([new S(this.view.ea.$a(),this.nodeType,this.aa)]))};c.prototype.Ti=function(a){this.aa.lineWidth=this.view.ig(a)};c.prototype.ee=function(a,b){nd.prototype.ee.call(this,a,b);this.aa[b?"fillStyle":"strokeStyle"]=a};c.prototype.ge=function(a,b){nd.prototype.ge.call(this,a,b);var c=b?"fillStyle":"strokeStyle",e=zb(this.aa[c],a);this.log("oldColour=%s+opacity %s = %s",this.aa[c],a,e);this.aa[c]=e};c.prototype.cd=function(){return this.Jt};c.prototype.hd=function(a,b){this.aa[a]=
b};c.prototype.ki=function(){return this.aa};c.prototype.Fd=function(a,b){"defaultLineWidth"===a&&this.Ti(b)};return c}();function Jd(c,a,b){this.Ha=c;this.Xi=a;this.fn=b;this.$i=0}
var Kd=new (function(){function c(){this.zb=[];this.vl=!1;this.log=w.create("ImageLoader")}c.prototype.timeout=function(){var a=[];this.log("Timeout running... %s images remaining",this.zb.length);for(var b=0;b<this.zb.length;b++)this.zb[b].Ha.complete?this.zb[b].fn(this.zb[b].Ha,this.zb[b].Xi):5E3>this.zb[b].$i?(this.zb[b].$i+=250,a.push(this.zb[b])):this.zb[b].fn(this.zb[b].Ha,this.zb[b].Xi);this.zb=a;this.zb.length?setTimeout(this.timeout,250):(this.log("Timeout Stopped"),this.vl=!1)};c.prototype.load=
function(a,b,c){var d=this;void 0===c&&(c=!1);var f=document.createElement("img"),g=new Jd(f,a,b);this.zb.push(g);var h=0<=a.indexOf("://"),l="://"+window.location.host,k=0!==a.indexOf("data:")&&h&&-1===a.indexOf(l);k&&!c&&(this.log("Using cross origin request for img"),f.crossOrigin="");f.addEventListener("load",function(){d.log("LoadFn called. complete=%s",f.complete);if(f.complete)for(var a=0;a<d.zb.length;a++){var c=d.zb[a];if(c.Ha===f){d.zb.splice(a,1);b(f,c.Xi);break}}else d.vl||(d.vl=!0,setTimeout(d.timeout,
250),g.$i=250)},!1);f.addEventListener("error",function(){d.log("Error loading %s; useCors=%s disableCors=%s",a,k,c);!k||c?b(null,g.Xi):d.load(a,b,!0)},!1);f.src=a;return f};return c}());var Ld=function(c){function a(){var a=c.call(this)||this;a.Pf=[];a.zf=!1;a.canvas=null;a.log=w.create("FORMAT",!0);return a}n(a,c);a.prototype.add=function(a,c,e,f,g){var b;var d=this.Pf;var k=0;for(b=d.length;k<b;k++){var m=d[k];m.type===c&&m.Jk===a&&(m.jl=!0)}this.log("Request URL %s",e.substr(0,64));this.Pf.push({Jk:a,type:c,url:e,Bs:f||{},Sp:g,jl:!1});this.check()};a.prototype.check=function(){for(var a=0;!this.zf&&a<this.Pf.length;)this.Pf[a].jl?this.Pf.shift():(this.tp(this.Pf[0]),a+=1);this.zf||
this.ua("done")};a.prototype.tp=function(a){var b=this;b.zf=!0;b.log("Processing request for item %s url=%s",a.Jk,a.url.substr(0,64));0===a.type.indexOf("image")&&Kd.load(a.url,function(c,d){null!==c?(b.log("Image request completed for item %s url %s",a.Jk,d.substr(0,64)),a.Sp(c,d)):b.log("Image request failed for url %s",d);b.zf=!1;a.jl=!0;b.check()})};a.prototype.eq=function(a,c){this.ua("convert-dom-request",a,c)};a.prototype.Qf=function(a){this.ua("reformat",a)};a.prototype.wd=function(){if(null===
this.canvas)return new D(0,0,0,0);var a=z(this.canvas).dc();return new D(a.left,a.top,this.canvas.width,this.canvas.height)};return a}(Pc);var Md=function(){function c(a,b,c){this.view=a;this.aa=b;this.hs=c;this.state="none";this.scale=1;this.log=w.create("ImageStamp");this.Ha=document.createElement("img");this.url=this.Ha.src=b.url;"scale"in this.aa&&(this.scale=this.aa.scale,delete this.aa.scale)}c.prototype.Fc=function(){this.log("Entering ImageStampBehaviour");this.view.canvas.style.cursor="move"};c.prototype.Ac=function(){this.log("Leaving ImageStampBehaviour");this.view.ha()};c.prototype.rb=function(a){if("touchstart"===a.type){var b=
a.changedTouches[0];b=this.view.Za(b.pageX,b.pageY);return this.Ta(b.x,b.y,a)}return"touchmove"===a.type?(b=a.changedTouches[0],b=this.view.Za(b.pageX,b.pageY),this.Va(b.x,b.y,a)):"touchend"===a.type?(b=a.changedTouches[0],b=this.view.Za(b.pageX,b.pageY),this.Wa(b.x,b.y,a)):!1};c.prototype.Ma=function(a,b){this.Ha.complete&&(a-=this.Ha.width/2,b-=this.Ha.height/2);return this.view.Ma(new A(a,b))};c.prototype.Ta=function(a,b,c){this.log("onMouseDown type %s",c.type);a=this.Ma(a,b);this.view.pa([new S(this.view.ea.$a(),
"ImageNode",Fb({},this.aa,{url:this.url,layer:this.view.Qa,matrix:(new E(a.x,a.y)).multiply(new Lb(this.scale,this.scale))}))]);this.hs||(this.log("MultiStamp not set; return to pick mode."),this.view.eb());return!0};c.prototype.Va=function(a,b){this.Ha.complete||this.log("Don't draw; image not loaded.");var c=this.Ma(a,b),e=this;this.view.ha(function(a){var b=a.globalAlpha;a.globalAlpha=.5;a.drawImage(e.Ha,c.x,c.y,e.Ha.naturalWidth*e.scale,e.Ha.naturalHeight*e.scale);a.globalAlpha=b});return!0};
c.prototype.Wa=function(){return!0};c.prototype.Lc=function(a){"cancel"===a&&(this.view.eb(),this.view.qc.ua("goto-toolbar"))};return c}();var Nd=function(){function c(a){this.view=a;this.state="none";this.start=new A(0,0);this.No=this.Mo=0;this.log=w.create("PanTool");this.Xb=new Dd(a)}c.prototype.Fc=function(){this.log("Entering PanToolBehaviour");this.view.canvas.style.cursor="all-scroll"};c.prototype.Ac=function(){this.log("Leaving PanToolBehaviour")};c.prototype.bb=function(a){return this.Xb.bb(a)};c.prototype.rb=function(a){if("touchstart"===a.type){var b=a.changedTouches[0];b=this.view.Za(b.pageX,b.pageY);return this.Ta(b.x,b.y,
a)}return"touchmove"===a.type?(b=a.changedTouches[0],b=this.view.Za(b.pageX,b.pageY),this.Va(b.x,b.y,a)):"touchend"===a.type?(b=a.changedTouches[0],b=this.view.Za(b.pageX,b.pageY),this.Wa(b.x,b.y,a)):!0};c.prototype.tn=function(a){switch(a.type){case "touchend":case "touchstart":case "touchmove":return new A(a.changedTouches[0].pageX,a.changedTouches[0].pageY);case "mousedown":case "mouseup":case "mousemove":case "pointerdown":case "pointermove":case "pointerup":return new A(a.pageX,a.pageY);default:return this.log("Can't handle event: %s",
a.type),new A(0,0)}};c.prototype.Ta=function(a,b,c){this.log("onMouseDown type %s",c.type);this.state="dragging";this.start=this.tn(c);this.Mo=this.view.ub;this.No=this.view.ib;return!0};c.prototype.Va=function(a,b,c){if("dragging"!==this.state)return!1;a=this.tn(c);b=this.No+a.y-this.start.y;this.view.ub=this.Mo+a.x-this.start.x;this.view.ib=b;this.view.mc();this.view.ha();return!0};c.prototype.Wa=function(){this.state="none";return!0};c.prototype.Pk=function(a,b,c,e){if(!this.view.fa.get("allowZoom"))return this.log("Zooming is disabled."),
!1;this.log("onMouseWheel(%s, %s, %s)",a,b,c);c=0<c?1/1.1:1.1;a=new Lb(c,c,a,b);b=this.view.ae();b.transform(a);this.view.$g(b);e.stopPropagation();e.preventDefault();return!0};c.prototype.Lc=function(a){"cancel"===a&&this.view.eb()};c.prototype.cd=function(){return"pan"};return c}();var Od=function(c){function a(a,d,e){var b=c.call(this)||this;b.id=a;b.Cd=d;b.Ci=!0;b.width=32;b.height=500;b.Hu=0;b.Fb=new D(0,0,0,0);b.Ra=!1;b.Lp="#c0c0c0";b.Fm="#808080";b.borderWidth=1;b.Xd=0;b.Wd=100;b.Jl=10;b.position=5;b.offset=0;b.log=w.create("SCROLLBAR",!0);b.Ci=!0;b.canvas=qb(document.body);b.canvas.style.position="absolute";b.canvas.style.border="none";b.canvas.classList.add("zwibbler-scrollbar");b.ia=b.canvas.getContext("2d");b.canvas.addEventListener("mousedown",function(a){b.Ta(a)});
e.addEventListener(document.body,"mousemove",function(a){b.Va(a)});e.addEventListener(document.body,"mouseup",function(a){b.Wa(a)});b.canvas.addEventListener("touchstart",function(a){b.rb(a)});e.addEventListener(document.body,"touchmove",function(a){b.rb(a)});e.addEventListener(document.body,"touchend",function(a){b.rb(a)});b.format();return b}n(a,c);a.prototype.Sd=function(a){a.appendChild(this.canvas)};a.prototype.moveTo=function(a,c){this.canvas.style.left=""+a+"px";this.canvas.style.top=""+c+
"px"};a.prototype.Xf=function(a,c){this.width=a;this.height=c;this.canvas.width=this.width;this.canvas.height=c;this.format();this.ha()};a.prototype.be=function(){this.canvas.style.display="none"};a.prototype.show=function(){this.canvas.style.display="block"};a.prototype.Sr=function(){return"block"===this.canvas.style.display};a.prototype.Ho=function(a,c,e,f){this.Xd=a;this.Wd=c-a;this.Jl=e;this.position=f;this.format();this.ha()};a.prototype.format=function(){var a=this.Cd?this.width:this.height;
var c=this.Jl/this.Wd*a;a*=(this.position-this.Xd)/this.Wd;this.Fb=this.Cd?new D(a,0,c-1,this.height-1):new D(0,a,this.width-1,c-1);this.Fb.x=Math.round(this.Fb.x)+.5;this.Fb.y=Math.round(this.Fb.y)+.5;this.Fb.width=Math.round(this.Fb.width);this.Fb.height=Math.round(this.Fb.height)};a.prototype.ha=function(){this.ia.beginPath();this.ia.fillStyle=this.Lp;this.ia.strokeStyle=this.Fm;this.ia.lineWidth=this.borderWidth;this.ia.rect(this.borderWidth/2,this.borderWidth/2,this.width-this.borderWidth,this.height-
this.borderWidth);this.ia.fill();this.ia.stroke();this.ia.beginPath();this.ia.fillStyle=this.Fm;this.ia.strokeStyle="#000000";this.ia.rect(this.Fb.x,this.Fb.y,this.Fb.width,this.Fb.height);this.ia.fill();this.ia.stroke()};a.prototype.Ym=function(a){var b=z(this.canvas).dc(),c=0,f=0;if("touchstart"===a.type||"touchend"===a.type||"touchmove"===a.type)c=a.changedTouches[0].pageX,f=a.changedTouches[0].pageY;else if("mousedown"===a.type||"mouseup"===a.type||"mousemove"===a.type)c=a.pageX,f=a.pageY;return new A(c-
b.left,f-b.top)};a.prototype.rb=function(a){switch(a.type){case "touchstart":this.Ta(a);break;case "touchend":this.Wa(a);break;case "touchmove":this.Va(a)}};a.prototype.mo=function(a){a=this.Cd?a.x/this.width*this.Wd+this.Xd:a.y/this.height*this.Wd+this.Xd;a=Math.min(a,this.Wd-this.Jl+this.Xd);return a=Math.max(a,this.Xd)};a.prototype.Ta=function(a){a.preventDefault();a=this.Ym(a);this.Fb.Vc(a.x,a.y)?this.Cd?(this.offset=a.x-this.Fb.x,a.x-=this.offset):(this.offset=a.y-this.Fb.y,a.y-=this.offset):
(this.position=this.mo(a),this.offset=0,this.Cd?this.Fb.x=(this.position-this.Xd)/this.Wd*this.width:this.Fb.y=(this.position-this.Xd)/this.Wd*this.height,this.ua("scroll",this.position),this.ha());this.Ra=!0};a.prototype.Va=function(a){this.Ra&&(this.Ra&&"mousemove"===a.type&&0===a.buttons?this.Ra=!1:(a.preventDefault(),a=this.Ym(a),this.Cd?a.x-=this.offset:a.y-=this.offset,this.position=this.mo(a),this.ua("scroll",this.position),this.format(),this.ha()))};a.prototype.Wa=function(){this.Ra&&(this.Ra=
!1)};a.prototype.sk=function(){return this.Cd?this.height:this.width};a.qu=0;a.ou=1;a.ku=2;a.pu=3;return a}(Pc);function Pd(c,a,b,d,e,f){var g=!1;c.save();switch(b){case 0:case 3:var h=a.height;var l=a.width;break;default:h=a.width,l=a.height}switch(b){case 2:g=!0}c.translate(a.x,a.y);c.fillStyle="rgba(0, 0, 0, 0.2)";c.fillStyle="#ccc";c.fillRect(0,0,a.width,a.height);c.lineWidth=1;c.fillStyle="black";c.strokeStyle="black";c.font="10px sans-serif";a=Math.ceil(50/e);b=f/e;var k=Math.ceil(b/a)*a;f=k;c.beginPath();if(g)for(b=(k-b)*e;b<l;)c.moveTo(0,b),c.lineTo(h,b),g=f.toString()+d,c.fillText(g,0,b+1+10),f+=a,
b+=e*a;else for(b=(k-b)*e;b<l;)c.moveTo(b,h),c.lineTo(b,0),g=f.toString()+d,c.fillText(g,b+1,10),f+=a,b+=e*a;c.stroke();c.restore()};var Qd=function(){function c(){this.images={}}c.prototype.add=function(a,b){var c=this.images[a];c||(c={Ha:null,Li:0},Kd.load(b,function(a){c.Ha=a}),this.images[a]=c);c.Li+=1};c.prototype.release=function(a){var b=this.images[a];b&&(--b.Li,0>=b.Li&&delete this.images[a])};c.prototype.get=function(a){return(a=this.images[a])&&a.Ha?a.Ha:null};return c}();for(var Rd,Sd=[],Td=0;4>Td;Td++)Sd.push(String.fromCharCode(">2$-".charCodeAt(Td)^"zwibbler3".charCodeAt(Td%9)));Rd=Sd.join("");for(var Ud,Vd=[115,116,114,111,107,101,84,101,120,116],Wd=[],Xd=0;Xd<Vd.length;Xd++)Wd.push(String.fromCharCode(Vd[Xd]));Ud=Wd.join("");
var Yd=function(){function c(a,b,d,e,f,g,h){var l=this;this.canvas=a;this.ea=b;this.qc=d;this.fa=e;this.language=f;this.za=g;this.La=h;this.md="none";this.ih=this.hh=0;this.scale=1;this.ib=this.ub=0;this.Oc=new D(0,0,0,0);this.al=new Tb;this.Sf=this.Xg=this.Oi=!0;this.Ni=new F;this.selection=[];this.gf=[];this.Qa="default";this.le=this.Yh=!1;this.Sc=this.background=this.we=null;this.backgroundRepeat="no-repeat";this.Xc=this.xa=null;this.Xl=4;this.Yl=2*this.Xl;this.ne=this.tg=null;this.Yj=!1;this.Wc=
null;this.uf=!1;this.Ub=this.Bb=this.Lb="#000000";this.Bf=5;this.Gf="";this.Yb=0;this.Kk=new D(0,0,0,0);this.Lk=new D(0,0,0,0);this.Aa={tb:!1,Ra:!1,Ij:!1,x:100,y:100};this.no=function(){};this.ui=new Qd;this.mi=[];this.log=w.create("VIEW");this.ia=this.canvas.getContext("2d");this.le=!0===e.get("pageView");this.Ss();this.ma=new nd(this);this.La.add(function(){l.ma&&l.ma.Ac&&l.ma.Ac()});this.dd=new Od("horizontal",!0,this.La);this.dd.Sd(this.canvas.parentNode);this.gc=new Od("vertical",!1,this.La);
this.gc.Sd(this.canvas.parentNode);this.Ei=this.Bg();this.xe=new Ib(this.canvas.width/this.Ei,this.canvas.height/this.Ei);var k=this;this.request=new Ld;this.request.canvas=this.canvas;this.request.Ja("reformat",function(a){k.log("Node %s requests reformat",a);k.ea.Ge(a)&&(k.log("   Reformatting... zoom=%s",k.md),k.ea.Lg(a));k.update();a===k.Sc&&k.Mh();k.Rf();k.za.ua("resource-loaded")});this.request.Ja("convert-dom-request",function(a,b){k.za.ua("convert-dom-request",b,a)});e.Ja("useTouch",function(){k.ne=
null;k.Yl=2*k.Xl});this.gc.Ja("scroll",function(a){k.ib=-a*k.scale;k.ha()});this.dd.Ja("scroll",function(a){k.ub=-a*k.scale;k.ha()});this.Mh();this.ea=this.hf(b);(a=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame)?(this.log("Using requestAnimationFrame"),this.requestAnimationFrame=a):this.log("Emulating requestAnimationFrame");this.fa.Ja("update",function(a,b){k.Fd(a,b)});this.La.addEventListener(document,"webkitfullscreenchange",function(){0<=navigator.userAgent.search("Safari")&&
0>navigator.userAgent.search("Chrome")&&(l.log("SAFARI WORKAROUND: Disabling requestAnimationFrame."),l.requestAnimationFrame=c.prototype.requestAnimationFrame)});a=document;a.fonts&&this.La.addEventListener(a.fonts,"loadingdone",function(){l.log("Font loading done, redraw now.");l.ha()});this.xc(.5,0,0,-30,"","rotate");this.xc(0,0,0,0,"","scale");this.xc(1,0,0,0,"","scale");this.xc(1,1,0,0,"","scale");this.xc(0,1,0,0,"","scale");this.xc(.5,0,0,0,"","scale");this.xc(1,.5,0,0,"","scale");this.xc(.5,
1,0,0,"","scale");this.xc(0,.5,0,0,"","scale");this.ma=this.eb()}c.prototype.ig=function(a){this.fa.get("adaptiveBrushWidth")&&(a/=this.scale);return a};c.prototype.vn=function(a){var b,c=-1,e=!1;for(b=0;b<a.cf.length;b++){var f=a.cf[b];f===this.Sc&&(this.log("Background node has been removed"),c=-1)}for(b=0;b<a.ac.length;b++){f=a.ac[b];var g=this.ea.va(f,!1);"background"===g.ka("layer")&&(this.log("Background node has been added"),c=f)}for(b=0;b<a.bg.length;b++)f=a.bg[b],g=this.ea.va(f,!1),"background"===
g.ka("layer")?(this.log("Background node has been changed"),c=f,e=!0):f===this.Sc&&(this.log("Node removed from background layer"),c=-1);-1===c||!e&&c===this.Sc||(this.Sc=c,this.Mh(),this.Sc&&this.ea.va(this.Sc,!1).ke(!0));a.ac.length&&this.za.ua("nodes-added",a.ac);a.bg.length&&this.za.ua("nodes-changed",a.bg);a.cf.length&&this.za.ua("nodes-removed",a.cf)};c.prototype.requestAnimationFrame=function(a){a()};c.prototype.fk=function(){return parseInt(z(this.canvas).Me("borderLeftWidth"),10)||0};c.prototype.xg=
function(){this.log("getActiveLayer() -> %s",this.Qa);return this.Qa};c.prototype.Qi=function(a){this.log("setActiveLayer(%s)",a);this.Qa=a;this.pb();this.Mb();this.ha()};c.prototype.ah=function(a,b){this.ea.ah(a,b);b||a!==this.Qa||(this.pb(),this.Mb());this.ha()};c.prototype.hf=function(a){this.log("setDocument()");this.eb();this.ea=a;this.scale=1;this.ib=this.ub=0;this.selection=[];this.Xc=this.xa=null;this.Yb=1;this.Oc=new D(0,0,0,0);this.al=new Tb(this.Oc);this.Ni=new F;this.Gf="";this.Qa="default";
this.Bb="#ffffff";this.Ub=this.fa.Na("defaultBrushColour");this.Lb=this.fa.Na("defaultStrokeStyle");this.wa={};this.wa.lineWidth=this.fa.Na("defaultLineWidth");this.wa.sloppiness=.5;this.wa.fontName=this.fa.Na("defaultFont");this.wa.fontSize=this.fa.Na("defaultFontSize");this.wa.bold=this.fa.Na("defaultBold");this.wa.italic=this.fa.Na("defaultItalic");this.wa.smoothness=.3;this.wa.textFillStyle=this.fa.Na("defaultTextFillStyle");this.wa.textStrokeStyle=this.fa.Na("defaultTextStrokeStyle");this.wa.textLineWidth=
this.fa.Na("defaultTextLineWidth");this.wa.textDecoration=this.fa.Na("defaultTextDecoration");this.wa.textAlign=this.fa.Na("defaultTextAlign");this.Bf=this.fa.get("defaultBrushWidth");var b=this.Ke();this.ub=-b.x;this.ib=-b.y;this.mc();this.ea.nl=this.fa.get("spotHighlightColour");this.ea.Wi=this.fa.get("spotHighlightZIndex");this.ea.format(this.ia,this.request);this.Lk=new D(0,0,0,0);this.Kk=new D(0,0,0,0);"none"!==this.md?this.vc(this.md):(this.vc(this.fa.get("defaultZoom")),this.ha());return a};
c.prototype.Fd=function(a,b){var c=!1;switch(a){case "allowResize":this.Af();this.ha();break;case "defaultBrushColour":this.Ub=b;break;case "defaultFillStyle":this.Bb=this.wa.fillStyle=b;break;case "defaultStrokeStyle":this.Lb=b;this.wa.strokeStyle=b;break;case "defaultLineWidth":this.wa.lineWidth=b;break;case "defaultFont":this.wa.fontName=b;break;case "defaultBold":this.wa.bold=b;break;case "defaultTextAlign":this.wa.textAlign=b;break;case "defaultTextDecoration":this.wa.textDecoration=b;break;
case "defaultItalic":this.wa.italic=b;break;case "defaultFontSize":this.wa.fontSize=b;break;case "defaultTextFillStyle":this.wa.textFillStyle=b;break;case "defaultTextStokeStyle":this.wa.textStrokeStyle=b;break;case "defaultTextLineWidth":this.wa.textLineWidth=b;break;case "defaultBrushWidth":this.Bf=b;break;case "defaultZoom":this.vc(b);break;case "pageView":this.le=b;c=!0;break;case "pagePlacement":case "pageInflation":this.vc(this.md);break;case "snap":case "background":case "gridSpacing":case "gridBlocks":case "gridColour":case "backgroundImage":this.Mh();
c=!0;break;case "pageShadow":case "outsidePageColour":c=!0;break;case "readOnly":!0===b&&(this.eb(),this.pb(),this.Mb(),c=!0);this.ea.Wf(b);break;case "spotHighlightColour":this.ea.nl=b;c=!0;break;case "spotHighlightZIndex":this.ea.Wi=b;c=!0;break;case "showRuler":case "pixelsPerUnit":case "units":c=!0}this.ma.Fd&&this.ma.Fd(a,b);c&&this.ha()};c.prototype.je=function(a,b){this.wa[a]=b;"fillStyle"===a?this.Bb=b:"strokeStyle"===a&&(this.Lb=b)};c.prototype.vc=function(a){a!==this.md&&this.log("Zooming to: %s",
a);var b=this.wd().width-20;var c=this.ea.zn("width");var e=!0;this.md=a;c||"number"===typeof a||(this.log("WARNING: Cannot zoom to page/width because the document size has not been set."),e="page"===a||"width"===a);if("number"===typeof a)this.scale=a;else if("none"===a||this.ea.empty()||!c)this.scale=1;else{if("page"===a)return c=this.Ke(),this.$g(c,"centre"===this.fa.get("pagePlacement"),!0),this.md=a,this.ma.Re&&this.ma.Re(),e;"width"===a&&(c=this.Ke(),this.scale=b/c.width,this.ub=-c.x*this.scale,
this.ib=-c.y*this.scale,this.log("RECT=%s scale=%s tx=%s ty=%s",c,this.scale,this.ub,this.ib),this.md=a)}this.mc();this.ha();this.ma.Re&&this.ma.Re();return e};c.prototype.Za=function(a,b,c){void 0===c&&(c=!1);a=this.tk().apply(a,b);c||(a=this.Ma(a));return a};c.prototype.Tj=function(a,b){return this.tk().inverse().apply(a,b)};c.prototype.ns=function(a,b,c){return a.yd().multiply(this.tk()).apply(b,c)};c.prototype.Zb=function(a){return this.Za(a.pageX,a.pageY,!0)};c.prototype.Lc=function(a,b){this.ma.Lc&&
this.ma.Lc(a,b);if("TEXTAREA"!==b.target.tagName&&"INPUT"!==b.target.tagName&&!this.Kr(a,b)){switch(a){case "next-page":this.Rb(this.ea.Sa+1);break;case "previous-page":this.Rb(this.ea.Sa-1);break;case "zoom-to-page":this.fa.get("allowZoom")&&this.vc("page");break;case "zoom-to-width":this.fa.get("allowZoom")&&this.vc("width")}b.preventDefault();b.stopPropagation()}};c.prototype.Ss=function(){function a(a){c.log(a.type)}function b(a){a.stopPropagation();a.preventDefault()}var c=this,e=this;this.fk();
this.canvas.addEventListener("gesturestart",function(a){e.log("GestureStart");e.ma.bb&&!1!==e.ma.bb(a)?(a.stopPropagation(),a.preventDefault()):e.log("Pass to browser")});this.canvas.addEventListener("gesturechange",function(a){e.ma.bb&&!1!==e.ma.bb(a)?(a.stopPropagation(),a.preventDefault()):e.log("Pass to browser")});this.canvas.addEventListener("gestureend",function(a){e.log("GestureEnd");e.ma.bb&&!1!==e.ma.bb(a)?(a.stopPropagation(),a.preventDefault()):e.log("Pass to browser")});"ongesturestart"in
this.canvas?this.log("Using native gestures"):(this.log("Using emulated gestures"),Ma(this.canvas,function(a){e.ma.bb&&!1!==e.ma.bb(a)?(a.stopPropagation(),a.preventDefault()):e.log("Allow %s event to pass through",a.type)}));var f="ontouchstart"in window,g="onpointerdown"in window,h="ongesturestart"in window,l="onmousedown"in window;this.log("Have TouchEvents: %s",f);this.log("Have PointerEvents: %s",g);this.log("Have GestureEvents: %s",h);this.log("Have MouseEvents: %s",l);g&&!this.fa.get("allowPointerEvents")&&
(this.log("Configuration does not allow PointerEvents"),g=!1);var k=new A(0,0),m=0,q=0,p=!1,t=!1,r;this.no=function(){e.log("Preventing next double click.");p=!0};if(f){this.log("Using touch events for screen movement.");var v=new Date,x=new A(0,0);this.canvas.addEventListener("touchstart",function(a){if(e.ma.rb&&"touchstart"===a.type){var b=!0;300<(new Date).getTime()-v.getTime()?b=!1!==e.ma.rb(a):e.ma.fe&&(r=new A(a.changedTouches[0].pageX,a.changedTouches[0].pageY),e.log("Double-click distance: %s",
r.vb(x)),10>r.vb(x)?(r=e.Zb(a.changedTouches[0]),b=!1!==e.ma.fe(r.x,r.y,a)):b=!1);b&&(a.stopPropagation(),a.preventDefault());v=new Date;x=new A(a.changedTouches[0].pageX,a.changedTouches[0].pageY)}});this.canvas.addEventListener("touchmove",function(a){e.ma.rb&&!1!==e.ma.rb(a)&&(a.stopPropagation(),a.preventDefault())});this.canvas.addEventListener("touchend",function(a){e.ma.rb&&!1!==e.ma.rb(a)&&(a.stopPropagation(),a.preventDefault())})}else if(g){this.log("Using pointer events for movement");
this.canvas.addEventListener("pointerdown",function(a){"pointerdown"===a.type&&(e.log("PointerDown"),k=new A(a.pageX,a.pageY),m=rb(),t=!0,e.ma.Ta&&(r=e.Zb(a),!1!==e.ma.Ta(r.x,r.y,a)&&(a.stopPropagation(),a.preventDefault())))});this.canvas.addEventListener("pointermove",function(a){t&&0===a.buttons&&(e.log("MISSED POINTERUP! Fixing."),I(a));e.ma.Va&&(r=e.Zb(a),!1!==e.ma.Va(r.x,r.y,a)&&(a.stopPropagation(),a.preventDefault()))});var I=function(a){if("pointerup"===a.type||"pointermove"===a.type){e.log("PointerUp");
r=e.Zb(a);e.ma.Wa&&t&&!1!==e.ma.Wa(r.x,r.y,a)&&(a.stopPropagation(),a.preventDefault());t=!1;e.log("TimeDist=%s PixelDist=%s",rb()-m,k.vb(new A(a.pageX,a.pageY)));var b=q,c=200>rb()-m&&2>k.vb(new A(a.pageX,a.pageY));e.log("Didclick: %s dbltime=%s",c,rb()-b);e.ma.Gd&&c&&(e.log("Simulate mouseclick from pointerup"),r=e.Zb(a),!1!==e.ma.Gd(r.x,r.y,a)&&(a.stopPropagation(),a.preventDefault()));e.ma.fe&&c&&300>rb()-b&&!p&&(e.log("Simulate double-click"),!1!==e.ma.fe(r.x,r.y,a)&&(a.stopPropagation(),a.preventDefault()));
c&&(q=rb(),p=!1)}};this.La.addEventListener(document,"pointerup",I);this.canvas.addEventListener("pointerleave",function(a){e.ma.eo&&(r=e.Zb(a),!1!==e.ma.eo(r.x,r.y,a)&&(a.stopPropagation(),a.preventDefault()))})}!g||f?(this.log("Using mouse events for screen movement."),this.canvas.addEventListener("mousemove",function(a){e.ma.Va&&(r=e.Zb(a),e.ma.Va(r.x,r.y,a));a.preventDefault()}),this.canvas.addEventListener("mousedown",function(a){t=!0;e.ma.Ta&&(r=e.Zb(a),e.ma.Ta(r.x,r.y,a));a.preventDefault()}),
this.La.addEventListener(document,"mouseup",function(a){e.ma.Wa&&t&&(r=e.Zb(a),e.ma.Wa(r.x,r.y,a));t=!1}),this.canvas.addEventListener("click",function(a){z(e.canvas).dc();e.ma.Gd&&(r=e.Zb(a),e.ma.Gd(r.x,r.y,a));a.stopPropagation();a.preventDefault()}),this.canvas.addEventListener("dblclick",function(a){z(e.canvas).dc();if(e.ma.fe||e.ma.Gd)r=e.Zb(a),vb()&&e.ma.Gd&&(e.log("Insert false mouse click for IE"),e.ma.Gd(r.x,r.y,a)),e.ma.fe&&e.ma.fe(r.x,r.y,a);a.stopPropagation();a.preventDefault()})):this.log("Not using mouse events.");
this.canvas.addEventListener("contextmenu",function(a){var b=e.Zb(a);e.ma.bo&&!1!==e.ma.bo(b.x,b.y,a)?(a.stopPropagation(),a.preventDefault()):e.log("Pass contextmenu to browser")});this.canvas.addEventListener("mouseenter",b);this.canvas.addEventListener("mouseleave",b);this.canvas.addEventListener("mouseover",b);this.canvas.addEventListener("mouseout",b);!window.parent&&this.fa.get("setFocus")&&this.canvas.focus();f="mousewheel";"onwheel"in document.createElement("div")&&(f="wheel");e.log("Binding to '%s' for mouse wheel",
f);this.canvas.addEventListener(f,function(a){if("wheel"===a.type||"mousewheel"===a.type){var b=a.wheelDelta||-40*a.deltaY,c=b/120*32;r=e.Zb(a);if((!e.ma.Pk||!1===e.ma.Pk(r.x,r.y,c,a))&&e.gc.Sr()){var d=e.Ke();e.ib=-120>=b?Math.max(e.ib+c,-(d.bottom()*e.scale-e.canvas.clientHeight)):Math.min(e.ib+c,-d.y*e.scale);e.mc();e.ha();a.stopPropagation();a.preventDefault()}}});this.canvas.addEventListener("dragover",function(a){e.log("Dragover");a.preventDefault()});this.canvas.addEventListener("drop",a);
this.canvas.addEventListener("dragenter",a);this.canvas.addEventListener("dragleave",a)};c.prototype.Ok=function(a){function b(a){var b=new FileReader;b.readAsDataURL(a.getAsFile());b.onloadend=function(){c.ks(b.result)}}this.log("Received clipboard event: %s",a.type);if(this.fa.get("allowSystemClipboard")){var c=this;switch(a.type){case "copy":case "cut":if(!this.An())break;this.log("Cut to system clipboard.");var e=this.Ce(!0,this.rc(!1));a.clipboardData.setData("application/zwibbler",e);a.preventDefault();
"cut"===a.type&&this.pg();break;case "paste":for(this.log("There are %s items on the clipboard",a.clipboardData.items.length),e=0;e<a.clipboardData.items.length;e++){var f=a.clipboardData.items[e];this.log("Item [%s] type is %s",e,f.type);if(0===f.type.indexOf("image/")){b(f);a.preventDefault();break}else if("application/zwibbler"===f.type){this.log("Pasting from system clipboard");f.getAsString(function(a){c.Rg(a)});a.preventDefault();break}}}}else this.log("   ignored due to allowSystemClipboard setting.")};
c.prototype.Kr=function(a,b){if(!this.Aa.tb)return!1;var c=0,e=0,f=this.fa.get("nudge");switch(a){case "right":c=f;break;case "left":c=-f;break;case "down":e=f;break;case "up":e=-f;break;case "enter":if(this.ma.Gd){this.Aa.Ra=!1;var g="click"}else this.Aa.Ra=!this.Aa.Ra,g=this.Aa.Ra?"mousedown":"mouseup"}if(c||e)g=this.wd(),this.Aa.x+=c,this.Aa.x=Math.max(this.Aa.x,0),this.Aa.x=Math.min(g.width,this.Aa.x),this.Aa.y+=e,this.Aa.y=Math.max(this.Aa.y,0),this.Aa.y=Math.min(g.height,this.Aa.y),this.ha(),
g="mousemove";return g?(b.preventDefault(),b.stopPropagation(),this.ha(),e=z(this.canvas).dc(),c=this.Aa.x+e.left-window.pageXOffset,e=this.Aa.y+e.top-window.pageYOffset,f=this.Za(c,e),this.log("Simulate a %s at (%s,%s)",g,c,e),"mousedown"!==g&&"click"!==g||!this.ma.Ta||this.ma.Ta(f.x,f.y,b),"mousemove"===g&&this.ma.Va&&this.ma.Va(f.x,f.y,b),"mouseup"!==g&&"click"!==g||!this.ma.Wa||this.ma.Wa(f.x,f.y,b),!0):!1};c.prototype.il=function(a){void 0===a&&(a=!1);this.Aa.tb=!0;this.Aa.Ra=!1;this.Aa.Ij=a;
this.log("Showing keyboard cursor, caret=%s",a);this.ha()};c.prototype.wt=function(a){this.Aa.tb=!0;this.Aa.Ij=!1;if(0<this.selection.length){this.log("showKeyboardCursorAndStartMoving()");this.Aa.Ra=!0;var b=this.Oc.Uc();this.Aa.x=b.x;this.Aa.y=b.y;this.eb();this.fb(new Bd(this,new wd(qd,this.selection[0].Ea()),!1,b.x-4,b.y-4,a))}this.ha()};c.prototype.Nr=function(){this.Aa.tb&&(this.log("Hiding keyboard cursor"),this.Aa.tb=!1,this.ha())};c.prototype.Rr=function(a){var b=this.fk(),c=z(this.canvas).dc(),
e=this.gc.sk();if("changedTouches"in a){var f=a.changedTouches[0].pageX-c.left-b;a=a.changedTouches[0].pageY-c.top-b}else if("pageX"in a)f=a.pageX-c.left-b,a=a.pageY-c.top-b;else return!1;b=this.wd();return this.ne&&f>b.width-this.ne.width-e&&a<this.ne.height};c.prototype.Ma=function(a,b){void 0===b&&(b=0);b=b||this.fa.get("snap")||0;this.fa.get("autoSnap");if(0<b){var c=Math.round(a.x/b)*b;var e=Math.round(a.y/b)*b}else c=a.x,e=a.y;return new A(c,e)};c.prototype.Ai=function(){var a=this.rc(!1);a.length&&
this.pa([new Kc(a,Kc.$l)])};c.prototype.zi=function(){var a=this.rc(!1);a.length&&this.pa([new Kc(a,Kc.Zl)])};c.prototype.Fh=function(){var a=this.rc(!1);a.length&&this.pa([new Kc(a,Kc.Rl)])};c.prototype.Pi=function(){var a=this.rc(!1);a.length&&this.pa([new Kc(a,Kc.oj)])};c.prototype.setProperty=function(a,b){var c=this.rc(!0);this.wa[a]=b;if(c.length){var e=[new Dc(c,a,b)];if("fillStyle"===a)for(var f=0;f<c.length;f++){var g=this.ea.va(c[f],!1);g&&(this.log("nodeType=%s closed=%s",g.type(),g.ka("closed")),
"PathNode"===g.type()&&!1===g.ka("closed")&&e.push(new Dc([c[f]],"strokeStyle",b)))}this.pa(e)}0<this.selection.length&&"lineWidth"===a&&"BrushNode"===this.selection[0].type()?this.Bf=b:"textFillStyle"===a&&(this.wa.textFillStyle=b)};c.prototype.hd=function(a,b){this.ma.hd&&this.ma.hd(a,b)};c.prototype.gi=function(){return this.wa.fillStyle};c.prototype.ji=function(){return this.wa.strokeStyle};c.prototype.hl=function(a,b){this.log("setSelectionOpacity(%s, fill=%s)",a,b);for(var c=this.rc(!0),e=[],
f=b?"fillStyle":"strokeStyle",g=0;g<c.length;g++){var h=c[g],l=this.ea.va(h);l&&(l=l.ka(f))&&(l=zb(l,a),e.push(new Dc([h],f,l)),this.log("   set %s of %s to %s",f,h,l))}e.length&&this.pa(e);this.log("   Affected %s of %s nodes",e.length,c.length)};c.prototype.group=function(){var a=this.rc(!1);a.length&&this.pa([new Gc(this.ea.$a(),a)])};c.prototype.lh=function(){var a=this.rc(!1);a.length&&this.pa([new Hc(a)])};c.prototype.pg=function(){var a=this.rc(!1);a.length&&this.pa([new Cc(a)])};c.prototype.pb=
function(a){void 0===a&&(a=!1);var b=!1;0<this.selection.length&&(this.Yb+=1,this.selection.length=0,this.log("Clear selection. selectGeneration=%s",this.Yb),b=!0);null!==this.Xc&&(this.za.ua("selected-edit-handle",null,null),b=!0);this.xa&&(this.log("Clear selection."),this.Xc=this.xa=null,b=!0);b&&a&&(this.Mb(),this.ha())};c.prototype.ve=function(a){this.jf(null);if(a.Yb!==this.Yb&&a.zd()===this.Qa){this.selection.push(a);a.Yb=this.Yb;if(a.Jn()){for(var b=a.parent,c=0;c<b.children.length;c++)this.ve(b.children[c]);
this.ve(b)}a.children&&0<a.children.length&&this.ve(a.children[0])}};c.prototype.selectNodes=function(a){this.pb();for(var b=0;b<a.length;b++)a[b].ka("locked")||"PageNode"===a[b].type()||this.ve(a[b]);this.Mb()};c.prototype.at=function(a,b){var c=this.ea.va(a,!1);c?c.Gn()?(c!==this.xa&&this.jf(c),this.log("Select edit handle %s",b),this.Xc=b,this.za.ua("selected-edit-handle",a,b)):this.log("selectEditHandle: That handle is not selectable."):this.log("selectEditHandle: nodeid %s does not exist.",a)};
c.prototype.pa=function(a,b){void 0===b&&(b=!1);if(this.fa.get("readOnly")&&!b)this.log("readOnly mode: Ignoring change.");else if(0!==a.length){var c=this.ea.pa(a,b),e;this.ea.format(this.ia,this.request);if(c.ac.length&&!b){var f=[];for(e=0;e<c.ac.length;e++)f.push(this.ea.va(c.ac[e],!1));this.fa.get("autoPickTool")&&this.selectNodes(f)}else if(this.selection.length||this.xa){e=!1;for(f=0;f<a.length;f++){var g=a[f];if(g instanceof Dc&&("lockSize"===g.name||"lockRotate"===g.name||"lockPosiiton"===
g.name||"lockAspectRatio"===g.name)||g instanceof Kc){e=!0;break}}if(0<c.cf.length||e){f=0;this.Yb+=1;g=this.ea.Sa;for(e=0;e<this.selection.length;e++)e!==f&&(this.selection[f]=this.selection[e]),this.ea.Ge(this.selection[f].id)&&this.ea.$c(this.selection[f].id)===g&&(this.selection[f].Yb=this.Yb,f++);this.selection.length!==f&&(this.selection.length=f);this.xa&&!this.ea.Ge(this.xa.id)&&(this.log("EditNode %s no longer exists",this.xa.id),this.xa=null,null!==this.Xc&&this.za.ua("selected-edit-handle",
null,null),this.Xc=null);0!==this.selection.length||this.xa||this.pb();this.Mb();this.log("Done selecting called.")}}this.vn(c);this.Rf();this.ha();this.za.$h("document-changed")}};c.prototype.$s=function(a){a=this.ea.Ar(a);for(var b=0;b<a.length;b++)this.ve(a[b])};c.prototype.Mb=function(){this.Af();this.za.$h("selected-nodes")};c.prototype.Uk=function(){for(var a=0,b=this.mi;a<b.length;a++){var c=b[a];""!==c.Ne&&this.ui.release(c.Ne)}this.mi.length=0};c.prototype.xc=function(a,b,c,e,f,g,h){this.mi.push({type:g,
position:new A(a,b),offset:new A(c,e),Ne:f,Jm:h});""!==f&&this.ui.add(f,f)};c.prototype.Af=function(){var a;this.Sf=this.Xg=this.Oi=!0;var b=!1;this.gf.length=0;if(0!==this.selection.length){this.Oc=this.selection[0].rect.clone();this.selection[0].ka("lockSize")&&(this.Oi=!1);this.selection[0].ka("lockRotation")&&(this.Xg=!1);this.selection[0].ka("lockPosition")&&(this.Sf=!1);this.selection[0].ka("lockAspectRatio")&&(b=!0);for(a=1;a<this.selection.length;a++)this.Oc.mh(this.selection[a].rect),this.selection[a].ka("lockSize")&&
(this.Oi=!1),this.selection[a].ka("lockRotation")&&(this.Xg=!1),this.selection[a].ka("lockAspectRatio")&&(b=!0),this.selection[a].ka("lockPosition")&&(this.Sf=!1);this.al=1===this.selection.length?this.selection[0].gn():new Tb(this.Oc);var c=0<this.fa.get("snap");if(1<this.selection.length){var e=new F;a=null;var f=this.Oc}else a=this.selection[0],f=a.Pa,e=a.Ea();for(var g=0,h=this.mi;g<h.length;g++){var l=h[g];if("scale"===l.type){if(!this.fa.get("allowResize"))continue;if("scale"===l.type&&(0!==
l.position.x&&1!==l.position.x||0!==l.position.y&&1!==l.position.y)&&b)continue}else if("rotate"===l.type&&!this.Xg)continue;this.gf.push(zd(l,f,e,c))}if(this.Xg&&a&&a.ka("rotationHandles"))for(b=a.ka("rotationHandles"),a=0;a<b.length;a+=4)new A(b[a],b[a+1]),g=new A(b[a+2],b[a+3]),this.gf.push(new vd(rd,e,f,g,c))}};c.prototype.Wp=function(){for(var a=0,b=0;b<this.selection.length;b++)b!==a&&(this.selection[a]=this.selection[b]),this.ea.Ge(this.selection[a].id)&&(a+=1);this.selection.length!==a&&(this.selection.length=
a);this.xa&&!this.ea.Ge(this.xa.id)&&(this.xa=null,null!==this.Xc&&this.za.ua("selected-edit-handle",null,null),this.Xc=null)};c.prototype.ko=function(a,b){return this.selection.length&&this.al.Vc(a,b)};c.prototype.An=function(){return 0!==this.selection.length||null!==this.xa};c.prototype.ad=function(){var a=this.selection.concat();this.xa&&a.push(this.xa);return a};c.prototype.zr=function(a){if(0===a.length)return new A(0,0);for(var b=a[0].rect.clone(),c=1;c<a.length;c++)b.mh(a[c].rect);return b.Uc()};
c.prototype.qn=function(a){for(var b=[],c=0;c<a.length;c++)this.log("Selected id=%s",a[c].id),b.push(a[c].id);return b};c.prototype.tk=function(){var a=z(this.canvas).dc();this.fa.get("showRuler")&&(a.left+=20,a.top+=20);return(new F).multiply(new Lb(1/this.scale,1/this.scale)).multiply(new E(-this.ub,-this.ib)).multiply(new E(-a.left,-a.top))};c.prototype.rc=function(a){var b=this.ad();a||(b=this.ea.Hh(b));return this.qn(b)};c.prototype.gk=function(a){for(var b=null,c=0;c<a.length;c++){var e=this.ea.va(a[c]);
e&&(null===b?b=e.rect.clone():b.mh(e.rect))}null===b&&(b=new D(0,0,0,0));return b};c.prototype.update=function(a,b){void 0===a&&(a=!1);if(this.ea.format(this.ia,this.request)||a)this.Af(),this.ha(b)};c.prototype.Mh=function(){var a=this.fa.get("snap"),b=null,c;var e=this.fa.get("background");var f=u.ci(e),g=this.fa.get("backgroundImage");this.background=this.we=null;this.backgroundRepeat="no-repeat";var h=this;this.log("createBackground() background=%s",e);this.log("backgroundNodeId==%s",this.Sc);
if("grid"===e){this.backgroundRepeat="repeat";a=this.fa.get("gridBlocks");g=this.fa.get("gridSpacing");var l=(a||1)*g;b=qb(document.body);b.width=l;b.height=l;e=b.getContext("2d");e.fillStyle="#ffffff";e.fillRect(0,0,l,l);e.beginPath();for(c=0;c<l;c+=g)if(c%l||1>a)e.moveTo(c+.5,0),e.lineTo(c+.5,l);for(c=0;c<l;c+=g)if(c%l||1>a)e.moveTo(0,c+.5),e.lineTo(l,c+.5);e.strokeStyle=this.fa.get("gridColour");e.lineWidth=.5;e.stroke();if(0<a){e.beginPath();for(c=0;c<=l;c+=l)e.moveTo(c,0),e.lineTo(c,l);for(c=
0;c<=l;c+=l)e.moveTo(0,c+.5),e.lineTo(l,c+.5);e.lineWidth=2;e.stroke()}}else if(g)this.request.add(0,"image",g,null,function(a){h.log("Background image finished loading");h.background=a});else if(this.Sc){if(this.log("Regenerate background image"),a=this.ea.va(this.Sc,!1))e=a.rect.clone(),b=qb(document.body),b.width=e.x+e.width,b.height=e.y+e.height,e=b.getContext("2d"),a.ha(e)}else f?(this.log("Using background colour %s",f.toString()),this.we=function(a,b,c,d,e){a.fillStyle=f.toString();a.fillRect(b,
c,d,e)}):0<a&&"clear"!==e&&(this.backgroundRepeat="repeat",b=qb(document.body),b.width=a,b.height=a,e=b.getContext("2d"),e.beginPath(),e.moveTo(0,0),e.arc(0,0,3,0,2*Math.PI,!1),e.moveTo(a,0),e.arc(a,0,3,0,2*Math.PI,!1),e.moveTo(a,a),e.arc(a,a,3,0,2*Math.PI,!1),e.moveTo(0,a),e.arc(0,a,3,0,2*Math.PI,!1),e.fillStyle="#c0c0c0",e.fill());b&&document.body.removeChild(b);this.background=b};c.prototype.td=function(a,b,c,e,f){a.nd=null;this.background?(a.nd=a.createPattern(this.background,this.backgroundRepeat),
a.fillStyle=a.nd||"magenta",a.fillRect(b,c,e,f)):this.we?this.we(a,b,c,e,f):"G_vmlCanvasManager"in window&&(a.fillStyle="rgba(0, 0, 0, 0.0)",a.fillRect(b,c,e,f))};c.prototype.uq=function(a){var b=this.ea.qk();a.beginPath();a.fillStyle="#FFFFFF";this.fa.get("pageShadow")&&(a.shadowOffsetX=3/this.scale,a.shadowOffsetY=3/this.scale,a.shadowBlur=5/this.scale,a.shadowColor="rgba(0,0,0,1.0)");a.rect(0,0,b.width,b.height);a.fill();a.shadowColor="rgba(0,0,0,0.0)";a.shadowBlur=0;a.shadowOffsetX=0;a.shadowOffsetY=
0;a.strokeStyle=this.fa.get("pageBorderColour");a.stroke();this.td(a,0,0,b.width,b.height);this.we&&this.we(a,0,0,b.width,b.height)};c.prototype.cl=function(a){a?(this.log("Setting a custom background function."),this.we=a):this.log("Clearing custom background function.")};c.prototype.tq=function(a){if(this.Aa.tb){var b=this.Aa.x,c=this.Aa.y,e=this.Bg();a.save();a.setTransform(e,0,0,e,0,0);a.beginPath();this.Aa.Ij?(a.moveTo(b-3,c-10),a.lineTo(b+3,c-10),a.moveTo(b-3,c+10),a.lineTo(b+3,c+10),a.moveTo(b,
c-10),a.lineTo(b,c+10)):(a.moveTo(b,c-3),a.lineTo(b,c-15),a.moveTo(b,c+3),a.lineTo(b,c+15),a.moveTo(b-3,c),a.lineTo(b-15,c),a.moveTo(b+3,c),a.lineTo(b+15,c));this.Aa.Ra&&this.ia.arc(b,c,8,0,2*Math.PI,!1);a.lineWidth=2;a.strokeStyle="#000000";a.stroke();a.restore()}};c.prototype.Re=function(){var a=this.fa.get("showRuler")?20:0,b=z(this.canvas).dc(),c=z(this.canvas.parentElement).dc(),e=this.canvas.clientWidth,f=this.canvas.clientHeight,g=b.left-c.left;b=b.top-c.top;c=this.fk();this.gc.moveTo(g+e-
20+c,b+c+a);this.gc.Xf(20,f-20);this.dd.moveTo(g+c+a,b+f-20+c);this.dd.Xf(e-20,20);this.Rf();this.ha()};c.prototype.Rf=function(){if(!this.Bk()){var a=this.Ke(),b=this.wd();b=new D(0,0,b.width,b.height);a.ud(this.Lk)&&b.ud(this.Kk)||!this.vc(this.md)||(this.Lk=a,this.Kk=b)}};c.prototype.Km=function(){if(this.le){var a=this.ea.qk();this.ia.save();this.ia.beginPath();this.ia.rect(0,0,a.width,a.height);this.ia.clip()}return this.le};c.prototype.ha=function(a){if(!this.Bk()&&(this.Wc=a||null,!this.Yj)){this.Yj=
!0;var b=this;this.requestAnimationFrame.call(window,function(){if(!b.za.Th){b.Yj=!1;var a=b.Bg();a!==b.Ei&&(b.log("Detected DPR change; resize canvas now"),b.Bo(b.xe.width,b.xe.height),b.Ei=a);var c=b.ae(),f=c.x,g=c.y,h=c.width,l=c.height;b.ia.setTransform(1,0,0,1,0,0);b.ia.clearRect(0,0,b.canvas.width,b.canvas.height);b.le&&(b.ia.fillStyle=b.fa.get("outsidePageColour"),b.ia.fillRect(0,0,b.canvas.width,b.canvas.height));b.ia.scale(a,a);b.ia.translate(b.ub,b.ib);b.ia.scale(b.scale,b.scale);b.fa.get("showRuler")&&
b.ia.translate(20/b.scale,20/b.scale);var k=new E(b.ub,b.ib);k=k.multiply(new Lb(b.scale,b.scale));b.ia.Ql=k;b.le?b.uq(b.ia):b.td(b.ia,f,g,Math.max(h,h-f),Math.max(l,l-f));b.ea.vt();f=b.Km();b.ea.ha(b.ia,c);b.za.Wc&&(b.ia.save(),b.za.Wc(b.ia),b.ia.restore());0<b.selection.length&&(b.ia.save(),b.vq(b.ia),b.ia.restore());f&&b.ia.restore();b.xa&&b.xa.Xh(b.ia,1/b.scale,b.Xc);""!==b.Gf&&b.fa.get("showHints")&&(b.ia.save(),b.ia.font=10/b.scale+"px Arial",b.ia.fillStyle="#000000",b.ia.textBaseline="top",
b.ia.fillText(b.Gf,0,0),b.ia.restore());b.tq(b.ia);b.ma.Qg&&b.ma.Qg(b.ia);b.Wc&&b.Wc(b.ia);b.za.$d("draw",b.ia);b.fa.get("showRuler")&&(b.ia.setTransform(a,0,0,a,0,0),c=b.fa.get("pixelsPerUnit")*b.scale,f=b.fa.get("units"),b.ia.fillStyle="#ccc",b.ia.fillRect(0,0,20,20),Pd(b.ia,new D(20,0,b.canvas.width-20,20),0,f,c,-b.ub),Pd(b.ia,new D(0,20,20,b.canvas.height-20),2,f,c,-b.ib));b.ia.setTransform(1,0,0,1,0,0);0<b.selection.length&&b.ne&&b.ne.naturalWidth&&(c=b.ne.width,b.ia.drawImage(b.ne,b.canvas.width-
c-b.gc.sk(),0));b.tg&&b.tg.complete&&b.tg.naturalWidth&&(c=b.tg.naturalWidth,b.ia.drawImage(b.tg,b.canvas.width-c-b.gc.sk(),0));b.ia.setTransform(a,0,0,a,0,0);b.ia.beginPath();b.ia.font="20px Arial";h=b.ia.measureText(Rd).width;a=b.canvas.width/a/h;b.ia.scale(a,a);b.ia.textBaseline="top";b.ia.lineWidth=4/a;b.ia.strokeStyle="rgba(128, 128, 128, 0.1)";b.ia[Ud](Rd,0,0)}})}};c.prototype.vq=function(a){a.lineWidth=1/this.scale;a.strokeStyle="#888888";a.beginPath();for(var b=0;b<this.selection.length;b++){var c=
this.selection[b];var e=c.Ea();c=new H(c.Pa);c.transform(e);c.Wh(a,[3/this.scale,3/this.scale])}a.stroke();for(b=0;b<this.gf.length;b++)this.gf[b].ha(a,this.ui,this.scale,this.Ni)};c.prototype.jf=function(a){this.xa=a};c.prototype.jk=function(){return this.xa};c.prototype.aj=function(a){this.Ni=a};c.prototype.Qr=function(a){return a.Yb===this.Yb};c.prototype.mr=function(a,b){if(this.xa)return null;for(var c=this.Yl,e=null,f=0;f<this.gf.length;f++){var g=this.gf[f];if(g.xb(this.ui,a,b,c,this.scale)){e=
g;break}}return e};c.prototype.jb=function(){this.Qo(!1)};c.prototype.Jd=function(){this.Qo(!0)};c.prototype.Qo=function(a){if(a?this.ea.pd():this.ea.qd())a=a?this.ea.Jd():this.ea.jb(),this.ea.format(this.ia,this.request),this.Wp(),this.Af(),this.Rf(),this.mc(),this.vn(a),a=this.ea.Jf,this.log("Most recent change page=%s",a),a!==this.ea.Sa?(this.log("Undo/redo switched page %s->%s",this.ea.Sa,a),this.Rb(a)):this.ha(),this.za.ua("document-changed")};c.prototype.Qj=function(){this.Ce();this.pg()};c.prototype.Ce=
function(a,b){void 0===a&&(a=!1);var c=b?this.ea.mk(b,!1,!1):this.ad();var e=this.ea.Zs(c);0<c.length&&(!0!==a&&ld.setItem("clipboard",e),this.log("Reset paste offset to 0"),this.ih=this.hh=0);return e};c.prototype.duplicate=function(){var a=this.rc(!1),b=this.fa.get("pasteOffset"),c=b||this.fa.get("pasteOffsetX");b=b||this.fa.get("pasteOffsetY");0<a.length&&this.pa([new Jc(a,c,b)])};c.prototype.Rg=function(a){if(!a&&(a=ld.getItem("clipboard"),!a))return;var b=this.fa.get("pasteOffset"),c=b||this.fa.get("pasteOffsetX");
b=b||this.fa.get("pasteOffsetY");this.hh+=c;this.ih+=b;this.log("Using paste offset %s,%s",this.hh,this.ih);c=new E(this.hh,this.ih);a=this.ea.Pn(a,c);this.pa(a);this.update()};c.prototype.Si=function(a){""!==a?(this.Gf=this.language.get(a),this.za.ua("hint",this.Gf)):(this.Gf="",this.za.ua("hint",""))};c.prototype.eb=function(){return this.fb(new nd(this))};c.prototype.fb=function(a){this.ma&&this.ma.Ac&&this.ma.Ac();this.ma=a;a.Fc&&a.Fc();a.cd&&this.za.ua("tool-changed",a.cd());return a};c.prototype.Ag=
function(){var a=null;this.ma.cd&&(a=this.ma.cd());return a};c.prototype.tl=function(a){a=new Cd(this,a);this.fb(a);return a};c.prototype.Nn=function(a,b,c){this.fb(new Hd(this,"line",void 0,a,b,c))};c.prototype.Wj=function(a){a.lineWidth=a.lineWidth||this.Bf;a.strokeStyle=a.strokeStyle||this.Ub;this.fb(new Gd(this,this.ma,a,"brush"))};c.prototype.wq=function(a){a.lineWidth=a.lineWidth||this.Bf;a.strokeStyle=a.strokeStyle||this.Ub;this.fb(new Gd(this,this.ma,a,"shapebrush"))};c.prototype.Qm=function(a,
b){a.lineWidth=a.lineWidth||this.Bf;a.strokeStyle=a.strokeStyle||this.Ub;this.fb(new Gd(this,this.ma,a,b))};c.prototype.Nm=function(a){this.fb(new Hd(this,"curve",void 0,a))};c.prototype.Hp=function(a,b){this.fb(new Hd(this,"arrow",void 0,a,b))};c.prototype.Ke=function(){if(this.le){var a=this.ea.qk();a=new D(0,0,a.width,a.height);var b=this.fa.get("pageInflation");a.ed(b,b)}else a=this.ea.bd();return a};c.prototype.mc=function(){if(!this.Bk())if(this.fa.get("scrollbars")){var a=this.wd(),b=this.Ke(),
c=this.ae(),e=!1,f=!1;c.y<=b.y&&c.bottom()>=b.bottom()?this.gc.be():(this.gc.show(),this.gc.Ho(Math.min(c.y,b.y),Math.max(c.bottom(),b.bottom()),c.height,-this.ib/this.scale),e=!0);c.x<=b.x&&c.right()>=b.right()?this.dd.be():(this.dd.show(),this.dd.Ho(Math.min(c.x,b.x),Math.max(c.right(),b.right()),c.width,-this.ub/this.scale),f=!0);f&&e?(this.gc.Xf(20,a.height-20),this.dd.Xf(a.width-20,20)):e?this.gc.Xf(20,a.height):f&&this.dd.Xf(a.width,20)}else this.gc.be(),this.dd.be()};c.prototype.Uf=function(a,
b,c){this.log("Set document size %s,%s",a,b);c?c.push(new Mc({width:a,height:b})):(this.ea.setProperty("width",a),this.ea.setProperty("height",b),this.mc(),this.Rf(),this.za.ua("document-changed"));return!0};c.prototype.Di=function(a,b,c){if(this.Sf)if(this.Aa.tb)this.log("Not nudging; keyboard cursor shown.");else return a*=c/this.scale,b*=c/this.scale,this.log("Nudge selection by %s, %s",a,b),c=this.rc(!0),c.length&&(a=new E(a,b),this.pa([new Ec(c,a)]),this.aj(a.multiply(this.Ni))),0<c.length;else this.log("Can't nudge; selection motion is locked.")};
c.prototype.nh=function(a){var b=new R;var c=new A(-50,-50);var e=new A(50,-50);var f=new A(50,50);var g=new A(-50,50);b.moveTo(c.x,c.y);b.lineTo(e.x,e.y);b.lineTo(f.x,f.y);b.lineTo(g.x,g.y);b.lineTo(c.x,c.y);b.close();a=Fb({},{commands:b.Sb(),fillStyle:this.Bb,strokeStyle:this.Lb,seed:Math.round(65535*Math.random()),lineWidth:this.ig(this.wa.lineWidth),sloppiness:this.wa.sloppiness,layer:this.Qa,wrap:this.fa.get("multilineText"),fontSize:this.fa.get("defaultFontSize")},a);this.log("Create an item on layer %s",
this.Qa);this.fb(new Id(this,"PathNode",a,100,100,"rectangle","rectangle",null))};c.prototype.Gl=function(a,b,c,e){var d=new R;for(var g=0;g<=a;g++){var h=50*Math.sin(b),l=50*-Math.cos(b);g&1&&(h*=c,l*=c);"matrix"in e&&(l=e.matrix.apply(h,l),h=l.x,l=l.y);0===g?d.moveTo(h,l):d.lineTo(h,l);b+=2*Math.PI/a}d.close();"matrix"in e&&delete e.matrix;e=Fb({},{commands:d.Sb(),fillStyle:this.Bb,strokeStyle:this.Lb,seed:Math.round(65535*Math.random()),lineWidth:this.ig(this.wa.lineWidth),sloppiness:this.wa.sloppiness,
layer:this.Qa,wrap:this.fa.get("multilineText"),fontSize:this.fa.get("defaultFontSize")},e);this.log("Create an item on layer %s",this.Qa);this.fb(new Id(this,"PathNode",e,100,100,this.fa.mn(),"polygon",null))};c.prototype.As=function(){this.fb(new Nd(this))};c.prototype.dj=function(a){var b=new A(0,0);var c=new R;c.moveTo(b.x,b.y-50);c.De(b.x+50,b.y-50,b.x+50,b.y);c.De(b.x+50,b.y+50,b.x,b.y+50);c.De(b.x-50,b.y+50,b.x-50,b.y);c.De(b.x-50,b.y-50,b.x,b.y-50);c.closePath();b=c.Sb();a=Fb({},{commands:b,
fillStyle:this.Bb,strokeStyle:this.Lb,seed:Math.round(65535*Math.random()),lineWidth:this.ig(this.wa.lineWidth),sloppiness:this.wa.sloppiness,layer:this.Qa,wrap:this.fa.get("multilineText"),fontSize:this.fa.get("defaultFontSize")},a||{});this.fb(new Id(this,"PathNode",a,100,100,this.fa.mn(),"circle",null))};c.prototype.Hl=function(a,b,c,e,f,g){this.fb(new Id(this,a,b,c,e,f,"shape",g))};c.prototype.St=function(a,b){this.fb(new Md(this,a,b))};c.prototype.Fl=function(a){var b=this.ea.va(a,!1);if(!b)return this.log("useEditHandleTool: node %s doesn't exist.",
a),!1;if(!b.Fg())return this.log("useEditHandleTool: nodetype %s has no edit mode",b.type()),!1;this.eb();this.pb();this.Mb();this.jf(b);this.ha()};c.prototype.ks=function(a){var b=this.ea.$a();var c=this.Ma(new A(100,100));c=new E(c.x,c.y);this.pa([new S(b,"ImageNode",{url:a,layer:this.Qa}),new Ec([b],c)]);this.eb()};c.prototype.Ff=function(){return wb()};c.prototype.rs=function(a,b){this.ma.ee?(this.log("Simulating click of colour %s",a),this.ma.ee(a,b)):this.log("A colour is not needed for this tool.")};
c.prototype.ws=function(a,b){this.ma.ge?(this.log("Simulating opacity change %s",a),this.ma.ge(a,b)):this.log("An opacity is not needed for this tool.")};c.prototype.Rb=function(a){this.ea.Rb(a)&&(this.pb(),this.Mb(),this.ha(),this.za.ua("set-page",a))};c.prototype.fl=function(a){this.le=a;a=this.Ke();this.ub=-a.x;this.ib=-a.y;this.mc();this.ha()};c.prototype.gj=function(){this.vc(this.fa.Zk(1.1*this.scale))};c.prototype.hj=function(){this.vc(this.fa.Zk(this.scale/1.1))};c.prototype.wg=function(a,
b,c){c=c||this.zr(a);b=new Mb(b,c.x,c.y);this.pa([new Ec(this.qn(a),b)])};c.prototype.an=function(a,b){this.An()||this.log("flipSelection: selection is empty");this.wg(this.ad(),a,b)};c.prototype.Bg=function(){var a=this.ia;return(window.devicePixelRatio||1)/(a.Iu||a.vu||a.xu||a.zu||a.su||1)};c.prototype.wd=function(){var a=this.xe,b=this.fa.get("showRuler")?20:0;return new D(b,b,a.width-b,a.height-b)};c.prototype.Bo=function(a,b){var c=this.Bg();this.canvas.width=a*c;this.canvas.height=b*c;this.canvas.style.width=
a+"px";this.canvas.style.height=b+"px";this.xe.width=a;this.xe.height=b};c.prototype.ae=function(){var a=this.wd();return new D((0-this.ub)/this.scale,(0-this.ib)/this.scale,a.width/this.scale,a.height/this.scale)};c.prototype.$g=function(a,b,c){void 0===b&&(b=!1);void 0===c&&(c=!1);this.log("setViewRect(%s)",a);var d=this.wd(),f=Math.min(d.width/a.width,d.height/a.height),g=a.x*f,h=a.y*f;this.ub=b?(d.width-a.width*f)/2-g:-g;this.ib=c?(d.height-a.height*f)/2-h:-h;this.md=this.scale=f;this.mc();this.ha()};
c.prototype.Tq=function(a){this.request.zf?(this.log("Formatting in progress; will call function soon"),this.request.once("done",a)):(this.log("Format already done; call function in 1 tick"),setTimeout(a,0))};c.prototype.yi=function(a){!this.uf&&a?(this.log("Locking updates."),this.uf=!0):this.uf&&!a&&(this.log("Resuming updates"),this.uf=!1,this.Rf(),this.mc(),this.ha())};c.prototype.Bk=function(){this.uf&&this.log("Updates are locked. Ignoring draw/format request");return this.uf};c.prototype.Hk=
function(){function a(){e.drawImage(b.canvas,f.x*g,f.y*g,f.width*g,f.height*g,f.x*g,f.y*g,f.width*g,f.height*g);l=!0;k=b.ae();b.log("Got new FASTDRAW buffer.")}var b=this,c=document.createElement("canvas");c.width=this.canvas.width;c.height=this.canvas.height;var e=c.getContext("2d"),f=this.wd(),g=this.Bg(),h=this,l=!1,k=new D(0,0,0,0);h.ha(a);return{ha:function(b,d){k.ud(h.ae())||(l=!1,h.ha(a));h.requestAnimationFrame.call(window,function(){l&&(h.ia.setTransform(1,0,0,1,0,0),h.ia.clearRect(f.x*g,
f.y*g,f.width*g,f.height*g),h.ia.drawImage(c,0,0),b&&(h.ia.scale(g,g),h.ia.translate(f.x,f.y),h.ia.translate(h.ub,h.ib),h.ia.scale(h.scale,h.scale),b.call(d,h.ia)))})}}};return c}();var Zd=function(){function c(a,b,c){var d=this;this.za=a;this.sa=b;this.log=w.create("APP");this.La=new jd;this.Rc=null;this.Xn=this.ao=-1;this.Vh=[];this.oh="";this.$k=this.Cl=null;for(this.Se=[];null!==b.firstChild;)b.removeChild(b.firstChild);b=z(this.sa).Me("position");"absolute"!==b&&"fixed"!==b&&(this.sa.style.position="relative");this.sa.style.overflow="none";this.sa.style.textAlign="left";this.sa.classList.add("zwibbler-main");O.Dd(".zwibbler-main { font-size: 16px; }");this.Rh=new id(z("div").Ec({width:"300px"}).Ga,
this.La);this.log("Zwibbler built on "+new Date(1561683944442)+" for 'web'");this.fa=new Uc(this.La,c);this.language=new La("\nen:arrowhead-size:Arrowhead size\nes:arrowhead-size:Flecha tama\u00f1o\n\nen:arrowhead-size-large:Large\nes:arrowhead-size-large:Grande\n\nen:arrowhead-size-medium:Medium\nes:arrowhead-size-medium:Medio\n\nen:arrowhead-size-none:None\nes:arrowhead-size-none:Nada\n\nen:arrowhead-size-small:Small\nes:arrowhead-size-small:Peque\u00f1o\n\nen:arrowhead-size-tiny:Tiny\nes:arrowhead-size-tiny:Diminuto\n\nen:arrowhead-style:Arrowhead style\nes:arrowhead-style:Flecha estilo\n\nen:arrowhead-style-simple:Simple\nes:arrowhead-style-simple:Llanura\n\nen:arrowhead-style-solid:Solid\nes:arrowhead-style-solid:Denso\n\nen:arrow-keys:Arrow Keys\nes:arrow-keys:Teclas de flecha\n\nen:arrow-tool:Arrow tool\nes:arrow-tool:Flecha\nfr:arrow-tool:Fl\u00e8che\nnl:arrow-tool:Pijl\n\nen:break-apart-group:Break apart group\nes:break-apart-group:Dividir el grupo\n\nen:bring-to-front:Bring to front\nes:bring-to-front:Traer al frente\n\nen:brush-tool:Brush tool\nes:brush-tool:Brocha\nfr:brush-tool:Brosse\nnl:brush-tool:Penseel\n\nen:circle-tool:Circle tool\nes:circle-tool:C\u00edrculo\nfr:circle-tool:Cercle\nnl:circle-tool:Cirkel\n\nen:click-to-place-another-point-or-double-click-to-end-the-line:Click to place another point, or double-click to end the line.\nes:click-to-place-another-point-or-double-click-to-end-the-line:Haga clic para colocar otro punto, o doble clic para finalizar la l\u00ednea\nfr:click-to-place-another-point-or-double-click-to-end-the-line:Cliquez pour placer un autre point, ou double-cliquez pour terminer la ligne.\nnl:click-to-place-another-point-or-double-click-to-end-the-line:Klik op een ander punt te plaatsen, of dubbelklik om de lijn te be\u00ebindigen.\n\nen:click-to-place-first-point-of-line:Click to place first point of line\nes:click-to-place-first-point-of-line:Haga clic para colocar el primer punto de la l\u00ednea\nfr:click-to-place-the-first-point-of-line:Cliquez pour placer le premier point de la ligne\nnl:click-to-place-the-first-point-of-line:Klik om het eerste punt van de lijn te plaatsen.\n\nen:click-to-set-the-end-of-the-line:Click to set the end of the line\nes:click-to-set-the-end-of-the-line:Haga clic para colocar el extremo de la l\u00ednea\nfr:click-to-set-the-end-of-the-line:Cliquez pour d\u00e9finir la fin de la ligne\nnl:click-to-set-the-end-of-the-line:Klik hier voor het einde van de lijn in te stellen.\n\nen:copy:Copy\nes:copy:Copiar\nfr:copy:Copie\nnl:copy:Kopi\u00ebren\n\nen:curve-tool:Curve tool\nes:curve-tool:Curva\nfr:curve-tool:Courbes\nnl:curve-tool:Kromme\n\nen:delete-selection:Delete selection\nes:delete-selection:Eliminar la selecci\u00f3n\n\nen:del-key:Del\nes:del-key:Del\n\nen:double-arrows:Double arrows\nes:double-arrows:flechas dobles\n\nen:draw-curves:Draw curves\nes:draw-curves:Dibuje las curvas\n\nen:draw-lines:Draw lines\nes:draw-lines:Dibujar l\u00edneas\n\nen:duplicate-selection:Duplicate selection\nes:duplicate-selection:Duplica la selecci\u00f3n\n\nen:fill-colour:Fill colour\nes:fill-colour:Color de relleno\n\nen:font:Font\nes:font:Font\n\nen:font-size:Font size\nes:font-size:Tama\u00f1o de letra\n\nen:group-selection:Group selection\nes:group-selection:Grupo la selecci\u00f3n\n\nen:image-tool:Image tool\nes:image-tool:Imagen\nfr:image-tool:Image\nnl:image-tool:Afbeelding\n\nen:image-url:Image URL\nes:image-url:URL de la imagen\n\nen:keyboard:Keyboard\nes:keyboard:Teclado\n\nen:line-style:Line style\nes:line-style:Estilo de l\u00ednea\n\nen:line-style-long-dashes:Long dashes\nes:line-style-long-dashes:Gui\u00f3n largo\n\nen:line-style-short-dashes:Short dashes\nes:line-style-short-dashes:Gui\u00f3n corto\n\nen:line-style-solid:Solid\nes:line-style-solid:Denso\n\nen:line-tool:Line tool\nes:line-tool:Raya\nfr:line-tool:Lignes\nnl:line-tool:Lijn\n\nen:move-selection-away:Move selection away\nes:move-selection-away:Mover la selecci\u00f3n de distancia\n\nen:move-selection-closer:Move selection closer\nes:move-selection-closer:Mover la selecci\u00f3n de distancia\n\nen:move-while-zoomed:Move while zoomed\nes:move-while-zoomed:Desplazarse por la pantalla\n\nen:none:None\nes:none:Nada\n\nen:no:No\nes:no:No\n\nen:outline-colour:Outline colour\nes:outline-colour:Color del contorno\n\nen:outline-thickness:Outline thickness\nes:outline-thickness:Grosor del contorno\n\nen:page-down-key:Page Down\nes:page-down-key:Page Down\n\nen:page-up-key:Page Up\nes:page-up-key:Page Up\n\nen:paste:Paste\nes:paste:Pegar\nfr:paste:Coller\nnl:paste:Plak\n\nen:pick-tool:Pick tool\nes:pick-tool:Seleccionar\nfr:pick-tool:S\u00e9lectionner\nnl:pick-tool:Uitkiezen\n\nen:rectangle-tool:Rectangle tool\nes:rectangle-tool:rect\u00e1ngulo\nfr:rectangle-tool:Rectangle\nnl:rectangle-tool:Rechthoek\n\nen:redo:Redo\nes:redo:Rehacer\nfr:redo:Refaire\nnl:redo:Opnieuw maken\n\nen:rounded-rectangle-tool:Rounded rectangle tool\nes:rounded-rectangle-tool:Rect\u00e1ngulo redondeado\n\nen:save:Save\nes:save:Guardar\n\nen:send-to-back:Send to back\nes:send-to-back:Enviar a la parte posterior\n\nen:shadow:Shadow\nes:shadow:Sombra\n\nen:shape-brush-tool:Shape brush tool\nes:shape-brush-tool:Brush que dibuja formas\n\nen:sloppiness-artist:Artist\nes:sloppiness-artist:Artista\n\nen:sloppiness-cartoonist:Cartoonist\nes:sloppiness-cartoonist:Caricaturista\n\nen:sloppiness-child:Child\nes:sloppiness-child:Ni\u00f1o\n\nen:sloppiness-draftsman:Draftsman\nes:sloppiness-draftsman:Dibujante\n\nen:sloppiness-drunk:Drunk\nes:sloppiness-drunk:Borracho\n\nen:sloppiness:Sloppiness\nes:sloppiness:La dejadez\n\nen:smoothness-sharper:Sharper\nes:smoothness-sharper:Muy afilado\n\nen:smoothness-sharpest:Sharpest\nes:smoothness-sharpest:M\u00e1s afilado\n\nen:smoothness-sharp:Sharp\nes:smoothness-sharp:Afilado\n\nen:smoothness-smoothest:Smoothest\nes:smoothness-smoothest:Muy liso\n\nen:smoothness:Smoothness\nes:smoothness:Lisura\n\nen:smoothness-smooth:Smooth\nes:smoothness-smooth:Liso\n\nen:text-colour:Text colour\nes:text-colour:Color del texto\n\nen:text:Text\nes:text:Texto\n\nen:text-tool:Text tool\nes:text-tool:Texto\nfr:text-tool:Texte\nnl:text-tool:Tekst\n\nen:thickness-brush:Brush\nes:thickness-brush:Brocha\n\nen:thickness-marker:Marker\nes:thickness-marker:Rotulador\n\nen:thickness-pencil:Pencil\nes:thickness-pencil:L\u00e1piz\n\nen:thickness-pen:Pen\nes:thickness-pen:Pluma\n\nen:undo:Undo\nes:undo:Deshacer\nfr:undo:D\u00e9faire\nnl:undo:Ongedaan maken\n\nen:yes:Yes\nes:yes:S\u00ed\n\nen:zoom-in:Zoom in\nes:zoom-in:Zoom\n\nen:zoom-out:Zoom out\nes:zoom-out:Disminuir el zoom\n");
this.language.Eo(this.fa.get("language"));this.Hj=z("div").ue("zwibbler-canvas-holder").Ec({position:"absolute",overflow:"hidden"}).Ga;this.sa.appendChild(this.Hj);this.canvas=qb(this.Hj);z(this.canvas).ue("zwibbler-main-canvas").Ec({outline:"0",position:"absolute",left:"0",top:"0",touchAction:"pan-x pan-y"});-1<window.navigator.userAgent.indexOf("Edge")&&(this.log("Edge detected. Set touch action none"),z(this.canvas).Ec({touchAction:"none"}));this.canvas.setAttribute("tabindex","0");this.ia=this.canvas.getContext("2d");
this.qc=new Pc;this.view=new Yd(this.canvas,new Yc,this.qc,this.fa,this.language,this.za,this.La);this.Co();this.Vr=this.tt();this.La.addEventListener(window,"resize",function(){d.za.resize()});window.$&&(this.log("jQuery detected; register for bootstrap events"),window.$(document).bind("shown.bs.modal",function(){d.log("Bootstrap modal shown; resize now");d.za.resize()}));null!==this.fa.Na("backgroundImage")&&(this.bl(this.fa.Na("backgroundImage")),this.view.ea.Vg());this.fa.Ja("update",function(a,
b){d.Fd(a,b)});O.Dd(".zwibbler-progress-notification {\n            position: absolute;\n            top: 0;\n            right: 0;\n            box-shadow: 3px 3px 3px #444;\n            background: #ccc;\n            color: black;\n            border-bottom-left-radius: 4px;\n            font-family: arial,sans;\n        }");this.oo=z("div").ue("zwibbler-progress-notification").Sd(this.sa).Ga;a.resize();this.fa.get("setFocus")&&this.focus("toolbar");this.Fd("showDebug",this.fa.get("showDebug"));
this.za.ua("document-changed");this.za.ua("set-page",this.view.ea.Sa);if(ld.Eh()){if(this.fa.get("persistent")&&(a=ld.getItem("zwibbler-document")))try{var f=hd.rh(a);if(f)this.hf(f);else throw Error("Failed to open document.");}catch(g){this.log("Failed to load persistent document: %s",g.message)}this.Cl=md(function(){d.fa.get("persistent")&&(d.log("Saving document"),ld.setItem("zwibbler-document",d.za.save()))});this.za.Ja("document-changed",function(){d.Cl()});this.La.add(function(){d.Cl.cancel()})}this.La.add(function(){for(;d.sa.firstChild;)d.sa.removeChild(d.sa.firstChild)})}
c.prototype.qg=function(){this.La.qg()};c.prototype.Fd=function(a,b){var c=!1;this.log("onConfigChange %s=%s",a,b);switch(a){case "showDebug":b?(this.Rh.show(),this.hg(0,"right",this.Rh.sa)):(this.Rh.be(),this.Ug(this.Rh.sa));c=!0;break;case "backgroundImage":this.bl(b);break;case "language":this.language.Eo(b)}c&&this.zh()};c.prototype.Co=function(){this.fa.Na("sloppy")||this.view.je("sloppiness",0);this.view.je("smoothness",this.fa.fr());this.view.je("fillStyle",this.fa.Na("defaultFillStyle"));
this.view.je("strokeStyle",this.fa.Na("defaultStrokeStyle"));this.view.je("fontName",this.fa.Na("defaultFont"));this.view.je("fontSize",this.fa.Na("defaultFontSize"));this.view.je("lineWidth",this.fa.Na("defaultLineWidth"));this.view.je("textFillStyle",this.fa.Na("defaultTextFillStyle"))};c.prototype.hf=function(a){this.Rc=null;this.view.hf(a);this.Co();this.Jq();this.za&&(this.za.ua("document-changed"),this.za.ua("set-page",a.Sa));for(a=0;a<this.Vh.length;a++){var b=this.Vh[a];this.log("Removing old DomElement of type %s",
b.tagName);z(b).remove()}this.Vh=[]};c.prototype.Im=function(){this.view.ea.Vg()};c.prototype.tt=function(){var a=this,b=this;this.oh="none";var c=new kd;this.fa.Ip(c);c.Ja("*",function(a,c){"canvas"===b.oh?b.view.Lc(a,c):b.log("Ignore key action -- don't have focus.")});this.sa.setAttribute("tabindex","0");c.Jp(this.sa);this.La.add(function(){a.Vr.detach(a.sa)});this.view.Yh=!1;this.canvas.addEventListener("click",function(){vb()||b.view.Yh?b.oh="canvas":b.focus("canvas");b.view.Yh=!1});this.qc.Ja("goto-toolbar",
function(){b.fa.get("showToolbar")?b.focus("toolbar"):(a.$k&&a.$k.focus(),b.za.ua("blur"))});this.qc.Ja("goto-canvas",function(){b.focus("canvas")});this.La.addEventListener(this.sa,"blur",function(){"text"!==b.view.Ag()&&(b.log("Blur event received -- hide keyboard cursor"),b.view.Nr())});this.fa.Ja("allowSystemClipboard",function(b){a.log("allowSystemClipboard=>%s",b);a.fa.yk()&&(a.La.addEventListener(document,"cut",function(b){return a.view.Ok(b)}),a.La.addEventListener(document,"copy",function(b){return a.view.Ok(b)}),
a.La.addEventListener(document,"paste",function(b){return a.view.Ok(b)}))});return c};c.prototype.qt=function(a){this.$k=a};c.prototype.focus=function(a){this.log("Set focus to %s",a);if("toolbar"!==a&&"canvas"!==a&&"none"!==a)throw"Focus must be toolbar or canvas or none, not "+a;this.oh=a;"canvas"===this.oh&&this.fa.get("setFocus")&&this.sa.focus()};c.prototype.il=function(a){void 0===a&&(a=!1);this.focus("canvas");this.view.il(a)};c.prototype.createNode=function(a,b,c){var d=this.view.ea.$a();
"layer"in c||(c.layer=this.view.Qa);a.push(new S(d,b,c));return d};c.prototype.transformNode=function(a,b,c){a.push(new Ec(b,c));return!0};c.prototype.el=function(a,b,c,e,f,g,h,l){c=new F(c,f,e,g,h,l);a.push(new Dc(b,"matrix",c));return!0};c.prototype.kh=function(a,b,c,e){c=new E(c,e);a.push(new Ec(b,c));return!0};c.prototype.Mi=function(a,b,c,e,f,g){c=new Lb(c,e,f,g);a.push(new Ec(b,c));return!0};c.prototype.yc=function(a,b){a.push(new Cc(b));return!0};c.prototype.Jq=function(){var a=this;this.Rc=
null;this.view.ea.oc(!1,function(b){"ImageNode"!==b.type()||"background"!==b.ka("layer")&&"background"!==b.ka("tag")||(a.log("Found background image at nodeid %s",b.id),a.Rc=b.id,b.ke(!0))})};c.prototype.bl=function(a){var b=[];null!==this.Rc&&this.view.ea.Ge(this.Rc)&&b.push(new Cc([this.Rc]));if(a){var c=this.view.ea.$a();b.push(new S(c,"ImageNode",{url:a,locked:!0,tag:"background",layer:this.view.Qa}));b.push(new Kc([c],Kc.oj))}this.Rc=c||null;this.view.pa(b);c&&this.view.ea.va(c,!1).ke(!0);this.view.pb();
this.view.Mb()};c.prototype.ar=function(){return null!==this.Rc&&this.view.ea.Ge(this.Rc)?this.view.ea.va(this.Rc).ka("url"):null};c.prototype.Gk=function(){this.hf(new Yc);null!==this.fa.Na("backgroundImage")&&(this.bl(this.fa.Na("backgroundImage")),this.view.ea.Vg())};c.prototype.zh=function(){var a=!0;void 0===a&&(a=!1);var b=this.sa.clientWidth,c=this.sa.clientHeight;if(a||b!==this.ao||c!==this.Xn){this.log("onResize()");this.ao=b;this.Xn=c;for(var e=a=0,f=0,g=0,h=0,l=this.Se;h<l.length;h++){var k=
l[h];switch(k.position){case "left":case "right":k.sa.style.top=f+"px";k.sa.style.bottom=g+"px";break;case "top":case "bottom":k.sa.style.left=a+"px",k.sa.style.right=e+"px"}switch(k.position){case "left":k.sa.style.left=a+"px";a+=k.sa.offsetWidth;break;case "right":k.sa.style.right=e+"px";e+=k.sa.offsetWidth;break;case "top":k.sa.style.top=f+"px";f+=k.sa.offsetHeight;break;case "bottom":k.sa.style.bottom=g+"px",g+=k.sa.offsetHeight}}z(this.Hj).Ec({left:a+"px",right:e+"px",top:f+"px",bottom:g+"px"});
this.view.Bo(b-e-a,c-g-f);z(this.oo).Ec({top:"0",right:e+"px"});this.view.Re();this.za.ua("resize")}else this.log("Ignoring resize; div size did not change.")};c.prototype.pj=function(a,b,c){void 0===c&&(c=this.view.ea.Sa);var d=this.view.ea.Sa;this.view.ea.Rb(c);a.translate(-b.x,-b.y);this.view.td(a,b.x,b.y,b.width,b.height);this.view.ea.ha(a);this.za.Wc&&this.za.Wc(a);this.view.ea.Rb(d)};c.prototype.uo=function(a,b){if("image/svg+xml"===a||"application/pdf"===a){var c=!1;if("image/svg+xml"===a)var e=
new gd(new D(0,0,b.width,b.height));else e=new ed(new D(0,0,b.width,b.height),O.fonts),c=!0;if(c)for(c=0;c<this.view.ea.Hc();c++)0<c&&e.Zf(),this.pj(e,b,c);else this.pj(e,b);return"data:"+a+";base64,"+qa(e.toString())}c=document.createElement("canvas");c.setAttribute("width",b.width.toString());c.setAttribute("height",b.height.toString());e=c.getContext("2d");if("image/jpeg"===a||"image/bmp"===a)e.fillStyle="#ffffff",e.fillRect(0,0,b.width,b.height);this.pj(e,b);return"image/bmp"===a?Db(c):c.toDataURL(a)};
c.prototype.Pc=function(a,b,c,e){this.log("External app setItemProperty %s: %s=%s",b,c,e);a.push(new Dc(b,c,e));return!0};c.prototype.dl=function(a,b,c){var d;this.log("External app setNodeProperty %s: %s",b,c);for(d in c)c.hasOwnProperty(d)&&a.push(new Dc(b,d,c[d]));return!0};c.prototype.hi=function(a,b){var c,e;(c=this.view.ea.va(a))&&(e=c.ka(b));this.log("GetItemProperty %s: %s=%s",a,b,e);return e};c.prototype.Mj=function(a,b){var c,e;if(6>b.length)this.log("newShape: Cannot create shape with fewer than three points.");
else{var f=new R;var g=c=0;for(e=b.length-1;c<=e;g=c+=2){var h=this.view.Ma(new A(b[g],b[g+1]));if(0===g){f.moveTo(h.x,h.y);var l=h}else f.lineTo(h.x,h.y)}l&&(f.lineTo(l.x,l.y),f.close());return this.Nh(a,f.Sb())}};c.prototype.Nh=function(a,b){return this.createNode(a,"PathNode",{commands:b,fillStyle:this.view.Bb,strokeStyle:this.view.Lb,seed:Math.round(65535*Math.random()),lineWidth:this.view.wa.lineWidth,sloppiness:this.view.wa.sloppiness,angleArcs:this.fa.get("angleArcs")})};c.prototype.ng=function(a,
b){var c=this.view.ea.$a();a.push(new Gc(c,b));return c};c.prototype.lh=function(a,b){a.push(new Hc(b));return!0};c.prototype.lq=function(a){return new Vc(this.oo,a)};c.prototype.hg=function(a,b,c){for(var d=0,f=this.Se;d<f.length;d++)if(f[d].sa===c)return;this.sa.appendChild(c);this.Se.push({order:a,sa:c,position:b});c.style.position="absolute";this.Se.sort(function(a,b){return a.order<b.order?-1:1});this.zh()};c.prototype.Ug=function(a){for(var b=0;b<this.Se.length;b++)if(this.Se[b].sa===a){this.Se.splice(b,
1);this.sa.removeChild(a);break}this.zh()};return c}();var $d=function(){function c(a,b){this.view=a;this.methods=b;this.log=w.create("CustomToolBehaviour");this.Xb=new Dd(a)}c.prototype.Fc=function(){this.log("Entering CustomToolBehaviour");this.methods.enter&&this.methods.enter()};c.prototype.Ac=function(){this.log("Leaving CustomToolBehaviour");this.methods.leave&&this.methods.leave()};c.prototype.Gd=function(a,b,c){return this.methods.onMouseClick?this.methods.onMouseClick(a,b,c):!1};c.prototype.Ta=function(a,b,c){return this.methods.onMouseDown?
this.methods.onMouseDown(a,b,c):!1};c.prototype.Va=function(a,b,c){return this.methods.onMouseMove?this.methods.onMouseMove(a,b,c):!1};c.prototype.Wa=function(a,b,c){return this.methods.onMouseUp?this.methods.onMouseUp(a,b,c):!1};c.prototype.eo=function(a,b,c){return this.methods.onMouseLeave?this.methods.onMouseLeave(a,b,c):!1};c.prototype.fe=function(a,b,c){return this.methods.onDoubleClick?this.methods.onDoubleClick(a,b,c):!1};c.prototype.bo=function(a,b,c){return this.methods.onContextMenu?this.methods.onContextMenu(a,
b,c):!1};c.prototype.ee=function(a,b){return this.methods.onColour?this.methods.onColour(a,b):!1};c.prototype.ge=function(a,b){return this.methods.onOpacity?this.methods.onOpacity(a,b):!1};c.prototype.Lc=function(a,b){this.log("keyboard: %s",a);this.methods.onKeyCommand&&!1===this.methods.onKeyCommand(a,b)||"cancel"!==a||(this.log("ESC pressed. Abort and go back to toolbar."),this.view.eb(),this.view.qc.ua("goto-toolbar"))};c.prototype.Qg=function(a){if(this.methods.onRedraw)this.methods.onRedraw(a)};
c.prototype.rb=function(a){if(this.methods.onTouch)return this.methods.onTouch(a);if("touchstart"===a.type||"touchmove"===a.type||"touchend"===a.type){if(a.touches&&a.touches.length)var b=a.touches[0];else a.changedTouches&&a.changedTouches.length?b=a.changedTouches[0]:(this.log("No touches!"),b={pageX:0,pageY:0});b=this.view.Za(b.pageX,b.pageY);return"touchstart"===a.type?this.Ta(b.x,b.y,a):"touchend"===a.type?this.Wa(b.x,b.y,a):"touchmove"===a.type?this.Va(b.x,b.y,a):!1}};c.prototype.bb=function(a){return this.methods.onGesture?
this.methods.onGesture(a):this.Xb.bb(a)};c.prototype.Pk=function(a,b,c,e){return this.methods.onMouseWheel?this.methods.onMouseWheel(a,b,c,e):!1};c.prototype.cd=function(){return this.methods.getToolName?this.methods.getToolName():"custom"};return c}();function ae(c){for(var a=[],b=0;b<c;b++)a.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz01234567890"[Math.floor(63*Math.random())]);return a.join("")};w.create("OTDocument");
var be=function(){function c(a,b,c,e,f){void 0===e&&(e=[]);void 0===f&&(f=!1);this.Ya=a;this.sc=b;this.cj=c;this.Bc=e;this.local=f}c.prototype.clone=function(a,b){void 0===b&&(b=this.cj);for(var d=[],e=0,f=this.Bc;e<f.length;e++)d.push(f[e].clone());return new c(a,this.sc,b,d,this.local)};c.prototype.inverse=function(a,b){void 0===a&&(a=this.Ya);void 0===b&&(b=this.cj);for(var d=[],e=this.Bc.length-1;0<=e;e--)d.push(this.Bc[e].inverse());return new c(a,this.sc,b,d,this.local)};return c}(),ce=function(){function c(a,
b,c){this.Vp=a;this.Np=b;this.Ln=c}c.prototype.getData=function(){return this.Vp};c.prototype.Cg=function(){return this.Ln};c.prototype.empty=function(){return this.Np===this.Ln};return c}(),de=function(){function c(a,b){void 0===a&&(a=!1);this.Dm=a;this.ze=b;this.log=w.create("OTDocument");this.$b=[];this.next=0;this.local=[];this.all=[];this.Gb=0;this.oe={};this.Db=!1;this.sp=-1;this.uh=""}c.prototype.qd=function(){return 0<this.next};c.prototype.pd=function(){return this.next<this.$b.length};c.prototype.jb=
function(){this.qd()&&this.qo(this.$b[--this.next],!0)};c.prototype.Jd=function(){this.pd()&&this.qo(this.$b[this.next++],!1)};c.prototype.Im=function(){this.next=this.$b.length=0};c.prototype.yg=function(){return this.local.length?0===this.ze?new ce(this.encode(this.local),this.Gb.toString(),(this.Gb+this.local.length).toString()):new ce(this.encode(this.local),this.local[0].sc,this.local[this.local.length-1].Ya):new ce("","0","0")};c.prototype.Hf=function(a){if(0===this.ze){a=parseInt(a,10)-this.Gb;
for(var b=0;b<a;b++)this.all[this.Gb+b].Ya=(this.Gb+b+1).toString(),this.Gb+b+1<this.all.length&&(this.all[this.Gb+b+1].sc=this.all[this.Gb+b].Ya);this.Gb+=a;this.local.splice(0,a)}else for(b=this.local.length-1;0<=b;b--)if(a===this.local[b].Ya){this.local.splice(0,b+1);break}};c.prototype.Cg=function(){return this.all.length?this.all[this.all.length-1].Ya:this.ai()};c.prototype.Aj=function(a){this.Db||(a.local=!0,this.$b.length=this.next,this.$b.push(a),this.next+=1,this.local.push(a),this.all.push(a),
this.Dm?(this.log("Executing LOCAL %s",a.Ya),this.ug(a)):this.log("adding LOCAL %s",a.Ya),1===this.ze&&(this.oe[a.Ya]=a))};c.prototype.ug=function(a){var b=0;for(a=a.Bc;b<a.length;b++)this.wb(a[b])};c.prototype.Oq=function(a){for(var b=this.all.length-1;0<=b&&this.all[b].Ya!==a;b--);return b};c.prototype.qo=function(a,b){var c=this.Oq(a.Ya);if(-1===c)this.log("ERROR");else{var e=this.Bi();b?(e=a.inverse(e,this.now()),e.sc=this.all[c].Ya):e=a.clone(e,this.now());for(c=b?c+1:c;c<this.all.length;c++)this.all[c].local||
this.Bl(this.all[c],[e]);this.local.push(e);this.all.push(e);this.Dm&&this.ug(e)}};c.prototype.Bl=function(a,b){if(a.sc!==b[0].sc)throw Error("Error: Expected same parentage.");for(var c=0,e=a.Bc;c<e.length;c++)for(var f=e[c],g=0,h=b;g<h.length;g++){var l=h[g];f=this.Kt(f,l.Bc,a.Ya,l.Ya)}b[0].sc=a.Ya};c.prototype.Kt=function(a,b,c,e){this.log("Transform "+c+" agaisnt list "+e);for(var d=0;d<b.length;d++){var g=b[d];b[d]=this.Al(a,g,c,e);a=this.Al(g,a,e,c)}return a};c.prototype.xf=function(a){var b=
this.decode(a);if(null===b||0===b.length)return null!==b;this.log("Entering addRemoteChanges");a=this.all.length;if(0===this.ze){if(this.Gb===this.all.length)for(var c=0;c<b.length;c++)this.all.push(b[c]);else{for(this.Db=!0;a!==this.Gb;)--a,this.ug(this.all[a].inverse());this.Db=!1;var e=this.all.slice(this.Gb);this.all.length=this.Gb;for(var f=0;f<b.length;f++)c=b[f],this.Bl(c,e);this.all=this.all.concat(b,e)}this.Gb+=b.length}else{for(a=0;a<b.length;a++)c=b[a],c.Ya in this.oe||(this.oe[c.Ya]=c);
a={};a[this.ai()]=[];for(e in this.oe)a[e]=[];for(e in this.oe)c=this.oe[e],c.sc in a&&a[c.sc].push(c.Ya);for(e in a)a[e].sort();e=a[this.ai()];b=this.ai();for(c=0;c<this.all.length&&1===e.length&&e[0]===this.all[c].Ya;c++)b=e[0],e=a[e[0]];this.Db=!0;for(e=this.all.length-1;e>=c;e--){this.log("[%s] Executing INVERSE %s",e,this.all[e].Ya);try{this.ug(this.all[e].inverse())}catch(g){throw this.log("Error occurred HEREEEEEE %s",this.all[e].Ya),g;}}this.Db=!1;this.all.length=c;c=[];this.nk(a,b,c);a=this.all.length;
for(b=1;b<c.length;b++)this.all.push(c[b])}this.Db=!0;for(c=a;c<this.all.length;c++)this.log("[%s] Executing REMOTE %s",c,this.all[c].Ya),this.ug(this.all[c]);0<this.all.length-a&&this.pa();this.Db=!1;this.log("Done addremotechanges");return!0};c.prototype.nk=function(a,b,c){c.push(this.oe[b]);for(b=a[b];1===b.length;)c.push(this.oe[b[0]]),b=a[b[0]];if(0!==b.length){var d=c.length;this.nk(a,b[0],c);for(var f=1;f<b.length;f++){var g=[];this.nk(a,b[f],g);for(var h=d;h<c.length;h++)this.Bl(c[h],g);c.push.apply(c,
g)}}};c.prototype.ai=function(){return(0).toString()};c.prototype.Bi=function(){return 0===this.ze?(this.sp--).toString():this.uh+Math.floor(1E6*Math.random()).toString(36)};c.prototype.show=function(){this.log("%s",JSON.stringify(this.all,null,2))};c.prototype.now=function(){return Math.floor((new Date).getTime()/1E3)};c.prototype.bt=function(a){this.uh=a};c.prototype.Hm=function(a,b){if(0===this.ze){var c=parseInt(a,10),e=parseInt(b,10);return 0>c&&0>e?c>e:0<c&&0<e?c<e:0<e?!1:!0}return a<b};c.prototype.pa=
function(){};return c}(),ee=function(){function c(a,b,c){this.type=a;this.Ob=b;this.newValue=c}c.prototype.clone=function(){return new c(this.type,this.Ob,this.newValue)};c.prototype.inverse=function(){return"a"===this.type?new c("a",-this.Ob,this.newValue-this.Ob):new c("m",1/this.Ob,this.newValue/this.Ob)};return c}();
(function(c){function a(a,d){var b=c.call(this,!0,a)||this;b.prefix=d;b.value=0;b.bt(d);return b}n(a,c);a.prototype.wb=function(a){"a"===a.type?(this.log("Add to  %s  %s",this.value,a.Ob),this.value+=a.Ob):"m"===a.type&&(this.log("Multiply %s by %s",this.value,a.Ob),this.value*=a.Ob);if(this.value!==a.newValue)throw Error("Document value should be "+a.newValue+", but got "+this.value);};a.prototype.decode=function(a){a=JSON.parse(a,function(a,b){if(b instanceof Object){if(b.Ob)return new ee(b.type,
b.Ob,b.newValue);if(b.Bc)return new be(b.Ya,b.sc,b.cj,b.Bc)}return b});if(0===this.ze)for(var b=this.Gb,c=b+1,f=0;f<a.length;f++){var g=a[f];g.sc=b.toString();g.Ya=c.toString();b=c;c+=1}return a};a.prototype.encode=function(a){return JSON.stringify(a)};a.prototype.Al=function(a,c,e,f){this.log("transform %s/,%s",e,f);if(this.Hm(e,f))return e=a.newValue,e="a"===c.type?e+c.Ob:e*c.Ob,new ee(c.type,c.Ob,e);e=c.newValue;e="a"===a.type?e+a.Ob:e*a.Ob;this.log("   Modified op2 with value "+e);return new ee("a",
e-a.newValue,e)};a.prototype.add=function(a){var b=this.Bi();this.Aj(new be(b,this.Cg(),Math.round((new Date).getTime()/1E3),[new ee("a",a,this.value+a)]))};a.prototype.multiply=function(a){var b=this.Bi();this.Aj(new be(b,this.Cg(),Math.round((new Date).getTime()/1E3),[new ee("m",a,this.value*a)]))};return a})(de);var fe=function(){function c(a,b){this.Pb=a;this.index=b}c.prototype.encode=function(){return this.Pb+";"+this.index};return c}(),he=function(){function c(a,b,c,e){this.ab=a;this.aa=e;this.type="c";this.Ka=new fe(b,c)}c.prototype.encode=function(){var a=JSON.stringify(this.aa);return"C"+this.ab+";"+this.Ka.encode()+";"+a.length+";"+a+";"};c.prototype.clone=function(){return new c(this.ab,this.Ka.Pb,this.Ka.index,this.aa)};c.prototype.inverse=function(){return new ge(this.ab,this.Ka.Pb,this.Ka.index)};
c.pe=function(a,b){var d=/C([^;]+);([^;]+);(\d+);(\d+);/g;d.lastIndex=b;var e=d.exec(a);if(e&&e.index===b){var f=parseInt(e[4],10),g=JSON.parse(a.substr(d.lastIndex,f));return{ye:new c(e[1],e[2],parseInt(e[3],10),g),position:d.lastIndex+f+1}}return null};return c}(),ge=function(){function c(a,b,c){this.ab=a;this.Pb=b;this.index=c;this.aa=null;this.type="d";this.Ka=new fe(b,c)}c.prototype.clone=function(){return new c(this.ab,this.Ka.Pb,this.Ka.index)};c.prototype.inverse=function(){if(null===this.aa)throw Error("DeleteOp should have been executed before inverse");
return new he(this.ab,this.Ka.Pb,this.Ka.index,this.aa)};c.prototype.encode=function(){return"D"+this.ab+";"+this.Ka.encode()+";"};c.pe=function(a,b){var d=/D([^;]+);([^;]+);(\d+);/g;d.lastIndex=b;var e=d.exec(a);return e&&e.index===b?{ye:new c(e[1],e[2],parseInt(e[3],10)),position:d.lastIndex}:null};return c}(),ie=function(){function c(a,b,c){this.ab=a;this.aa=b;this.Lf=c;this.type="s"}c.prototype.clone=function(){return new c(this.ab,this.aa,this.Lf)};c.prototype.inverse=function(){if(null===this.Lf)throw Error("SetPropertiesOp was not executed before inversion");
return new c(this.ab,this.Lf,this.aa)};c.prototype.encode=function(){var a=JSON.stringify(this.aa);return"S"+this.ab+";"+a.length+";"+a+";"};c.pe=function(a,b){var d=/S([^;]+);(\d+);/g;d.lastIndex=b;var e=d.exec(a);if(e&&e.index===b){var f=parseInt(e[2],10),g=JSON.parse(a.substr(d.lastIndex,f));return{ye:new c(e[1],g,null),position:d.lastIndex+f+1}}return null};return c}(),je=function(){function c(a,b,c,e,f){this.ab=a;this.type="m";this.src=new fe(b,c);this.Ka=new fe(e,f)}c.prototype.clone=function(){return new c(this.ab,
this.src.Pb,this.src.index,this.Ka.Pb,this.Ka.index)};c.prototype.inverse=function(){return new c(this.ab,this.Ka.Pb,this.Ka.index,this.src.Pb,this.src.index)};c.prototype.encode=function(){return"M"+this.ab+";"+this.src.encode()+";"+this.Ka.encode()+";"};c.pe=function(a,b){var d=/M([^;]+);([^;]+);(\d+);([^;]+);(\d+);/g;d.lastIndex=b;var e=d.exec(a);return e&&e.index===b?{ye:new c(e[1],e[2],parseInt(e[3],10),e[4],parseInt(e[5],10)),position:d.lastIndex}:null};return c}(),ke=function(c){function a(a,
d,e){void 0===e&&(e=!1);e=c.call(this,e,1)||this;e.Nd=a;e.pf=[];e.ct(d);return e}n(a,c);a.prototype.ct=function(a){this.uh=a};a.prototype.ds=function(a){return"N-"+this.uh+"-"+a};a.prototype.createNode=function(a,c,e,f){this.Db||(c=new he(a,c,e,f),this.pf.push(c));return a};a.prototype.yc=function(a,c,e){this.Db||(c=new ge(a,c,e),c.aa=this.Nd.ec(a),this.pf.push(c))};a.prototype.Pe=function(a,c,e,f,g){this.Db||(a=new je(a,f,g,c,e),this.pf.push(a))};a.prototype.Jb=function(a,c,e){this.Db||(a=new ie(a,
c,e),this.pf.push(a))};a.prototype.ec=function(a){return this.Nd.ec(a)};a.prototype.pa=function(){if(!this.Db&&this.pf.length){for(var a=new be(this.Bi(),this.Cg(),this.now()),c=0,e=this.pf;c<e.length;c++)a.Bc.push(e[c]);this.Aj(a)}else this.Db&&this.Nd.pa();this.pf.length=0};a.prototype.wb=function(a){this.log("Execute "+a.type);switch(a.type){case "c":this.Nd.createNode(a.ab,a.Ka.Pb,a.Ka.index,a.aa);break;case "d":-1===a.Ka.index?this.log("op was nullified."):(a.aa=this.Nd.ec(a.ab),this.Nd.yc(a.ab,
a.Ka.Pb,a.Ka.index));break;case "s":a.Lf={};var b=this.Nd.ec(a.ab),c;for(c in a.aa)a.Lf[c]=b[c];this.Nd.Jb(a.ab,a.aa,a.Lf);break;case "m":-1!==a.src.index&&this.Nd.Pe(a.ab,a.Ka.Pb,a.Ka.index,a.src.Pb,a.src.index)}};a.prototype.decode=function(a){for(var b=[],c=0,f=/B([^;]+);([^;]+);([^;]+);\d+;/g;c<a.length;){var g;switch(a[c]){case "B":f.lastIndex=c;if((g=f.exec(a))&&g.index===c){c=parseInt(g[1],36);var h=g[2];g=g[3];if(isNaN(c))return this.log("Error: TS is not a number."),null;g=new be(g,h,c);
b.push(g);c=f.lastIndex}else return null;continue;case "C":g=he.pe(a,c);break;case "D":g=ge.pe(a,c);break;case "S":g=ie.pe(a,c);break;case "M":g=je.pe(a,c);break;default:return null}if(0===b.length)return this.log("Got change outside of batch"),null;c=g.position;b[b.length-1].Bc.push(g.ye)}return b};a.prototype.encode=function(a){for(var b="",c=0;c<a.length;c++){var f=a[c];b+="B"+f.cj.toString(36)+";"+f.sc+";"+f.Ya+";"+f.Bc.length+";";var g=0;for(f=f.Bc;g<f.length;g++)b+=f[g].encode()}return b};a.prototype.Al=
function(a,c,e,f){function b(b,c,e){b="c"===a.type?1:-1;switch(e.type){case "c":e=e.clone();d(c,e.Ka,b,"c");l.log("Result is "+f+":"+e.type+"."+e.Ka.index);break;case "d":e=e.clone();d(c,e.Ka,b,"d");l.log("Result is "+f+":"+e.type+"."+e.Ka.index);break;case "m":e=e.clone(),d(c,e.src,b,"d"),d(c,e.Ka,b,"c")}return e}function d(b,d,g,h){b.Pb===d.Pb&&0<=d.index&&(b.index<d.index||b.index==d.index&&0<g?(d.index+=g,l.log("Shift "+f+":"+c.type+" by "+g)):b.index===d.index&&0>g&&"d"===h?(d.index=-1,l.log("NULLIFY")):
l.log("No conflict; "+e+":"+a.type+" "+b.index+" "+f+":"+c.type+" "+d.index))}var l=this;this.log("xform "+e+":"+a.type+"/"+f+":"+c.type);if(this.Hm(f,e))return this.log("Not doing anything; "+f+"<"+e),c;"c"===a.type?c=b(a.type,a.Ka,c):"d"===a.type?c=b(a.type,a.Ka,c):"m"===a.type&&(c=b("d",a.src,c),c=b("c",a.Ka,c));return c};return a}(de);
(function(){function c(){this.ra={};this.log=w.create("DebugTree");this.root={ab:"0",parent:null,children:[],aa:{name:"root"}};this.ra["0"]=this.root}c.prototype.createNode=function(a,b,c,e){this.log("create node "+a+" child of "+b);b=this.ra[b];e={ab:a,parent:b,children:[],aa:e};b.children.splice(c,0,e);this.ra[a]=e};c.prototype.yc=function(a){this.log("delete node "+a);if(a in this.ra){var b=this.ra[a].parent;if(b)for(var c=0;c<b.children.length;c++)if(b.children[c].ab===a){b.children.splice(c,
1);break}delete this.ra[a]}};c.prototype.Pe=function(a,b,c){this.log("move "+a+" to "+b+":"+c);if(a in this.ra){var d=this.ra[a];this.yc(a);this.createNode(a,b,c,d.aa)}};c.prototype.Jb=function(a,b){if(a in this.ra)for(var c in b)b.hasOwnProperty(c)&&(this.ra[a].aa[c]=b[c])};c.prototype.ec=function(a){return a in this.ra?this.ra[a].aa:{}};c.prototype.pa=function(){};c.prototype.toString=function(){return this.encode(this.root)};c.prototype.encode=function(a){for(var b="("+a.aa.name,c=0;c<a.children.length;c++)b+=
" "+this.encode(a.children[c]);return b+")"};return c})();var le="IDLE CONNECTING CONNECTED WAIT_FOR_ACK ERROR_WAIT STOPPING".split(" "),pe=function(){function c(a,b,c){this.view=a;this.sb=null;this.log=w.create("DocumentSharer");var d=new me;a=new ne(a,d);this.Vi=new ke(a,b);b=new oe(this.Vi,d);this.view.ea.Fo(b,c)}c.prototype.xf=function(a){this.Vi.xf(a)};c.prototype.Mr=function(){return null!==this.sb};c.prototype.yg=function(){this.sb||(this.sb=this.Vi.yg(),this.sb.empty()&&(this.sb=null));return this.sb?this.sb.getData():""};c.prototype.Hf=function(a){this.log("Marking outstanding changes sent");
if(!this.sb||this.sb.getData()!==a)throw Error("markChangesSent(): does not match outstanding changes.");this.Vi.Hf(this.sb.Cg());this.sb=null};c.prototype.end=function(){this.view.ea.Fo(new Xc)};return c}(),qe=function(){function c(a,b){var c=this;this.name=a;this.ia=b;this.log=w.create("Sharing");this.state=0;this.paused=!1;this.k=0;this.timeout=null;this.ms=1;this.sb="";this.jg=!1;this.listener=function(a){c.log("Got some more changes to send: %s",a.substr(0,30));c.sb=a;c.jg=!1;c.zo()};b.Ja("local-changes",
this.listener);this.connect()}c.prototype.kf=function(a){this.log(le[this.state]+" -> "+le[a]);this.state=a};c.prototype.connect=function(){var a=this;this.log("connect(): "+le[this.state]);0!==this.state?this.log("Bad state"):(this.kf(1),this.bh=new O.WebSocket("wss://zwibbler.com/socket/"+this.name),this.bh.onopen=function(){return a.ts()},this.bh.onclose=function(){return a.qs()},this.bh.onmessage=function(b){return a.us(b)})};c.prototype.ts=function(){this.log("onConnected(): "+le[this.state]);
1!==this.state?this.log("Bad state"):(this.kf(2),this.zo())};c.prototype.qs=function(){this.log("onClose(): "+le[this.state]);this.jg=!1;4!==this.state&&(1===this.state?(this.kf(4),this.Qs()):(this.kf(0),this.paused||(this.k=0,this.connect())))};c.prototype.Qs=function(){var a=this;4===this.state&&(this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.timeout=setTimeout(function(){4===a.state&&(a.log("onTimeout(): "+le[a.state]),a.timeout=null,a.kf(0),a.connect())},1E3*Math.pow(2,this.k)),
5>this.k&&(this.k+=1))};c.prototype.zo=function(){var a=this,b=this.ia.hk("latency");setTimeout(function(){if(2===a.state){if(a.paused)a.log("Currently paused; ignoring changes.");else if(""!==a.sb&&a.jg){a.log("Have outstanding changes... not sending more.");return}""!==a.sb&&(a.log("Sending outstanding changes"),a.jg=!0,a.bh.send(JSON.stringify({type:"Data",MID:""+a.ms++,oldCID:"0",newCID:"0",data:a.sb})))}},b)};c.prototype.us=function(a){var b=JSON.parse(a.data);"Data"===b.type?(this.log("Got message from socket: %s",
a.data.substr(0,64)),this.ia.xf(b.data)):"Ack"===b.type&&""!==this.sb&&(this.log("Marking changes sent to: %s",this.sb.substr(0,30)),this.ia.Hf(this.sb),this.sb="",this.jg=!1)};c.prototype.pause=function(a){this.log("SharedSession.pause(): "+le[this.state]);(this.paused=a)?stop():0===this.state&&(this.kf(1),this.connect())};c.prototype.stop=function(){this.log("SharedSession.stop(): "+le[this.state]);this.paused=!0;4>this.state?this.bh.close():this.kf(0);this.ia.removeEventListener("local-changes",
this.listener)};return c}(),me=function(){function c(){this.local={};this.remote={};this.add("0",0)}c.prototype.add=function(a,b){this.local[a]=b;this.remote[b]=a};c.prototype.remove=function(a,b){delete this.local[a];delete this.remote[b]};c.prototype.$f=function(a){return this.local[a]};c.prototype.mf=function(a){a in this.remote||console.log("LocalId "+a+" has no remote");return this.remote[a]};return c}();function re(c){var a={},b;for(b in c)a[b]="matrix"===b?c[b].Sb():c[b];return a}
function se(c){var a={},b;for(b in c)a[b]="matrix"===b&&c[b]instanceof Array?new F(c[b]):c[b];return a}
var ne=function(){function c(a,b){this.view=a;this.map=b;this.Ud={};this.actions=[];this.log=w.create("Remote")}c.prototype.createNode=function(a,b,c,e){if(!e.type)throw console.log(e),Error("Tried to create node with bad type");var d=se(e),g=d.type;delete d.type;var h=this.view.ea.$a();this.log("Create node "+g+" "+a+"/"+h+" at "+b+":"+c);this.map.add(a,h);b=new S(h,g,d,this.map.$f(b),c);this.actions.push(b);this.Ud[a]=e};c.prototype.yc=function(a,b,c){var d=this.map.$f(a);this.log("Delete node "+
a+"/"+d+" from "+b+":"+c);b=new Cc([d]);this.actions.push(b);this.map.remove(a,d)};c.prototype.Pe=function(a,b,c){this.log("Move node "+a+" to "+b+":"+c);this.actions.push(new Lc(this.map.$f(a),this.map.$f(b),c))};c.prototype.Jb=function(a,b){b=se(b);var c=this.map.$f(a);this.log("Set properties for node "+a+"/"+c+" to "+JSON.stringify(b));for(var e in b)this.actions.push(new Dc([c],e,b[e]));if(a in this.Ud)for(var f in b)this.Ud[a][f]=b[f]};c.prototype.ec=function(a){var b={};if(a in this.Ud)b=this.Ud[a];
else if(a=this.view.ea.va(this.map.$f(a)))b=re(a.ec()),b.type=a.type();return b};c.prototype.pa=function(){this.Ud={};this.view.pa(this.actions,!0);this.view.Af();this.view.ha();this.actions=[]};return c}(),oe=function(){function c(a,b){this.Nc=a;this.map=b;this.log=w.create("LOCAL")}c.prototype.createNode=function(a,b,c,e){if(!this.Nc.Db){this.log("Create node "+e.type+" "+a+" at "+b+":"+c);if(!e.type)throw Error("Error: Local tried to create node with bad type.");e=re(e);var d=this.Nc.ds(a);this.map.add(d,
a);a=this.map.mf(b);this.Nc.createNode(d,a,c,e)}};c.prototype.yc=function(a,b,c){this.Nc.Db||(this.log("Delete node "+a+" from "+b+":"+c),b=this.map.mf(b),a=this.map.mf(a),this.Nc.yc(a,b,c))};c.prototype.Pe=function(a,b,c,e,f){this.Nc.Db||(this.log("Move node "+a+" from "+e+":"+f+" to "+b+":"+c),this.Nc.Pe(this.map.mf(a),this.map.mf(b),c,this.map.mf(e),f))};c.prototype.Jb=function(a,b,c){this.Nc.Db||(this.log("Set properties for node "+a+" to "+JSON.stringify(b)),b=re(b),c=re(c),this.Nc.Jb(this.map.mf(a),
b,c))};c.prototype.pa=function(){this.Nc.Db||this.Nc.pa()};return c}();var te={style:".zwibbler-builtin-toolbar {\n    background: white;\n    width: 130px;\n    overflow-y: auto;\n    -webkit-touch-callout: none;\n    -webkit-user-select: none; \n     -khtml-user-select: none; \n       -moz-user-select: none; \n        -ms-user-select: none; \n            user-select: none; \n}\n\n.zwibbler-builtin-toolbar button {\n    font-family: inherit;\n    font-size: 100%;\n    padding: 5px;\n    background-color: white;\n    border: none;\n}\n\n.zwibbler-builtin-toolbar button img {\n    margin: 0;\n}\n\n.zwibbler-builtin-toolbar button:hover,\n.zwibbler-builtin-toolbar button.selected {\n    background-color: #9fb3e7;\n}\n",
si:'<div class="zwibbler-builtin-toolbar">\n<button \n    z-if="getConfig(\'showPickTool\')"\n    z-click="usePickTool()"\n    z-selected="getCurrentTool()===\'pick\'"\n    title="Pick">\n    <img z-bind:src="getImageUrl(\'wd-pick.png\')">\n</button>\n<button \n    z-if="getConfig(\'showSquareTool\')"\n    z-click="useRectangleTool()"\n    z-selected="getCurrentTool()===\'rectangle\'"\n    title="Rectangle">\n    <img z-bind:src="getImageUrl(\'wd-box.png\')">\n</button>\n<button \n    z-if="getConfig(\'showRoundRectTool\')"\n    z-click="useRoundRectTool()"\n    title="Rounded Rectangle">\n    <img z-bind:src="getImageUrl(\'wd-roundrect.png\')">\n</button>\n<button \n    z-if="getConfig(\'showCircleTool\')"\n    z-click="useCircleTool()"\n    z-selected="getCurrentTool()===\'circle\'"\n    title="Circle">\n    <img z-bind:src="getImageUrl(\'wd-circle.png\')">\n</button>\n<button \n    z-if="getConfig(\'showShapeBrushTool\')"\n    z-click="useShapeBrushTool()"\n    title="Shape brush">\n    <img z-bind:src="getImageUrl(\'wd-shapebrush.png\')">\n</button>\n<button \n    z-if="getConfig(\'showBrushTool\')"\n    z-click="useBrushTool()"\n    z-selected="getCurrentTool()===\'brush\'"\n    title="Brush">\n    <img z-bind:src="getImageUrl(\'wd-brush.png\')">\n</button>\n<button \n    z-if="getConfig(\'showLineTool\')"\n    z-click="useLineTool()"\n    z-selected="getCurrentTool()===\'line\'"\n    title="Lines">\n    <img z-bind:src="getImageUrl(\'wd-line.png\')">\n</button>\n<button \n    z-if="getConfig(\'showCurveTool\')"\n    z-click="useCurveTool()"\n    z-selected="getCurrentTool()===\'curve\'"\n    title="Curves">\n    <img z-bind:src="getImageUrl(\'wd-curve.png\')">\n</button>\n<button \n    z-if="getConfig(\'showArrowTool\')"\n    z-click="useArrowTool()"\n    z-selected="getCurrentTool()===\'arrow\'"\n    title="Arrows">\n    <img z-bind:src="getImageUrl(\'wd-arrow.png\')">\n</button>\n<button \n    z-if="getConfig(\'showTextTool\')"\n    z-selected="getCurrentTool()===\'text\'"\n    z-click="useTextTool()"\n    title="Text">\n    <img z-bind:src="getImageUrl(\'wd-text.png\')">\n</button>\n<button \n    z-if="getConfig(\'showImageTool\')"\n    z-click="insertImage()"\n    title="Insert image...">\n    <img z-bind:src="getImageUrl(\'wd-image.png\')">\n</button>\n<button \n    z-if="getConfig(\'showMoveToFrontBack\')"\n    z-click="bringToFront()"\n    title="Bring to front">\n    <img z-bind:src="getImageUrl(\'wd-moveup.png\')">\n</button>\n<button \n    z-if="getConfig(\'showMoveToFrontBack\')"\n    z-click="sendToBack()"\n    title="Send to back">\n    <img z-bind:src="getImageUrl(\'wd-movedown.png\')">\n</button>\n<button \n    z-if="getConfig(\'showUndoRedo\')"\n    z-disabled="!canUndo()"\n    z-click="undo()"\n    title="Undo">\n    <img z-bind:src="getImageUrl(\'wd-undo.png\')">\n</button>\n<button \n    z-if="getConfig(\'showUndoRedo\')"\n    z-disabled="!canRedo()"\n    z-click="redo()"\n    title="Redo">\n    <img z-bind:src="getImageUrl(\'wd-redo.png\')">\n</button>\n<button \n    z-if="getConfig(\'showCopyPaste\')"\n    z-click="copy()"\n    title="Copy">\n    <img z-bind:src="getImageUrl(\'wd-copy.png\')">\n</button>\n<button \n    z-if="getConfig(\'showCopyPaste\')"\n    z-click="paste()"\n    title="Paste">\n    <img z-bind:src="getImageUrl(\'wd-paste.png\')">\n</button>\n</div>\n'};var ue={style:".zwibbler-page-selector {\n    overflow-y: scroll;\n    background: #888;\n    width: 160px;\n    text-align: center;\n}\n\n.zwibbler-page-selector [z-page] {\n    border: 3px solid transparent;\n    margin: 5px;\n    display: inline-block;\n    box-shadow: 2px 2px 2px rgba(0,0,0,0.2);\n}\n\n.zwibbler-page-selector [z-page].selected {\n    border: 3px solid #9fb3e7;\n}\n",si:'<div class="zwibbler-page-selector">\n    <button z-if="getConfig(\'showPageSelectorControls\')"\n        z-click="setCurrentPage(insertPage(getCurrentPage()+1))">\n        Add Page\n    </button>\n    <button z-if="getConfig(\'showPageSelectorControls\')"\n        z-click="deletePage(getCurrentPage())">\n        Delete Page\n    </button>\n    <br>\n    <div z-sort="movePage($from,$to)">\n        <div z-for="page in getPageCount()"\n            draggable="TRUE"\n            z-sortable\n            z-page="page"\n            z-width="130"\n            z-height="130"\n            z-click="setCurrentPage(page)"\n            z-selected="page==getCurrentPage()">\n        </div>\n    </div>\n</div>\n'};var ve={style:".zwibbler-property-panel {\n    width: 200px;\n    background: #f5f5f5;\n    display:flex;\n    flex-flow: column nowrap;\n    overflow-y: scroll;\n    padding: 10px;\n    font-family: sans-serif;\n    -webkit-touch-callout: none;\n    -webkit-user-select: none; \n     -khtml-user-select: none; \n       -moz-user-select: none; \n        -ms-user-select: none; \n            user-select: none;     \n}\n\n.zwibbler-property-panel h3 {\n    margin-bottom: 0.5em;\n}\n\n.zwibbler-property-panel button {\n    font-family: inherit;\n    font-size: 100%;\n    padding: 5px;\n    display: block;\n    background-color: white;\n    color: black;\n    border: none;\n    border-radius: 2px;\n    border-bottom: 2px solid #ddd;\n    width: 100%;\n}\n\n.zwibbler-property-panel button[tool] {\n    display: inline-block;\n    width: 60px;\n    height: 60px;\n    font-size: 30px;\n}\n\n.zwibbler-property-panel button.zwibbler-option {\n    border: 0;\n    padding: 10px;\n    border-radius: 3px;\n    background: transparent;\n    text-align: left;\n}\n\n.zwibbler-property-panel button.selected {\n    background: #9fb3e7;\n}\n\n.zwibbler-property-panel button.hover {\n    background: #ddd;\n}\n\n.zwibbler-property-panel hr {\n    border: none;\n    border-top: 1px solid #ccc;\n}\n\n.zwibbler-property-panel select {\n    width: 100%;\n}\n\n.zwibbler-property-panel .colour-picker {\n    padding: 10px 0;\n}\n\n.zwibbler-property-panel [swatch] {\n    border: 1px solid black;\n    display: inline-block;\n    height: 2em;\n    width: 4em;\n    vertical-align:middle;\n    margin-right: 10px;\n}\n",
si:'<div class="zwibbler-property-panel">\n<h3>Shape options</h3>\n<div z-if="summary.empty">\n    There are no selected shapes.\n</div>\n<div z-has="AnyNode">\n    <button z-click="deleteNodes()">Delete</button>                    \n    <button z-click="bringToFront()">\n        Move to front\n    </button>\n    <button z-click="sendToBack()">\n        Send to back\n    </button>\n</div>\n<div z-has="fontName">\n    <h3>Font</h3>\n    <select z-property="fontName">\n        <option z-for="font in getConfig(\'fonts\')" z-text="font" z-bind:value="font"></option>\n    </select>\n</div>\n<div z-has="fontSize">\n    <h3>Font size</h3>\n    <select z-property="fontSize">\n        <option value="8">8</option>\n        <option value="10">10</option>\n        <option value="12">12</option>\n        <option value="16">16</option>\n        <option value="20">20</option>\n        <option value="24">24</option>\n        <option value="50">50</option>\n    </select>\n</div>\n<div z-has="fillStyle|strokeStyle|background">\n    <h3>Colours</h3>\n    <div class="colour-picker" z-has="fillStyle">\n        <div swatch z-property="fillStyle" z-colour></div>\n        Fill style\n    </div>\n    <div class="colour-picker" z-has="strokeStyle">\n        <div swatch z-property="strokeStyle" z-colour></div>\n        Outline\n    </div>\n    <div class="colour-picker" z-has="background">\n        <div swatch z-property="background" z-colour></div>\n        Background\n    </div>\n</div>\n<div z-has="arrowSize">\n    <h3>Arrows</h3>\n    <button class="zwibbler-option" z-property="arrowSize" z-value="0">None</button>\n    <button class="zwibbler-option" z-property="arrowSize" z-value="10">Small</button>\n    <button class="zwibbler-option" z-property="arrowSize" z-value="15">Large</button>\n    <hr>\n    <button class="zwibbler-option" z-property="arrowStyle" z-value="solid">Solid</button>\n    <button class="zwibbler-option" z-property="arrowStyle" z-value="open">Open</button>\n</div>\n<div z-has="lineWidth">\n        <h3>Line width</h3> \n        <select z-property="lineWidth">\n            <option value="0">None</option>\n            <option value="1">1</option>\n            <option value="2">2</option>\n            <option value="4">4</option>\n            <option value="8">8</option>\n        </select>\n    </div>\n<div z-has="dashes">\n    <h3>Line style</h3>\n    <button class="zwibbler-option" z-property="dashes" z-value="">Solid</button>\n    <button class="zwibbler-option" z-property="dashes" z-value="3,3">Dots</button>\n    <button class="zwibbler-option" z-property="dashes" z-value="8,2">Dashes</button>\n</div>\n<div z-has="opacity">\n    <h3>Opacity</h3>\n    <input z-property="opacity" type="range" min="0.1" max="1.0" step="0.05">\n</div>              \n'};var we=function(c){function a(a){var b=c.call(this)||this;b.ia=a;b.path=new R;b.node=0;return b}n(a,c);a.prototype.beginPath=function(){this.path=new R;this.node=0};a.prototype.closePath=function(){this.path.close()};a.prototype.moveTo=function(a,c){this.path.moveTo(a,c)};a.prototype.lineTo=function(a,c){this.path.lineTo(a,c)};a.prototype.quadraticCurveTo=function(a,c,e,f){this.path.quadraticCurveTo(a,c,e,f)};a.prototype.bezierCurveTo=function(a,c,e,f,g,h){this.path.bezierCurveTo(a,c,e,f,g,h)};a.prototype.fill=
function(){this.jm(!0)};a.prototype.stroke=function(){this.jm(!1)};a.prototype.jm=function(a){this.node||(this.node=this.ia.createNode("PathNode",{ba:this.path.Sb(),oa:this.oa.clone(),lineWidth:this.lineWidth}));a?this.ia.Pc(this.node,"fillStyle",this.fillStyle):this.ia.Pc(this.node,"strokeStyle",this.strokeStyle)};a.prototype.fillText=function(a,c,e){this.km(a,c,e,!0)};a.prototype.strokeText=function(a,c,e){this.km(a,c,e,!1)};a.prototype.km=function(a,c,e,f){c=this.oa.multiply(new E(c,e));e=this.te(this.font);
a={text:a,matrix:c,fontName:e.fontFamily,fontSize:e.fontSize,italic:"italic"===e.fontStyle,bold:"bold"===e.fontWeight};f?a.fillStyle=this.fillStyle:a.strokeStyle=this.strokeStyle;this.ia.createNode("TextNode",a)};a.prototype.qj=function(){throw Error("drawImage: not implented");};a.prototype.measureText=function(a){var b=document.createElement("canvas").getContext("2d");b.font=this.font;return b.measureText(a)};a.prototype.clip=function(){throw Error("clip: not implemented.");};a.prototype.tj=function(){return{}};
a.prototype.wj=function(){};return a}(ad);function xe(c){return c instanceof Array?c:[c]}function ze(c,a,b,d){c.fillStyle="#ffffff";c.fillRect(a,b,d,d);c.beginPath();c.strokeStyle="#000000";c.moveTo(a,b);c.lineTo(a+d,b+d);c.moveTo(a+d,b);c.lineTo(a,b+d);c.stroke()}
function Ae(c,a,b,d){for(var e,f=0;f<d;f+=5){e=0===f/5%2;for(var g=0;g<d;g+=5)c.fillStyle=e?"#000000":"#ffffff",e=!e,c.fillRect(a+g,b+f,5,5)}e=c.createLinearGradient(a+d,b+d,a,b);e.addColorStop(0,"rgba(255, 255, 255, 1.0)");e.addColorStop(1,"rgba(255, 255, 255, 0.0)");c.fillStyle=e;c.fillRect(a,b,d,d)}
var W=function(){function c(a,b){var c=this;this.kb={};this.ak={};this.yb=0;this.actions=[];this.Ph=new T;this.Sj=new T;this.Gi=0;this.Oj=-1;this.Ek=null;this.vf={};this.Yf=this.nc=this.Wc=null;this.Th=!1;this.log=w.create("CONTEXT");this.ym=!1;this.Yk=0;this.Of=null;this.Lm="";this.da=new Zd(this,a,b);this.fo();var e=this;O.xk.push(this);this.da.La.add(function(){c.log("Running ZwibblerContext destructor");c.fh();delete a.zwibbler;delete e.kb;delete e.actions;delete e.da;delete e.Wc;for(var b=O.xk,
d=0;d<b.length;d++)if(b[d]===e){b.splice(d,1);break}c.Yf&&c.Yf.stop()});this.Ja("document-changed",function(){c.summary=c.Dg();if(c.nc)if(c.nc.Mr())c.log("Have outstanding changes; not sending more");else{var a=c.nc.yg();""!==a&&c.ua("local-changes",a)}});this.up();this.Ja("selected-nodes",function(){c.summary=c.Dg()});this.Ja("tool-changed",function(){c.summary=c.Dg()});this.summary=this.Dg();this.vh(te,"left","showToolbar");this.vh(ue,"right","showPageSelector");this.vh(ve,"right","showPropertyPanel");
this.vh(Be,"bottom","showColourPanel")}c.prototype.xf=function(a){this.nc&&this.nc.xf(a)};c.prototype.lc=function(a,b){var d=this;V.lc(a,b);V.digest();this.da.La.add(function(){d.log("DESTROYING A PANEL");V.detach(b)});!this.ym&&a instanceof c&&(this.ym=!0,this.Ja("tool-changed",function(){return V.digest()}),this.da.fa.Ja("update",function(){return V.digest()}),this.Ja("document-changed",function(){return V.digest()}),this.Ja("selected-nodes",function(){return V.digest()}));this.resize()};c.prototype.yp=
function(){1<this.yb&&this.Ba("abortTransaction is not implemented for nested calls. Please contact support.");this.yb=0;this.actions=[]};c.prototype.xc=function(a,b,c,e,f,g){switch(g){case "scale":case "rotate":case "translate":var d=g;break;default:if("function"===typeof g){d="click";var l=g}else{this.Ba('addSelectionHandle: action must be "scale", "rotate", "translate", or a function');return}}this.da.view.xc(a,b,c,e,f,d,l)};c.prototype.Bj=function(a){this.da.language.Bj(a)};c.prototype.Dp=function(){if(!this.ta())return this.vi(this.Hc())};
c.prototype.hg=function(a,b,c){this.da.hg(a,b,c)};c.prototype.Fj=function(){this.yb+=1;1===this.yb?(this.actions=[],this.Sj.clear(),this.Ph.clear(),this.Gi=0,this.Oj=this.da.view.ea.Sa,this.log("beginTransaction() -- beginning new")):this.log("beginTransaction() -- already in one, bump counter")};c.prototype.Fh=function(){this.ta()||this.da.view.Fh()};c.prototype.pd=function(){return this.ta()?!1:this.da.view.ea.pd()};c.prototype.qd=function(){return this.ta()?!1:this.da.view.ea.qd()};c.prototype.pb=
function(){this.da.view.pb();this.da.view.Mb();this.da.view.ha()};c.prototype.Yp=function(){this.da.Im()};c.prototype.Zp=function(a,b){if(this.ta())return!1;this.Tf(a,!b)};c.prototype.aq=function(){this.yb=Math.max(0,this.yb-1);0===this.yb?(this.da.view.pa(this.actions,!0),this.actions=[],this.log("committing irreversible transaction.")):this.log("delaying transaction commit -- nested call (count=%s)",this.yb)};c.prototype.Ih=function(){this.yb=Math.max(0,this.yb-1);0===this.yb?(this.da.view.pa(this.actions),
this.actions=[],this.log("committing transaction.")):this.log("delaying transaction commit -- nested call (count=%s)",this.yb)};c.prototype.Ce=function(a,b){void 0===a&&(a=!1);"boolean"!==typeof a&&this.Ba("First parameter of copy() must be true/false");return this.da.view.Ce(a,b)};c.prototype.jq=function(){function a(a){for(var c=30;100>c;c+=20)a.values[2]=c/100,b.push(a.toString())}var b="rgba(0,0,0,0.0) rgba(0,0,0,0.5) #000000 #ffffff #000088 #008800 #008888 #880000 #880088 #884400 #888888 #444444 #0000ff #00ff00 #00ffff #ff0000 #ff00ff #ffff00".split(" ");
a(new u(u.qe,[0,0,0,1]));for(var c=0;720>c;c+=35){var e=new u(u.qe,[c,.5,0,1]);a(e)}return b};c.prototype.ng=function(a){if(this.ta())return!1;if(0<a.length)return this.Kb(this.da.ng(this.actions,a))};c.prototype.Hb=function(a){void 0===a&&(a={});var b={};if(a instanceof Array)return a.concat();if(!(a instanceof Object))return a;for(var c in a)if(a.hasOwnProperty(c)){var e=a[c];"matrix"===c&&("[object Array]"===Object.prototype.toString.apply(e)&&"Matrix"===e[0]?(e.splice(0,1),e=new F(e)):e instanceof
F||(e=new F(e)));b[c]=e}return b};c.prototype.createNode=function(a,b){this.log("createNode(%s)",a);var c=this.Hb(b);return this.Kb(this.da.createNode(this.actions,a,c))};c.prototype.Nh=function(a){return this.Kb(this.da.Nh(this.actions,a))};c.prototype.vh=function(a,b,c){var d=this,f;this.da.fa.Ja(c,function(c){c?(f||(a.style&&O.Dd(a.style),c=document.createElement("div"),c.innerHTML=a.si,f=c.firstChild,d.lc(d,f),a.controller&&a.controller(d)),d.da.hg(1,b,f)):f&&d.da.Ug(f)})};c.prototype.nq=function(a,
b){var c=pb(a);if(c){Xb(b)||this.Ba("createToolbar: second parameter must be array");O.Dd("a.zwibbler-button {\n            background-repeat: no-repeat;\n            background-position: center;\n            display: inline-block;\n            overflow: hidden;\n        }");for(var e=this,f=function(a,b){b.addEventListener("click",function(b){a.onclick.call(this,e,b)})},g=0;g<b.length;g++){var h=b[g],l=z("a").ue("zwibbler-button").Ga;l.setAttribute("href","javascript:void(0)");h.toolName&&z(l).ue(h.toolName);
h.onclick&&f(h,l);h.title&&l.setAttribute("title",h.title);h.background?l.style.background=h.background:h.image&&(l.style.backgroundImage="url("+h.image+")");h.html&&(l.innerHTML=h.html);c.appendChild(l)}var k;this.Ja("tool-changed",function(a){k&&k.classList.remove("zwibbler-selected");(k=c.querySelector("."+a))&&k.classList.add("zwibbler-selected")})}else this.Ba("createToolbar: Could not convert first parameter to an HTML element")};c.prototype.Mj=function(a){if(a=this.da.Mj(this.actions,a))return this.Kb(a);
this.Ba("createShape needs an array of at least 6 numbers");return null};c.prototype.Qj=function(){if(this.ta())return!1;var a=this.da.view.Ce(!1);this.Pm();return a};c.prototype.qg=function(){this.da.qg();for(var a in this)this.hasOwnProperty(a)&&delete this[a];this.Th=!0};c.prototype.Kb=function(a){this.yb?"number"===typeof a&&this.Ph.add(a):(this.log("Not in a transaction. committing immediately. id=%s",a),this.Ih());return"number"===typeof a?a:0};c.prototype.yc=function(a){this.Om(a)};c.prototype.np=
function(a){for(var b=0;b<a.length;b++){var c=a[b],e=this.da.view.ea.va(c,!1);e&&!this.Sj.contains(c)||!e&&this.Ph.contains(c)||(a.splice(b,1),--b)}return 0<a.length};c.prototype.Om=function(a){void 0===a&&(a=this.ad());if(this.ta())return!1;this.log("deleteNodes()");a=xe(a);this.np(a)&&(this.Kb(this.da.yc(this.actions,a)),this.Sj.add(a))};c.prototype.pq=function(){if(this.ta())return!1;1<this.yb&&this.Ba("deletePage is not implemented inside transactions. Please contact support.");1===this.Hc()?
this.log("Cannot remove all the pages."):(this.actions.push(new Cc([this.da.view.ea.pk().id])),this.Kb())};c.prototype.Pm=function(){if(this.ta())return!1;this.da.view.pg()};c.prototype.Vd=function(){1===arguments.length&&!1===arguments[0]&&this.da.view.ea.Rn();return this.da.view.ea.Vd()};c.prototype.download=function(a,b,c){"jpeg"===a&&(a="jpg");var d;if("pdf"===a||"svg"===a||"png"===a||"jpg"===a||"bmp"===a||"zwibbler3"===a){var f="zwibbler3"===a?hd.sh(this.da.view.ea,a,"data-uri"):this.save(a,
c);"Blob"in window&&(d=Ab(f));if(d){if(window.navigator.msSaveOrOpenBlob){this.log("Using msSaveOrOpenBlob()");window.navigator.msSaveOrOpenBlob(d,b);return}f=window.URL.createObjectURL(d);this.log("Using blob object url %s",f);this.da.La.add(function(){window.URL.revokeObjectURL(f)})}var g=document.createElement("a");g.innerHTML="download";g.setAttribute("href",f);g.setAttribute("download",b);g.style.display="none";document.body.appendChild(g);g.click();setTimeout(function(){document.body.removeChild(g)},
1E3)}else this.log("unsupported format for download: %s",a)};c.prototype.ha=function(a,b){void 0===b&&(b={});var c=b.page||0,e=this.da.view.ea.Sa,f=this.da.view.ea.bd();this.da.view.ea.Rb(c);this.da.view.td(a,0,0,f.width,f.height);this.da.view.ea.ha(a);this.da.view.ea.Rb(e)};c.prototype.zq=function(a){if(this.ta())return!1;var b=this.da.view.ea.va(a,!1);b?b.oi()?(a=this.da.view.tl({}))&&a.ql(b,b.rect.x,b.rect.y):this.log("editNodeText: node %s (%s) cannot contain text.",a,b.type()):this.log("editNodeText: nodeid %s does not exist.",
a)};c.prototype.duplicate=function(){if(this.ta())return!1;this.da.view.duplicate()};c.prototype.rj=function(a,b,c){var d=this;if(!(this.Th||this.ak[a]||this.rp(a))){var f=function(){if(!d.Th&&(d.ak[a]=!1,a in d.kb))for(var c=0,e=d.kb[a];c<e.length;c++)e[c].apply(null,b)};if("once"===c&&(this.ak[a]=!0,b.length))throw Error("emitOnce("+a+") with args not supported.");"now"===c?f():setTimeout(f,0);return this}};c.prototype.ua=function(a){for(var b=[],c=1;c<arguments.length;c++)b[c-1]=arguments[c];return this.rj(a,
b,"normal")};c.prototype.$d=function(a){for(var b=[],c=1;c<arguments.length;c++)b[c-1]=arguments[c];return this.rj(a,b,"now")};c.prototype.$h=function(a){for(var b=[],c=1;c<arguments.length;c++)b[c-1]=arguments[c];return this.rj(a,b,"once")};c.prototype.yt=function(a){this.vf[a]=a in this.vf?this.vf[a]+1:1};c.prototype.rp=function(a){return a in this.vf&&0<this.vf[a]?(this.log("Skipped %s event",a),--this.vf[a],!0):!1};c.prototype.focus=function(a,b){void 0===a&&(a=!1);void 0===b&&(b=null);this.da.qt(b);
a?this.da.il("text"===this.Ag()):this.da.focus("canvas")};c.prototype.Mq=function(a){a=this.Zm(a);return a.length?a[0]:null};c.prototype.Zm=function(a){a=this.da.view.ea.Nq(a);for(var b=[],c=0;c<a.length;c++)b.push(a[c].id);return b};c.prototype.Pq=function(a,b,c){if(this.ta())return!1;if(3===arguments.length)if("number"!==typeof b||"number"!==typeof c)this.Ba("flip: 2nd and 3rd args must be numbers.");else{var d=new A(b,c);this.da.view.an(a/180*Math.PI,d)}else this.da.view.an(a/180*Math.PI)};c.prototype.wg=
function(a,b,c,e){if(this.ta())return!1;a=this.tm(a);"number"===typeof c&&"number"===typeof e?(c=new A(c,e),this.da.view.wg(a,b/180*Math.PI,c)):this.da.view.wg(a,b/180*Math.PI)};c.prototype.dn=function(a,b,c){function d(a){a.addEventListener("click contextmenu",function(b){m.call(h,a.Me("backgroundColor"),0===b.button);b.preventDefault()})}function f(a,b){return z("div").Ec({width:b+"px",height:b+"px",display:"inline-block"}).Sd(a)}function g(a,b){var c=document.createElement("canvas");c.width=a;
c.height=a;b(c.getContext("2d"),0,0,a);var d=f(l,a);d.Ga.appendChild(c);return d}void 0===c&&(c={});var h=this,l=pb(a),k;if(l){var m=c.onColour||c.onColor||h.Tf;a=g(b,ze);a.addEventListener("click contextmenu",function(a){if("click"===a.type||"contextmenu"===a.type)m.call(h,"transparent",0===a.button),a.preventDefault()});a=g(b,Ae);a.addEventListener("click contextmenu",function(a){if("click"===a.type||"contextmenu"===a.type){if(c.onOpacity)c.onOpacity(.5,0===a.button);else h.Go(.5,0===a.button);
a.preventDefault()}});for(k=0;1>=k;k+=1/13){var q=(new u(u.qe,[0,0,k,1])).toString();d(f(l,b).Ec({backgroundColor:q}))}for(k=.3;1>=k;k+=.7/14)for(a=0;360>a;a+=22.5)q=(new u(u.qe,[a,.7,k,1])).toString(),d(f(l,b).Ec({backgroundColor:q}));for(a=0;360>a;a+=22.5)q=(new u(u.qe,[a,1,1,1])).toString(),d(f(l,b).Ec({backgroundColor:q}))}};c.prototype.xg=function(){return this.da.view.xg()};c.prototype.Xq=function(){var a=[];this.da.view.ea.Ee(function(b){a.push(b.id)},this.zg());return a};c.prototype.pp=function(){var a=
[];this.da.view.ea.oc(!1,function(b){a.push(b.id)});return a};c.prototype.$q=function(){return this.da.ar()};c.prototype.gk=function(a){return this.se(this.da.view.gk(a))};c.prototype.hk=function(a){Yb(a)||this.Ba("getConfig: Expected string");return this.da.fa.get(a)};c.prototype.getContext=function(){return new we(this)};c.prototype.zg=function(){return this.yb?this.Oj:this.da.view.ea.Sa};c.prototype.cr=function(){return this.da.view.gi()};c.prototype.dr=function(){return this.da.view.ji()};c.prototype.Ag=
function(){return this.da.view.Ag()};c.prototype.er=function(a){a=this.da.view.ea.va(a);var b=null;a&&"CustomNode"===a.type()&&(b=a.Ua);return b};c.prototype.ln=function(a,b){var c=this.da.view.Za(a,b);return{x:c.x,y:c.y}};c.prototype.gr=function(a){return this.da.view.ea.ka(a)};c.prototype.di=function(){return this.se(this.da.view.ea.bd())};c.prototype.gi=function(){return this.da.view.gi()};c.prototype.lk=function(a){return this.da.fa.lk(a)};c.prototype.rr=function(a){return this.da.language.get(a)};
c.prototype.se=function(a){return{x:a.x,y:a.y,width:a.width,height:a.height}};c.prototype.yh=function(a){"object"!==typeof a&&this.Ba("Error: Rectangle object expected.");a=new D(a.x||0,a.y||0,a.width||0,a.height||0);a.ro();return a};c.prototype.ir=function(){return this.se(this.da.view.ea.hn())};c.prototype.pr=function(a,b){return this.hi(a,b)};c.prototype.tr=function(){var a=[],b={};this.da.view.ea.oc(!1,function(d){!(c=d.zd())||c in b||(b[c]=1,a.push(c))});var c=this.xg();c in b||a.push(c);return a};
c.prototype.sr=function(a){var b=[];this.da.view.ea.oc(!1,function(c){c.zd()===a&&b.push(c.id)});return b};c.prototype.ur=function(a,b,c){var d=this.da.view.ea.va(a);if(null===d)return this.Ba("Error: node %s does not exist",a),null;a=this.da.view.ns(d,b,c);return{x:a.x,y:a.y}};c.prototype.$c=function(a){return this.da.view.ea.$c(a)};c.prototype.hi=function(a,b){return this.da.hi(a,b)};c.prototype.vr=function(a){a=xe(a);for(var b=null,c=0;c<a.length;c++){var e=a[c],f=this.da.view.ea.va(e);null===
f?this.Ba("Error: node %s does not exist",e):b?b.mh(f.rect):b=f.rect.clone()}b||(b=new D(0,0,0,0));return this.se(b)};c.prototype.wr=function(a){var b=this.da.view.ea.va(a);if(null===b)return this.Ba("Error: node %s does not exist",a),null;a=b.Ea().Ad();return{x:a.x,y:a.y}};c.prototype.xr=function(a){a=this.da.view.ea.va(a);var b="";a&&(b=a.type(),"CustomNode"===b&&(b=a.ka("nodeType")));return b};c.prototype.yr=function(a,b){var c=this.da.view.ea.xb(a,b,this.da.view.Qa);return c?c.id:this.da.view.ko(a,
b)&&(c=this.ad(),c.length)?c[0]:null};c.prototype.Hc=function(){var a=this.da.view.ea.Hc();this.yb&&(a+=this.Gi);return a};c.prototype.rn=function(a){return(a=this.da.view.ea.pk(a))?a.id:null};c.prototype.sn=function(a){return this.se(this.da.view.ea.bd(a))};c.prototype.ii=function(a){var b=this.da.view.ea.va(a,!1);if(!b||"PathNode"!==b.type())return null;a=b.ii().clone().ag();var c=[];b.Ea();for(b=0;b<a.length;b++){var e=a[b];c.push(e.x);c.push(e.y)}return c};c.prototype.Cr=function(a){a=this.da.view.ea.va(a,
!1);if(!a||"PathNode"!==a.type())return null;a=a.ii();for(var b=[],c=[],e=0;e<a.ba.length;){switch(a.ba[e]){case H.jc:c=[{x:a.ba[e+1],y:a.ba[e+2]}];b.push(c);break;case H.ic:c.push({x:a.ba[e+1],y:a.ba[e+2]})}e+=H.kc[a.ba[e]]}return b};c.prototype.jn=function(){return this.da.view.scale};c.prototype.jk=function(){var a=this.da.view.jk();return a?a.id:0};c.prototype.Dr=function(a,b,c,e){var d=this.da.view.Tj(a,b);if(void 0===c||void 0===e)return{x:d.x,y:d.y};a=this.da.view.Tj(a+c,b+e);return this.se(new D(d.x,
d.y,a.x-d.x,a.y-d.y))};c.prototype.Fr=function(){return this.da.view.Xc};c.prototype.ji=function(){return this.da.view.ji()};c.prototype.fi=function(a,b){var c=this.da.view.ea.va(a,!1);return c?c.fi(b):null};c.prototype.jt=function(a,b,c){var d=this.da.view.ea.va(a,!1);if(!d)return this.log("setEditHandle: node %s doesn't exist.",a),!1;if("PathNode"!==d.type())return this.log("setEditHandle: node %s is not a PathNode.",a),!1;d=d.ka("commands");d=Q.kp(d,b,c);if(!d)return this.log("setEditHandle: failed"),
!1;this.Pc(a,"commands",d);return!0};c.prototype.ad=function(a){void 0===a&&(a=!1);return this.da.view.rc(a)};c.prototype.Dg=function(a){function b(a,b){var d=c.properties[a];void 0!==b&&(c.properties[a]=d!==b&&void 0!==d?null:b);c.empty=!1}void 0===a&&(a=this.ad());for(var c={properties:{},types:{},nodes:[],empty:!0},e=this.da.fa.get("allowTextInShape"),f=0;f<a.length;f++){var g=this.da.view.ea.va(a[f],!1);if(g){var h=g.type();c.types[h]=!0;c.types.AnyNode=!0;c.empty=!1;"PathNode"===h&&(h=g.ka("closed")?
"PathNode-closed":"PathNode-open",c.types[h]=!0);g=g.ec();for(var l in g)g.hasOwnProperty(l)&&"matrix"!==l&&("BrushNode"!==h||"fillStyle"!==l)&&("PathNode-open"!==h||"fontSize"!==l&&"fontName"!==l&&"fillStyle"!==l)&&("PathNode-closed"!==h||(e||"fontSize"!==l&&"fontName"!==l)&&"arrowSize"!==l&&"arrowStyle"!==l)&&b(l,g[l])}}!c.nodes.length||"opacity"in c.properties||(c.properties.opacity=1);if(this.da.view.ma.ki){a=this.da.view.ma.ki();for(var k in a)b(k,a[k])}return c};c.prototype.Ir=function(){return this.se(this.da.view.ae())};
c.prototype.Ba=function(a){for(var b=1;b<arguments.length;b++);b=arguments[0].split("%s");for(var c=[],e=0;e<b.length;e++)c.push(b[e]),e<b.length-1&&c.push(JSON.stringify(arguments[e+1]));var f=c.join("");this.log(f);throw{message:f,toString:function(){return f}};};c.prototype.pm=function(a,b){var c=document.createElement("input");c.setAttribute("id","ZwibblerFileInput");c.setAttribute("type","file");a.accept&&c.setAttribute("accept",a.accept);c.style.display="none";document.body.appendChild(c);this.da.La.add(function(){c.parentNode&&
c.parentNode.removeChild(c)});var e=new FileReader;c.addEventListener("change",function(){var b=this.files;b&&0<b.length&&("data-uri"===a.format?e.readAsDataURL(b[0]):"text"===a.format&&e.readAsText(b[0]));c.parentNode&&c.parentNode.removeChild(c)});e.addEventListener("load",function(){b(e.result)});c.value="";c.click()};c.prototype.Or=function(){var a=this;if(this.ta())return!1;this.pm({accept:"image/*",format:"data-uri"},function(b){a.createNode("ImageNode",{url:b,ru:!0})})};c.prototype.vi=function(a){if(this.ta())return!1;
var b=this.da.view.ea.$a();this.actions.push(new S(b,"PageNode",{},this.da.view.ea.root.id,a));this.Kb(b);this.yb&&(this.Gi+=1);return a};c.prototype.Ak=function(a){return this.da.view.ea.Ak(a)};c.prototype.load=function(a,b){void 0===b&&(b=a);var c=hd.rh(b);if(c)return this.fh(),this.da.hf(c),!0;this.log("load(): Could not open file.");return!1};c.prototype.yi=function(a){var b=this;J(a)?(this.Ek&&clearTimeout(this.Ek),this.Ek=setTimeout(function(){b.da.view.yi(!1)},a),b.da.view.yi(!0)):this.Ba("lockUpdates: Expected a number")};
c.prototype.Hf=function(a){this.nc&&(this.nc.Hf(a),a=this.nc.yg(),""!==a&&(this.log("Releasing buffered changes"),this.ua("local-changes",a)))};c.prototype.zi=function(){if(this.ta())return!1;this.da.view.zi()};c.prototype.fs=function(a,b){if(this.ta())return!1;if(J(a)&&J(b)){var c=this.Hc();0>a||a>=c?this.Ba("From page must be > 0 and less than getPageCount()"):0>b||b>=c?this.Ba("From page must be > 0 and less than getPageCount()"):(c=this.rn(a),null!==c&&(this.actions.push(new Kc([c],Kc.bm,b)),
this.Kb()))}else this.Ba("movePage: needs two valid page numbers.")};c.prototype.Ai=function(){if(this.ta())return!1;this.da.view.Ai()};c.prototype.Gk=function(){this.fh();this.da.Gk();this.fo()};c.prototype.nextPage=function(){this.Yg(Math.min(this.zg()+1,this.Hc()-1))};c.prototype.Ja=function(a,b){"draw"===a?this.Wc=b:a in this.kb?this.kb[a].push(b):this.kb[a]=[b];return this};c.prototype.ss=function(a){"function"===typeof a||this.Ba("Error: onComplete needs a function argument.");this.da.view.Tq(a)};
c.prototype.fo=function(){var a=this.da.fa.get("defaultPaperSize");this.log("onNewDocument()");"none"!==a&&this.gl(a)};c.prototype.xs=function(a){var b=this;return new ib(function(c,e){b.pm({accept:"."+a,format:"text"},function(a){b.load(a)?c(b):e(Error("Could not open the file."))})})};c.prototype.Rg=function(a){if(this.ta())return!1;this.da.view.Rg(a)};c.prototype.Gs=function(){this.Yg(Math.max(this.zg()-1,0))};c.prototype.print=function(a,b){var c=[],e;if("number"===typeof a)c.push(a);else if(a instanceof
Array)for(e=0;e<a.length;e++)if(J(a[e]))c.push(a[e]);else{this.Ba("print(): pageSpec must be array of numbers");return}else if(!a)for(e=0;e<this.Hc();e++)c.push(e);var f=b?this.yh(b):this.yh(this.di());var g=this.zg(),h=document.createElement("canvas");h.width=f.width;h.height=f.height;var l=h.getContext("2d");l.translate(-f.x,-f.y);e=window.location.hostname;var k=window.open("about:blank","_blank");k.document.write("<!DOCTYPE html><html><head><title>"+e+"</title></head><body>");for(e=0;e<c.length;e++)this.Yg(c[e]),
this.da.view.td(l,f.x,f.y,f.width,f.height),this.da.view.ea.ha(l),0<e?k.document.write("<div style='page-break-before:always'>"):k.document.write("<div>"),k.document.write("<img style='width:100%' src='"),k.document.write(h.toDataURL()),k.document.write("'></div>"),l.clearRect(f.x,f.y,f.width,f.height);k.document.write("</body></html>");k.document.close();setTimeout(function(){k.focus();k.print();setTimeout(function(){k.close()},1E3)},1E3);this.Yg(g)};c.prototype.ta=function(){return this.da.fa.get("readOnly")?
(this.log("readOnly; ignore tool click."),!0):!1};c.prototype.Jd=function(){this.da.view.Jd()};c.prototype.ie=function(a){this.da.view.ha(a)};c.prototype.removeEventListener=function(a,b){if(a in this.kb){for(var c=this.kb[a],e=0;e<c.length;e++)if(c[e]===b){c.splice(e,1);break}0===c.length&&delete this.kb[a]}};c.prototype.resize=function(){if(!this.Yk){var a=this;a.Yk=setTimeout(function(){a.Yk=0;a.da.zh()},0)}};c.prototype.save=function(a,b){void 0===a&&(a="zwibbler3");var c={jpeg:"image/jpeg",jpg:"image/jpeg",
png:"image/png",bmp:"image/bmp",svg:"image/svg+xml",pdf:"application/pdf"},e=this.yh(b||this.di());switch(a){case "list":return hd.sh(this.da.view.ea,"list","object");case "png":case "jpeg":case "jpg":case "bmp":case "svg":case "pdf":return this.da.uo(c[a],e);case "zwibbler3":return hd.sh(this.da.view.ea,"zwibbler3","string");case "image/png":case "image/jpeg":case "image/bmp":var f=this.da.uo(a,e);f=f.substr(f.indexOf(",")+1);c="";e=0;var g={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,
N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,a:26,b:27,c:28,d:29,e:30,f:31,g:32,h:33,i:34,j:35,k:36,l:37,m:38,n:39,o:40,p:41,q:42,r:43,s:44,t:45,u:46,v:47,w:48,x:49,y:50,z:51,0:52,1:53,2:54,3:55,4:56,5:57,6:58,7:59,8:60,9:61,"+":62,"/":63,"=":64};for(f=f.replace(/[^A-Za-z0-9\-_=\+\/]/g,"");e<f.length;){var h=g[f.charAt(e++)];var l=g[f.charAt(e++)];var k=g[f.charAt(e++)];var m=g[f.charAt(e++)];h=h<<2|l>>4;l=(l&15)<<4|k>>2;var q=(k&3)<<6|m;c+=String.fromCharCode(h);64!==k&&(c+=String.fromCharCode(l));
64!==m&&(c+=String.fromCharCode(q))}return c;default:return"Unsupported format: "+a}};c.prototype.gt=function(a){this.da.view.canvas.style.cursor=a};c.prototype.hd=function(a,b){if(this.ta())return!1;this.da.view.hd(a,b)};c.prototype.tm=function(a){for(var b=[],c=0;c<a.length;c++){var e=this.da.view.ea.va(a[c],!1);e&&b.push(e)}return b};c.prototype.selectNodes=function(a){a=this.tm(xe(a));this.da.view.selectNodes(a);this.da.view.Mb();this.da.view.ha()};c.prototype.Pi=function(){if(this.ta())return!1;
this.da.view.Pi()};c.prototype.Qi=function(a){this.da.view.Qi(a)};c.prototype.et=function(a,b){"defaultPaperSize"===a&&this.gl(b);return this.da.fa.set(a,b)};c.prototype.Tf=function(a,b){if(this.ta())return!1;this.da.view.rs(a,b)};c.prototype.Yg=function(a){this.yb?(this.log("Set page to %s inside transaction",a),this.actions.push(new Nc(a)),this.Oj=a):this.da.view.Rb(a)};c.prototype.cl=function(a){this.da.view.cl(a)};c.prototype.ht=function(a,b){this.da.view.ea.setProperty(a,b)};c.prototype.Uf=function(a,
b){!J(a)&&null!==a||!J(b)&&null!==b?alert("setDocumentSize: width/height must be numbers"):this.da.view.Uf(a,b)};c.prototype.Do=function(a,b){!J(a)&&null!==a||!J(b)&&null!==b?alert("setDocumentSize: width/height must be numbers"):this.Kb(this.da.view.Uf(a,b,this.actions))};c.prototype.it=function(a,b){var c=this.da.view.ea.va(a);c?("DomNode"!==c.type()&&this.Ba("setDomElement: Node %s is not a DomNode. It is %s",a,c.type()),c.kt(b),this.da.Vh.push(b)):this.Ba("setDomElement: Node %s does not exist",
a)};c.prototype.up=function(){var a=this;this.log("Setting up dragdrop");this.da.canvas.addEventListener("drop",function(b){b.preventDefault();try{var c=JSON.parse(b.dataTransfer.getData("text"))}catch(g){return}if("object"===typeof c&&c["zwibbler-src"]){var e=parseFloat(c["zwibbler-width"]),f=c["zwibbler-src"];a.log("DragDrop received with src=%s size=%s",f,e);f&&O.pn(f,function(c,d){var g=1;e&&(g=e/c);var h=a.ln(b.pageX,b.pageY);h.x-=c*g/2;h.y-=d*g/2;a.Fj();var m=a.createNode("ImageNode",{url:f});
a.Mi(m,g,g);a.kh(m,h.x,h.y);a.Ih();a.So()})}})};c.prototype.hr=function(a){var b=this.da.view.ea.va(a);if(!b)return this.Ba("getDomElement: Node %s does not exist",a),null;b instanceof dc||this.Ba("getDomElement: Node %s is not a DomNode. It is %s",a,b.type());return b.nn()};c.prototype.ot=function(a,b){Yb(a)&&Yb(b)?(this.xg()===a&&this.Qi(b),this.da.view.ea.oc(!1,function(c){c.zd()===a&&c.setProperty("layer",b)})):this.Ba("setLayerName() needs string arguments.")};c.prototype.gl=function(a,b){var c=
null,e=null,f=!0,g=!1;if(2===arguments.length)if(J(arguments[0])&&J(arguments[1])){var h=arguments[0];c=arguments[1]}else Yb(arguments[0])&&"boolean"===typeof arguments[1]?(e=arguments[0],g=arguments[1]):f=!1;else if(1===arguments.length&&Yb(arguments[0]))for(var l=arguments[0].split(" "),k=0;k<l.length;k++)"landscape"===l[k]?g=!0:"portrait"===l[k]?g=!1:e=l[k];if(!1===f)return this.log("Bad arguments to setPaperSize()."),!1;if(null===e)return this.Uf(h,c),!0;switch(e.toLowerCase()){case "letter":h=
816;c=1056;break;case "legal":h=816;c=1344;break;case "11x17":h=1056;c=1632;break;case "tabloid":h=1056;c=1632;break;case "a0":h=841/25.4*96;c=1189/25.4*96;break;case "a1":h=594/25.4*96;c=841/25.4*96;break;case "a2":h=420/25.4*96;c=594/25.4*96;break;case "a3":h=297/25.4*96;c=420/25.4*96;break;case "a4":h=210/25.4*96;c=297/25.4*96;break;case "none":c=h=null;break;default:return this.log("Invalid paper size: %s",e),!1}g&&(e=h,h=c,c=e);this.Uf(h,c);return!0};c.prototype.nt=function(a,b,c){this.Pc(a,
b,c)};c.prototype.dl=function(a,b){if(this.ta())return!1;if(2!==arguments.length)throw"Error: setNodeProperties takes 2 arguments.";return this.Kb(this.da.dl(this.actions,xe(a),this.Hb(b)))};c.prototype.Pc=function(a,b,c){if(this.ta())return!1;3!==arguments.length&&this.Ba("Error: setNodeProperty takes 3 arguments.");return this.Kb(this.da.Pc(this.actions,xe(a),b,this.Hb(c)))};c.prototype.pt=function(a,b){for(var c=xe(a),e=0;e<c.length;e++){var f=this.da.view.ea.va(c[e],!0);f&&f.ke(!b)}this.da.view.ha()};
c.prototype.Go=function(a,b){if(this.ta())return!1;this.da.view.ws(a,b)};c.prototype.fl=function(a){this.da.view.fl(a)};c.prototype.setProperty=function(a,b){this.Pc(this.ad(),a,b);this.hd(a,b)};c.prototype.st=function(a){Zb(a)&&J(a.x)&&J(a.y)&&J(a.width)&&J(a.height)||this.Ba("setViewRect: arg must be an object with numeric x, y, width, height properties");0!==a.width&&0!==a.height||this.Ba("setViewRect: width and height must be non-zero.");this.da.view.$g(this.yh(a))};c.prototype.vc=function(a,
b,c){if(J(a)||"page"===a||"width"===a)if(1===arguments.length)this.da.view.vc(a);else if(3===arguments.length&&"number"===typeof a&&J(b)&&J(c)){var d=this.jn()/a,f=this.da.view.ae();f.transform(new Lb(d,d,b,c));this.da.view.$g(f)}else this.Ba("setZoom: invalid arguments.");else this.log("setZoom: invalid parameter.")};c.prototype.ah=function(a,b){void 0===b&&(b=!0);this.da.view.ah(a,b)};c.prototype.Ma=function(a,b,c){a=this.da.view.Ma(new A(a,b),c);return{x:a.x,y:a.y}};c.prototype.gh=function(a){var b=
this.da.canvas;if(a)(a=pb(a))||this.Ba("toggleFullScreen: can't find element from "+a);else for(a=b;a;){if(a instanceof HTMLElement&&(a.getAttribute("zwibbler")||"ZWIBBLER"===a.tagName)){b=a;break}a=a.parentElement}O.gh(b)};c.prototype.kh=function(a,b,c){if(this.ta())return!1;this.log("Translate node %s by %s,%s actions=%s",a,b,c,this.actions.length);return this.Kb(this.da.kh(this.actions,xe(a),b,c))};c.prototype.Ug=function(a){this.da.Ug(a)};c.prototype.Uk=function(){this.da.view.Uk()};c.prototype.Xs=
function(a){if(this.ta())return!1;var b=Math.round(a/(Math.PI/2));a=b*Math.PI/2;b=0===b%2;var c=this.pp(),e=this.di(),f=e.width/2,g=e.height/2;this.Fj();for(var h=0;h<c.length;h++)this.to(c[h],a,f,g),b||this.kh(c[h],g-f,f-g);b||this.Do(e.height,e.width);this.Ih()};c.prototype.to=function(a,b,c,e){if(this.ta())return!1;this.log("Rotate nodes by %s around (%s,%s) actions=%s",b/Math.PI*180,c,e,this.actions.length);for(var d=4===arguments.length,g=xe(a),h=new A(0,0),l=0;l<g.length;l++){var k=g[l],m=this.da.view.ea.va(k);
!m&&!this.Ph.contains(k)||!m&&!d?this.log("rotateNode: Node %s does not exist",k):!d&&m&&(k=m.rect.Uc(),h.x+=k.x,h.y+=k.y)}d?(h.x=c,h.y=e):(h.x/=g.length,h.y/=g.length);d=new Kb(b,h.x,h.y);return this.Kb(this.da.transformNode(this.actions,g,d))};c.prototype.Mi=function(a,b,c,e,f){void 0===e&&(e=0);void 0===f&&(f=0);if(this.ta())return!1;this.log("Scale node %s by %s,%s actions=%s",a,b,c,this.actions.length);return this.Kb(this.da.Mi(this.actions,xe(a),b,c,e,f))};c.prototype.el=function(a,b,c,e,f,
g,h){if(this.ta())return!1;7!==arguments.length&&this.Ba("setNodeTransform: requires 7 arguments");this.log("setNodeTransform(id=%s %s %s %s %s %s %s %s)",a,b,c,e,f,g,h);return this.Kb(this.da.el(this.actions,xe(a),b,c,e,f,g,h))};c.prototype.Jo=function(a,b,c){var d=this;if(!this.Of){var f=document.createElement("div");f.style.width="320px";f.style.lineHeight="0";var g=this;this.dn(f,20,{onColour:function(a){g.setProperty(g.Lm,a)}});this.Of=O.qh(f);this.da.La.add(function(){d.Of&&(d.Of.destroy(),
d.Of=null)})}this.Lm=a;this.Of.show(b,c,!0)};c.prototype.mq=function(){var a=ae(32);this.log("Creating shared session "+a);return this.om(a,!0)};c.prototype.om=function(a,b){this.log("Attach to shared session "+a);this.fh();this.nc=new pe(this.da.view,ae(4),b);"zwibbler"===this.da.fa.get("collaborationServer")&&(this.Yf=new qe(a,this));var c=this.nc.yg();""!==c&&this.ua("local-changes",c);return a};c.prototype.Ur=function(a){void 0===a&&(a="");var b=new Yc(!0);this.da.hf(b);this.om(a,!1)};c.prototype.fh=
function(){this.nc&&(this.nc.end(),this.nc=null);this.Yf&&(this.Yf.stop(),this.Yf=null)};c.prototype.jb=function(){if(this.ta())return!1;this.da.view.jb()};c.prototype.lh=function(a){if(this.ta())return!1;this.Kb(this.da.lh(this.actions,xe(a)))};c.prototype.upload=function(a,b){function c(){}function e(){}var f=this.da.lq(b||"Working"),g=new XMLHttpRequest,h=new FormData(a);g.upload.addEventListener("progress",function(a){f.update(a.loaded/a.total)},!1);g.addEventListener("load",function(){200===
g.status?(f.done(),e(g.response,g)):(f.error("Error"),c(g))},!1);g.addEventListener("error",function(){f.error("Error");c(g)},!1);g.addEventListener("abort",function(){f.error("Aborted");c(g)},!1);g.open(a.method,a.action);g.send(h);var l={success:function(a){e=a;return l},error:function(a){c=a;return l}};return l};c.prototype.Lt=function(a,b){void 0===b&&(b=!1);if(this.ta())return!1;this.da.view.Hp(this.Hb(a),b)};c.prototype.Mt=function(a,b){if(this.ta())return!1;2===arguments.length?this.da.view.Wj({lineWidth:b,
strokeStyle:a}):1===arguments.length?this.da.view.Wj(this.Hb(arguments[0])):this.da.view.Wj({})};c.prototype.Nt=function(a){if(this.ta())return!1;this.da.view.dj(this.Hb(a))};c.prototype.Ot=function(a){if(this.ta())return!1;this.da.view.Nm(this.Hb(a))};c.prototype.Pt=function(a){if(this.ta())return!1;Zb(a)?(a=new $d(this.da.view,a),this.da.view.fb(a)):this.Ba("useCustomTool(): requires an object as argument.")};c.prototype.Fl=function(a){if(this.ta())return!1;this.da.view.Fl(a)};c.prototype.dj=function(a){void 0===
a&&(a={});if(this.ta())return!1;this.da.view.dj(this.Hb(a))};c.prototype.Rt=function(a,b,c){void 0===c&&(c="freehand");if(this.ta())return!1;Zb(a)?(a=this.Hb(a),c=b):a={strokeStyle:a,lineWidth:b};this.da.view.Qm(a,c)};c.prototype.Zt=function(a,b){void 0===b&&(b=!0);if(this.ta())return!1;var c=a;Yb(a)?c={url:a}:"url"in c||this.Ba("useStampTool: missing url in properties");this.da.view.St(c,1===arguments.length||!0===b)};c.prototype.Tt=function(a,b){if(this.ta())return!1;if(Zb(b)){var c=b.singleLine;
var e=b.orthogonal}else c=b;this.da.view.Nn(this.Hb(a),c,e)};c.prototype.Ut=function(){this.da.view.As()};c.prototype.So=function(){this.da.view.eb()};c.prototype.Gl=function(a,b,c,e){if(this.ta())return!1;J(a)||this.Ba("usePolygonTool: parameter 1 must be a number.");J(b)||this.Ba("usePolygonTool: parameter 2 must be a number.");c&&!J(c)&&this.Ba("usePolygonTool: parameter 3 must be a number.");e&&!Zb(e)&&this.Ba("usePolygonTool: parameter 4 must be a object properties.");this.da.view.Gl(a,b,c||
1,this.Hb(e||{}))};c.prototype.Vt=function(a){void 0===a&&(a={});if(this.ta())return!1;this.da.view.Qm(this.Hb(a),"quadratic")};c.prototype.nh=function(a){void 0===a&&(a={});if(this.ta())return!1;this.da.view.nh(this.Hb(a))};c.prototype.Wt=function(a){void 0===a&&(a={});if(this.ta())return!1;this.da.view.nh(Fb({roundRadius:this.da.fa.get("defaultRoundRectRadius")},a))};c.prototype.Xt=function(a,b){if(this.ta())return!1;var c={};Zb(a)?c=this.Hb(a):Yb(a)&&(c.stokeStyle=a);J(b)&&(c.lineWidth=b);this.da.view.wq(c)};
c.prototype.Hl=function(a,b,c,e,f,g){void 0===f&&(f="rectangle-tl");void 0===g&&(g=null);if(this.ta())return!1;this.da.view.Hl(a,this.Hb(b),c,e,f,g)};c.prototype.Yt=function(a){if(this.ta())return!1;this.da.view.nh(this.Hb(a))};c.prototype.$t=function(a){if(this.ta())return!1;this.da.view.tl(this.Hb(a))};c.prototype.gj=function(){this.da.view.gj()};c.prototype.hj=function(){this.da.view.hj()};return c}();W.prototype.log=W.prototype.log;W.prototype.addRemoteChanges=W.prototype.xf;
W.prototype.attach=W.prototype.lc;W.prototype.abortTransaction=W.prototype.yp;W.prototype.addSelectionHandle=W.prototype.xc;W.prototype.addToLanguage=W.prototype.Bj;W.prototype.addPage=W.prototype.Dp;W.prototype.addPanel=W.prototype.hg;W.prototype.beginTransaction=W.prototype.Fj;W.prototype.bringToFront=W.prototype.Fh;W.prototype.canRedo=W.prototype.pd;W.prototype.canUndo=W.prototype.qd;W.prototype.clearSelection=W.prototype.pb;W.prototype.clearUndo=W.prototype.Yp;W.prototype.clickColour=W.prototype.Zp;
W.prototype.commitIrreversibleTransaction=W.prototype.aq;W.prototype.commitTransaction=W.prototype.Ih;W.prototype.copy=W.prototype.Ce;W.prototype.createGroup=W.prototype.ng;W.prototype.createNode=W.prototype.createNode;W.prototype.createPath=W.prototype.Nh;W.prototype.createToolbar=W.prototype.nq;W.prototype.createShape=W.prototype.Mj;W.prototype.cut=W.prototype.Qj;W.prototype.destroy=W.prototype.qg;W.prototype.deleteNode=W.prototype.yc;W.prototype.deleteNodes=W.prototype.Om;
W.prototype.deletePage=W.prototype.pq;W.prototype.deleteSelection=W.prototype.Pm;W.prototype.dirty=W.prototype.Vd;W.prototype.download=W.prototype.download;W.prototype.draw=W.prototype.ha;W.prototype.editNodeText=W.prototype.zq;W.prototype.duplicate=W.prototype.duplicate;W.prototype.emit=W.prototype.ua;W.prototype.emitNow=W.prototype.$d;W.prototype.emitOnce=W.prototype.$h;W.prototype.skipEvent=W.prototype.yt;W.prototype.focus=W.prototype.focus;W.prototype.findNode=W.prototype.Mq;
W.prototype.findNodes=W.prototype.Zm;W.prototype.flip=W.prototype.Pq;W.prototype.flipNodes=W.prototype.wg;W.prototype.generatePalette=W.prototype.dn;W.prototype.getActiveLayer=W.prototype.xg;W.prototype.getAllNodes=W.prototype.Xq;W.prototype.getBackgroundImage=W.prototype.$q;W.prototype.getBoundingRectangle=W.prototype.gk;W.prototype.getConfig=W.prototype.hk;W.prototype.getContext=W.prototype.getContext;W.prototype.getCurrentPage=W.prototype.zg;W.prototype.getCurrentFillColour=W.prototype.cr;
W.prototype.getCurrentOutlineColour=W.prototype.dr;W.prototype.getCurrentTool=W.prototype.Ag;W.prototype.getCustomNode=W.prototype.er;W.prototype.getDocumentCoordinates=W.prototype.ln;W.prototype.getDocumentProperty=W.prototype.gr;W.prototype.getDocumentSize=W.prototype.di;W.prototype.getFillColour=W.prototype.gi;W.prototype.getImageUrl=W.prototype.lk;W.prototype.getLanguageString=W.prototype.rr;W.prototype.getDrawingRectangle=W.prototype.ir;W.prototype.getItemProperty=W.prototype.pr;
W.prototype.getLayers=W.prototype.tr;W.prototype.getLayerNodes=W.prototype.sr;W.prototype.getNodeCoordinates=W.prototype.ur;W.prototype.getNodePageNumber=W.prototype.$c;W.prototype.getNodeProperty=W.prototype.hi;W.prototype.getNodeRectangle=W.prototype.vr;W.prototype.getNodeScale=W.prototype.wr;W.prototype.getNodeType=W.prototype.xr;W.prototype.getNodeUnderPoint=W.prototype.yr;W.prototype.getPageCount=W.prototype.Hc;W.prototype.getPageNode=W.prototype.rn;W.prototype.getPageRect=W.prototype.sn;
W.prototype.getPathData=W.prototype.ii;W.prototype.getPathAsPoints=W.prototype.Cr;W.prototype.getCanvasScale=W.prototype.jn;W.prototype.getEditNode=W.prototype.jk;W.prototype.getScreenCoordinates=W.prototype.Dr;W.prototype.getSelectedEditHandle=W.prototype.Fr;W.prototype.getStrokeColour=W.prototype.ji;W.prototype.getEditHandleType=W.prototype.fi;W.prototype.setEditHandle=W.prototype.jt;W.prototype.getSelectedNodes=W.prototype.ad;W.prototype.getPropertySummary=W.prototype.Dg;
W.prototype.getViewRectangle=W.prototype.Ir;W.prototype.insertImage=W.prototype.Or;W.prototype.insertPage=W.prototype.vi;W.prototype.isLayerVisible=W.prototype.Ak;W.prototype.load=W.prototype.load;W.prototype.lockUpdates=W.prototype.yi;W.prototype.markChangesSent=W.prototype.Hf;W.prototype.moveDown=W.prototype.zi;W.prototype.movePage=W.prototype.fs;W.prototype.moveUp=W.prototype.Ai;W.prototype.newDocument=W.prototype.Gk;W.prototype.nextPage=W.prototype.nextPage;W.prototype.on=W.prototype.Ja;
W.prototype.onComplete=W.prototype.ss;W.prototype.openFromComputer=W.prototype.xs;W.prototype.paste=W.prototype.Rg;W.prototype.previousPage=W.prototype.Gs;W.prototype.print=W.prototype.print;W.prototype.redo=W.prototype.Jd;W.prototype.redraw=W.prototype.ie;W.prototype.removeEventListener=W.prototype.removeEventListener;W.prototype.resize=W.prototype.resize;W.prototype.save=W.prototype.save;W.prototype.setCursor=W.prototype.gt;W.prototype.setToolProperty=W.prototype.hd;W.prototype.selectNodes=W.prototype.selectNodes;
W.prototype.sendToBack=W.prototype.Pi;W.prototype.setActiveLayer=W.prototype.Qi;W.prototype.setConfig=W.prototype.et;W.prototype.setColour=W.prototype.Tf;W.prototype.setCurrentPage=W.prototype.Yg;W.prototype.setCustomBackgroundFn=W.prototype.cl;W.prototype.setDocumentProperty=W.prototype.ht;W.prototype.setDocumentSize=W.prototype.Uf;W.prototype.setDocumentSizeInTransaction=W.prototype.Do;W.prototype.setDomElement=W.prototype.it;W.prototype.getDomElement=W.prototype.hr;W.prototype.setLayerName=W.prototype.ot;
W.prototype.setPaperSize=W.prototype.gl;W.prototype.setItemProperty=W.prototype.nt;W.prototype.setNodeProperties=W.prototype.dl;W.prototype.setNodeProperty=W.prototype.Pc;W.prototype.setNodeVisibility=W.prototype.pt;W.prototype.setOpacity=W.prototype.Go;W.prototype.setPageView=W.prototype.fl;W.prototype.setProperty=W.prototype.setProperty;W.prototype.setViewRectangle=W.prototype.st;W.prototype.setZoom=W.prototype.vc;W.prototype.showLayer=W.prototype.ah;W.prototype.snap=W.prototype.Ma;
W.prototype.toggleFullscreen=W.prototype.gh;W.prototype.translateNode=W.prototype.kh;W.prototype.removePanel=W.prototype.Ug;W.prototype.removeSelectionHandles=W.prototype.Uk;W.prototype.rotateDocument=W.prototype.Xs;W.prototype.rotateNode=W.prototype.to;W.prototype.scaleNode=W.prototype.Mi;W.prototype.setNodeTransform=W.prototype.el;W.prototype.showColourPicker=W.prototype.Jo;W.prototype.createSharedSession=W.prototype.mq;W.prototype.joinSharedSession=W.prototype.Ur;W.prototype.stopSharing=W.prototype.fh;
W.prototype.undo=W.prototype.jb;W.prototype.ungroup=W.prototype.lh;W.prototype.upload=W.prototype.upload;W.prototype.useArrowTool=W.prototype.Lt;W.prototype.useBrushTool=W.prototype.Mt;W.prototype.useCircleTool=W.prototype.Nt;W.prototype.useCurveTool=W.prototype.Ot;W.prototype.useCustomTool=W.prototype.Pt;W.prototype.useEditHandleTool=W.prototype.Fl;W.prototype.useEllipseTool=W.prototype.dj;W.prototype.useFreehandTool=W.prototype.Rt;W.prototype.useStampTool=W.prototype.Zt;
W.prototype.useLineTool=W.prototype.Tt;W.prototype.usePanTool=W.prototype.Ut;W.prototype.usePickTool=W.prototype.So;W.prototype.usePolygonTool=W.prototype.Gl;W.prototype.useQuadraticBezierTool=W.prototype.Vt;W.prototype.useRectangleTool=W.prototype.nh;W.prototype.useRoundRectTool=W.prototype.Wt;W.prototype.useShapeBrushTool=W.prototype.Xt;W.prototype.useShapeTool=W.prototype.Hl;W.prototype.useSquareTool=W.prototype.Yt;W.prototype.useTextTool=W.prototype.$t;W.prototype.zoomIn=W.prototype.gj;
W.prototype.zoomOut=W.prototype.hj;function X(c){var a;void 0===a&&(a="Assertion failed.");if(!c)throw Error(a);}
var Ce=function(){function c(a){var b=this;this.Cc=0;this.log=w.create("BinaryReader");if("string"===typeof a)this.length=a.length,this.getUint8=function(){X(b.Cc<a.length);return a.charCodeAt(b.Cc++)&255};else{var c=new Uint8Array(a);this.length=c.length;this.getUint8=function(){X(b.Cc<c.length);return c[b.Cc++]}}}c.prototype.seek=function(a){X(0<=a&&a<=this.length);var b=this.Cc;this.Cc=a;return b};c.prototype.getUint16=function(){return(this.getUint8()<<8|this.getUint8())>>>0};c.prototype.getUint32=
function(){return this.getInt32()>>>0};c.prototype.getInt16=function(){var a=this.getUint16();a&32768&&(a-=65536);return a};c.prototype.getInt32=function(){return this.getUint8()<<24|this.getUint8()<<16|this.getUint8()<<8|this.getUint8()};c.prototype.Ib=function(){return this.getInt16()};c.prototype.Gr=function(){this.getUint16()};c.prototype.Je=function(){return this.getInt16()/16384};c.prototype.kk=function(){return this.getInt32()/65536};c.prototype.un=function(a){for(var b="",c=0;c<a;c++)b+=String.fromCharCode(this.getUint8());
return b};c.prototype.Hr=function(a){for(var b="",c=0;c<a;c+=2)b+=String.fromCharCode(this.getUint16());return b};c.prototype.getDate=function(){var a=1E3*(4294967296*this.getUint32()+this.getUint32())+Date.UTC(1904,1,1);return new Date(a)};return c}(),De=function(){function c(a){this.format=0;this.Bm=[];this.log=w.create("CMAP0");for(var b=0;256>b;b++){var c=a.getUint8();this.log("   Glyph[%s] = %s",b,c);this.Bm.push(c)}}c.prototype.map=function(a){return 0<=a&&255>=a?this.Bm[a]:0};return c}(),Ee=
function(){function c(a){this.file=a;this.format=4;this.cache={};this.log=w.create("CMAP4");var b,c=[],e=a.getUint16()/2;a.getUint16();a.getUint16();a.getUint16();for(b=0;b<e;b++)c.push({ti:0,Yi:0,Um:a.getUint16(),Dn:0});a.getUint16();for(b=0;b<e;b++)c[b].Yi=a.getUint16();for(b=0;b<e;b++)c[b].Dn=a.getUint16();for(b=0;b<e;b++){var f=a.getUint16();c[b].ti=f?a.Cc-2+f:0}this.qa=c}c.prototype.map=function(a){if(!(a in this.cache)){for(var b=0;b<this.qa.length;b++){var c=this.qa[b];if(c.Yi<=a&&c.Um>=a){if(c.ti){var e=
c.ti+2*(a-c.Yi);this.file.seek(e);var f=this.file.getUint16()}else f=c.Dn+a&65535;this.log("Charcode %s is between %s and %s; maps to %s (%s) roffset=%s",a,c.Yi,c.Um,e,f,c.ti);this.cache[a]=f;break}}b===this.qa.length&&(this.cache[a]=0)}return this.cache[a]};return c}(),Fe=function(){function c(a,b,c){this.file=a;this.map={};this.Qe=-1;this.log=w.create("KERN0");this.Et=b&&!c||!b&&c;this.file=a;this.offset=a.Cc;this.js=a.getUint16();a.getUint16();a.getUint16();a.getUint16();for(b=0;b<this.js;b++){c=
a.getUint16();var d=a.getUint16(),f=a.Ib();this.map[c<<16|d]=f}this.reset()}c.prototype.reset=function(){this.Qe=-1};c.prototype.get=function(a){var b=0;if(0<=this.Qe){var c=this.Qe<<16|a;c in this.map&&(b=this.map[c])}this.Qe=a;return this.Et?{x:0,y:b}:{x:b,y:0}};return c}(),Ge=function(){function c(a){this.Jj=[];this.Hg=[];this.El=this.flags=this.Qn=this.version=0;this.Ud=new Date;this.Fn=this.Nl=this.Ll=this.Ol=this.Ml=0;this.fontFamily=this.Ie="";this.Mg=0;this.log=w.create("TrueType");this.file=
new Ce(a);this.hb=this.Os(this.file);this.Ks(this.file);this.Ns(this.file);this.Is(this.file);this.Ls(this.file);this.Ms(this.file);this.length=this.Jr()}c.prototype.Os=function(a){var b={};a.getUint32();var c=a.getUint16();a.getUint16();a.getUint16();a.getUint16();for(var e=0;e<c;e++){var f=a.un(4);b[f]={Xp:a.getUint32(),offset:a.getUint32(),length:a.getUint32()};"head"!==f&&this.log("Table %s has checksum 0x%s",f,b[f].Xp.toString(16))}return b};c.prototype.Ks=function(a){X("head"in this.hb);a.seek(this.hb.head.offset);
this.version=a.kk();a.kk();a.getUint32();this.Qn=a.getUint32();X(1594834165===this.Qn);this.flags=a.getUint16();this.El=a.getUint16();this.Ud=a.getDate();a.getDate();this.Ml=a.Ib();this.Ol=a.Ib();this.Ll=a.Ib();this.Nl=a.Ib();a.getUint16();a.getUint16();a.getInt16();this.Fn=a.getInt16();a.getInt16()};c.prototype.Is=function(a){X("cmap"in this.hb);var b=this.hb.cmap.offset;a.seek(b);a.getUint16();for(var c=a.getUint16(),e=0;e<c;e++){var f=a.getUint16(),g=a.getUint16(),h=a.getUint32();this.log("CMap platformid=%s specificid=%s offset=%s",
f,g,h);3===f&&1>=g&&this.Hs(a,b+h)}};c.prototype.Hs=function(a,b){var c=a.seek(b),e=a.getUint16(),f=a.getUint16();a.getUint16();var g;this.log("    Cmap format %s length %s",e,f);0===e?g=new De(a,f):4===e&&(g=new Ee(a,f));g&&this.Jj.push(g);a.seek(c)};c.prototype.Ms=function(a){if("kern"in this.hb){a.seek(this.hb.kern.offset);var b=a.getUint16(),c=a.getUint16();this.log("Kern Table version: %s",b);this.log("Kern nTables: %s",c);for(var e=0;e<c;e++){b=a.getUint16();var f=a.getUint16(),g=a.getUint16(),
h=g>>8,l=g&4,k=0===(g&1);this.log("Kerning subtable version %s format %s length %s coverage: %s",b,h,f,g);b=null;0===h?b=new Fe(a,k,0!=l):(this.log("Unknown format -- skip"),a.seek(a.Cc+f));b&&this.Hg.push(b)}}};c.prototype.Ns=function(a){X("name"in this.hb);var b=this.hb.name.offset;a.seek(b);a.getUint16();for(var c=a.getUint16(),e=a.getUint16(),f=0;f<c;f++){var g=a.getUint16(),h=a.getUint16(),l=a.getUint16(),k=a.getUint16(),m=a.getUint16(),q=a.getUint16();q=a.seek(b+e+q);m=0===g||3===g?a.Hr(m):
a.un(m);this.log("Name %s/%s id %s language %s: %s",g,h,k,l,m);a.seek(q);switch(k){case 1:this.fontFamily=m;break;case 4:this.Ie=m}}};c.prototype.Ls=function(a){X("hhea"in this.hb);a.seek(this.hb.hhea.offset);a.kk();a.Ib();a.Ib();a.Ib();a.Gr();a.Ib();a.Ib();a.Ib();a.getInt16();a.getInt16();a.Ib();a.getInt16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();this.Mg=a.getUint16()};c.prototype.nr=function(a){X("hmtx"in this.hb);var b=this.file;b.seek(this.hb.hmtx.offset+4);var c=this.hb.hmtx.offset;
if(a<this.Mg){var e=this.file.seek(c+4*a);var f=b.getUint16();a=b.getInt16()}else e=b.seek(c+4*(this.Mg-1)),f=b.getUint16(),b.seek(c+4*this.Mg+2*(a-this.Mg)),a=b.Ib();this.file.seek(e);return{zm:f,Wr:a}};c.prototype.Jr=function(){X("maxp"in this.hb);var a=this.file.seek(this.hb.maxp.offset+4),b=this.file.getUint16();this.file.seek(a);return b};c.prototype.lr=function(a){X("loca"in this.hb);var b=this.hb.loca,c=this.file;if(1===this.Fn){b=c.seek(b.offset+4*a);a=c.getUint32();var e=c.getUint32()}else b=
c.seek(b.offset+2*a),a=2*c.getUint16(),e=2*c.getUint16();c.seek(b);return a===e?0:a+this.hb.glyf.offset};c.prototype.po=function(a){var b=this.lr(a);a=this.file;if(0===b||b>=this.hb.glyf.offset+this.hb.glyf.length)return null;X(b>=this.hb.glyf.offset);X(b<this.hb.glyf.offset+this.hb.glyf.length);a.seek(b);b={sd:[],Og:a.getInt16(),la:[],Ml:a.Ib(),Ol:a.Ib(),Ll:a.Ib(),Nl:a.Ib()};X(-1<=b.Og);-1===b.Og?this.Js(a,b):this.Ps(a,b);return b};c.prototype.Ps=function(a,b){function c(b,c,d){for(var f=0,l=0;l<
g;l++){var k=h[l];k&c?f=k&d?f+a.getUint8():f-a.getUint8():~k&d&&(f+=a.getInt16());e[l][b]=f}}b.sd=[];for(var e=b.la=[],f=0;f<b.Og;f++)b.sd.push(a.getUint16());a.seek(a.getUint16()+a.Cc);if(0!==b.Og){var g=Math.max.apply(null,b.sd)+1,h=[];for(f=0;f<g;f++){var l=a.getUint8();h.push(l);e.push({x:0,y:0,Mf:0<(l&1)});if(l&8){var k=a.getUint8();X(0<k);for(f+=k;k--;)h.push(l),e.push({x:0,y:0,Mf:0<(l&1)})}}c("x",2,16,b.Ml,b.Ll);c("y",4,32,b.Ol,b.Nl)}};c.prototype.Js=function(a,b){var c,e,f=32;b.sd=[];for(b.la=
[];f&32;){f=a.getUint16();var g=a.getUint16();var h=1;var l=c=0;var k=1;var m=e=0;if(f&1){var q=a.getInt16();var p=a.getInt16()}else q=a.getUint8(),p=a.getUint8();f&2&&(e=q,m=p);f&8?k=h=a.Je():f&64?(h=a.Je(),k=a.Je()):f&128&&(h=a.Je(),c=a.Je(),l=a.Je(),k=a.Je());this.log("Read component glyph index %s",g);this.log("Transform: [%s %s %s %s %s %s]",h,c,l,k,e,m);q=a.Cc;if(g=this.po(g)){var t=b.la.length;for(p=0;p<g.sd.length;p++)b.sd.push(g.sd[p]+t);for(p=0;p<g.la.length;p++){t=g.la[p].x;var r=g.la[p].y;
t=h*t+c*r+e;r=l*t+k*r+m;b.la.push({x:t,y:r,Mf:g.la[p].Mf})}}a.seek(q)}b.Og=b.sd.length;f&256&&a.seek(a.getUint16()+a.Cc)};c.prototype.sq=function(a,b,c,e){b=this.po(b);if(null!==b)for(var d=0,g=0,h=0,l=0,k;g<b.la.length;g++){var m=b.la[g];0===d?(a.moveTo(m.x+c,m.y+e),d=1):1===d?m.Mf?a.lineTo(m.x+c,m.y+e):d=2:(k=b.la[g-1],m.Mf?(a.quadraticCurveTo(k.x+c,k.y+e,m.x+c,m.y+e),d=1):a.quadraticCurveTo(k.x+c,k.y+e,(k.x+m.x)/2+c,(k.y+m.y)/2+e));g===b.sd[h]&&(2===d&&(k=m,m=b.la[l],m.Mf?a.quadraticCurveTo(k.x+
c,k.y+e,m.x+c,m.y+e):a.quadraticCurveTo(k.x+c,k.y+e,(k.x+m.x)/2+c,(k.y+m.y)/2+e)),l=g+1,h+=1,d=0)}};c.prototype.transform=function(a,b){a.scale(b/this.El,-b/this.El)};c.prototype.yq=function(a,b,c,e,f){a.save();a.translate(c,e);this.transform(a,f);e=c=0;this.Vs();for(f=0;f<b.length;f++){var d=this.es(b.charCodeAt(f)),h=this.nr(d),l=this.ls(d);this.log("Metrics for %s code %s index %s: %s %s kern: %s,%s",b.charAt(f),b.charCodeAt(f),d,h.zm,h.Wr,l.x,l.y);this.sq(a,d,c+l.x,e+l.y);c+=h.zm}a.restore()};
c.prototype.es=function(a){for(var b=0,c=0;c<this.Jj.length&&!(b=this.Jj[c].map(a));c++);return b};c.prototype.Vs=function(){for(var a=0;a<this.Hg.length;a++)this.Hg[a].reset()};c.prototype.ls=function(a){for(var b,c=0,e=0,f=0;f<this.Hg.length;f++)b=this.Hg[f].get(a),c+=b.x,e+=b.y;return{x:c,y:e}};return c}(),He=function(c){function a(){var a=c.call(this)||this;a.fonts={};a.Ng=0;a.Vj=[];a.log=w.create("FontCollection");return a}n(a,c);a.prototype.add=function(a,c){this.Ng+=1;var b=this;return kb({url:a,
mimeType:"text/plain; charset=x-user-defined"}).then(function(d){b.qp(a,c,d.responseText)},function(c){b.Ba(a,c.message)})};a.prototype.Rq=function(a){for(var b in this.fonts){var c=this.fonts[b];if(c.url===a)return c.font}return null};a.prototype.Ba=function(a,c){this.log("Error when fetching "+a+": "+c);--this.Ng;this.hm()};a.prototype.qp=function(a,c,e){this.log("Got font %s; result is %s bytes",a,e.length);for(var b="",d=0;d<e.length;d++)b+=String.fromCharCode(e.charCodeAt(d)&255);e=new Ge(b);
this.log("Loaded '%s'",e.Ie);for(d=0;d<e.Ie.length;d++)this.log("   %s, %s",e.Ie.charAt(d),e.Ie.charCodeAt(d));c=c||e.fontFamily;this.fonts[c]={name:e.Ie,url:a,data:b,font:e};--this.Ng;this.hm()};a.prototype.hm=function(){if(0===this.Ng){this.ua("done");for(var a=0;a<this.Vj.length;a++)this.Vj[a]();this.Vj.length=0}};a.prototype.get=function(a){this.log("Lookup font %s",a);for(var b=0;b<a.length;b++)this.log("   %s, %s",a.charAt(b),a.charCodeAt(b));if(a in this.fonts)return this.fonts[a].font;this.log("Lookup font %s; not found",
a);for(var c in this.fonts)this.log("Searched: '%s'",c)};return a}(Pc);"undefined"!==typeof jQuery&&(jQuery.fn.zwibbler=function(c){void 0===c&&(c={});var a=null;this.each(function(b,d){d.zwibbler&&jQuery(d).empty();a=new W(d,c);d.zwibbler=a});return a},jQuery.fn.zwibblerContext=function(){return this[0].zwibbler});
var Ie=function(){function c(a,b,c,e){this.scope=a;this.element=b;this.name=c;this.value=e}c.prototype.emit=function(a,b){V.ua(this.element,a,b)};c.prototype.listen=function(a,b){V.Jc(this.element,a,b)};c.prototype.watch=function(a,b){V.watch(this.scope,this.element,a,b)};c.prototype.destructor=function(a){V.La(this.element,a)};return c}(),Y=function(){function c(){this.xk=[];this.buttons=[];this.Pj={};this.fonts=new He;this.log=w.create("ZWIBBLER");this.WebSocket=WebSocket;this.controllers={};this.ap=
W}c.prototype.create=function(a,b){"string"===typeof a&&0<a.length&&"."!==a.charAt(0)&&"#"!==a.charAt(0)&&(a="#"+a);var c=pb(a);return c?new W(c,b):(alert("Zwibbler.create: Cannot find an element with id "+a),null)};c.prototype.zp=function(a){for(var b=["name","image","onclick"],c=0;c<b.length;c++)if(!(b[c]in a))return alert("Zwibbler.addButton: missing "+b[c]),!1;this.buttons.push(a);return!0};c.prototype.Ap=function(a,b){this.Pj[a]=b};c.prototype.hp=function(a,b){void 0===b&&(b={});return this.qh(a,
b)};c.prototype.qh=function(a,b){function c(){var a=f.offsetWidth,b=f.offsetHeight,c=Bb();z(f).Ui({left:c.x+c.width/2-a/2,top:c.y+c.height/2-b/2})}function e(){m&&q.hide()}void 0===b&&(b={});var f=pb(a);if(!f)throw Error("Zwibbler.Dialog: Bad element passed in: "+a);var g=null===f.parentNode;g&&document.body.appendChild(f);"static"===z(f).Me("position")&&(f.style.position="absolute");f.style.display="none";var h=new Gb("transparent");h.insertBefore=f;var l=b.showNear,k=b.showHow,m=!1,q={hide:function(){h.be();
f.style.display="none";if(q.onhide)q.onhide();window.removeEventListener("resize",c)},show:function(a,b,d,e){void 0===d&&(d=!1);void 0===e&&(e=!0);var g=0,p=0,t="",r="";if("number"===typeof a&&"number"===typeof b){g=a;p=b;var v=!0}else t=a||l,r=b||k,v=!1;a=wb()+1;f.style.zIndex=a.toString();h.zIndex=a;f.style.display="block";a=f.offsetWidth;b=f.offsetHeight;if(v)r=Bb(),g={left:g,top:p},g.left=Math.min(g.left,r.x+r.width-a-2),g.top=Math.min(g.top,r.y+r.height-b-3),z(f).Ui(g);else if(t&&r){if(p=pb(t))g=
f,t=r,r=z(p).dc(),t=t.toLowerCase().split(" "),2!==t.length&&(t=["tl","tl"]),0<=t[0].indexOf("b")&&(r.top+=p.offsetHeight),0<=t[0].indexOf("r")&&(r.left+=p.offsetWidth),0<=t[1].indexOf("b")&&(r.top-=g.offsetHeight),0<=t[1].indexOf("r")&&(r.left-=g.offsetWidth),g.style.position="absolute",p=Bb(),t=g.clientHeight,r.left=Math.min(r.left,p.x+p.width-g.clientWidth),r.top=Math.min(r.top,p.y+p.height-t),z(g).Ui(r)}else window.addEventListener("resize",c),c();e&&h.show(q.hide);if(q.onshow)q.onshow();m=d},
destroy:function(){window.removeEventListener("resize",c);f.removeEventListener("click",e);f.removeEventListener("pointerup",e);f.removeEventListener("touchend",e);g&&z(f).remove()},onshow:b.onshow,onhide:b.onhide};f.addEventListener("click",e);return q};c.prototype.kq=function(a,b){return this.df(a,b)};c.prototype.Cb=function(a,b){V.Cb(a,function(a,c,f,g){b(new Ie(a,c,f,g))})};c.prototype.df=function(a,b,c){function d(){var a=r.bd(),b=1,d=0,e=0;l&&(a.y=l);q&&(a.height=q-a.y);k&&(a.x=k);m&&(a.width=
m-a.x);g&&h?b=Math.min(g/a.width,h/a.height):g?(b=g/a.width,h=a.height*b):h?(b=h/a.height,g=a.width*b):(g=a.width,h=a.height);a.width*b<g&&(d=g/2-a.width*b/2);a.height*b<h&&(e=h/2-a.height*b/2);d-=a.x*b;e-=a.y*b;p.width=Math.ceil(g);p.height=Math.ceil(h);t.translate(d,e);t.scale(b,b);r.ha(t);f.log("Drawn.");c(p)}var f=this;void 0===b&&(b={});void 0===c&&(c=function(){});var g=b.width||0,h=b.height||0,l=b.top||0,k=b.left||0,m=b.right||0,q=b.bottom||0,p=qb(null),t=p.getContext("2d"),r=hd.rh(a);if(!r)throw Error("Zwibbler.render: Could not open document");
var v=new Ld;r.format(t,v);v.Ja("reformat",function(a){r.Lg(a)});v.zf?v.Ja("done",function(){r.format(t,v);d()}):d();return p};c.prototype.save=function(a,b){return new ib(function(c,e){var d=hd.rh(a);if(d){d.zn("background")||d.setProperty("background","white");var g=qb(null).getContext("2d"),h=new Ld;h.Ja("reformat",function(a){d.Lg(a)});h.Ja("done",function(){try{d.format(g,h);var a=hd.sh(d,b,"string");c(a)}catch(k){e(k)}});d.format(g,h)}else e(Error("Failed to open document"))})};c.prototype.Es=
function(a){a=u.vd(a);return{r:a.values[0],g:a.values[1],b:a.values[2],a:a.values[3]}};c.prototype.bs=function(a){return(new u(u.RGBA,[a.r,a.g,a.b,a.a])).toString()};c.prototype.Wq=function(a){var b=document.createElement("a");b.href=a;return b.href};c.prototype.Mp=function(a){return qa(a)};c.prototype.Bp=function(a,b){var c=this;this.fonts.add(a,b).then(function(){if(!b){var d=c.fonts.Rq(a);d&&(b=d.Ie)}b&&c.Dd('\n@font-face {\n    font-family: "'+b+'";\n    src: url("'+a+'");\n}')},function(){})};
c.prototype.gp=function(a){return new R(a)};c.prototype.$o=function(a){var b=new R,c;void 0===c&&(c=null);a=a.match(/[A-Z]|[-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?/gi);var e=0,f=0,g,h=0,l=0,k=[];if(a)for(g=0;g<a.length;g++){var m=a[g++];var q=a;for(k.length=0;g<q.length;g++){var p=parseFloat(q[g]);if(isNaN(p)){g--;break}else k.push(p)}if("M"===m){b.moveTo(k[0],k[1]);for(m=2;m<k.length;m+=2)b.lineTo(k[m],k[m+1]);e=k[k.length-2];f=k[k.length-1]}else if("m"===m)for(b.moveTo(k[0]+e,k[1]+f),e=k[0]+e,f=k[1]+
f,m=2;m<k.length;m+=2)b.lineTo(k[m]+e,k[m+1]+f),e=k[m]+e,f=k[m+1]+f;else if("L"===m){for(m=0;m<k.length;m+=2)b.lineTo(k[m],k[m+1]);e=k[k.length-2];f=k[k.length-1]}else if("l"===m)for(m=0;m<k.length;m+=2)b.lineTo(k[m]+e,k[m+1]+f),e=k[m]+e,f=k[m+1]+f;else if("H"===m)for(m=0;m<k.length;m+=1)b.lineTo(k[m],f),e=k[m];else if("h"===m)for(m=0;m<k.length;m+=1)b.lineTo(k[m]+e,f),e=k[m]+e;else if("V"===m)for(m=0;m<k.length;m+=1)b.lineTo(e,k[m]),f=k[m];else if("v"===m)for(m=0;m<k.length;m+=1)b.lineTo(e,k[m]+
f),f=k[m]+f;else if("Q"===m)for(m=0;m<k.length;m+=4)b.quadraticCurveTo(k[m],k[m+1],k[m+2],k[m+3]),h=k[m],l=k[m+1],e=k[m+2],f=k[m+3];else if("C"===m)for(m=0;m<k.length;m+=6)b.bezierCurveTo(k[m],k[m+1],k[m+2],k[m+3],k[m+4],k[m+5]),h=k[m+2],l=k[m+3],e=k[m+4],f=k[m+5];else if("c"===m)for(m=0;m<k.length;m+=6)b.bezierCurveTo(k[m]+e,k[m+1]+f,k[m+2]+e,k[m+3]+f,k[m+4]+e,k[m+5]+f),h=k[m+2]+e,l=k[m+3]+f,e=k[m+4]+e,f=k[m+5]+f;else if("S"===m)for(m=0;m<k.length;m+=4)h=e+e-h,l=f+f-l,b.bezierCurveTo(h,l,k[m],k[m+
1],k[m+2],k[m+3]),h=k[m],l=k[m+1],e=k[m+2],f=k[m+3];else if("s"===m)for(m=0;m<k.length;m+=4)h=e+e-h,l=f+f-l,b.bezierCurveTo(h,l,k[m]+e,k[m+1]+f,k[m+2]+e,k[m+3]+f),h=k[m]+e,l=k[m+1]+f,e=k[m+2]+e,f=k[m+3]+f;else"z"===m||"Z"===m?b.closePath():c?c(m,k):Hb("Unknown command: %s",m)}return b.Sb()};c.prototype.pn=function(a,b){var c=document.createElement("img");c.src=a;c.onload=function(){b(c.naturalWidth,c.naturalHeight,c)}};c.prototype.dt=function(a,b){return zb(a,b)};c.prototype.It=function(a){return this.gh(a)};
c.prototype.gh=function(a){var b=pb(a);if(!b)throw Error("Zwibbler.toggleFullScreen: "+a+" not found");a=document;this.Hn()?document.exitFullscreen?document.exitFullscreen():a.msExitFullscreen?a.msExitFullscreen():a.gs?a.gs():a.webkitExitFullscreen&&a.webkitExitFullscreen():b.requestFullscreen?b.requestFullscreen():b.msRequestFullscreen?b.msRequestFullscreen():b.wu?b.mozRequestFullScreen():b.webkitRequestFullscreen&&b.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)};c.prototype.Hn=function(){var a=
document;return a.fullscreenElement||a.mozFullScreenElement||a.webkitFullscreenElement||a.msFullscreenElement?!0:!1};c.prototype.Bq=function(){w.Aq()};c.prototype.yn=function(a){return Uc.cp(a)};c.prototype.Dd=function(a){nb(a)};c.prototype.controller=function(a,b){this.controllers[a]=b};c.prototype.Jh=function(a,b){V.Jh(a,b)};c.prototype.lc=function(a){var b=pb(a);if(!b)throw Error("Zwibbler.attach: Cannot find element from "+a);return Je(b,!0)};return c}();
document.addEventListener("dragstart",function(c){var a=c.target;"IMG"===a.tagName&&(a={"zwibbler-src":a.getAttribute("zwibbler-src"),"zwibbler-width":a.getAttribute("zwibbler-width")},a["zwibbler-src"]&&c.dataTransfer.setData("text",JSON.stringify(a)))});var O=new Y;O.instances=O.xk;Y.prototype.addButton=Y.prototype.zp;Y.prototype.addCustomNode=Y.prototype.Ap;Y.prototype.Popup=Y.prototype.hp;Y.prototype.Dialog=Y.prototype.qh;Y.prototype.createPreview=Y.prototype.kq;Y.prototype.directive=Y.prototype.Cb;
Y.prototype.render=Y.prototype.df;Y.prototype.save=Y.prototype.save;Y.prototype.parseColour=Y.prototype.Es;Y.prototype.makeColour=Y.prototype.bs;Y.prototype.getAbsoluteUrl=Y.prototype.Wq;Y.prototype.base64Encode=Y.prototype.Mp;Y.prototype.addFont=Y.prototype.Bp;Y.prototype.PathCommands=Y.prototype.gp;Y.prototype.CommandsFromSvgPath=Y.prototype.$o;Y.prototype.getImageSize=Y.prototype.pn;Y.prototype.setColourOpacity=Y.prototype.dt;Y.prototype.toggleFullScreen=Y.prototype.It;
Y.prototype.toggleFullscreen=Y.prototype.gh;Y.prototype.isFullScreen=Y.prototype.Hn;Y.prototype.enableConsoleLogging=Y.prototype.Bq;Y.prototype.hasConfig=Y.prototype.yn;Y.prototype.injectStyle=Y.prototype.Dd;Y.prototype.controller=Y.prototype.controller;Y.prototype.component=Y.prototype.Jh;Y.prototype.attach=Y.prototype.lc;Y.prototype.Context=Y.prototype.ap;window.Zwibbler=O;var Ke=w.create("EVALJS"),Le=function(){function c(a,b){this.Tc=a;this.key=b}c.prototype.toString=function(){return"LValue("+this.key+")"};return c}(),Me=function(){function c(a,b,c){this.id=a;this.xi=b;c&&(this.ce=c)}c.prototype.ce=function(){return this};c.prototype.Mn=function(a){return a};c.prototype.toString=function(){return"Token(id='"+this.id+"', lbp="+this.xi+")"};return c}(),Ne=function(){function c(a,b){return a[b]}function a(a,b,c){a[b]=c}function b(a){if(a instanceof Le){if(a.Tc===r)return v(r,
a.key);if(a.Tc)return a.Tc[a.key]}else return a}function d(a,b){void 0===b&&(b=0);var c=I[a];c?c.xi=Math.max(c.xi,b):c=I[a]=new Me(a,b);return c}function e(a,b){var c=d(a);c.ce=function(){return b};return c}function f(a){return new Me("(literal)",0,function(){return a})}function g(a){var b=new Me("(name)",0,function(){return new Le(r,a)});b.toString=function(){return"Token(name: "+a+")"};return b}function h(a,c,d){l(a,c,function(a){return d(b(a),b(t(c-1)))})}function l(a,b,c){d(a,b).Mn=c}function k(a,
c,e){d(a,c).ce=function(){return e(b(t(c)))}}function m(a,b,c){d(a,b).ce=c}function q(){return Da<Qa.length?Qa[Da++]:I["(end)"]}function p(a){if(a&&G.id!==a)throw Error("Error: expected "+a+" but got "+G.id);return G=q()}function t(a){var b=G;G=q();for(var c=b.ce();a<G.xi;)b=G,G=q(),c=b.Mn(c);return c}var r={},v=c,x=a,I={},y=0,K,P;e("true",!0);e("false",!1);e("null",null);e("undefined",void 0);d("(end)");(function(a,c,d){l(a,c,function(a){return d(b(a),b(t(c)))})})(",",K=++y,function(a,b){return b});
l("=",P=++y,function(a){var c=t(P);if(!(a instanceof Le))throw Error("Error: lhs of = must be assignable");c=b(c);if(a.Tc===r)x(r,a.key,c);else if(a.Tc instanceof Object)a.Tc[a.key]=c;else throw Error(a.Tc+"["+a.key+"] cannot be assigned to.");return c});h("&&",++y,function(a,b){return a&&b});h("||",++y,function(a,b){return a||b});h("|",++y,function(a,b){return a|b});h("^",++y,function(a,b){return a^b});h("&",++y,function(a,b){return a&b});h("===",++y,function(a,b){return a===b});h("!==",y,function(a,
b){return a!==b});h("==",y,function(a,b){return a==b});h("!=",y,function(a,b){return a!=b});h(">",++y,function(a,b){return a>b});h(">=",y,function(a,b){return a>=b});h("<",y,function(a,b){return a<b});h("<=",y,function(a,b){return a<=b});h("in",y,function(a,b){return a in b});h("<<",++y,function(a,b){return a<<b});h(">>",y,function(a,b){return a>>b});h(">>>",y,function(a,b){return a>>>b});h("+",++y,function(a,b){return a+b});h("-",y,function(a,b){return a-b});h("*",++y,function(a,b){return a*b});
h("/",y,function(a,b){return a/b});h("%",y,function(a,b){return a%b});k("!",++y,function(a){return!a});k("~",y,function(a){return~a});k("+",y,function(a){return+a});k("-",y,function(a){return-a});k("typeof",y,function(a){return typeof a});l(".",++y,function(a){var c=G;if("(name)"!==c.id)throw Error("Error: '.' expects a name, not "+G.id);if(!(a instanceof Le))throw Error("Error: '.' must be preceded by lvalue");a.Tc=b(a);a.key=c.ce().key;p();return a});m("(",++y,function(){var a=t(0);p(")");return a});
d(")");l("(",++y,function(a){var c=[];if(")"!==G.id)for(;;){c.push(b(t(K+1)));if(","!==G.id)break;p(",")}p(")");var d=null;a instanceof Le&&(d=a.Tc);a=b(a);if("function"!==typeof a)throw Error("Tried to call a non-function; type was "+typeof a);return a.apply(d,c)});d(",");l("[",y,function(a){var c=t(0);if(!(a instanceof Le))throw Error("Error: '[]' must be preceded by lvalue");p("]");a.Tc=b(a);a.key=b(c);return a});d("]");m("{",++y,function(){for(var a={};"}"!==G.id;){if("(literal)"===G.id)var c=
G.ce();else if("(name)"===G.id)c=G.ce().key;else throw Error("Bad {}; expecting name or string constant");p();p(":");a[c]=b(t(K+1));if(","!==G.id)break;G=p(",")}p("}");return a});m("[",y,function(){for(var a=[];"]"!==G.id;){a.push(b(t(K+1)));if(","!==G.id)break;G=p(",")}p("]");return a});d(",");d(":");d("}");var ma=/(\d+(\.\d+)?)|(===|!==|==|!=|\+=|-=|&&|\|\||<=|>=|<<|>>>|>>|&&|\|\||[{}\(\)\[\]\+\-\.\*\/=!,\?&\|:%~<>])|([a-zA-Z\$_][\$_a-zA-Z0-9]*)|("([^"\\]|\\.)*"|'([^'\\]|\\.)*')/g,Qa=[],Da=0,G;
return{parse:function(a){for(var b=[],c=0;c<a.length;){for(;" "===a.charAt(c);)c++;ma.lastIndex=c;var d=ma.exec(a);if(d&&d.index===c)if(c+=d[0].length,d[1])b.push(f(parseFloat(d[1])));else if(d[3]&&d[3]in I)b.push(I[d[3]]);else if(d[4])switch(d[4]){case "true":case "false":case "null":case "in":case "typeof":case "undefined":b.push(I[d[4]]);break;default:b.push(g(d[4]))}else{if(d[5]){d=d[5].substr(1,d[5].length-2);for(var e="",h=!1,l=0;l<d.length;l++){var k=d[l];if(h){switch(k){case "n":k="\n";break;
case "r":k="\r";break;case "t":k="\t"}e+=k;h=!1}else"\\"===k?h=!0:e+=k}b.push(f(e))}}else throw Error("Parse error: Expected stuff in "+a+" near: "+a.substr(c));}b.push(I["(end)"]);return b},evaluate:function(d,e,f,g){Da=0;Qa=e;r=d;v=f||function(a,b){return a[b]};x=g||function(a,b,c){a[b]=c};G=q();d=b(t(0));r={};v=c;x=a;return d}}}(),Oe=Ne.parse,Pe=Ne.evaluate;function Qe(c,a,b){try{return Pe(c,Oe(a),b)}catch(d){console.log("When evaluating:",a),console.log(d)}}
function Re(c,a){if(c===a)return!0;if(!(c instanceof Object&&a instanceof Object)||c.constructor!==a.constructor)return!1;for(var b in c)if(c.hasOwnProperty(b)&&(!a.hasOwnProperty(b)||c[b]!==a[b]&&("object"!==typeof c[b]||!Re(c[b],a[b]))))return!1;for(b in a)if(a.hasOwnProperty(b)&&!c.hasOwnProperty(b))return!1;return!0}
var Se=function(){function c(){this.Od={};this.ac=0;this.Cj=[];this.timeout=0}c.prototype.watch=function(a,b,c){a={scope:a,parsed:Oe(b),$n:void 0,Wn:c};b in this.Od?this.Od[b].push(a):this.Od[b]=[a];this.ac+=1};c.prototype.unwatch=function(a,b){if(a in this.Od){for(var c=this.Od[a],e=0;e<c.length;e++)if(c[e].Wn===b){c.splice(e,1);break}0===c.length&&delete this.Od[a]}};c.prototype.check=function(a){var b=this;a&&this.Cj.push(a);0===this.timeout&&(this.timeout=setTimeout(function(){b.timeout=0;for(var a=
(new Date).getTime(),c=0,f=0,g=!0,h=0;10>h&&g;h++){g=!1;b.ac=0;for(var l in b.Od)for(var k=null,m=void 0,q=0;q<b.Od[l].length;q++){var p=b.Od[l][q];try{p.scope!==k?(m=Pe(p.scope,p.parsed),k=p.scope,c+=1):f+=1,Re(p.$n,m)||(p.$n=m,p.Wn(m),g=!0)}catch(t){console.log("Error when evaluating %s: ",l,t),console.log("Context was: %o",p.scope)}}b.ac&&(g=!0)}Ke("Evauated %s/%s watchers in %sms",c,c+f,(new Date).getTime()-a);a=0;for(c=b.Cj;a<c.length;a++)(0,c[a])();b.Cj.length=0},0))};return c}();var Te=w.create("DRAGSORT");
function Ue(c){var a=c.parent.mp;c.parent.mp=!0;for(var b=c.parent.children,d=0;d<b.length;d++)null!==b[d].getAttribute(c.Dh)&&b[d].setAttribute("draggable","true");if(!a){z(c.parent).addEventListener("dragstart dragover dragend drop",function(a){Te(a.type);for(var b=a.target;b.parentNode!==c.parent&&b.parentNode;)b=b.parentNode;if(1===b.nodeType&&b.getAttribute("draggable")&&"false"!==b.getAttribute("draggable").toLowerCase()&&b.parentNode===c.parent)if("dragstart"===a.type){for(var d=c.parent.children,
g=0;g<d.length;g++)console.log(c.Dh,d[g].getAttribute(c.Dh),d[g]),null!==d[g].getAttribute(c.Dh)&&d[g].setAttribute("sort-index",g.toString());a.dataTransfer.setData("text",b.id);a.dataTransfer.dropEffect="move";f=e=b;a.stopPropagation()}else"dragover"===a.type&&f&&e.parentNode===b.parentNode?(f.classList.remove(c.Rk),f=b,f.classList.add(c.Rk),a.preventDefault()):"dragend"===a.type&&f&&e.parentNode===b.parentNode?(f.classList.remove(c.Rk),b=parseInt(f.getAttribute("sort-index")||"0"),d=parseInt(e.getAttribute("sort-index")||
"0"),c.vs(d,b),a.preventDefault(),a.stopPropagation()):"drop"===a.type&&(a.preventDefault(),a.stopPropagation())});var e,f}};var Z=w.create("Zeact");function Ve(c){var a=document.createElement("div");a.innerHTML=c;c=[];for(a=a.firstChild;a;)a instanceof HTMLElement&&c.push(a),a=a.nextSibling;return c}
var V=new (function(){function c(){this.Kl=new Se;this.Uh={};this.Mm={};this.fp=1}c.prototype.Cb=function(a,b,c){void 0===c&&(c=2);this.Uh[a]={name:a,link:b,Lo:c}};c.prototype.Jh=function(a,b){this.Mm[a.toUpperCase()]=b;"string"===typeof b.template&&(b.template=b.template.trim())};c.prototype.qf=function(a,b){var c=this;this.Cb(a,function(a,d,g,h){c.watch(a,d,h,function(c){b(d,c,a)})})};c.prototype.watch=function(a,b,c,e){var d=this;this.Kl.watch(a,c,e);this.La(b,function(){d.Kl.unwatch(c,e)})};c.prototype.Jc=
function(a,b,c){a.addEventListener(b,c);this.La(a,function(){a.removeEventListener(b,c)});a.zwibblerListeners||(a.zwibblerListeners={});a.zwibblerListeners[b]||(a.zwibblerListeners[b]=[]);a.zwibblerListeners[b].push(c)};c.prototype.ua=function(a,b,c){a.zwibblerListeners&&b in a.zwibblerListeners&&setTimeout(function(){for(var d=0,f=a.zwibblerListeners[b];d<f.length;d++)f[d].call(a,c)},0)};c.prototype.La=function(a,b){a.ij?a.ij.push(b):a.ij=[b]};c.prototype.detach=function(a){for(var b=a.firstChild;b;)this.detach(b),
b=b.nextSibling;if(a.ij){b=0;for(var c=a.ij;b<c.length;b++)(0,c[b])();delete a.zwibblerWatchers}a.zwibblerListeners&&delete a.zwibblerListeners};c.prototype.digest=function(a){this.Kl.check(a)};c.prototype.Kq=function(a,b){var c=/^z-([a-z0-9@\-]+)/.exec(a.toLowerCase());if(c&&(c=c[1],c in this.Uh&&this.Uh[c].Lo===b))return this.Uh[c]};c.prototype.Am=function(a,b,c,e){void 0===e&&(e=b);for(var d=[],g=0;g<e.attributes.length;g++)d.push({name:e.attributes[g].name,value:e.attributes[g].value});for(g=
0;g<d.length&&b.parentNode;g++){e=d[g].name;var h=d[g].value,l=this.Kq(e,c);if(l&&l.Lo===c&&(Z("Link directive to %s for %s=%s",b.em,e,h),(e=l.link(a,b,e,h))&&e!==b))return{Ga:e,Wk:!0}}return{Ga:b,Wk:null===b.parentNode}};c.prototype.Fp=function(a,b){var c=this,e=this.Mm[b.tagName];if(!e)return null;Z("Attaching component %s",b.tagName);var f=e.template;if(f instanceof HTMLElement)var g=f.cloneNode(!0);else if("string"===typeof f)if("<"===f[0]){Z("Using elementsFromString %s to instantiate component",
f);var h=Ve(f);if(0===h.length)throw Error("Component "+b.tagName+": Could not interpret as HTML: "+f);if(1<h.length)throw Error("Component "+b.tagName+": Should render as a single element, but got "+h.length);g=h[0]}else{Z("Using querySelector to instantiate component");g=document.querySelector(f);if(null===g)throw Error("Component "+b.tagName+': querySelector("'+f+'") returned null');g=g.cloneNode(!0)}else throw Error("Component "+b.tagName+": Could not interpret template "+f);b.parentNode.replaceChild(g,
b);var l=this,k={$emit:function(a,b){l.ua(g,a,b)}};k.$parent=a;f=e.properties;var m={};f&&f.forEach(function(d){m[d]=1;var e=b.getAttribute(d);e&&(Z("Bind prop %s to %s",d,e),c.watch(a,g,e,function(a){k[d]=a}))});e.style&&O.Dd(e.style);for(f=0;f<b.attributes.length;f++){h=b.attributes[f].name;var q=b.attributes[f].value;m[h]||0===h.indexOf("z-")||g.setAttribute(h,q)}for(f=1;2>=f;f++)if(h=this.Am(a,g,f,b),h.Wk)return h.Ga;this.digest(function(){if(e.controller)try{e.controller(k,new Ie(k,g,"",""))}catch(p){console.log(p),
console.log("When running controller for %s",b.tagName)}c.lc(k,g)});return g};c.prototype.lc=function(a,b){if(1===b.nodeType){if(b.em)return b;b.em=this.fp++;for(var c=0;2>=c;c++){var e=this.Am(a,b,c);if(e.Wk)return e.Ga;if(0===c&&(e=this.Fp(a,b)))return e}for(c=b.firstChild;c;)e=c.nextSibling,this.lc(a,c),c=e}return b};return c}());function We(c,a,b,d,e){b&&(c["this"]=b);d&&(c.$event=d);Qe(c,a,e)}V.Cb("init",function(c,a,b,d){We(c,d,a)});
function Xe(c){"BUTTON"===c.tagName&&(c.getAttribute("type")||c.setAttribute("type","button"))}
V.Cb("click",function(c,a,b,d){function e(b){Z("z-click=["+d+"] received "+b.type);We(c,d,a,b,f);V.digest();b.preventDefault()}function f(a,b){a instanceof W&&0<=b.indexOf("Tool")&&(Z("Called %s",b),h=!0);return a[b]}Xe(a);b="ontouchstart"in window;var g="onpointerdown"in window;b?V.Jc(a,"touchend",e):g&&V.Jc(a,"pointerup",e);!g&&b&&V.Jc(a,"mouseup",e);var h;V.Jc(a,"keydown",function(b){13===b.keyCode&&(h=!1,e(b),h&&c.focus(!0,a))})});V.qf("text",function(c,a){c.textContent=a});
function Ye(c,a){var b=c.type?c.type.toLowerCase():"";if("zwibblerValue"in c)var d="zwibblerValue";else d="value",a=""+a;"radio"===b||"checkbox"===b?c.checked=c[d]===a:c[d]=a}function Ze(c){var a=c.type?c.type.toLowerCase():"";if("checkbox"===a)return c.checked;"radio"===a&&(a=c.getAttribute("name"))&&(a=document.querySelector('input[name="'+a+"]:checked"))&&(c=a);return"zwibblerValue"in c?c.zwibblerValue:c.value}
V.Cb("model",function(c,a,b,d){V.Jc(a,"input",function(){var b=Ze(a);Z("input -> model: New value for %s: %s",d,b);Qe(c,d+"="+JSON.stringify(b));V.digest()});var e;V.watch(c,a,d,function(b){Z("model(%s) -> input : new value is %s",d,b);e=b;Ye(a,e)});if(b=a.getAttribute("z-value"))V.watch(c,a,b,function(b){a.zwibblerValue=b;Ye(a,e)}),V.La(a,function(){delete a.zwibblerValue})});
V.Cb("has",function(c,a,b,d){b=[];var e=0;for(d=d.split("|");e<d.length;e++){var f=d[e];f=f.trim();b.push('("'+f+'" in summary.types || "'+f+'" in summary.properties)')}(b=b.join("||"))&&V.watch(c,a,b,function(b){a.style.display=b?"block":"none"})});function $e(c,a){var b=c.indexOf(a);return-1===b?"":c.substr(b+a.length+1)}
V.Cb("on",function(c,a,b,d){var e=$e(b,"on");""!==e&&(Z("Attaching native event %s => %s",e,d),V.Jc(a,e,function(b){Z("Got %s, execute %s",e,d);We(c,d,a,b);V.digest();b&&b.preventDefault&&b.preventDefault()}))});V.Cb("bind",function(c,a,b,d){var e=$e(b,"bind");""!==e&&V.watch(c,a,d,function(b){a.setAttribute(e,b)})},1);
V.Cb("for",function(c,a,b,d){b=d.indexOf(" in ");if(-1!==b){var e=d.substr(0,b),f=d.substr(b+4),g=[];Z("z-for '%s' in '%s'",e,f);var h=a.parentNode,l=a.nextSibling;a.parentNode.removeChild(a);V.watch(c,h,f,function(b){if("number"===typeof b){for(var d=[],k=0;k<b;k++)d.push(k);b=d}for(k=0;k<g.length;k++)d=g[k],d.parentNode&&d.parentNode.removeChild(d),V.detach(d);g.length=0;if("object"===typeof b&&"length"in b)for(k=0;k<b.length;k++){d=document.createComment("z-for "+f+"["+k+"] = "+b[k]);h.insertBefore(d,
l);g.push(d);d=Object.create(c);d.$parent=c;d[e]=b[k];var p=a.cloneNode(!0);p.removeAttribute("z-for");h.insertBefore(p,l);d=V.lc(d,p);g.push(d)}})}},0);V.Cb("if",function(c,a,b,d){var e=document.createComment(b+" "+d),f=a.parentElement,g=null;f.replaceChild(e,a);V.watch(c,f,d,function(d){d&&!g?(g=a.cloneNode(!0),g.removeAttribute(b),f.replaceChild(g,e),V.lc(c,g)):!d&&g&&(V.detach(g),f.replaceChild(e,g),g=null)})},0);V.qf("class",function(c,a){for(var b in a)z(c).yl(b,a[b])});
V.qf("style",function(c,a){for(var b in a)c.style[b]=a[b]});V.qf("selected",function(c,a){z(c).yl("selected",a)});V.qf("disabled",function(c,a){a?c.setAttribute("disabled","true"):c.removeAttribute("disabled")});V.qf("checked",function(c,a){c.checked=a?!0:!1});
V.Cb("property",function(c,a,b,d){b='summary.properties["'+d+'"]';var e=a.getAttribute("z-value"),f=null!==a.getAttribute("z-colour");V.watch(c,a,b,function(b){"value"in a&&(a.value=b);null!==e&&z(a).yl("selected",""+b===e);f&&(a.style.backgroundColor=b)});"BUTTON"===a.tagName?(Xe(a),V.Jc(a,"click",function(){var b=a.getAttribute("z-value")||"";c.setProperty(d,b)})):V.Jc(a,"change",function(){var b=Ze(a);void 0!==b&&c.setProperty(d,b)})});
V.Cb("popup",function(c,a,b,d){var e=O.qh(a);a.getAttribute("z-position");var f=null!==a.getAttribute("z-click-dismiss");c.he||(c.he={});V.La(a.parentNode,function(){e.destroy()});e.onshow=function(){var b=a.querySelector("[z-focus]");b&&"focus"in b&&b.focus()};c.he[d]={show:function(a,b,c){e.show(b,c,f)},hide:function(){e.hide()}};c.resize&&c.resize()});V.Cb("show-popup",function(c,a,b,d){Xe(a);V.Jc(a,"click",function(a){c.he&&d in c.he&&c.he[d].show(this,a.pageX,a.pageY)})});
V.Cb("colour",function(c,a){V.Jc(a,"click",function(b){c.Jo(a.getAttribute("z-property")||"",b.pageX,b.pageY)})});
V.Cb("page",function(c,a,b,d){function e(){var a=c.sn(g),b=Math.min(h/a.width,l/a.height);1<b&&(b=1);f.width=a.width*b|0;f.height=a.height*b|0;k.setTransform(b,0,0,b,0,0);k.fillStyle="white";k.fillRect(0,0,a.width,a.height);c.ha(k,{page:g})}if(!a.ju){var f=document.createElement("canvas"),g=Qe(c,d)||0,h=parseInt(a.getAttribute("z-width")||"1000000"),l=parseInt(a.getAttribute("z-height")||"1000000");f.style.backgroundColor="white";var k=f.getContext("2d");a.parentNode&&(a.parentNode.insertBefore(f,
a),a.parentNode.removeChild(a));e();c.Ja("document-changed",e);c.Ja("resource-loaded",e);V.La(f,function(){c.removeEventListener("document-changed",e);c.removeEventListener("resource-loaded",e)});for(b=0;b<a.attributes.length;b++)f.setAttribute(a.attributes[b].name,a.attributes[b].value);f.ju=!0;return V.lc(c,f)}});
V.Cb("sort",function(c,a,b,d){O.Dd(".zwibbler-sort-highlight { outline: 3px solid orange }");Ue({parent:a,Dh:"z-sortable",Rk:"zwibbler-sort-highlight",vs:function(a,b){c.$from=a;c.$to=b;Qe(c,d);V.digest()}})});function af(){Z("Document loaded.");Array.prototype.forEach.call(document.querySelectorAll("zwibbler,[zwibbler]"),function(c){Je(c)})}function bf(c,a,b){z(c).matches(a)&&b(c);Array.prototype.forEach.call(c.querySelectorAll(a),b)}
function Je(c,a){void 0===a&&(a=!1);"ZWIBBLER"===c.tagName&&O.Dd("zwibbler {display: block}");if(a||null===c.getAttribute("z-no-auto-init")){bf(c,"[z-component]",function(a){var b=a.getAttribute("z-component"),c=a.getAttribute("z-controller"),d=(a.getAttribute("z-properties")||"").split(/[ ,]+/);if(b){var e=null;if(c)if(c in O.controllers)e=O.controllers[c];else if("function"===typeof window.zcontroller)e=window.zcontroller;else throw Error("While processing component: "+b+" could not find controller function "+
c);O.Jh(b,{template:a,properties:d,controller:e});a.parentNode.removeChild(a)}});for(var b,d={},e=0;e<c.attributes.length;e++){var f=c.attributes[e];O.yn(f.name)&&(d[f.name]=f.value)}bf(c,"z-canvas,[z-canvas]",function(a){b=O.create(a,d)});var g=b;b?b.lc(b,c):(g={},V.lc(g,c));g.$digest=function(){V.digest()};g.hidePopup=function(a){g.he&&a in g.he&&g.he[a].hide()};e=c.getAttribute("z-controller")||"";e in O.controllers?(Z("Running controller: %s",e),O.controllers[e](g)):"function"===typeof window[e]&&
(Z("Running controller: %s",e),window[e](g));V.digest();return g}}document.addEventListener("DOMContentLoaded",function(){af()});var cf=w.create("ColourPanel");V.qf("clear-glyph",function(c,a,b){cf("Drawing colour panel, width=%s tag=%s",JSON.stringify(a),c.tagName);"CANVAS"===c.tagName&&(c.width=a.width,c.height=a.width,"clear"===a.style?ze(c.getContext("2d"),0,0,a.width):Ae(c.getContext("2d"),0,0,a.width),b.resize())});
var Be={style:"\n.zwibbler-colour-panel {\n    overflow:hidden;\n    border-top: 1px solid black;\n    white-space: nowrap;\n    font-size: 0;\n}\n\n.zwibbler-colour-panel div { \n    display: inline-block;\n}",si:'<div class="zwibbler-colour-panel" z-style="{height:ColourPanelWidth()+\'px\'}">\n    <canvas z-clear-glyph="{width: ColourPanelWidth(), style:\'clear\'}"\n        z-on:click="setColour(\'rgba(0,0,0,0.0)\', true)"\n        z-on:contextmenu="setColour(\'rgba(0,0,0,0.0)\', false)">\n    </canvas>\n    <canvas z-clear-glyph="{width: ColourPanelWidth(), style:\'transparent\'}"\n        z-on:click="setOpacity(0.5, true)"\n        z-on:contextmenu="setOpacity(0.5, false)">\n    </canvas>\n    <div z-for="colour in ColourPanelColours"\n        z-style="{width: ColourPanelWidth()+\'px\', height: ColourPanelWidth()+\'px\', background: colour}"\n        z-on:click="setColour(colour, true)"\n        z-on:contextmenu="setColour(colour, false)">\n    </div>\n</div>\n',
controller:function(c){var a=c.jq();a.shift();a.shift();c.ColourPanelColours=a;c.ColourPanelWidth=function(){return c.hk("useTouch")?40:20}}};}).call(window);
//# sourceMappingURL=zwibbler-demo.js.map